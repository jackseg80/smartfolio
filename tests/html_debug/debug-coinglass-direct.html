<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="/static/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Debug CoinGlass Direct</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a202c;
            color: #e2e8f0;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card {
            background: #2d3748;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3182ce;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2c5282; }
        .log {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ”§ Debug CoinGlass Direct</h1>
            <p>Test direct des appels CoinGlass pour identifier le problÃ¨me</p>
            
            <div>
                <button class="btn" onclick="testAPI()">ğŸ“¡ Test API Direct</button>
                <button class="btn" onclick="testPageDirect()">ğŸŒ Test Page Direct</button>
                <button class="btn" onclick="testCORSProxies()">ğŸ”„ Test CORS Proxies</button>
                <button class="btn" onclick="inspectNetworkErrors()">ğŸ” Inspect Network</button>
                <button class="btn" onclick="clearLog()">ğŸ§¹ Clear</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ Debug Log</h3>
            <div class="log" id="debug-log">Debug CoinGlass direct initialisÃ©...
</div>
        </div>
    </div>

    <script>
        let logElement;
        
        window.onload = function() {
            logElement = document.getElementById('debug-log');
            log('ğŸ”§ Debug interface loaded', 'success');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        window.testAPI = async function() {
            log('ğŸ“¡ Testing CoinGlass API direct...', 'info');
            
            const apiUrl = 'https://open-api-v4.coinglass.com/api/bull-market-peak-indicator';
            
            try {
                log(`Making request to: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Response data type: ${typeof data}`, 'info');
                    log(`Response keys: ${Object.keys(data)}`, 'info');
                    log(`Full response: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    if (data.data && Array.isArray(data.data)) {
                        log(`Found ${data.data.length} indicators`, 'success');
                        data.data.forEach((item, index) => {
                            log(`[${index}] ${item.indicator_name}: ${item.current_value}`, 'info');
                        });
                    }
                } else {
                    const text = await response.text();
                    log(`Error response body: ${text}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ API request failed: ${error.name}: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    log('ğŸš« CORS error detected - API blocked by browser', 'error');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log('ğŸŒ Network error - check internet connection', 'error');
                }
            }
        };
        
        window.testPageDirect = async function() {
            log('ğŸŒ Testing CoinGlass page direct...', 'info');
            
            const pageUrl = 'https://www.coinglass.com/bull-market-peak-signals';
            
            try {
                log(`Making request to: ${pageUrl}`, 'info');
                
                const response = await fetch(pageUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const html = await response.text();
                    log(`HTML length: ${html.length} characters`, 'success');
                    
                    // Look for indicators in HTML
                    const indicators = ['MVRV', 'Puell', 'Ahr999', 'Pi Cycle'];
                    indicators.forEach(indicator => {
                        const found = html.toLowerCase().includes(indicator.toLowerCase());
                        log(`${indicator} found in HTML: ${found}`, found ? 'success' : 'error');
                    });
                    
                    // Show first 500 chars of HTML
                    log(`HTML preview: ${html.substring(0, 500)}...`, 'info');
                    
                } else {
                    const text = await response.text();
                    log(`Error response: ${text}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Page request failed: ${error.name}: ${error.message}`, 'error');
                
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    log('ğŸš« CORS error detected - page blocked by browser', 'error');
                }
            }
        };
        
        window.testCORSProxies = async function() {
            log('ğŸ”„ Testing CORS proxies...', 'info');
            
            const targetUrl = 'https://www.coinglass.com/bull-market-peak-signals';
            const proxies = [
                {
                    name: 'AllOrigins',
                    url: 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl),
                    parseResponse: (data) => JSON.parse(data).contents
                },
                {
                    name: 'CORS Anywhere (Heroku)',
                    url: 'https://cors-anywhere.herokuapp.com/' + targetUrl,
                    parseResponse: (data) => data
                },
                {
                    name: 'CORSProxy.io',
                    url: 'https://corsproxy.io/?' + encodeURIComponent(targetUrl),
                    parseResponse: (data) => data
                }
            ];
            
            for (const proxy of proxies) {
                try {
                    log(`Testing ${proxy.name}...`, 'info');
                    
                    const response = await fetch(proxy.url);
                    log(`${proxy.name} status: ${response.status}`, response.ok ? 'success' : 'error');
                    
                    if (response.ok) {
                        const rawData = await response.text();
                        const html = proxy.parseResponse(rawData);
                        
                        log(`${proxy.name} HTML length: ${html.length}`, 'success');
                        
                        // Quick test for indicators
                        const mvrvFound = html.toLowerCase().includes('mvrv');
                        const puellFound = html.toLowerCase().includes('puell');
                        
                        log(`${proxy.name} - MVRV: ${mvrvFound}, Puell: ${puellFound}`, 'info');
                        
                        if (mvrvFound || puellFound) {
                            log(`âœ… ${proxy.name} is working and has indicator data!`, 'success');
                            return; // Exit on first success
                        }
                    }
                    
                } catch (error) {
                    log(`${proxy.name} failed: ${error.message}`, 'error');
                }
            }
            
            log('All CORS proxies failed or returned no indicator data', 'error');
        };
        
        window.inspectNetworkErrors = async function() {
            log('ğŸ” Inspecting network capabilities...', 'info');
            
            // Test basic network
            try {
                const testResponse = await fetch('https://httpbin.org/get');
                log(`Basic network test: ${testResponse.status} âœ…`, 'success');
            } catch (error) {
                log(`Basic network test failed: ${error.message}`, 'error');
                return;
            }
            
            // Test CORS-enabled endpoint
            try {
                const corsResponse = await fetch('https://api.coindesk.com/v1/bpi/currentprice.json');
                const corsData = await corsResponse.json();
                log(`CORS test (CoinDesk): ${corsResponse.status} âœ…`, 'success');
                log(`Bitcoin price: $${corsData.bpi.USD.rate}`, 'info');
            } catch (error) {
                log(`CORS test failed: ${error.message}`, 'error');
            }
            
            // Test CoinGlass domain specifically
            try {
                log('Testing CoinGlass domain connectivity...', 'info');
                const response = await fetch('https://www.coinglass.com/', { method: 'HEAD' });
                log(`CoinGlass domain: ${response.status}`, response.ok ? 'success' : 'error');
            } catch (error) {
                log(`CoinGlass domain test: ${error.message}`, 'error');
            }
            
            // Check browser capabilities
            log(`Navigator online: ${navigator.onLine}`, 'info');
            log(`Browser: ${navigator.userAgent}`, 'info');
        };
        
        window.clearLog = function() {
            logElement.textContent = 'Log cleared...\n';
        };
        
        // Auto-run basic tests on load
        setTimeout(() => {
            inspectNetworkErrors();
        }, 1000);
    </script>
</body>
</html>
