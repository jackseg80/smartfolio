<!DOCTYPE html>
<html>
<head>
    <base href="/static/">
  <title>Test FRED Complete Data</title>
  <script src="global-config.js"></script>
</head>
<body>
  <h1>ğŸ›ï¸ Test FRED DonnÃ©es ComplÃ¨tes</h1>
  <p>VÃ©rification que FRED retourne bien les donnÃ©es depuis 2014</p>
  
  <button onclick="testFredComplete()">Test FRED Complete</button>
  <button onclick="testFetchFunction()">Test fetchBitcoinHistoricalData()</button>
  
  <div id="results"></div>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.style.cssText = `
        margin: 0.5rem 0; 
        padding: 0.5rem; 
        border-radius: 4px; 
        background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'};
        color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'};
      `;
      div.innerHTML = message;
      results.appendChild(div);
    }

    // Test FRED API directement avec les vraies donnÃ©es complÃ¨tes
    async function testFredComplete() {
      log('ğŸ›ï¸ Test FRED API avec donnÃ©es complÃ¨tes depuis 2014...');
      
      const FRED_API_KEY = prompt('Entrez votre clÃ© API FRED:') || 'test-key';
      
      try {
        // Test avec toutes les donnÃ©es depuis 2014
        const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01`;
        const response = await fetch(url, { mode: 'cors' });
        
        if (response.ok) {
          const data = await response.json();
          if (data.observations && data.observations.length > 0) {
            const totalCount = data.count;
            const observations = data.observations;
            
            // Filtrer les donnÃ©es valides
            const validData = observations
              .filter(o => o.value !== '.' && o.value != null)
              .map(o => ({ 
                date: o.date, 
                price: parseFloat(o.value),
                timestamp: new Date(o.date).getTime()
              }))
              .filter(p => Number.isFinite(p.price));
            
            const firstValid = validData[0];
            const lastValid = validData[validData.length - 1];
            
            log(`âœ… FRED API: ${totalCount} observations totales disponibles`, 'success');
            log(`ğŸ“Š DonnÃ©es valides: ${validData.length} points`, 'success');
            log(`ğŸ“… PremiÃ¨re donnÃ©e: ${firstValid.date} = $${firstValid.price}`, 'success');
            log(`ğŸ“… DerniÃ¨re donnÃ©e: ${lastValid.date} = $${lastValid.price}`, 'success');
            
            // VÃ©rifier l'Ã©tendue temporelle
            const firstYear = new Date(firstValid.timestamp).getFullYear();
            const lastYear = new Date(lastValid.timestamp).getFullYear();
            
            log(`ğŸ—“ï¸ PÃ©riode couverte: ${firstYear} Ã  ${lastYear} (${lastYear - firstYear + 1} annÃ©es)`, 'success');
            
            if (firstYear <= 2014) {
              log(`âœ… HISTORIQUE COMPLET: DonnÃ©es depuis ${firstYear} âœ¨`, 'success');
            } else {
              log(`âš ï¸ Historique limitÃ©: DonnÃ©es depuis ${firstYear} seulement`, 'warning');
            }
            
            // Sauvegarder la clÃ© dans globalConfig
            window.globalConfig?.set?.('fred_api_key', FRED_API_KEY);
            log(`ğŸ’¾ ClÃ© FRED sauvÃ©e dans GlobalConfig`, 'success');
            
          } else {
            log('âŒ FRED API: Aucune observation dans la rÃ©ponse', 'error');
          }
        } else {
          log(`âŒ FRED API erreur: HTTP ${response.status}`, 'error');
        }
      } catch (e) {
        log(`âŒ Erreur FRED API: ${e.message}`, 'error');
      }
    }

    // Test de la fonction complÃ¨te fetchBitcoinHistoricalData
    async function testFetchFunction() {
      log('ğŸ“ˆ Test de fetchBitcoinHistoricalData() complÃ¨te...');
      
      // Simuler la fonction du risk dashboard
      async function fetchBitcoinHistoricalData() {
        let FRED_API_KEY = (window.globalConfig?.get?.('fred_api_key')) || '';
        
        // Fallback: demander la clÃ© si pas dans globalConfig
        if (!FRED_API_KEY) {
          FRED_API_KEY = prompt('Entrez votre clÃ© API FRED:') || 'test-key';
          window.globalConfig?.set?.('fred_api_key', FRED_API_KEY);
        }
        
        if (FRED_API_KEY) {
          try {
            const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01`;
            const r = await fetch(url, { mode: 'cors' });
            if (!r.ok) throw new Error(`FRED HTTP ${r.status}: ${r.statusText}`);
            const j = await r.json();
            if (Array.isArray(j.observations)) {
              const data = j.observations
                .filter(o => o.value !== '.' && o.value != null)
                .map(o => ({ time: new Date(o.date).getTime(), price: parseFloat(o.value) }))
                .filter(p => Number.isFinite(p.price));
              if (data.length > 0) {
                return { data, source: 'FRED (CBBTCUSD)' };
              }
            }
          } catch (e) {
            console.warn('FRED fetch failed:', e.message);
          }
        }
        return { data: [], source: 'Ã‰chec' };
      }

      try {
        const result = await fetchBitcoinHistoricalData();
        
        if (result.data.length > 0) {
          const first = result.data[0];
          const last = result.data[result.data.length - 1];
          const firstDate = new Date(first.time);
          const lastDate = new Date(last.time);
          
          log(`âœ… fetchBitcoinHistoricalData() rÃ©ussie!`, 'success');
          log(`ğŸ“Š Source: ${result.source}`, 'success');
          log(`ğŸ“Š Points de donnÃ©es: ${result.data.length}`, 'success');
          log(`ğŸ“Š PÃ©riode: ${firstDate.toLocaleDateString()} ($${first.price}) â†’ ${lastDate.toLocaleDateString()} ($${last.price})`, 'success');
          
          // VÃ©rifier que nous avons des donnÃ©es depuis 2014
          if (firstDate.getFullYear() <= 2014) {
            log(`ğŸ¯ SUCCÃˆS: Historique complet depuis ${firstDate.getFullYear()}! Le graphique devrait maintenant montrer toute l'histoire Bitcoin.`, 'success');
          } else {
            log(`âš ï¸ Historique limitÃ©: donnÃ©es depuis ${firstDate.getFullYear()} seulement`, 'warning');
          }
          
          // Format pour Chart.js
          const chartData = result.data.map(point => ({
            x: point.time,
            y: point.price
          }));
          
          log(`ğŸ“Š DonnÃ©es prÃªtes pour Chart.js: ${chartData.length} points formatÃ©s`, 'success');
          
        } else {
          log(`âŒ fetchBitcoinHistoricalData() retourne aucune donnÃ©e`, 'error');
        }
      } catch (e) {
        log(`âŒ Erreur test fonction: ${e.message}`, 'error');
      }
    }

    // Auto-test on load
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ Test FRED complet initialisÃ©');
      setTimeout(testFredComplete, 500);
    });
  </script>
</body>
</html>
