<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DI Backtest - SmartFolio</title>
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/view-modes.css">
    <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="analytics-unified-theme.css?v=20260129v1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Chart && window['chartjs-plugin-annotation'] && !window.__di_annotation_registered__) {
        Chart.register(window['chartjs-plugin-annotation']);
        window.__di_annotation_registered__ = true;
      }
    });
  </script>
  <script src="debug-logger.js"></script>
  <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script type="module" src="components/data-freshness.js"></script>
  <script type="module" src="network-state-manager.js"></script>
    <script type="module" src="core/sentry-init.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="components/view-toggle.js"></script>
  <script type="module" src="components/domain-nav.js"></script>
  <script type="module">
    // ===== AUTH GUARD =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();

    // ===== VIEW MODE MANAGER (Feb 2026) =====
    import { ViewModeManager } from './core/view-mode-manager.js';
    ViewModeManager.init();
    // ========================================
  </script>
  <style>
    .wrap {
      max-width: min(1600px, 96vw);
      margin: 0 auto;
      padding: var(--space-lg);
    }

    .page-header {
      margin-bottom: var(--space-xl);
    }

    .page-header h1 {
      font-size: 1.75rem;
      margin: 0 0 var(--space-sm) 0;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .page-header p {
      color: var(--theme-text-muted);
      margin: 0;
    }

    /* Controls Panel */
    .controls-panel {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .control-group label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--theme-text-muted);
    }

    .control-group select,
    .control-group input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      background: var(--theme-surface);
      color: var(--theme-text);
      font-size: 0.9rem;
      color-scheme: light dark;
    }

    /* Dark mode specific: ensure inputs are readable */
    [data-theme="dark"] .control-group select,
    [data-theme="dark"] .control-group input {
      background: var(--theme-bg);
    }

    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px rgba(var(--brand-primary-rgb, 59, 130, 246), 0.2);
    }

    /* Date inputs specific styling for dark mode */
    .control-group input[type="date"]::-webkit-calendar-picker-indicator {
      filter: var(--theme-icon-filter, none);
      cursor: pointer;
    }

    [data-theme="dark"] .control-group input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    .btn-primary {
      background: var(--brand-primary);
      color: white;
      border: none;
      padding: 0.6rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-lg);
    }

    .result-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
    }

    .result-card h3 {
      font-size: 1rem;
      margin: 0 0 var(--space-md) 0;
      color: var(--theme-text);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-md);
    }

    .kpi-card {
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      text-align: center;
    }

    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--space-xs);
    }

    .kpi-value.positive { color: var(--color-success); }
    .kpi-value.negative { color: var(--color-danger); }
    .kpi-value.neutral { color: var(--theme-text); }

    .kpi-label {
      font-size: 0.75rem;
      color: var(--theme-text-muted);
      text-transform: uppercase;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Period Presets */
    .period-presets {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-xs);
      margin-top: var(--space-sm);
    }

    .preset-btn {
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
      background: var(--theme-surface);
      color: var(--theme-text);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: var(--theme-bg);
    }

    .preset-btn.active {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary);
    }

    /* Loading State */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--theme-border);
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* DI History Chart Zones */
    .di-zone-bullish { background: rgba(16, 185, 129, 0.1); }
    .di-zone-neutral { background: rgba(245, 158, 11, 0.1); }
    .di-zone-bearish { background: rgba(239, 68, 68, 0.1); }

    /* Responsive */
    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
      .results-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Strategy comparison table */
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .comparison-table th,
    .comparison-table td {
      padding: var(--space-sm);
      text-align: left;
      border-bottom: 1px solid var(--theme-border);
    }

    .comparison-table th {
      font-weight: 600;
      color: var(--theme-text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .comparison-table tr:hover {
      background: var(--theme-bg);
    }

    .rank-badge {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .rank-1 { background: #ffd700; color: #000; }
    .rank-2 { background: #c0c0c0; color: #000; }
    .rank-3 { background: #cd7f32; color: #fff; }

    /* Strategy Description Panel */
    .strategy-info {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
    }

    .strategy-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .strategy-info-title {
      font-weight: 600;
      color: var(--theme-text);
    }

    .strategy-info-toggle {
      background: none;
      border: none;
      color: var(--brand-primary);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .strategy-description {
      color: var(--theme-text-muted);
      margin-bottom: var(--space-sm);
    }

    .strategy-rules {
      display: none;
      margin-top: var(--space-sm);
    }

    .strategy-rules.expanded {
      display: block;
    }

    .strategy-rules h4 {
      font-size: 0.85rem;
      color: var(--theme-text);
      margin: var(--space-sm) 0 var(--space-xs) 0;
    }

    .strategy-rules ul {
      margin: 0;
      padding-left: var(--space-md);
      color: var(--theme-text-muted);
    }

    .strategy-rules li {
      margin-bottom: var(--space-xs);
      font-size: 0.85rem;
    }

    .strategy-pros-cons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
      margin-top: var(--space-sm);
    }

    .pros li::marker { color: var(--color-success); }
    .cons li::marker { color: var(--color-danger); }

    .strategy-best-for {
      margin-top: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      background: rgba(var(--brand-primary-rgb, 59, 130, 246), 0.1);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
    }

    .strategy-best-for strong {
      color: var(--brand-primary);
    }

    /* ===== Advanced Parameters Panel ===== */
    .advanced-params-panel {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
    }

    .advanced-params-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .advanced-params-header h4 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--theme-text);
    }

    .advanced-params-header .toggle-icon {
      transition: transform 0.2s;
      color: var(--theme-text-muted);
    }

    .advanced-params-header .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .advanced-params-body {
      display: none;
      margin-top: var(--space-md);
    }

    .advanced-params-body.expanded {
      display: block;
    }

    .layer-toggles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .layer-toggle input[type="checkbox"] {
      accent-color: var(--brand-primary);
    }

    .param-sliders {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-md);
    }

    .param-slider {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .param-slider label {
      display: flex;
      justify-content: space-between;
      font-size: 0.82rem;
      color: var(--theme-text-muted);
    }

    .param-slider label .param-value {
      font-weight: 600;
      color: var(--theme-text);
    }

    .param-slider input[type="range"] {
      width: 100%;
      accent-color: var(--brand-primary);
    }

    .advanced-params-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: var(--space-md);
    }

    .btn-reset {
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
      background: var(--theme-surface);
      color: var(--theme-text-muted);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-reset:hover {
      border-color: var(--color-danger);
      color: var(--color-danger);
    }

    .active-layers-display {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-xs);
      margin-top: var(--space-xs);
    }

    .layer-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
      background: rgba(var(--brand-primary-rgb, 59, 130, 246), 0.1);
      color: var(--brand-primary);
      border-radius: var(--radius-sm);
      font-weight: 500;
    }

    /* ===== Chart Modal (zoom) ===== */
    .chart-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: var(--space-lg);
    }

    .chart-modal.active {
      display: flex;
    }

    .chart-modal-content {
      background: var(--theme-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      width: 90vw;
      max-width: 1400px;
      height: 80vh;
      max-height: 800px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .chart-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .chart-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .chart-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: var(--theme-text-muted);
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }

    .chart-modal-close:hover {
      color: var(--theme-text);
    }

    .chart-modal-body {
      flex: 1;
      min-height: 0;
    }

    .chart-modal-body canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Make chart containers clickable */
    .chart-container {
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .chart-container:hover {
      opacity: 0.9;
    }

    .chart-container::after {
      content: "Click to enlarge";
      position: absolute;
      bottom: 8px;
      right: 8px;
      font-size: 0.7rem;
      color: var(--theme-text-muted);
      background: var(--theme-surface);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .chart-container:hover::after {
      opacity: 1;
    }

    .result-card .chart-container {
      position: relative;
    }

    /* ===== Rotation Params ===== */
    .rotation-presets {
      margin-bottom: var(--space-md);
    }

    .preset-buttons {
      display: flex;
      gap: var(--space-xs);
      margin-top: var(--space-xs);
    }

    .rotation-preset-btn {
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
      background: var(--theme-surface);
      color: var(--theme-text);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .rotation-preset-btn:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }

    .rotation-preset-btn.active {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary);
    }

    .preset-detail {
      margin-top: var(--space-xs);
      font-size: 0.78rem;
      color: var(--theme-text-muted);
      font-style: italic;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.72rem;
      color: var(--theme-text-muted);
      margin-top: -2px;
    }

    .dd-breaker-section {
      margin-top: var(--space-md);
    }

    .dd-breaker-params {
      margin-top: var(--space-sm);
      padding-left: var(--space-md);
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="wrap">
    <!-- Page Header -->
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
      <div>
        <h1>Decision Index Backtest</h1>
        <p>Retrospectively validate the Decision Index performance over historical periods (2017+)</p>
      </div>
      <view-toggle></view-toggle>
    </div>

    <!-- Navigation contextuelle Analytics Domain (Feb 2026) -->
    <domain-nav domain="analytics"></domain-nav>

    <!-- Controls Panel -->
    <div class="controls-panel">
      <div class="controls-grid">
        <div class="control-group">
          <label for="strategy">Strategy</label>
          <select id="strategy">
            <option value="di_cycle_rotation">Cycle Rotation (Recommended)</option>
            <option value="di_smartfolio_replica">SmartFolio Replica</option>
            <option value="di_trend_gate">Trend Gate (SMA200)</option>
            <option value="di_threshold">DI Threshold</option>
            <option value="di_momentum">DI Momentum</option>
            <option value="di_contrarian">DI Contrarian</option>
            <option value="di_risk_parity">DI Risk Parity</option>
            <option value="di_signal">DI Signal Only</option>
            <option value="di_adaptive_continuous">Adaptive Continuous (S9)</option>
          </select>
        </div>

        <div class="control-group">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" value="2020-01-01">
        </div>

        <div class="control-group">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate">
        </div>

        <div class="control-group">
          <label for="rebalanceFreq">Rebalance Frequency</label>
          <select id="rebalanceFreq">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <div class="control-group">
          <label for="initialCapital">Initial Capital ($)</label>
          <input type="number" id="initialCapital" value="10000" min="100">
        </div>

        <div class="control-group">
          <label for="calculatorVersion">DI Calculator</label>
          <select id="calculatorVersion">
            <option value="v1">V1 — Fixed Normalization</option>
            <option value="v2">V2 — Adaptive Proxies</option>
          </select>
        </div>

        <div class="control-group">
          <button class="btn-primary" id="runBacktest">
            Run Backtest
          </button>
        </div>
      </div>

      <!-- Strategy Description -->
      <div class="strategy-info" id="strategyInfo">
        <div class="strategy-info-header">
          <span class="strategy-info-title" id="strategyTitle">Cycle Rotation</span>
          <button class="strategy-info-toggle" id="strategyToggle">Show details</button>
        </div>
        <p class="strategy-description" id="strategyDescription">
          3-asset rotation (BTC/ETH/Stables) across 5 Bitcoin cycle phases. Best risk-adjusted returns.
        </p>
        <div class="strategy-rules" id="strategyDetails">
          <h4>Rules</h4>
          <ul id="strategyRules"></ul>
          <div class="strategy-pros-cons">
            <div class="pros">
              <h4>Avantages</h4>
              <ul id="strategyPros"></ul>
            </div>
            <div class="cons">
              <h4>Drawbacks</h4>
              <ul id="strategyCons"></ul>
            </div>
          </div>
          <div class="strategy-best-for" id="strategyBestFor"></div>
        </div>
      </div>

      <!-- Period Presets -->
      <div class="period-presets">
        <span style="font-size: 0.85rem; color: var(--theme-text-muted);">Periods:</span>
        <button class="preset-btn" data-start="2017-01-01" data-end="2017-12-31">Bull 2017</button>
        <button class="preset-btn" data-start="2018-01-01" data-end="2018-12-31">Crash 2018</button>
        <button class="preset-btn" data-start="2020-02-01" data-end="2020-05-01">COVID</button>
        <button class="preset-btn" data-start="2020-10-01" data-end="2021-11-15">Bull 2020-21</button>
        <button class="preset-btn" data-start="2021-11-15" data-end="2022-11-15">Bear 2022</button>
        <button class="preset-btn" data-start="2022-11-15" data-end="2024-04-01">Recovery 23-24</button>
        <button class="preset-btn" data-start="2017-01-01" data-end="">Full History</button>
      </div>

      <!-- Advanced Parameters (Cycle Rotation) -->
      <div class="advanced-params-panel" id="rotationParamsPanel" style="display: none;">
        <div class="advanced-params-header" id="rotationParamsToggle">
          <h4>Rotation Parameters</h4>
          <span class="toggle-icon" id="rotationParamsIcon">&#9660;</span>
        </div>
        <div class="advanced-params-body" id="rotationParamsBody">
          <!-- Presets -->
          <div class="rotation-presets">
            <label style="font-size: 0.85rem; font-weight: 500; color: var(--theme-text-muted);">Allocation Profile</label>
            <div class="preset-buttons">
              <button class="rotation-preset-btn active" data-preset="conservative">Conservative</button>
              <button class="rotation-preset-btn" data-preset="default">Default</button>
              <button class="rotation-preset-btn" data-preset="aggressive">Aggressive</button>
            </div>
            <div class="preset-detail" id="presetDetail">
              Bear: 10/3/87 &middot; Peak: 15/15/70 &middot; Distribution: 15/5/80
            </div>
          </div>

          <!-- Smoothing Alpha -->
          <div class="param-sliders">
            <div class="param-slider" id="symmetricAlphaSection">
              <label>
                <span>Smoothing Alpha</span>
                <span class="param-value" id="smoothingAlphaValue">0.30</span>
              </label>
              <input type="range" id="smoothingAlpha" min="0.00" max="1.00" step="0.05" value="0.30">
              <div class="slider-labels">
                <span>Slow</span>
                <span>Fast</span>
              </div>
            </div>
          </div>

          <!-- Asymmetric Alpha Toggle -->
          <label class="layer-toggle">
            <input type="checkbox" id="enableAsymAlpha">
            <span>Asymmetric Alpha (separate bull/bear speeds)</span>
          </label>
          <div class="param-sliders" id="asymAlphaParams" style="display: none;">
            <div class="param-slider">
              <label>
                <span>Bull Alpha (entry speed)</span>
                <span class="param-value" id="alphaBullValue">0.15</span>
              </label>
              <input type="range" id="alphaBull" min="0.05" max="0.50" step="0.05" value="0.15">
              <div class="slider-labels">
                <span>Slow entry</span>
                <span>Fast entry</span>
              </div>
            </div>
            <div class="param-slider">
              <label>
                <span>Bear Alpha (exit speed)</span>
                <span class="param-value" id="alphaBearValue">0.50</span>
              </label>
              <input type="range" id="alphaBear" min="0.10" max="1.00" step="0.05" value="0.50">
              <div class="slider-labels">
                <span>Slow exit</span>
                <span>Fast exit</span>
              </div>
            </div>
          </div>

          <!-- Drawdown Circuit Breaker -->
          <div class="dd-breaker-section">
            <label class="layer-toggle">
              <input type="checkbox" id="enableDDBreaker">
              <span>Drawdown Circuit Breaker</span>
            </label>
            <div class="dd-breaker-params" id="ddBreakerParams" style="display: none;">
              <div class="param-sliders">
                <div class="param-slider">
                  <label>
                    <span>Threshold 1 (moderate cut)</span>
                    <span class="param-value" id="ddThreshold1Value">-10%</span>
                  </label>
                  <input type="range" id="ddThreshold1" min="-0.30" max="-0.05" step="0.05" value="-0.10">
                </div>
                <div class="param-slider">
                  <label>
                    <span>Threshold 2 (floor to bear)</span>
                    <span class="param-value" id="ddThreshold2Value">-20%</span>
                  </label>
                  <input type="range" id="ddThreshold2" min="-0.40" max="-0.10" step="0.05" value="-0.20">
                </div>
              </div>
              <label class="layer-toggle">
                <input type="checkbox" id="ddRampUp" checked>
                <span>Gradual recovery (ramp-up)</span>
              </label>
            </div>
          </div>

          <div class="advanced-params-footer">
            <button class="btn-reset" id="resetRotationParams">Reset to Defaults</button>
          </div>
        </div>
      </div>

      <!-- Continuous Parameters (Adaptive Continuous S9 only) -->
      <div class="advanced-params-panel" id="continuousParamsPanel" style="display: none;">
        <div class="advanced-params-header" id="continuousParamsToggle">
          <h4>Adaptive Continuous Parameters</h4>
          <span class="toggle-icon" id="continuousParamsIcon">&#9660;</span>
        </div>
        <div class="advanced-params-body" id="continuousParamsBody">

          <div class="param-section">
            <h5>Allocation Range</h5>
            <div class="param-row">
              <label>Floor (Bear) <span id="allocFloorValue">10%</span></label>
              <input type="range" id="allocFloor" min="0.05" max="0.30" step="0.01" value="0.10">
            </div>
            <div class="param-row">
              <label>Ceiling (Bull) <span id="allocCeilingValue">85%</span></label>
              <input type="range" id="allocCeiling" min="0.50" max="0.95" step="0.01" value="0.85">
            </div>
          </div>

          <div class="param-section">
            <h5>Trend Overlay (Golden/Death Cross)</h5>
            <div class="param-row">
              <label>
                <input type="checkbox" id="enableTrendOverlay" checked>
                Enable trend confirmation (SMA50 vs SMA200)
              </label>
            </div>
            <div class="param-row">
              <label>Trend Boost <span id="trendBoostValue">±10%</span></label>
              <input type="range" id="trendBoostPct" min="0.00" max="0.20" step="0.01" value="0.10">
            </div>
          </div>

          <div class="param-section">
            <h5>Asymmetric Smoothing</h5>
            <div class="param-row">
              <label>Bull Entry (slow) <span id="contAlphaBullValue">0.12</span></label>
              <input type="range" id="contAlphaBull" min="0.01" max="0.50" step="0.01" value="0.12">
            </div>
            <div class="param-row">
              <label>Bear Exit (fast) <span id="contAlphaBearValue">0.50</span></label>
              <input type="range" id="contAlphaBear" min="0.10" max="1.00" step="0.01" value="0.50">
            </div>
          </div>

          <div class="param-section">
            <h5>ETH Split</h5>
            <div class="param-row">
              <label>ETH share (bull) <span id="ethShareBullValue">40%</span></label>
              <input type="range" id="ethShareBull" min="0.10" max="0.60" step="0.01" value="0.40">
            </div>
            <div class="param-row">
              <label>ETH share (bear) <span id="ethShareBearValue">20%</span></label>
              <input type="range" id="ethShareBear" min="0.05" max="0.40" step="0.01" value="0.20">
            </div>
          </div>

          <div class="param-section">
            <div class="param-row">
              <label>
                <input type="checkbox" id="enableRiskAdj" checked>
                Enable risk score adjustment (±10%)
              </label>
            </div>
          </div>

        </div>
      </div>

      <!-- Advanced Parameters (SmartFolio Replica only) -->
      <div class="advanced-params-panel" id="advancedParamsPanel" style="display: none;">
        <div class="advanced-params-header" id="advancedParamsToggle">
          <h4>Advanced Parameters</h4>
          <span class="toggle-icon" id="advancedParamsIcon">&#9660;</span>
        </div>
        <div class="advanced-params-body" id="advancedParamsBody">
          <div class="layer-toggles">
            <label class="layer-toggle">
              <input type="checkbox" id="enableRiskBudget" checked>
              <span>Layer 1: Risk Budget</span>
            </label>
            <label class="layer-toggle">
              <input type="checkbox" id="enableMarketOverrides" checked>
              <span>Layer 2: Market Overrides</span>
            </label>
            <label class="layer-toggle">
              <input type="checkbox" id="enableExposureCap" checked>
              <span>Layer 3: Exposure Cap</span>
            </label>
            <label class="layer-toggle">
              <input type="checkbox" id="enableGovernancePenalty" checked>
              <span>Layer 4: Governance Penalty</span>
            </label>
            <label class="layer-toggle">
              <input type="checkbox" id="enableDirectionPenalty" checked>
              <span>V2.1: Direction Penalty</span>
            </label>
          </div>

          <div class="param-sliders">
            <div class="param-slider">
              <label>
                <span>Exposure Confidence</span>
                <span class="param-value" id="exposureConfidenceValue">0.65</span>
              </label>
              <input type="range" id="exposureConfidence" min="0.50" max="1.00" step="0.05" value="0.65">
            </div>
            <div class="param-slider">
              <label>
                <span>Max Governance Penalty</span>
                <span class="param-value" id="maxGovernancePenaltyValue">25%</span>
              </label>
              <input type="range" id="maxGovernancePenalty" min="0" max="0.30" step="0.05" value="0.25">
            </div>
            <div class="param-slider">
              <label>
                <span>Min Risky Allocation</span>
                <span class="param-value" id="riskBudgetMinValue">20%</span>
              </label>
              <input type="range" id="riskBudgetMin" min="0.10" max="0.30" step="0.05" value="0.20">
            </div>
            <div class="param-slider">
              <label>
                <span>Max Risky Allocation</span>
                <span class="param-value" id="riskBudgetMaxValue">85%</span>
              </label>
              <input type="range" id="riskBudgetMax" min="0.70" max="0.95" step="0.05" value="0.85">
            </div>
          </div>

          <div class="advanced-params-footer">
            <button class="btn-reset" id="resetAdvancedParams">Reset to Defaults</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Grid -->
    <div class="results-grid" id="resultsGrid" style="display: none;">
      <!-- KPIs -->
      <div class="result-card" style="grid-column: 1 / -1;">
        <h3>Performance</h3>
        <div class="kpi-grid" id="kpiGrid">
          <!-- KPIs injectés dynamiquement -->
        </div>
      </div>

      <!-- Equity Curve -->
      <div class="result-card">
        <h3>Equity Curve</h3>
        <div class="chart-container">
          <canvas id="equityChart" role="img" aria-label="Backtest equity curve chart"></canvas>
        </div>
      </div>

      <!-- Allocation Over Time -->
      <div class="result-card">
        <h3>Allocation Over Time</h3>
        <div class="chart-container">
          <canvas id="allocationChart" role="img" aria-label="Portfolio allocation over time chart"></canvas>
        </div>
        <div style="display: flex; gap: var(--space-md); padding: var(--space-xs) var(--space-sm); font-size: 0.75rem; color: var(--theme-text-muted);">
          <span style="display:flex;align-items:center;gap:4px;"><span style="width:16px;height:2px;background:#ef4444;display:inline-block;border-top:2px dashed #ef4444;"></span> Divergence Override</span>
          <span style="display:flex;align-items:center;gap:4px;"><span style="width:16px;height:2px;background:#f59e0b;display:inline-block;border-top:2px dashed #f59e0b;"></span> Direction Penalty</span>
        </div>
      </div>

      <!-- DI History -->
      <div class="result-card">
        <h3>Decision Index History</h3>
        <div class="chart-container">
          <canvas id="diHistoryChart" role="img" aria-label="Decision Index history chart"></canvas>
        </div>
      </div>

      <!-- Drawdown -->
      <div class="result-card">
        <h3>Drawdown</h3>
        <div class="chart-container">
          <canvas id="drawdownChart" role="img" aria-label="Portfolio drawdown chart"></canvas>
        </div>
      </div>

      <!-- Monthly Returns -->
      <div class="result-card">
        <h3>Monthly Returns</h3>
        <div class="chart-container">
          <canvas id="monthlyReturnsChart" role="img" aria-label="Monthly returns heatmap chart"></canvas>
        </div>
      </div>

      <!-- DI Metrics -->
      <div class="result-card" style="grid-column: 1 / -1;">
        <h3>Decision Index Metrics</h3>
        <div class="kpi-grid" id="diMetricsGrid">
          <!-- DI metrics injectés dynamiquement -->
        </div>
      </div>
    </div>

    <!-- Placeholder when no results -->
    <div class="result-card" id="placeholder" style="text-align: center; padding: var(--space-xl);">
      <h3 style="margin-bottom: var(--space-md);">Select a period and run the backtest</h3>
      <p style="color: var(--theme-text-muted);">
        The backtest reconstructs the historical Decision Index and simulates a trading strategy
        to evaluate performance over the selected period.
      </p>
    </div>
  </div>

  <!-- Chart Zoom Modal -->
  <div class="chart-modal" id="chartModal">
    <div class="chart-modal-content">
      <div class="chart-modal-header">
        <h3 id="chartModalTitle">Graphique</h3>
        <button class="chart-modal-close" id="chartModalClose">&times;</button>
      </div>
      <div class="chart-modal-body">
        <canvas id="modalChart" role="img" aria-label="Zoomed chart detail view"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
    import { getAuthHeaders } from './core/auth-guard.js';

    // State
    let equityChart = null;
    let diHistoryChart = null;
    let drawdownChart = null;
    let monthlyReturnsChart = null;
    let allocationChart = null;
    let modalChart = null;

    // Wiring state: equity_curve data for allocation chart
    let lastEquityCurve = null;
    let lastDIHistory = null;

    // Strategy descriptions cache
    let strategyDetails = {};

    // Chart modal functions
    const chartConfigs = {
      equityChart: { title: 'Equity Curve', getChart: () => equityChart },
      allocationChart: { title: 'Allocation Over Time', getChart: () => allocationChart },
      diHistoryChart: { title: 'Decision Index History', getChart: () => diHistoryChart },
      drawdownChart: { title: 'Drawdown', getChart: () => drawdownChart },
      monthlyReturnsChart: { title: 'Monthly Returns', getChart: () => monthlyReturnsChart }
    };

    /**
     * Clone Chart.js configuration properly (JSON.stringify cannot handle functions/circular refs)
     */
    function cloneChartConfig(sourceChart) {
      const sourceData = sourceChart.data;
      const sourceOptions = sourceChart.options;

      // Clone datasets manually
      const clonedDatasets = sourceData.datasets.map(ds => {
        const cloned = {
          label: ds.label,
          data: [...ds.data], // Copy data array
          borderColor: ds.borderColor,
          backgroundColor: ds.backgroundColor,
          borderWidth: ds.borderWidth,
          fill: ds.fill,
          tension: ds.tension,
          pointRadius: ds.pointRadius,
          pointHoverRadius: ds.pointHoverRadius,
          yAxisID: ds.yAxisID,
          stack: ds.stack,
          order: ds.order,
          hidden: ds.hidden
        };
        // Remove undefined properties
        Object.keys(cloned).forEach(key => {
          if (cloned[key] === undefined) delete cloned[key];
        });
        return cloned;
      });

      // Clone labels
      const clonedLabels = sourceData.labels ? [...sourceData.labels] : [];

      // Build new config
      return {
        type: sourceChart.config.type,
        data: {
          labels: clonedLabels,
          datasets: clonedDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: sourceOptions.interaction ? { ...sourceOptions.interaction } : undefined,
          plugins: {
            legend: sourceOptions.plugins?.legend ? {
              display: sourceOptions.plugins.legend.display !== false,
              position: sourceOptions.plugins.legend.position || 'top'
            } : { display: true },
            title: sourceOptions.plugins?.title ? {
              display: sourceOptions.plugins.title.display,
              text: sourceOptions.plugins.title.text
            } : undefined,
            tooltip: {
              mode: 'index',
              intersect: false
            },
            // Clone annotation plugin config (V2.1 markers)
            annotation: sourceOptions.plugins?.annotation ? JSON.parse(JSON.stringify(sourceOptions.plugins.annotation)) : undefined
          },
          scales: cloneScales(sourceOptions.scales)
        }
      };
    }

    /**
     * Clone scales configuration
     */
    function cloneScales(scales) {
      if (!scales) return undefined;

      const cloned = {};
      Object.keys(scales).forEach(key => {
        const scale = scales[key];
        cloned[key] = {
          type: scale.type,
          display: scale.display !== false,
          position: scale.position,
          stacked: scale.stacked,
          time: scale.time ? { ...scale.time } : undefined,
          title: scale.title ? {
            display: scale.title.display,
            text: scale.title.text
          } : undefined,
          grid: scale.grid ? {
            display: scale.grid.display !== false,
            color: scale.grid.color
          } : undefined,
          ticks: scale.ticks ? {
            callback: undefined // Cannot clone functions, use default
          } : undefined,
          min: scale.min,
          max: scale.max,
          beginAtZero: scale.beginAtZero
        };
        // Remove undefined properties
        Object.keys(cloned[key]).forEach(k => {
          if (cloned[key][k] === undefined) delete cloned[key][k];
        });
      });
      return cloned;
    }

    function openChartModal(chartId) {
      const config = chartConfigs[chartId];
      if (!config) return;

      const sourceChart = config.getChart();
      if (!sourceChart) return;

      const modal = document.getElementById('chartModal');
      const modalCanvas = document.getElementById('modalChart');
      const modalTitle = document.getElementById('chartModalTitle');

      modalTitle.textContent = config.title;

      // Destroy previous modal chart
      if (modalChart) {
        modalChart.destroy();
        modalChart = null;
      }

      // Clone chart config properly
      const chartConfig = cloneChartConfig(sourceChart);

      // Create new chart in modal
      modalChart = new Chart(modalCanvas, chartConfig);

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeChartModal() {
      const modal = document.getElementById('chartModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';

      if (modalChart) {
        modalChart.destroy();
        modalChart = null;
      }
    }

    // Initialize modal event listeners
    function initChartModalListeners() {
      // Close button
      document.getElementById('chartModalClose').addEventListener('click', closeChartModal);

      // Click outside to close
      document.getElementById('chartModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          closeChartModal();
        }
      });

      // ESC key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeChartModal();
        }
      });

      // Make charts clickable
      Object.keys(chartConfigs).forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
          canvas.parentElement.addEventListener('click', () => openChartModal(chartId));
        }
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Set default end date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('endDate').value = today;

      // Load strategy descriptions
      await loadStrategyDescriptions();

      // Update description on strategy change
      document.getElementById('strategy').addEventListener('change', (e) => {
        updateStrategyDescription(e.target.value);
      });

      // Toggle strategy details
      document.getElementById('strategyToggle').addEventListener('click', () => {
        const details = document.getElementById('strategyDetails');
        const toggle = document.getElementById('strategyToggle');
        const isExpanded = details.classList.toggle('expanded');
        toggle.textContent = isExpanded ? 'Hide details' : 'Show details';
      });

      // Period presets
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('startDate').value = btn.dataset.start;
          document.getElementById('endDate').value = btn.dataset.end || today;
        });
      });

      // Run backtest button
      document.getElementById('runBacktest').addEventListener('click', runBacktest);

      // Initial description update
      updateStrategyDescription(document.getElementById('strategy').value);

      // Initialize chart modal listeners
      initChartModalListeners();

      // Advanced Parameters panels
      initAdvancedParams();
      initRotationParams();
    });

    async function loadStrategyDescriptions() {
      try {
        const response = await fetch(`${window.globalConfig.get('api_base_url')}/api/di-backtest/strategies?details=true`, {
          headers: getAuthHeaders()
        });
        const result = await response.json();
        if (result.ok && result.data?.strategies) {
          result.data.strategies.forEach(s => {
            strategyDetails[s.key] = s;
          });
        }
      } catch (error) {
        console.error('Failed to load strategy descriptions:', error);
      }
    }

    function updateStrategyDescription(strategyKey) {
      // Show/hide advanced params panels based on strategy
      const advPanel = document.getElementById('advancedParamsPanel');
      const rotPanel = document.getElementById('rotationParamsPanel');
      if (advPanel) {
        advPanel.style.display = strategyKey === 'di_smartfolio_replica' ? 'block' : 'none';
      }
      if (rotPanel) {
        rotPanel.style.display = strategyKey === 'di_cycle_rotation' ? 'block' : 'none';
      }
      const contPanel = document.getElementById('continuousParamsPanel');
      if (contPanel) {
        contPanel.style.display = strategyKey === 'di_adaptive_continuous' ? 'block' : 'none';
      }

      const details = strategyDetails[strategyKey];
      if (!details) {
        // Fallback descriptions si API pas disponible
        const fallback = getFallbackDescription(strategyKey);
        document.getElementById('strategyTitle').textContent = fallback.name;
        document.getElementById('strategyDescription').textContent = fallback.description;
        return;
      }

      document.getElementById('strategyTitle').textContent = details.name;
      document.getElementById('strategyDescription').textContent = details.full_description || details.description;

      // Rules
      const rulesEl = document.getElementById('strategyRules');
      rulesEl.innerHTML = (details.rules || []).map(r => `<li>${r}</li>`).join('');

      // Pros
      const prosEl = document.getElementById('strategyPros');
      prosEl.innerHTML = (details.pros || []).map(p => `<li>${p}</li>`).join('');

      // Cons
      const consEl = document.getElementById('strategyCons');
      consEl.innerHTML = (details.cons || []).map(c => `<li>${c}</li>`).join('');

      // Best for
      const bestForEl = document.getElementById('strategyBestFor');
      if (details.best_for) {
        bestForEl.innerHTML = `<strong>Ideal for:</strong> ${details.best_for}`;
        bestForEl.style.display = 'block';
      } else {
        bestForEl.style.display = 'none';
      }
    }

    function getFallbackDescription(key) {
      const fallbacks = {
        'di_smartfolio_replica': {
          name: 'SmartFolio Replica',
          description: 'Full production pipeline: risk_budget formula (blended score → risky %), market overrides (BTC floor 15%, ETH floor 12%), exposure cap (20-80%), and governance penalty (contradiction-based 0-25% reduction). Most realistic backtest strategy.'
        },
        'di_threshold': {
          name: 'DI Threshold',
          description: 'Allocation based on Decision Index thresholds. The higher the DI, the greater the exposure to risky assets.'
        },
        'di_momentum': {
          name: 'DI Momentum',
          description: 'Follows the DI trend. Increases exposure when the DI rises sharply, reduces when it falls.'
        },
        'di_contrarian': {
          name: 'DI Contrarian',
          description: 'Contrarian strategy. Accumulates in extreme fear (DI<20), takes profits in extreme greed (DI>80).'
        },
        'di_risk_parity': {
          name: 'DI Risk Parity',
          description: 'Combines Risk Parity (allocation inversely proportional to volatility) with DI-based scaling.'
        },
        'di_signal': {
          name: 'DI Signal',
          description: 'Pure trading signals. BUY when DI crosses 40 upward, SELL when it crosses 60 downward.'
        }
      };
      fallbacks['di_cycle_rotation'] = {
        name: 'Cycle Rotation',
        description: '3-asset rotation (BTC/ETH/Stables) across 5 Bitcoin cycle phases. Uses cycle_score + direction to detect accumulation, bull building, peak, distribution, and bear phases. Best risk-adjusted returns (Sharpe >1.0).'
      };
      fallbacks['di_trend_gate'] = {
        name: 'Trend Gate (SMA200)',
        description: 'SMA(200) trend gate: risk-on when BTC > SMA200, risk-off below. Optional anti-whipsaw filter and drawdown circuit breaker.'
      };
      fallbacks['di_adaptive_continuous'] = {
        name: 'Adaptive Continuous (S9)',
        description: 'Continuous DI→allocation mapping (no discrete phases) with golden/death cross trend confirmation. Higher ceiling (85%) for bull capture, fast exit smoothing for bear protection. 3-asset rotation (BTC/ETH/Stables).'
      };
      return fallbacks[key] || { name: key, description: 'Strategy based on the Decision Index' };
    }

    async function runBacktest() {
      const strategy = document.getElementById('strategy').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const rebalanceFreq = document.getElementById('rebalanceFreq').value;
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);
      const calculatorVersion = document.getElementById('calculatorVersion').value;

      if (!startDate || !endDate) {
        alert('Please select a period');
        return;
      }

      // Show loading
      document.getElementById('loadingOverlay').classList.add('active');
      document.getElementById('runBacktest').disabled = true;

      try {
        const response = await fetch(`${window.globalConfig.get('api_base_url')}/api/di-backtest/run`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders()
          },
          body: JSON.stringify({
            strategy,
            start_date: startDate,
            end_date: endDate,
            initial_capital: initialCapital,
            rebalance_frequency: rebalanceFreq,
            use_macro_penalty: true,
            calculator_version: calculatorVersion,
            replica_params: getReplicaParams(),
            rotation_params: getRotationParams(),
            continuous_params: getContinuousParams()
          })
        });

        const result = await response.json();

        if (result.ok && result.data) {
          displayResults(result.data);
        } else {
          throw new Error(result.error || result.message || 'Backtest failed');
        }

      } catch (error) {
        console.error('Backtest error:', error);
        alert(`Error: ${error.message}`);
      } finally {
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('runBacktest').disabled = false;
      }
    }

    function displayResults(data) {
      document.getElementById('resultsGrid').style.display = 'grid';
      document.getElementById('placeholder').style.display = 'none';

      // KPIs
      const kpiGrid = document.getElementById('kpiGrid');
      const metrics = data.metrics || {};
      const benchmark = data.benchmark_comparison || {};

      kpiGrid.innerHTML = `
        <div class="kpi-card">
          <div class="kpi-value ${metrics.total_return_pct >= 0 ? 'positive' : 'negative'}">
            ${metrics.total_return_pct >= 0 ? '+' : ''}${metrics.total_return_pct?.toFixed(1) || '0'}%
          </div>
          <div class="kpi-label">Return Total</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${metrics.annualized_return_pct >= 0 ? 'positive' : 'negative'}">
            ${metrics.annualized_return_pct >= 0 ? '+' : ''}${metrics.annualized_return_pct?.toFixed(1) || '0'}%
          </div>
          <div class="kpi-label">Annualized Return</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value negative">${metrics.max_drawdown_pct?.toFixed(1) || '0'}%</div>
          <div class="kpi-label">Max Drawdown</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${metrics.sharpe_ratio >= 1 ? 'positive' : 'neutral'}">
            ${metrics.sharpe_ratio?.toFixed(2) || '0'}
          </div>
          <div class="kpi-label">Sharpe Ratio</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${metrics.sortino_ratio?.toFixed(2) || '0'}</div>
          <div class="kpi-label">Sortino Ratio</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${metrics.avg_risky_allocation_pct?.toFixed(0) || '50'}%</div>
          <div class="kpi-label">Avg Risky Alloc</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${benchmark.excess_return_pct >= 0 ? 'positive' : 'negative'}">
            ${benchmark.excess_return_pct >= 0 ? '+' : ''}${benchmark.excess_return_pct?.toFixed(1) || '0'}%
          </div>
          <div class="kpi-label">vs BTC B&H</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${data.period?.days || '0'}</div>
          <div class="kpi-label">Days</div>
        </div>
      `;

      // DI Metrics
      const diMetricsGrid = document.getElementById('diMetricsGrid');
      const diMetrics = data.di_metrics || {};

      diMetricsGrid.innerHTML = `
        <div class="kpi-card">
          <div class="kpi-value neutral">${diMetrics.di_btc_correlation_30d?.toFixed(2) || 'N/A'}</div>
          <div class="kpi-label">DI-BTC Correlation 30d</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${diMetrics.di_accuracy_pct > 55 ? 'positive' : 'neutral'}">
            ${diMetrics.di_accuracy_pct?.toFixed(1) || '0'}%
          </div>
          <div class="kpi-label">Accuracy DI</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${diMetrics.di_mean?.toFixed(1) || '50'}</div>
          <div class="kpi-label">Average DI</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${diMetrics.avg_di_during_gains?.toFixed(1) || 'N/A'}</div>
          <div class="kpi-label">DI (Gains >10%)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${diMetrics.avg_di_during_losses?.toFixed(1) || 'N/A'}</div>
          <div class="kpi-label">DI (Losses >10%)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${metrics.upside_capture >= 0.8 ? 'positive' : 'neutral'}">
            ${metrics.upside_capture?.toFixed(2) || 'N/A'}
          </div>
          <div class="kpi-label">Upside Capture</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value ${metrics.downside_capture <= 0.8 ? 'positive' : 'negative'}">
            ${metrics.downside_capture?.toFixed(2) || 'N/A'}
          </div>
          <div class="kpi-label">Downside Capture</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${metrics.turnover_annual?.toFixed(1) || '0'}</div>
          <div class="kpi-label">Turnover (annual)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value neutral">${data.summary?.rebalance_count || '0'}</div>
          <div class="kpi-label">Rebalances</div>
        </div>
      `;

      // Active layers display
      const activeLayers = data.di_metrics?.active_layers;
      if (activeLayers && activeLayers.length > 0) {
        const layersHtml = activeLayers.map(l => `<span class="layer-badge">${l}</span>`).join('');
        diMetricsGrid.insertAdjacentHTML('beforeend', `
          <div class="kpi-card" style="grid-column: 1 / -1;">
            <div class="kpi-label" style="margin-bottom: var(--space-xs);">Active Layers</div>
            <div class="active-layers-display">${layersHtml}</div>
          </div>
        `);
      }

      // Calculator version badge
      const calcVersion = data.summary?.calculator_version || 'v1';
      const isV2 = calcVersion === 'v2';
      diMetricsGrid.insertAdjacentHTML('beforeend', `
        <div class="kpi-card">
          <div class="kpi-value" style="font-size: 0.95rem; color: ${isV2 ? 'var(--color-success-600)' : 'var(--theme-text-muted)'};">
            ${isV2 ? 'V2 — Adaptive' : 'V1 — Fixed'}
          </div>
          <div class="kpi-label">DI Calculator</div>
        </div>
      `);

      // Charts
      lastEquityCurve = data.equity_curve || [];
      renderEquityChart(lastEquityCurve);
      renderAllocationChart(lastEquityCurve, lastDIHistory);
      renderDrawdownChart(data.drawdowns || []);
      renderMonthlyReturnsChart(data.monthly_returns || []);

      // Fetch DI history for the chart (will re-render allocation chart with annotations)
      fetchDIHistory(data.period?.start, data.period?.end);
    }

    async function fetchDIHistory(startDate, endDate) {
      try {
        const response = await fetch(`${window.globalConfig.get('api_base_url')}/api/di-backtest/historical-di`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders()
          },
          body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            include_macro: true
          })
        });

        const result = await response.json();
        if (result.ok && result.data?.history) {
          lastDIHistory = result.data.history;
          renderDIHistoryChart(result.data.history);
          // Re-render allocation chart with DI history annotations
          if (lastEquityCurve) {
            renderAllocationChart(lastEquityCurve, lastDIHistory);
          }
        }
      } catch (error) {
        console.error('Error fetching DI history:', error);
      }
    }

    function renderEquityChart(data) {
      const ctx = document.getElementById('equityChart').getContext('2d');

      if (equityChart) equityChart.destroy();

      const labels = data.map(d => d.date);
      const portfolioValues = data.map(d => d.portfolio_value);
      const benchmarkValues = data.map(d => d.benchmark_value);

      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Portfolio (DI Strategy)',
              data: portfolioValues,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0
            },
            {
              label: 'Benchmark (BTC B&H)',
              data: benchmarkValues,
              borderColor: '#f59e0b',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month' },
              grid: { display: false }
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(128, 128, 128, 0.1)' }
            }
          }
        }
      });
    }

    /**
     * Compute edge-detection annotations from DI history data.
     * Returns annotation objects for transitions into divergence/direction penalty zones.
     */
    function computeV21Annotations(diHistory) {
      if (!diHistory || diHistory.length < 2) return {};
      const annotations = {};
      let prevDivergence = false;
      let prevDirection = false;
      let divCount = 0;
      let dirCount = 0;

      for (let i = 0; i < diHistory.length; i++) {
        const p = diHistory[i];
        // Divergence: |cycle - onchain| >= 30
        const isDivergence = Math.abs(p.cycle_score - p.onchain_score) >= 30;
        // Direction penalty: cycle > 80 && cycle_direction < 0
        const isDirection = p.cycle_direction != null && p.cycle_score > 80 && p.cycle_direction < 0;

        // Edge detection: only mark transitions
        if (isDivergence && !prevDivergence) {
          annotations[`div_${divCount++}`] = {
            type: 'line',
            xMin: p.date, xMax: p.date,
            borderColor: 'rgba(239, 68, 68, 0.6)',
            borderWidth: 1.5,
            borderDash: [4, 4],
            label: { display: false }
          };
        }
        if (isDirection && !prevDirection) {
          annotations[`dir_${dirCount++}`] = {
            type: 'line',
            xMin: p.date, xMax: p.date,
            borderColor: 'rgba(245, 158, 11, 0.6)',
            borderWidth: 1.5,
            borderDash: [4, 4],
            label: { display: false }
          };
        }
        prevDivergence = isDivergence;
        prevDirection = isDirection;
      }
      return annotations;
    }

    /**
     * Detect cycle phase from score + direction (mirrors DICycleRotationStrategy._detect_phase)
     */
    function detectCyclePhase(cycleScore, cycleDirection) {
      const dir = cycleDirection ?? 0;
      if (cycleScore >= 90) return 'peak';
      if (cycleScore >= 70) return dir >= 0 ? 'bull_building' : 'distribution';
      return dir >= 0 ? 'accumulation' : 'bear';
    }

    const PHASE_COLORS = {
      accumulation: 'rgba(59, 130, 246, 0.12)',   // blue
      bull_building: 'rgba(16, 185, 129, 0.12)',   // green
      peak: 'rgba(245, 158, 11, 0.12)',            // amber
      distribution: 'rgba(249, 115, 22, 0.12)',    // orange
      bear: 'rgba(239, 68, 68, 0.12)',             // red
    };

    const PHASE_LABELS = {
      accumulation: 'Accum',
      bull_building: 'Bull',
      peak: 'Peak',
      distribution: 'Distrib',
      bear: 'Bear',
    };

    /**
     * Compute phase background annotations from DI history for the allocation chart.
     * Only shown when Cycle Rotation strategy is selected.
     */
    function computePhaseAnnotations(diHistory) {
      if (!diHistory || diHistory.length < 2) return {};
      const strategy = document.getElementById('strategy').value;
      if (strategy !== 'di_cycle_rotation') return {};

      const annotations = {};
      let currentPhase = null;
      let phaseStart = null;
      let count = 0;

      for (let i = 0; i < diHistory.length; i++) {
        const p = diHistory[i];
        const phase = detectCyclePhase(p.cycle_score, p.cycle_direction);

        if (phase !== currentPhase) {
          // Close previous phase
          if (currentPhase && phaseStart) {
            annotations[`phase_${count}`] = {
              type: 'box',
              xMin: phaseStart,
              xMax: p.date,
              backgroundColor: PHASE_COLORS[currentPhase],
              borderWidth: 0,
              label: {
                display: count === 0 || currentPhase !== detectCyclePhase(
                  diHistory[Math.max(0, i - 20)]?.cycle_score ?? 50,
                  diHistory[Math.max(0, i - 20)]?.cycle_direction
                ),
                content: PHASE_LABELS[currentPhase],
                position: { x: 'center', y: 'start' },
                font: { size: 9, weight: 'normal' },
                color: 'rgba(128, 128, 128, 0.6)',
              }
            };
            count++;
          }
          currentPhase = phase;
          phaseStart = p.date;
        }
      }

      // Close last phase
      if (currentPhase && phaseStart) {
        const lastDate = diHistory[diHistory.length - 1].date;
        annotations[`phase_${count}`] = {
          type: 'box',
          xMin: phaseStart,
          xMax: lastDate,
          backgroundColor: PHASE_COLORS[currentPhase],
          borderWidth: 0,
          label: {
            display: true,
            content: PHASE_LABELS[currentPhase],
            position: { x: 'center', y: 'start' },
            font: { size: 9, weight: 'normal' },
            color: 'rgba(128, 128, 128, 0.6)',
          }
        };
      }

      return annotations;
    }

    function renderAllocationChart(equityCurveData, diHistory) {
      const ctx = document.getElementById('allocationChart').getContext('2d');
      if (allocationChart) allocationChart.destroy();

      if (!equityCurveData || equityCurveData.length === 0) return;

      // Sample if too large
      let sampled = equityCurveData;
      if (equityCurveData.length > 500) {
        const step = Math.ceil(equityCurveData.length / 500);
        sampled = equityCurveData.filter((_, i) => i % step === 0);
      }

      const labels = sampled.map(d => d.date);
      const allocValues = sampled.map(d => d.risky_allocation_pct ?? 50);

      // Compute annotations: phase backgrounds (rotation) or V2.1 markers (replica)
      const phaseAnnotations = diHistory ? computePhaseAnnotations(diHistory) : {};
      const v21Annotations = diHistory ? computeV21Annotations(diHistory) : {};
      const allAnnotations = { ...phaseAnnotations, ...v21Annotations };

      allocationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Risky Allocation %',
            data: allocValues,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.15)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            annotation: { annotations: allAnnotations }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month' },
              grid: { display: false }
            },
            y: {
              min: 0,
              max: 100,
              title: { display: true, text: 'Risky %' },
              grid: { color: 'rgba(128, 128, 128, 0.1)' }
            }
          }
        }
      });
    }

    function renderDIHistoryChart(data) {
      const ctx = document.getElementById('diHistoryChart').getContext('2d');

      if (diHistoryChart) diHistoryChart.destroy();

      // Sample data if too large
      let sampledData = data;
      if (data.length > 500) {
        const step = Math.ceil(data.length / 500);
        sampledData = data.filter((_, i) => i % step === 0);
      }

      const labels = sampledData.map(d => d.date);
      const diValues = sampledData.map(d => d.decision_index);

      // Build datasets
      const datasets = [{
        label: 'Decision Index',
        data: diValues,
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        yAxisID: 'y'
      }];

      // V2.1: Add cycle direction overlay if data available
      const hasDirection = sampledData[0]?.cycle_direction != null;
      if (hasDirection) {
        const directionValues = sampledData.map(d => d.cycle_direction);
        // Segment coloring: green when positive, red when negative
        const segmentColors = sampledData.map(d =>
          d.cycle_direction >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'
        );

        datasets.push({
          label: 'Cycle Direction',
          data: directionValues,
          borderColor: (ctx) => {
            if (!ctx.p0 || !ctx.p1) return 'rgba(128,128,128,0.5)';
            const val = ctx.p1.parsed.y;
            return val >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
          },
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 1.5,
          yAxisID: 'y1',
          segment: {
            borderColor: (ctx) => {
              const val = ctx.p1.parsed.y;
              return val >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
            }
          }
        });
      }

      // Build scales
      const scales = {
        x: {
          type: 'time',
          time: { unit: 'month' },
          grid: { display: false }
        },
        y: {
          min: 0,
          max: 100,
          grid: { color: 'rgba(128, 128, 128, 0.1)' }
        }
      };

      if (hasDirection) {
        scales.y1 = {
          type: 'linear',
          display: true,
          position: 'right',
          min: -1,
          max: 1,
          title: { display: true, text: 'Direction' },
          grid: { display: false }
        };
      }

      diHistoryChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: hasDirection, position: 'top' },
            annotation: {
              annotations: {
                bullZone: {
                  type: 'box',
                  yMin: 60,
                  yMax: 100,
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  borderWidth: 0
                },
                bearZone: {
                  type: 'box',
                  yMin: 0,
                  yMax: 40,
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  borderWidth: 0
                }
              }
            }
          },
          scales
        }
      });
    }

    function renderDrawdownChart(data) {
      const ctx = document.getElementById('drawdownChart').getContext('2d');

      if (drawdownChart) drawdownChart.destroy();

      const labels = data.map(d => d.date);
      const ddValues = data.map(d => d.drawdown_pct);

      drawdownChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Drawdown %',
            data: ddValues,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month' },
              grid: { display: false }
            },
            y: {
              max: 0,
              grid: { color: 'rgba(128, 128, 128, 0.1)' }
            }
          }
        }
      });
    }

    function renderMonthlyReturnsChart(data) {
      const ctx = document.getElementById('monthlyReturnsChart').getContext('2d');

      if (monthlyReturnsChart) monthlyReturnsChart.destroy();

      const labels = data.map(d => d.date);
      const returns = data.map(d => d.return_pct);
      const colors = returns.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)');

      monthlyReturnsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Monthly Return %',
            data: returns,
            backgroundColor: colors,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: 'rgba(128, 128, 128, 0.1)' } }
          }
        }
      });
    }
    // ===== Advanced Parameters =====

    const REPLICA_DEFAULTS = {
      enableRiskBudget: true,
      enableMarketOverrides: true,
      enableExposureCap: true,
      enableGovernancePenalty: true,
      enableDirectionPenalty: true,
      exposureConfidence: 0.65,
      maxGovernancePenalty: 0.25,
      riskBudgetMin: 0.20,
      riskBudgetMax: 0.85,
    };

    function initAdvancedParams() {
      // Toggle panel expand/collapse
      const toggle = document.getElementById('advancedParamsToggle');
      const body = document.getElementById('advancedParamsBody');
      const icon = document.getElementById('advancedParamsIcon');

      toggle.addEventListener('click', () => {
        const expanded = body.classList.toggle('expanded');
        icon.classList.toggle('expanded', expanded);
      });

      // Slider value displays
      const sliders = [
        { id: 'exposureConfidence', displayId: 'exposureConfidenceValue', format: v => v },
        { id: 'maxGovernancePenalty', displayId: 'maxGovernancePenaltyValue', format: v => Math.round(v * 100) + '%' },
        { id: 'riskBudgetMin', displayId: 'riskBudgetMinValue', format: v => Math.round(v * 100) + '%' },
        { id: 'riskBudgetMax', displayId: 'riskBudgetMaxValue', format: v => Math.round(v * 100) + '%' },
      ];

      sliders.forEach(({ id, displayId, format }) => {
        const slider = document.getElementById(id);
        const display = document.getElementById(displayId);
        slider.addEventListener('input', () => {
          display.textContent = format(parseFloat(slider.value));
        });
      });

      // Min/Max validation
      document.getElementById('riskBudgetMin').addEventListener('change', () => {
        const min = parseFloat(document.getElementById('riskBudgetMin').value);
        const max = parseFloat(document.getElementById('riskBudgetMax').value);
        if (min >= max) {
          document.getElementById('riskBudgetMin').value = max - 0.05;
          document.getElementById('riskBudgetMinValue').textContent = Math.round((max - 0.05) * 100) + '%';
        }
      });

      document.getElementById('riskBudgetMax').addEventListener('change', () => {
        const min = parseFloat(document.getElementById('riskBudgetMin').value);
        const max = parseFloat(document.getElementById('riskBudgetMax').value);
        if (max <= min) {
          document.getElementById('riskBudgetMax').value = min + 0.05;
          document.getElementById('riskBudgetMaxValue').textContent = Math.round((min + 0.05) * 100) + '%';
        }
      });

      // Reset button
      document.getElementById('resetAdvancedParams').addEventListener('click', resetAdvancedParams);
    }

    function resetAdvancedParams() {
      document.getElementById('enableRiskBudget').checked = REPLICA_DEFAULTS.enableRiskBudget;
      document.getElementById('enableMarketOverrides').checked = REPLICA_DEFAULTS.enableMarketOverrides;
      document.getElementById('enableExposureCap').checked = REPLICA_DEFAULTS.enableExposureCap;
      document.getElementById('enableGovernancePenalty').checked = REPLICA_DEFAULTS.enableGovernancePenalty;
      document.getElementById('enableDirectionPenalty').checked = REPLICA_DEFAULTS.enableDirectionPenalty;

      document.getElementById('exposureConfidence').value = REPLICA_DEFAULTS.exposureConfidence;
      document.getElementById('exposureConfidenceValue').textContent = REPLICA_DEFAULTS.exposureConfidence;

      document.getElementById('maxGovernancePenalty').value = REPLICA_DEFAULTS.maxGovernancePenalty;
      document.getElementById('maxGovernancePenaltyValue').textContent = Math.round(REPLICA_DEFAULTS.maxGovernancePenalty * 100) + '%';

      document.getElementById('riskBudgetMin').value = REPLICA_DEFAULTS.riskBudgetMin;
      document.getElementById('riskBudgetMinValue').textContent = Math.round(REPLICA_DEFAULTS.riskBudgetMin * 100) + '%';

      document.getElementById('riskBudgetMax').value = REPLICA_DEFAULTS.riskBudgetMax;
      document.getElementById('riskBudgetMaxValue').textContent = Math.round(REPLICA_DEFAULTS.riskBudgetMax * 100) + '%';
    }

    // ===== Rotation Parameters =====

    const ROTATION_DEFAULTS = {
      preset: 'conservative',
      smoothingAlpha: 0.30,
      enableAsymAlpha: false,
      alphaBull: 0.15,
      alphaBear: 0.50,
      enableDDBreaker: false,
      ddThreshold1: -0.10,
      ddThreshold2: -0.20,
      ddRampUp: true,
    };

    const PRESET_DESCRIPTIONS = {
      conservative: 'Bear: 10/3/87 \u00b7 Peak: 15/15/70 \u00b7 Distribution: 15/5/80',
      default: 'Bear: 15/5/80 \u00b7 Peak: 20/20/60 \u00b7 Distribution: 20/10/70',
      aggressive: 'Bear: 15/5/80 \u00b7 Peak: 30/20/50 \u00b7 Distribution: 25/15/60',
    };

    function initRotationParams() {
      // Toggle panel expand/collapse
      const toggle = document.getElementById('rotationParamsToggle');
      const body = document.getElementById('rotationParamsBody');
      const icon = document.getElementById('rotationParamsIcon');

      toggle.addEventListener('click', () => {
        const expanded = body.classList.toggle('expanded');
        icon.classList.toggle('expanded', expanded);
      });

      // Preset buttons
      document.querySelectorAll('.rotation-preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.rotation-preset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const preset = btn.dataset.preset;
          document.getElementById('presetDetail').textContent = PRESET_DESCRIPTIONS[preset] || '';
        });
      });

      // Smoothing alpha slider
      const alphaSlider = document.getElementById('smoothingAlpha');
      const alphaDisplay = document.getElementById('smoothingAlphaValue');
      alphaSlider.addEventListener('input', () => {
        alphaDisplay.textContent = parseFloat(alphaSlider.value).toFixed(2);
      });

      // Asymmetric alpha toggle + sliders
      const asymToggle = document.getElementById('enableAsymAlpha');
      const asymParams = document.getElementById('asymAlphaParams');
      const symSection = document.getElementById('symmetricAlphaSection');
      asymToggle.addEventListener('change', () => {
        const enabled = asymToggle.checked;
        asymParams.style.display = enabled ? 'block' : 'none';
        symSection.style.opacity = enabled ? '0.4' : '1';
        symSection.style.pointerEvents = enabled ? 'none' : 'auto';
      });

      const bullSlider = document.getElementById('alphaBull');
      const bullDisplay = document.getElementById('alphaBullValue');
      bullSlider.addEventListener('input', () => {
        bullDisplay.textContent = parseFloat(bullSlider.value).toFixed(2);
      });

      const bearSlider = document.getElementById('alphaBear');
      const bearDisplay = document.getElementById('alphaBearValue');
      bearSlider.addEventListener('input', () => {
        bearDisplay.textContent = parseFloat(bearSlider.value).toFixed(2);
      });

      // DD breaker toggle
      const ddToggle = document.getElementById('enableDDBreaker');
      const ddParams = document.getElementById('ddBreakerParams');
      ddToggle.addEventListener('change', () => {
        ddParams.style.display = ddToggle.checked ? 'block' : 'none';
      });

      // DD threshold sliders
      const ddSliders = [
        { id: 'ddThreshold1', displayId: 'ddThreshold1Value', format: v => Math.round(v * 100) + '%' },
        { id: 'ddThreshold2', displayId: 'ddThreshold2Value', format: v => Math.round(v * 100) + '%' },
      ];
      ddSliders.forEach(({ id, displayId, format }) => {
        const slider = document.getElementById(id);
        const display = document.getElementById(displayId);
        slider.addEventListener('input', () => {
          display.textContent = format(parseFloat(slider.value));
        });
      });

      // Reset button
      document.getElementById('resetRotationParams').addEventListener('click', resetRotationParams);
    }

    function resetRotationParams() {
      // Reset preset
      document.querySelectorAll('.rotation-preset-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.rotation-preset-btn[data-preset="conservative"]').classList.add('active');
      document.getElementById('presetDetail').textContent = PRESET_DESCRIPTIONS.conservative;

      // Reset alpha
      document.getElementById('smoothingAlpha').value = ROTATION_DEFAULTS.smoothingAlpha;
      document.getElementById('smoothingAlphaValue').textContent = ROTATION_DEFAULTS.smoothingAlpha.toFixed(2);

      // Reset asymmetric alpha
      document.getElementById('enableAsymAlpha').checked = ROTATION_DEFAULTS.enableAsymAlpha;
      document.getElementById('asymAlphaParams').style.display = 'none';
      document.getElementById('symmetricAlphaSection').style.opacity = '1';
      document.getElementById('symmetricAlphaSection').style.pointerEvents = 'auto';
      document.getElementById('alphaBull').value = ROTATION_DEFAULTS.alphaBull;
      document.getElementById('alphaBullValue').textContent = ROTATION_DEFAULTS.alphaBull.toFixed(2);
      document.getElementById('alphaBear').value = ROTATION_DEFAULTS.alphaBear;
      document.getElementById('alphaBearValue').textContent = ROTATION_DEFAULTS.alphaBear.toFixed(2);

      // Reset DD breaker
      document.getElementById('enableDDBreaker').checked = ROTATION_DEFAULTS.enableDDBreaker;
      document.getElementById('ddBreakerParams').style.display = 'none';
      document.getElementById('ddThreshold1').value = ROTATION_DEFAULTS.ddThreshold1;
      document.getElementById('ddThreshold1Value').textContent = Math.round(ROTATION_DEFAULTS.ddThreshold1 * 100) + '%';
      document.getElementById('ddThreshold2').value = ROTATION_DEFAULTS.ddThreshold2;
      document.getElementById('ddThreshold2Value').textContent = Math.round(ROTATION_DEFAULTS.ddThreshold2 * 100) + '%';
      document.getElementById('ddRampUp').checked = ROTATION_DEFAULTS.ddRampUp;
    }

    function getRotationParams() {
      const strategy = document.getElementById('strategy').value;
      if (strategy !== 'di_cycle_rotation') return null;

      const activePreset = document.querySelector('.rotation-preset-btn.active');
      const asymEnabled = document.getElementById('enableAsymAlpha').checked;
      const params = {
        preset: activePreset ? activePreset.dataset.preset : 'conservative',
        smoothing_alpha: parseFloat(document.getElementById('smoothingAlpha').value),
        enable_di_modulation: false,
        di_mod_range: 0.10,
        enable_drawdown_breaker: document.getElementById('enableDDBreaker').checked,
        dd_threshold_1: parseFloat(document.getElementById('ddThreshold1').value),
        dd_threshold_2: parseFloat(document.getElementById('ddThreshold2').value),
        dd_multiplier: 0.50,
        dd_ramp_up: document.getElementById('ddRampUp').checked,
      };
      if (asymEnabled) {
        params.smoothing_alpha_bullish = parseFloat(document.getElementById('alphaBull').value);
        params.smoothing_alpha_bearish = parseFloat(document.getElementById('alphaBear').value);
      }
      return params;
    }

    function getContinuousParams() {
      const strategy = document.getElementById('strategy').value;
      if (strategy !== 'di_adaptive_continuous') return null;

      return {
        alloc_floor: parseFloat(document.getElementById('allocFloor').value),
        alloc_ceiling: parseFloat(document.getElementById('allocCeiling').value),
        enable_trend_overlay: document.getElementById('enableTrendOverlay').checked,
        sma_fast: 50,
        sma_slow: 200,
        trend_boost_pct: parseFloat(document.getElementById('trendBoostPct').value),
        enable_risk_adjustment: document.getElementById('enableRiskAdj').checked,
        smoothing_alpha_bull: parseFloat(document.getElementById('contAlphaBull').value),
        smoothing_alpha_bear: parseFloat(document.getElementById('contAlphaBear').value),
        eth_share_bull: parseFloat(document.getElementById('ethShareBull').value),
        eth_share_bear: parseFloat(document.getElementById('ethShareBear').value),
      };
    }

    // Wire continuous params sliders
    (function initContinuousSliders() {
      const sliders = [
        { id: 'allocFloor', display: 'allocFloorValue', fmt: v => Math.round(v * 100) + '%' },
        { id: 'allocCeiling', display: 'allocCeilingValue', fmt: v => Math.round(v * 100) + '%' },
        { id: 'trendBoostPct', display: 'trendBoostValue', fmt: v => '±' + Math.round(v * 100) + '%' },
        { id: 'contAlphaBull', display: 'contAlphaBullValue', fmt: v => v.toFixed(2) },
        { id: 'contAlphaBear', display: 'contAlphaBearValue', fmt: v => v.toFixed(2) },
        { id: 'ethShareBull', display: 'ethShareBullValue', fmt: v => Math.round(v * 100) + '%' },
        { id: 'ethShareBear', display: 'ethShareBearValue', fmt: v => Math.round(v * 100) + '%' },
      ];
      sliders.forEach(s => {
        const el = document.getElementById(s.id);
        const disp = document.getElementById(s.display);
        if (el && disp) {
          el.addEventListener('input', () => { disp.textContent = s.fmt(parseFloat(el.value)); });
        }
      });
      // Toggle collapse
      const toggle = document.getElementById('continuousParamsToggle');
      const body = document.getElementById('continuousParamsBody');
      const icon = document.getElementById('continuousParamsIcon');
      if (toggle && body) {
        toggle.addEventListener('click', () => {
          const isHidden = body.style.display === 'none';
          body.style.display = isHidden ? 'block' : 'none';
          if (icon) icon.textContent = isHidden ? '\u25B2' : '\u25BC';
        });
      }
    })();

    function getReplicaParams() {
      const strategy = document.getElementById('strategy').value;
      if (strategy !== 'di_smartfolio_replica') return null;

      return {
        enable_risk_budget: document.getElementById('enableRiskBudget').checked,
        enable_market_overrides: document.getElementById('enableMarketOverrides').checked,
        enable_exposure_cap: document.getElementById('enableExposureCap').checked,
        enable_governance_penalty: document.getElementById('enableGovernancePenalty').checked,
        enable_direction_penalty: document.getElementById('enableDirectionPenalty').checked,
        exposure_confidence: parseFloat(document.getElementById('exposureConfidence').value),
        max_governance_penalty: parseFloat(document.getElementById('maxGovernancePenalty').value),
        risk_budget_min: parseFloat(document.getElementById('riskBudgetMin').value),
        risk_budget_max: parseFloat(document.getElementById('riskBudgetMax').value),
      };
    }
  </script>
</body>

</html>
