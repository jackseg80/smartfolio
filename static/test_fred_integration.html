<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test FRED API Integration</title>
  <style>
    body { font-family: system-ui; margin: 2rem; background: #f5f5f5; }
    .container { background: white; padding: 2rem; border-radius: 8px; max-width: 800px; }
    .test-result { margin: 1rem 0; padding: 1rem; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    pre { background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    button { background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›ï¸ Test d'intÃ©gration FRED API</h1>
    <p>Ce script teste la nouvelle intÃ©gration FRED pour rÃ©cupÃ©rer l'historique Bitcoin complet.</p>
    
    <button onclick="testGlobalConfig()">1. Test GlobalConfig FRED</button>
    <button onclick="testBackendEndpoint()">2. Test Backend Endpoint</button>
    <button onclick="testFredDirect()">3. Test FRED Direct</button>
    <button onclick="testBitcoinFetch()">4. Test fetchBitcoinHistoricalData</button>
    <button onclick="clearResults()">Effacer les rÃ©sultats</button>
    
    <div id="results"></div>
  </div>

  <script src="global-config.js"></script>
  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    // Test 1: GlobalConfig
    function testGlobalConfig() {
      log('<h3>ğŸ”§ Test GlobalConfig FRED</h3>');
      try {
        const fredKey = window.globalConfig?.get?.('fred_api_key');
        if (fredKey) {
          log(`âœ… ClÃ© FRED configurÃ©e: ${fredKey.substring(0, 8)}...`, 'success');
        } else {
          log('âŒ ClÃ© FRED non configurÃ©e dans GlobalConfig', 'error');
        }
      } catch (e) {
        log(`âŒ Erreur GlobalConfig: ${e.message}`, 'error');
      }
    }

    // Test 2: Backend Endpoint
    async function testBackendEndpoint() {
      log('<h3>ğŸŒ Test Backend /debug/api-keys</h3>');
      try {
        const response = await fetch('/debug/api-keys?debug_token=crypto-rebal-debug-2025-secure');
        if (response.ok) {
          const data = await response.json();
          if (data.fred_api_key && data.fred_api_key !== '...') {
            log(`âœ… Backend retourne FRED API: ${data.fred_api_key}`, 'success');
          } else {
            log('âŒ Backend ne retourne pas la clÃ© FRED', 'error');
          }
          log(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
        } else {
          log(`âŒ Erreur backend: HTTP ${response.status}`, 'error');
        }
      } catch (e) {
        log(`âŒ Erreur backend: ${e.message}`, 'error');
      }
    }

    // Test 3: FRED Direct
    async function testFredDirect() {
      log('<h3>ğŸ›ï¸ Test API FRED Directe</h3>');
      const fredKey = window.globalConfig?.get?.('fred_api_key') || '1fe621fee6b4e86a7ae6fe92538cc003';
      
      try {
        const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${fredKey}&file_type=json&limit=5`;
        const response = await fetch(url, { mode: 'cors' });
        if (response.ok) {
          const data = await response.json();
          if (data.observations && data.observations.length > 0) {
            const count = data.count || data.observations.length;
            const first = data.observations[0];
            const last = data.observations[data.observations.length - 1];
            log(`âœ… FRED API fonctionne: ${count} observations disponibles`, 'success');
            log(`ğŸ“Š PremiÃ¨re observation: ${first.date} = $${first.value}`, 'success');
            log(`ğŸ“Š DerniÃ¨re observation: ${last.date} = $${last.value}`, 'success');
          } else {
            log('âŒ FRED API: Aucune observation dans la rÃ©ponse', 'error');
          }
        } else {
          log(`âŒ FRED API erreur: HTTP ${response.status}`, 'error');
        }
      } catch (e) {
        log(`âŒ Erreur FRED API: ${e.message}`, 'error');
      }
    }

    // Test 4: fetchBitcoinHistoricalData function
    async function testBitcoinFetch() {
      log('<h3>ğŸ“ˆ Test fetchBitcoinHistoricalData()</h3>');
      
      // Simuler la fonction fetchBitcoinHistoricalData
      async function fetchBitcoinHistoricalData() {
        const FRED_API_KEY = window.globalConfig?.get?.('fred_api_key') || '';
        if (FRED_API_KEY) {
          try {
            const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01`;
            const r = await fetch(url, { mode: 'cors' });
            if (!r.ok) throw new Error(`FRED HTTP ${r.status}: ${r.statusText}`);
            const j = await r.json();
            if (Array.isArray(j.observations)) {
              const data = j.observations
                .filter(o => o.value !== '.' && o.value != null)
                .map(o => ({ time: new Date(o.date).getTime(), price: parseFloat(o.value) }))
                .filter(p => Number.isFinite(p.price));
              if (data.length > 0) {
                return { data, source: 'FRED (CBBTCUSD)' };
              }
            }
          } catch (e) {
            console.warn('FRED fetch failed:', e.message);
          }
        }
        return { data: [], source: 'Ã‰chec' };
      }

      try {
        const result = await fetchBitcoinHistoricalData();
        if (result.data.length > 0) {
          const first = result.data[0];
          const last = result.data[result.data.length - 1];
          const firstDate = new Date(first.time).toLocaleDateString();
          const lastDate = new Date(last.time).toLocaleDateString();
          
          log(`âœ… fetchBitcoinHistoricalData() rÃ©ussie!`, 'success');
          log(`ğŸ“Š Source: ${result.source}`, 'success');
          log(`ğŸ“Š Points de donnÃ©es: ${result.data.length}`, 'success');
          log(`ğŸ“Š PÃ©riode: ${firstDate} ($${first.price}) â†’ ${lastDate} ($${last.price})`, 'success');
          
          // VÃ©rifier que nous avons des donnÃ©es depuis 2014
          if (first.time < new Date('2015-01-01').getTime()) {
            log(`âœ… Historique complet: donnÃ©es depuis ${firstDate}`, 'success');
          } else {
            log(`âš ï¸ Historique limitÃ©: donnÃ©es depuis ${firstDate} seulement`, 'warning');
          }
        } else {
          log(`âŒ fetchBitcoinHistoricalData() retourne aucune donnÃ©e`, 'error');
          log(`ğŸ“Š Source: ${result.source}`, 'error');
        }
      } catch (e) {
        log(`âŒ Erreur fetchBitcoinHistoricalData(): ${e.message}`, 'error');
      }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ Test d\'intÃ©gration FRED API initialisÃ©', 'success');
      log('Cliquez sur les boutons pour tester chaque composant.', 'info');
    });
  </script>
</body>
</html>