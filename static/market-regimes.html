<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Regimes - SmartFolio</title>

  <!-- Theme/compat -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/view-modes.css">

  <!-- Shared scripts -->
  <script src="debug-logger.js"></script>
  <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
  <script type="module" src="network-state-manager.js"></script>
  <script src="appearance.js"></script>
  <script src="lazy-loader.js"></script>

  <!-- Chart.js for regime charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // Register Chart.js plugins
    if (window.Chart && window.ChartDataLabels && !window.__di_dl_registered__) {
      window.Chart.register(window.ChartDataLabels);
      window.Chart.defaults.set('plugins.datalabels', { display: false });
      window.__di_dl_registered__ = true;
      console.debug('chartjs-plugin-datalabels registered');
    }
    if (window.Chart && window.ChartAnnotation && !window.__di_annotation_registered__) {
      window.Chart.register(window.ChartAnnotation);
      window.__di_annotation_registered__ = true;
      console.debug('chartjs-plugin-annotation registered');
    }
  </script>

  <!-- Risk Dashboard CSS (reuse existing styles) -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- View Mode System (Feb 2026) -->
  <script type="module" src="components/view-toggle.js"></script>
  <script type="module" src="components/domain-nav.js"></script>

  <!-- Navigation -->
  <script type="module">
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();

    // ===== VIEW MODE MANAGER (Feb 2026) =====
    import { ViewModeManager } from './core/view-mode-manager.js';
    ViewModeManager.init();
    // ========================================

    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Market Regimes modules -->
  <script type="module">
    import { initializeBTCRegimeChart } from './modules/btc-regime-chart.js';
    import { initializeETHRegimeChart } from './modules/eth-regime-chart.js';
    import { initializeStockRegimeHistory, openStockRegimeHistory, closeStockRegimeHistory } from './modules/stock-regime-history.js';

    window.initializeBTCRegimeChart = initializeBTCRegimeChart;
    window.initializeETHRegimeChart = initializeETHRegimeChart;
    window.openStockRegimeHistory = openStockRegimeHistory;
    window.closeStockRegimeHistory = closeStockRegimeHistory;
  </script>

  <!-- AI Chat Styles -->
  <link rel="stylesheet" href="/static/components/ai-chat.css">
</head>

<body>
  <main class="wrap">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-title">
        <h1>Market Regimes</h1>
      </div>
      <div class="header-controls">
        <view-toggle></view-toggle>
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Navigation contextuelle Risk Domain (Feb 2026) -->
    <domain-nav domain="risk"></domain-nav>

    <!-- Main Content -->
    <div class="dashboard-layout">
      <div class="main-content">
        <div class="tab-content">
          <div class="tab-pane active" id="regimes-tab" role="tabpanel">
            <div id="regimes-badge-container" class="badge-container"></div>

            <!-- Section 1: Stock Market Regime -->
            <div class="ml-card" style="margin-bottom: 2rem;">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-icon" aria-hidden="true">üìà</span>
                  Stock Market Regime Detection (HMM)
                </div>
                <div class="card-actions">
                  <button id="refresh-stock-regime" class="btn primary">üîÑ Refresh</button>
                  <button id="view-stock-history" class="btn secondary pro-only">üìä View Probabilities</button>
                </div>
              </div>
              <div class="card-content">
                <div class="status-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                  <div class="status-item">
                    <span class="status-label">Current Regime</span>
                    <span class="status-value" id="stock-regime-name">Loading...</span>
                  </div>
                  <div class="status-item">
                    <span class="status-label">Confidence</span>
                    <span class="status-value" id="stock-regime-confidence">--</span>
                  </div>
                  <div class="status-item">
                    <span class="status-label">Model</span>
                    <span class="status-value">Hidden Markov Model</span>
                  </div>
                  <div class="status-item">
                    <span class="status-label">Thresholds</span>
                    <span class="status-value" style="font-size: 0.85rem;">Bear: DD‚â§-20% (60d)</span>
                  </div>
                </div>

                <div class="pro-only" style="margin-top: 1rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--info);">
                  <strong>‚ÑπÔ∏è Stock Market Detection:</strong>
                  <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                    <li><strong>HMM Model:</strong> Statistical pattern recognition for market regimes</li>
                    <li><strong>States:</strong> Bear Market, Correction, Bull Market, Expansion</li>
                    <li><strong>Thresholds:</strong> Traditional stock market parameters (DD ‚â§ -20%, 60 days)</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Section 2: Bitcoin Regime Detection -->
            <div class="btc-regime-section ml-card" style="margin-bottom: 2rem;" id="btc-regime-section">
              <div class="card-header" style="margin-bottom: 1.5rem;">
                <div class="card-title">
                  <span class="card-icon" aria-hidden="true">‚Çø</span>
                  Bitcoin Regime Detection (Hybrid System)
                  <small style="font-size: 0.75rem; font-weight: 400; color: var(--theme-text-muted); margin-left: 0.5rem;">
                    Rule-Based + HMM Fusion
                  </small>
                </div>
              </div>

              <!-- Current Regime Summary Cards -->
              <div class="btc-regime-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="metric-card">
                  <h5>Current Regime</h5>
                  <div class="metric-value">
                    <span id="btc-current-regime-name" class="regime-chip">Loading...</span>
                  </div>
                  <small>Hybrid Detection</small>
                </div>

                <div class="metric-card">
                  <h5>Confidence</h5>
                  <div class="metric-value" id="btc-current-regime-confidence">--</div>
                  <small>Detection Certainty</small>
                </div>

                <div class="metric-card pro-only">
                  <h5>Detection Method</h5>
                  <div class="metric-value">
                    <span id="btc-current-regime-method" class="detection-method">--</span>
                  </div>
                  <small>Rule-Based or HMM</small>
                </div>

                <div class="metric-card pro-only" id="btc-regime-reason-card" style="display: none;">
                  <h5>Rule Trigger</h5>
                  <div class="metric-value" style="font-size: 0.85rem;" id="btc-current-regime-reason">--</div>
                  <small>Detection Criteria</small>
                </div>
              </div>

              <!-- Timeframe Selector -->
              <div class="btc-regime-timeframe-selector" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center; flex-wrap: wrap;">
                <button data-days="365" class="timeframe-btn active">1 Year</button>
                <button data-days="730" class="timeframe-btn">2 Years</button>
                <button data-days="1825" class="timeframe-btn">5 Years</button>
                <button data-days="3650" class="timeframe-btn">10 Years</button>
              </div>

              <!-- Loading/Error Messages -->
              <div id="btc-regime-loading-message" style="display: none; text-align: center; padding: 2rem; color: var(--theme-text-muted);">
                ‚è≥ Loading Bitcoin regime data...
              </div>
              <div id="btc-regime-error-message" style="display: none; text-align: center; padding: 2rem; color: var(--danger);"></div>

              <!-- Timeline Chart -->
              <div id="btc-regime-chart-container" style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border); margin-bottom: 2rem; min-height: 550px;">
                <canvas id="btc-regime-timeline-chart" style="height: 500px; width: 100%;"></canvas>
              </div>

              <!-- Regime Probabilities Chart -->
              <div class="btc-regime-probabilities-container" style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border);">
                <canvas id="btc-regime-probabilities-chart" style="max-height: 300px;"></canvas>
              </div>

              <!-- Regime Legend -->
              <div class="btc-regime-legend" style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-surface-elevated); border-radius: var(--radius-sm); display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
                <div class="legend-item">
                  <span class="regime-chip bear" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Bear Market</span>
                  <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD ‚â§ -50%, 30d+</small>
                </div>
                <div class="legend-item">
                  <span class="regime-chip correction" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Correction</span>
                  <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD 10-50% or Vol >60%</small>
                </div>
                <div class="legend-item">
                  <span class="regime-chip bull" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Bull Market</span>
                  <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD > -20%, Vol <60%</small>
                </div>
                <div class="legend-item">
                  <span class="regime-chip expansion" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Expansion</span>
                  <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">Recovery +30%/mo</small>
                </div>
              </div>

              <!-- Info Footer -->
              <div style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg); border-left: 3px solid var(--brand-primary); border-radius: var(--radius-sm);">
                <strong>‚ÑπÔ∏è About Hybrid Detection:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                  <li><strong>Rule-Based (‚â•85% confidence):</strong> Clear cases using drawdown, duration, and trend thresholds</li>
                  <li><strong>HMM (nuanced):</strong> Statistical model for corrections and consolidations</li>
                  <li><strong>Crypto-Adjusted:</strong> Thresholds adapted for Bitcoin volatility (3x higher than stocks)</li>
                  <li><strong>Events:</strong> Mt.Gox, FTX, COVID crashes annotated for context</li>
                </ul>
              </div>
            </div>

            <!-- Section 2.5: Ethereum Regime Detection -->
            <div class="ml-card" style="margin-bottom: 2rem;" id="eth-regime-section">
              <div class="card-header" style="margin-bottom: 1.5rem;">
                <div class="card-title">
                  <span class="card-icon" aria-hidden="true">‚ü†</span>
                  Ethereum Regime Detection (Hybrid System)
                  <small style="font-size: 0.75rem; font-weight: 400; color: var(--theme-text-muted); margin-left: 0.5rem;">
                    Rule-Based + HMM Fusion
                  </small>
                </div>
              </div>

              <!-- Current Regime Summary Cards -->
              <div class="eth-regime-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="metric-card">
                  <h5>Current Regime</h5>
                  <div class="metric-value">
                    <span id="eth-current-regime-name" class="regime-chip">Loading...</span>
                  </div>
                  <small>Hybrid Detection</small>
                </div>

                <div class="metric-card">
                  <h5>Confidence</h5>
                  <div class="metric-value" id="eth-current-regime-confidence">--</div>
                  <small>Detection Certainty</small>
                </div>

                <div class="metric-card">
                  <h5>Detection Method</h5>
                  <div class="metric-value">
                    <span id="eth-current-regime-method" class="detection-method">--</span>
                  </div>
                  <small>Rule-Based or HMM</small>
                </div>

                <div class="metric-card" id="eth-regime-reason-card" style="display: none;">
                  <h5>Rule Trigger</h5>
                  <div class="metric-value" style="font-size: 0.85rem;" id="eth-current-regime-reason">--</div>
                  <small>Detection Criteria</small>
                </div>
              </div>

              <!-- Historical Timeline -->
              <div style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border); margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h4 style="margin: 0;">Historical Regime Timeline</h4>
                  <div class="eth-regime-timeframe-selector" style="display: flex; gap: 0.5rem;">
                    <button class="timeframe-btn active" data-days="365">1Y</button>
                    <button class="timeframe-btn" data-days="730">2Y</button>
                    <button class="timeframe-btn" data-days="1825">5Y</button>
                  </div>
                </div>
                <div id="eth-regime-chart-container" style="position: relative; height: 500px; width: 100%;">
                  <canvas id="eth-regime-timeline-chart" style="position: absolute; top: 0; left: 0; height: 100%; width: 100%;"></canvas>
                </div>
                <div id="eth-regime-error-message" class="error-state" style="display: none;"></div>
              </div>

              <!-- Info Note -->
              <div style="margin-bottom: 1rem; padding: 1rem; background: var(--theme-bg); border-left: 3px solid var(--success); border-radius: var(--radius-sm);">
                <strong>‚ÑπÔ∏è About Ethereum Detection:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                  <li><strong>Same Hybrid System:</strong> Uses identical rule-based + HMM fusion as Bitcoin</li>
                  <li><strong>Crypto-Adjusted Thresholds:</strong> Bear ‚â§ -50% (30d+), Bull > -20% (vol <60%), Expansion +30%/mo</li>
                  <li><strong>Timeline Chart:</strong> Interactive regime visualization with price history</li>
                </ul>
              </div>
            </div>

            <!-- Section 3: Cross-Asset Comparison -->
            <div class="ml-card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-icon" aria-hidden="true">üìä</span>
                  Cross-Asset Regime Comparison
                </div>
              </div>
              <div class="card-content">
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: var(--theme-surface-elevated); text-align: left;">
                        <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Asset</th>
                        <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Current Regime</th>
                        <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Confidence</th>
                        <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Detection Method</th>
                        <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Bear Threshold</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">üìà Stock Market</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                          <span id="comparison-stock-regime" class="regime-chip">--</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);" id="comparison-stock-confidence">--</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">HMM Only</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§ -20%, 60d</td>
                      </tr>
                      <tr>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">‚Çø Bitcoin</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                          <span id="comparison-btc-regime" class="regime-chip">--</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);" id="comparison-btc-confidence">--</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);" id="comparison-btc-method">--</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§ -50%, 30d</td>
                      </tr>
                      <tr>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">‚ü† Ethereum</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                          <span id="comparison-eth-regime" class="regime-chip">--</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);" id="comparison-eth-confidence">--</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);" id="comparison-eth-method">--</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§ -50%, 30d</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                  <strong>üìå Key Differences:</strong>
                  <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                    <li><strong>Stock Market:</strong> Pure HMM statistical model, traditional thresholds</li>
                    <li><strong>Bitcoin & Ethereum:</strong> Hybrid Rule-Based + HMM, crypto-adjusted thresholds (3x higher volatility)</li>
                    <li><strong>Why Different?</strong> Crypto volatility (60-100% annual) vs Stocks (15-25%) requires distinct detection logic</li>
                  </ul>
                </div>
              </div>
              <div class="card-actions">
                <button id="refresh-comparison" class="btn primary">üîÑ Refresh Comparison</button>
                <button id="export-comparison" class="btn secondary">üíæ Export Data</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <!-- Market Regimes JavaScript -->
  <script>
    // Helper to fetch user config
    async function fetchUserConfig() {
      if (window.globalConfig && typeof window.globalConfig.get === 'function') {
        return {
          api_base_url: window.globalConfig.get('api_base_url') || window.location.origin
        };
      }
      return { api_base_url: window.location.origin };
    }

    // Load Stock Market regime data
    async function loadStockRegimeData() {
      try {
        const config = await fetchUserConfig();
        const endpoint = `${config.api_base_url}/api/ml/bourse/regime?benchmark=SPY&lookback_days=365`;
        debugLogger.debug('Fetching stock regime from:', endpoint);

        const response = await fetch(endpoint);
        debugLogger.debug('Stock regime response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          debugLogger.debug('Stock regime data received:', data);

          if (data.current_regime && data.confidence !== undefined) {
            const regimeName = data.current_regime;
            const confidencePercent = (data.confidence * 100).toFixed(1);

            const regimeEl = document.getElementById('stock-regime-name');
            regimeEl.textContent = regimeName;
            regimeEl.className = 'regime-chip ' + regimeName.toLowerCase().replace(' ', '-').replace('_', '-');

            const confidenceEl = document.getElementById('stock-regime-confidence');
            confidenceEl.textContent = confidencePercent + '%';
            const conf = data.confidence;
            confidenceEl.style.color = conf >= 0.8 ? 'var(--success)' : conf >= 0.6 ? 'var(--warning)' : 'var(--danger)';

            debugLogger.debug('Stock regime loaded:', regimeName, confidencePercent + '%');
          } else {
            debugLogger.warn('No current_regime in response');
            document.getElementById('stock-regime-name').textContent = 'N/A';
            document.getElementById('stock-regime-confidence').textContent = 'N/A';
          }
        } else {
          const errorText = await response.text();
          debugLogger.error('Stock regime API error:', response.status, errorText);
          document.getElementById('stock-regime-name').textContent = 'API Error';
          document.getElementById('stock-regime-confidence').textContent = '--';
        }
      } catch (error) {
        debugLogger.error('Failed to load stock regime:', error);
        document.getElementById('stock-regime-name').textContent = 'Error';
        document.getElementById('stock-regime-confidence').textContent = '--';
      }
    }

    // Load Ethereum regime data
    async function loadEthereumRegimeData() {
      try {
        const config = await fetchUserConfig();
        const endpoint = `${config.api_base_url}/api/ml/crypto/regime?symbol=ETH&lookback_days=365`;
        debugLogger.debug('Fetching ETH regime from:', endpoint);

        const response = await fetch(endpoint);
        debugLogger.debug('ETH regime response status:', response.status);

        if (response.ok) {
          const rawData = await response.json();
          debugLogger.debug('ETH regime data received:', rawData);

          const data = rawData.data || rawData;

          if (data.current_regime && data.confidence !== undefined) {
            const regimeName = data.current_regime;
            const confidencePercent = (data.confidence * 100).toFixed(1);
            const detectionMethod = data.detection_method;
            const ruleReason = data.rule_reason;

            const regimeChip = document.getElementById('eth-current-regime-name');
            regimeChip.textContent = regimeName;
            regimeChip.className = 'regime-chip ' + regimeName.toLowerCase().replace(' ', '-');

            document.getElementById('eth-current-regime-confidence').textContent = confidencePercent + '%';

            const methodBadge = document.getElementById('eth-current-regime-method');
            methodBadge.textContent = detectionMethod === 'rule_based' ? 'Rule-Based' : 'HMM';
            methodBadge.className = 'detection-method ' + detectionMethod;

            const reasonCard = document.getElementById('eth-regime-reason-card');
            if (ruleReason) {
              document.getElementById('eth-current-regime-reason').textContent = ruleReason;
              reasonCard.style.display = 'block';
            } else {
              reasonCard.style.display = 'none';
            }

            debugLogger.debug('ETH regime loaded:', regimeName, confidencePercent + '%', detectionMethod);
          } else {
            debugLogger.warn('No current_regime in ETH response');
            document.getElementById('eth-current-regime-name').textContent = 'N/A';
            document.getElementById('eth-current-regime-confidence').textContent = 'N/A';
          }
        } else {
          const errorText = await response.text();
          debugLogger.error('ETH regime API error:', response.status, errorText);
          document.getElementById('eth-current-regime-name').textContent = 'API Error';
          document.getElementById('eth-current-regime-confidence').textContent = '--';
        }
      } catch (error) {
        debugLogger.error('Failed to load ETH regime:', error);
        document.getElementById('eth-current-regime-name').textContent = 'Error';
        document.getElementById('eth-current-regime-confidence').textContent = '--';
      }
    }

    // Store cross-asset comparison data for export
    let crossAssetComparisonData = null;

    // Load cross-asset comparison data
    async function loadCrossAssetComparison() {
      try {
        const config = await fetchUserConfig();
        debugLogger.debug('Fetching cross-asset comparison data...');

        const btcResponse = await fetch(`${config.api_base_url}/api/ml/crypto/regime?symbol=BTC&lookback_days=365`);
        let btcData = btcResponse.ok ? await btcResponse.json() : null;

        const stockResponse = await fetch(`${config.api_base_url}/api/ml/bourse/regime?benchmark=SPY&lookback_days=365`);
        let stockData = stockResponse.ok ? await stockResponse.json() : null;

        const ethResponse = await fetch(`${config.api_base_url}/api/ml/crypto/regime?symbol=ETH&lookback_days=365`);
        let ethData = ethResponse.ok ? await ethResponse.json() : null;

        // Store data for export
        crossAssetComparisonData = {
          timestamp: new Date().toISOString(),
          stock: stockData,
          btc: btcData?.data || btcData,
          eth: ethData?.data || ethData
        };

        // Helper to get regime CSS class
        const getRegimeClass = (regime) => regime ? regime.toLowerCase().replace(' ', '-').replace('_', '-') : 'unknown';

        if (stockData && stockData.current_regime) {
          const stockEl = document.getElementById('comparison-stock-regime');
          stockEl.textContent = stockData.current_regime;
          stockEl.className = 'regime-chip ' + getRegimeClass(stockData.current_regime);
          document.getElementById('comparison-stock-confidence').textContent = (stockData.confidence * 100).toFixed(1) + '%';
        }

        if (btcData) {
          const btc = btcData.data || btcData;
          if (btc.current_regime) {
            const btcEl = document.getElementById('comparison-btc-regime');
            btcEl.textContent = btc.current_regime;
            btcEl.className = 'regime-chip ' + getRegimeClass(btc.current_regime);
            document.getElementById('comparison-btc-confidence').textContent = (btc.confidence * 100).toFixed(1) + '%';
            document.getElementById('comparison-btc-method').textContent = btc.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM';
          }
        }

        if (ethData) {
          const eth = ethData.data || ethData;
          if (eth.current_regime) {
            const ethEl = document.getElementById('comparison-eth-regime');
            ethEl.textContent = eth.current_regime;
            ethEl.className = 'regime-chip ' + getRegimeClass(eth.current_regime);
            document.getElementById('comparison-eth-confidence').textContent = (eth.confidence * 100).toFixed(1) + '%';
            document.getElementById('comparison-eth-method').textContent = eth.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM';
          }
        }

        debugLogger.debug('Cross-asset comparison loaded');
      } catch (error) {
        debugLogger.error('Failed to load cross-asset comparison:', error);
      }
    }

    // Export cross-asset comparison data
    function exportCrossAssetComparison(format = 'json') {
      if (!crossAssetComparisonData) {
        if (window.toast) window.toast.showError('No data available. Please refresh first.');
        return;
      }

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      let blob, filename;

      if (format === 'json') {
        const jsonData = JSON.stringify(crossAssetComparisonData, null, 2);
        blob = new Blob([jsonData], { type: 'application/json' });
        filename = `cross-asset-comparison_${timestamp}.json`;
      } else if (format === 'csv') {
        const csvRows = [];
        csvRows.push('Asset,Regime,Confidence (%),Detection Method,Drawdown (%),Volatility (%),Trend 30d (%)');

        const formatRow = (asset, data) => {
          if (!data) return null;
          return [
            asset,
            data.current_regime || 'N/A',
            ((data.confidence || 0) * 100).toFixed(1),
            data.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM',
            ((data.drawdown_from_peak || 0) * 100).toFixed(1),
            ((data.market_volatility || 0) * 100).toFixed(1),
            ((data.trend_30d || 0) * 100).toFixed(1)
          ].join(',');
        };

        const stockRow = formatRow('S&P 500 (SPY)', crossAssetComparisonData.stock);
        const btcRow = formatRow('Bitcoin (BTC)', crossAssetComparisonData.btc);
        const ethRow = formatRow('Ethereum (ETH)', crossAssetComparisonData.eth);

        if (stockRow) csvRows.push(stockRow);
        if (btcRow) csvRows.push(btcRow);
        if (ethRow) csvRows.push(ethRow);

        const csvContent = csvRows.join('\n');
        blob = new Blob([csvContent], { type: 'text/csv' });
        filename = `cross-asset-comparison_${timestamp}.csv`;
      }

      // Trigger download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      if (window.toast) window.toast.showSuccess(`Exported as ${filename}`);
    }

    // Setup button event listeners
    function setupRegimesPageButtons() {
      document.getElementById('refresh-stock-regime')?.addEventListener('click', async () => {
        await loadStockRegimeData();
        if (window.toast) window.toast.showSuccess('Stock regime data refreshed');
      });

      document.getElementById('view-stock-history')?.addEventListener('click', () => {
        if (window.openStockRegimeHistory) {
          window.openStockRegimeHistory();
        } else {
          if (window.toast) window.toast.showError('Stock regime history module not loaded');
        }
      });

      document.getElementById('refresh-comparison')?.addEventListener('click', async () => {
        await loadCrossAssetComparison();
        if (window.toast) window.toast.showSuccess('Comparison data refreshed');
      });

      document.getElementById('export-comparison')?.addEventListener('click', () => {
        const format = confirm('Click OK for JSON, Cancel for CSV') ? 'json' : 'csv';
        exportCrossAssetComparison(format);
      });

      document.getElementById('refresh-btn')?.addEventListener('click', async () => {
        await initializeAllRegimes();
        if (window.toast) window.toast.showSuccess('All regime data refreshed');
      });
    }

    // Initialize all regimes on page load
    async function initializeAllRegimes() {
      debugLogger.debug('Initializing Market Regimes page...');

      // Update timestamp
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

      try {
        // Initialize BTC regime chart
        if (window.initializeBTCRegimeChart) {
          await window.initializeBTCRegimeChart('btc-regime-section');
        }
        // Initialize ETH regime chart
        if (window.initializeETHRegimeChart) {
          await window.initializeETHRegimeChart();
        }
        // Load other data
        await loadStockRegimeData();
        await loadEthereumRegimeData();
        await loadCrossAssetComparison();
        setupRegimesPageButtons();
        debugLogger.debug('Market Regimes page fully initialized');
      } catch (error) {
        debugLogger.error('Error initializing Market Regimes page:', error);
      }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', initializeAllRegimes);
  </script>

  <!-- AI Chat Components -->
  <script type="module">
    import { initAIChat } from '/static/components/ai-chat-init.js';
    initAIChat('market-regimes');
  </script>
</body>

</html>
