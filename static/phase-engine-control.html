<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® Phase Engine Control Panel</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>ğŸ® Phase Engine Control Panel</h1>
      <p>Activation et contrÃ´le du Phase Engine risky-only</p>
    </div>
  </header>

  <main class="container">

    <!-- Current Status -->
    <div class="card">
      <h2>ğŸ“Š Statut Actuel</h2>
      <div id="current-status" class="alert"></div>
    </div>

    <!-- Mode Control -->
    <div class="card">
      <h2>ğŸ›ï¸ ContrÃ´le du Mode</h2>
      <p>SÃ©lectionnez le mode d'opÃ©ration du Phase Engine :</p>

      <div class="button-group" style="display: flex; gap: 1rem; margin: 1rem 0;">
        <button id="mode-off" class="btn btn-secondary">ğŸ”´ OFF</button>
        <button id="mode-shadow" class="btn btn-warning">ğŸ§ª SHADOW</button>
        <button id="mode-apply" class="btn btn-success">âœ… APPLY</button>
      </div>

      <div class="mode-descriptions" style="margin-top: 1rem;">
        <div style="padding: 0.75rem; margin: 0.5rem 0; border-left: 3px solid var(--danger); background: var(--theme-surface);">
          <strong>ğŸ”´ OFF:</strong> Phase Engine dÃ©sactivÃ© - aucun tilt calculÃ© ni appliquÃ©
        </div>
        <div style="padding: 0.75rem; margin: 0.5rem 0; border-left: 3px solid var(--warning); background: var(--theme-surface);">
          <strong>ğŸ§ª SHADOW:</strong> Tilts calculÃ©s et loggÃ©s mais PAS appliquÃ©s aux objectifs finaux
        </div>
        <div style="padding: 0.75rem; margin: 0.5rem 0; border-left: 3px solid var(--success); background: var(--theme-surface);">
          <strong>âœ… APPLY:</strong> Tilts calculÃ©s ET appliquÃ©s aux objectifs thÃ©oriques
        </div>
      </div>
    </div>

    <!-- Phase Control -->
    <div class="card">
      <h2>ğŸ­ ContrÃ´le des Phases</h2>
      <div class="button-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
        <button class="btn btn-secondary" onclick="forcePhase('neutral')">ğŸŸ¡ Neutral</button>
        <button class="btn btn-secondary" onclick="forcePhase('risk_off')">ğŸ”´ Risk Off</button>
        <button class="btn btn-primary" onclick="forcePhase('eth_expansion')">ğŸŸ¢ ETH Expansion</button>
        <button class="btn btn-primary" onclick="forcePhase('largecap_altseason')">ğŸ”µ Large-cap Altseason</button>
        <button class="btn btn-primary" onclick="forcePhase('full_altseason')">ğŸŸ£ Full Altseason</button>
        <button class="btn btn-info" onclick="clearForcedPhase()">ğŸ”„ Auto Detection</button>
      </div>
    </div>

    <!-- Test Results -->
    <div class="card">
      <h2>ğŸ§ª Test des Tilts</h2>
      <button id="test-tilts" class="btn btn-primary">ğŸ”„ Tester avec Mode Actuel</button>
      <div id="test-results" style="margin-top: 1rem;"></div>
    </div>

    <!-- Quick Links -->
    <div class="card">
      <h2>ğŸ”— Liens Rapides</h2>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="test-theoretical-targets.html" class="btn btn-outline">ğŸ¯ Test Objectifs</a>
        <a href="debug-phase-tilts-flow.html" class="btn btn-outline">ğŸ” Debug Flow</a>
        <a href="analytics-unified.html" class="btn btn-outline">ğŸ“Š Analytics</a>
        <a href="test-phase-engine.html" class="btn btn-outline">ğŸ§ª Test Suite</a>
      </div>
    </div>

  </main>

  <script type="module">

    // Update status display
    function updateStatus() {
      const mode = localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow';
      const forcedPhase = localStorage.getItem('forced_phase');
      const statusEl = document.getElementById('current-status');

      let statusClass = 'alert-info';
      let statusIcon = 'ğŸ§ª';

      if (mode === 'off') {
        statusClass = 'alert-secondary';
        statusIcon = 'ğŸ”´';
      } else if (mode === 'apply') {
        statusClass = 'alert-success';
        statusIcon = 'âœ…';
      }

      statusEl.className = 'alert ' + statusClass;
      statusEl.innerHTML = `
        ${statusIcon} <strong>Mode actuel: ${mode.toUpperCase()}</strong><br>
        Phase forcÃ©e: ${forcedPhase || 'Auto-dÃ©tection'}<br>
        DerniÃ¨re MAJ: ${new Date().toLocaleTimeString()}
      `;

      // Update button states
      document.querySelectorAll('[id^="mode-"]').forEach(btn => {
        btn.classList.remove('btn-active');
      });
      document.getElementById('mode-' + mode)?.classList.add('btn-active');
    }

    // Mode control
    document.getElementById('mode-off').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'off');
      debugLogger.debug('ğŸ”´ Phase Engine mode set to: OFF');
      updateStatus();
    });

    document.getElementById('mode-shadow').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'shadow');
      debugLogger.debug('ğŸ§ª Phase Engine mode set to: SHADOW');
      updateStatus();
    });

    document.getElementById('mode-apply').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'apply');
      debugLogger.debug('âœ… Phase Engine mode set to: APPLY');
      updateStatus();
    });

    // Phase control functions
    window.forcePhase = function(phase) {
      localStorage.setItem('forced_phase', phase);
      localStorage.removeItem('detected_phase_cache');
      debugLogger.debug('ğŸ­ Phase forcÃ©e:', phase);
      updateStatus();
    };

    window.clearForcedPhase = function() {
      localStorage.removeItem('forced_phase');
      localStorage.removeItem('detected_phase_cache');
      debugLogger.debug('ğŸ”„ Auto-dÃ©tection des phases rÃ©activÃ©e');
      updateStatus();
    };

    // Test tilts with current mode
    document.getElementById('test-tilts').addEventListener('click', async () => {
      const results = document.getElementById('test-results');
      const mode = localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow';
      const forcedPhase = localStorage.getItem('forced_phase') || 'auto';

      results.innerHTML = `<div class="loading">ğŸ§ª Test des tilts en mode ${mode.toUpperCase()}...</div>`;

      try {
        // Force a specific phase for testing
        if (forcedPhase === 'auto') {
          localStorage.setItem('forced_phase', 'eth_expansion');
          localStorage.removeItem('detected_phase_cache');
        }

        // Get unified state
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedStateBefore = await getUnifiedState();

        // Wait a bit for changes to propagate
        await new Promise(resolve => setTimeout(resolve, 200));

        const unifiedStateAfter = await getUnifiedState();

        // Check what happened
        const phaseData = unifiedStateAfter.phase;
        const targets = unifiedStateAfter.targets_by_group;

        let resultHtml = `
          <div class="success">âœ… Test complÃ©tÃ© en mode ${mode.toUpperCase()}</div>
          <h3>RÃ©sultats:</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
            <div style="padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
              <h4>Configuration</h4>
              <ul style="margin: 0; padding-left: 1.5rem;">
                <li><strong>Mode:</strong> ${mode.toUpperCase()}</li>
                <li><strong>Phase dÃ©tectÃ©e:</strong> ${unifiedStateAfter.cycle?.phase?.phase || 'unknown'}</li>
                <li><strong>Phase forcÃ©e:</strong> ${localStorage.getItem('forced_phase') || 'none'}</li>
              </ul>
            </div>
            <div style="padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
              <h4>Phase Engine Status</h4>
              <ul style="margin: 0; padding-left: 1.5rem;">
                <li><strong>Tilts appliquÃ©s:</strong> ${phaseData?.tiltsApplied ? 'âœ… Oui' : 'âŒ Non'}</li>
                <li><strong>Stables prÃ©servÃ©es:</strong> ${phaseData?.stablesPreserved ? 'âœ… Oui' : 'âŒ Non'}</li>
                <li><strong>Raison:</strong> ${phaseData?.reason || 'N/A'}</li>
              </ul>
            </div>
          </div>
        `;

        if (targets) {
          resultHtml += `
            <h4>Allocations Actuelles:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
              ${Object.entries(targets)
                .filter(([, pct]) => (pct || 0) > 0.1)
                .sort(([,a], [,b]) => (b || 0) - (a || 0))
                .map(([asset, pct]) => {
                  const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                  return `
                    <div style="background: var(--theme-surface); padding: 0.5rem; border-radius: 4px; border-left: 3px solid ${color};">
                      <div style="font-size: 0.8em; color: var(--theme-text-muted);">${asset}</div>
                      <div style="font-weight: 700; color: ${color};">${(pct || 0).toFixed(1)}%</div>
                    </div>
                  `;
                }).join('')}
            </div>
          `;
        }

        // Mode-specific guidance
        if (mode === 'shadow') {
          resultHtml += `
            <div class="alert alert-warning" style="margin-top: 1rem;">
              <strong>â„¹ï¸ Mode Shadow:</strong> Les tilts sont calculÃ©s mais PAS appliquÃ©s aux objectifs finaux.
              Pour voir les tilts rÃ©ellement appliquÃ©s, passez en mode <strong>APPLY</strong>.
            </div>
          `;
        } else if (mode === 'apply') {
          resultHtml += `
            <div class="alert alert-success" style="margin-top: 1rem;">
              <strong>âœ… Mode Apply:</strong> Les tilts sont calculÃ©s ET appliquÃ©s aux objectifs thÃ©oriques.
              Les pourcentages ci-dessus reflÃ¨tent les tilts de phase.
            </div>
          `;
        } else {
          resultHtml += `
            <div class="alert alert-secondary" style="margin-top: 1rem;">
              <strong>ğŸ”´ Mode Off:</strong> Le Phase Engine est dÃ©sactivÃ© - aucun tilt n'est calculÃ©.
            </div>
          `;
        }

        results.innerHTML = resultHtml;

        // Restore original phase setting
        if (forcedPhase === 'auto') {
          localStorage.removeItem('forced_phase');
          localStorage.removeItem('detected_phase_cache');
        }

      } catch (error) {
        debugLogger.error('âŒ Test failed:', error);
        results.innerHTML = `<div class="error">âŒ Test Ã©chouÃ©: ${error.message}</div>`;
      }
    });

    // Initialize
    updateStatus();

    // Auto-refresh status every 5 seconds
    setInterval(updateStatus, 5000);

  </script>

  <style>
    .btn-active {
      background: var(--primary) !important;
      color: white !important;
      border-color: var(--primary) !important;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--theme-border);
      color: var(--theme-text);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      display: inline-block;
      transition: all 0.2s;
    }

    .btn-outline:hover {
      background: var(--theme-surface);
      border-color: var(--primary);
      color: var(--primary);
      text-decoration: none;
    }
  </style>

</body>
</html>