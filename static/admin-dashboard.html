<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SmartFolio</title>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <link rel="stylesheet" href="css/admin-dashboard.css">

    <!-- Global Config & Theme Support -->
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
</head>
<body>
    <!-- Navigation will be injected here -->
    <div id="navigation-container"></div>

    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>
                <span>üîß</span>
                Admin Dashboard
            </h1>
            <p class="subtitle">System management - User management, Logs, Cache, ML models, API keys</p>
        </div>

        <!-- System Stats Overview -->
        <div class="stats-grid" id="system-stats">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="stat-value">-</div>
                <div class="stat-label">Registered users</div>
            </div>
            <div class="stat-card">
                <h3>Admin Users</h3>
                <div class="stat-value">-</div>
                <div class="stat-label">With admin role</div>
            </div>
            <div class="stat-card">
                <h3>Cache Types</h3>
                <div class="stat-value">4</div>
                <div class="stat-label">Active caches</div>
            </div>
            <div class="stat-card">
                <h3>ML Models</h3>
                <div class="stat-value">-</div>
                <div class="stat-label">Deployed models</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="users">üë• User Management</button>
            <button class="tab-btn" data-tab="logs">üìù Logs Viewer</button>
            <button class="tab-btn" data-tab="cache">‚ö° Cache Management</button>
            <button class="tab-btn" data-tab="ml">ü§ñ ML Models</button>
            <button class="tab-btn" data-tab="apikeys">üîë API Keys</button>
        </div>

        <!-- Tab: Overview -->
        <div class="tab-content active" id="tab-overview">
            <h2>System Overview</h2>

            <!-- Quick Actions (accessible √† tous) -->
            <div style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
                <button class="btn btn-primary" onclick="showChangeMyPasswordModal()" style="margin-right: 0.5rem;">
                    üîê Change My Password
                </button>
            </div>

            <div class="placeholder">
                <h3>Welcome to the dashboard</h3>
                <p>Select a module from the tabs above to manage the system.</p>
            </div>
        </div>

        <!-- Tab: User Management -->
        <div class="tab-content" id="tab-users">
            <h2>User Management</h2>
            <div class="loading">Loading users</div>
        </div>

        <!-- Tab: Logs Viewer -->
        <div class="tab-content" id="tab-logs">
            <h2>Logs Viewer</h2>
            <div class="loading">Loading logs</div>
        </div>

        <!-- Tab: Cache Management -->
        <div class="tab-content" id="tab-cache">
            <h2>Cache Management</h2>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="cache-total-caches">-</div>
                    <div class="stat-label">Total Caches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cache-total-entries">-</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cache-valid-entries">-</div>
                    <div class="stat-label">Valid Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cache-expired-entries">-</div>
                    <div class="stat-label">Expired Entries</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-bar">
                <button class="btn btn-primary" onclick="refreshCacheStats()">üîÑ Refresh Stats</button>
                <button class="btn btn-secondary" onclick="clearExpiredEntries()">üßπ Clear Expired</button>
                <button class="btn btn-danger" onclick="clearAllCaches()">üóëÔ∏è Clear All Caches</button>
            </div>

            <!-- Caches Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cache Name</th>
                            <th>Total Entries</th>
                            <th>Valid Entries</th>
                            <th>Expired Entries</th>
                            <th>TTL (seconds)</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cache-table-body">
                        <tr>
                            <td colspan="7" class="loading">Loading cache stats...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Success/Error Messages -->
            <div id="cache-messages" class="messages-container"></div>
        </div>

        <!-- Tab: ML Models -->
        <div class="tab-content" id="tab-ml">
            <h2>ML Models</h2>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="ml-total-models">-</div>
                    <div class="stat-label">Total Models</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ml-deployed-models">-</div>
                    <div class="stat-label">Deployed Models</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ml-active-jobs">-</div>
                    <div class="stat-label">Active Training Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ml-completed-jobs">-</div>
                    <div class="stat-label">Completed Jobs</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-bar">
                <button class="btn btn-primary" onclick="refreshMLModels()">üîÑ Refresh Models</button>
                <button class="btn btn-secondary" onclick="loadTrainingJobs()">üìã View Training Jobs</button>
            </div>

            <!-- Models Table -->
            <div class="table-container">
                <h3>Available ML Models</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Model Name</th>
                            <th>Type</th>
                            <th>Version</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Training Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ml-models-table-body">
                        <tr>
                            <td colspan="7" class="loading">Loading ML models...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Training Jobs Table -->
            <div class="table-container" id="ml-jobs-container" style="display: none;">
                <h3>Training Jobs</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Model Name</th>
                            <th>Status</th>
                            <th>Triggered By</th>
                            <th>Created At</th>
                            <th>Completed At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ml-jobs-table-body">
                        <tr>
                            <td colspan="7" class="loading">Loading jobs...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-secondary" onclick="hideTrainingJobs()" style="margin-top: 1rem;">Close Jobs View</button>
            </div>

            <!-- Success/Error Messages -->
            <div id="ml-messages" class="messages-container"></div>
        </div>

        <!-- Tab: API Keys -->
        <div class="tab-content" id="tab-apikeys">
            <h2>API Keys Management</h2>
            <div class="placeholder">
                <h3>üîë API Keys</h3>
                <p>Phase 4 - To implement</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Create New User</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUserId">User ID *</label>
                        <input type="text" id="newUserId" required pattern="[a-zA-Z0-9_-]+" maxlength="50">
                        <div class="help-text">Alphanumeric characters, underscores and hyphens only</div>
                    </div>
                    <div class="form-group">
                        <label for="newUserLabel">Display Label *</label>
                        <input type="text" id="newUserLabel" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Password *</label>
                        <input type="password" id="newUserPassword" required minlength="8" autocomplete="new-password">
                        <div class="help-text">Minimum 8 characters</div>
                    </div>
                    <div class="form-group">
                        <label for="newUserPasswordConfirm">Confirm Password *</label>
                        <input type="password" id="newUserPasswordConfirm" required minlength="8" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Roles</label>
                        <div class="checkbox-group" id="newUserRoles">
                            <label><input type="checkbox" value="admin"> Admin</label>
                            <label><input type="checkbox" value="ml_admin"> ML Admin</label>
                            <label><input type="checkbox" value="governance_admin"> Governance Admin</label>
                            <label><input type="checkbox" value="viewer" checked> Viewer</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateUser()">Create</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit User</h3>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label for="editUserLabel">Display Label *</label>
                        <input type="text" id="editUserLabel" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Roles</label>
                        <div class="checkbox-group" id="editUserRoles">
                            <label><input type="checkbox" value="admin"> Admin</label>
                            <label><input type="checkbox" value="ml_admin"> ML Admin</label>
                            <label><input type="checkbox" value="governance_admin"> Governance Admin</label>
                            <label><input type="checkbox" value="viewer"> Viewer</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editUserStatus">Status</label>
                        <select id="editUserStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitEditUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üóëÔ∏è Delete User</h3>
                <button class="modal-close" onclick="closeModal('deleteUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
                <p><strong id="deleteUserIdText"></strong></p>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Delete Type:</label>

                    <label style="display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); border: 2px solid var(--theme-border); cursor: pointer;">
                        <input type="radio" name="deleteType" value="soft" checked style="margin-top: 0.25rem;">
                        <div>
                            <div style="font-weight: 500;">Soft Delete (Recommended)</div>
                            <div style="font-size: 0.85em; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                Mark as inactive and rename data folder. Can be recovered manually if needed.
                            </div>
                        </div>
                    </label>

                    <label style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); border: 2px solid var(--brand-danger); cursor: pointer;">
                        <input type="radio" name="deleteType" value="hard" style="margin-top: 0.25rem;">
                        <div>
                            <div style="font-weight: 500; color: var(--brand-danger);">‚ö†Ô∏è Hard Delete (Permanent)</div>
                            <div style="font-size: 0.85em; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                Remove completely from config and delete data folder. <strong>Cannot be undone!</strong> User ID can be recreated later.
                            </div>
                        </div>
                    </label>
                </div>

                <input type="hidden" id="deleteUserId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteUserModal')">Cancel</button>
                <button class="btn btn-danger" onclick="submitDeleteUser()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Change My Password Modal (accessible √† tous) -->
    <div id="changeMyPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Change My Password</h3>
                <button class="modal-close" onclick="closeModal('changeMyPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changeMyPasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password *</label>
                        <input type="password" id="currentPassword" required autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password *</label>
                        <input type="password" id="newPassword" required minlength="8" autocomplete="new-password">
                        <div class="help-text">Minimum 8 characters</div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password *</label>
                        <input type="password" id="confirmPassword" required minlength="8" autocomplete="new-password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('changeMyPasswordModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitChangeMyPassword()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Reset User Password Modal (admin uniquement) -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîë Reset User Password</h3>
                <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Reset password for user: <strong id="resetPasswordUserIdText"></strong></p>
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetPasswordUserId">
                    <div class="form-group">
                        <label for="resetNewPassword">New Password *</label>
                        <input type="password" id="resetNewPassword" required minlength="8" autocomplete="new-password">
                        <div class="help-text">Minimum 8 characters. User will need to use this password to login.</div>
                    </div>
                    <div class="form-group">
                        <label for="resetConfirmPassword">Confirm Password *</label>
                        <input type="password" id="resetConfirmPassword" required minlength="8" autocomplete="new-password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitResetPassword()">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Model Info Modal (Phase 1A) -->
    <div id="modelInfoModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>‚ÑπÔ∏è Model Information - <span id="model-info-name"></span></h3>
                <button class="modal-close" onclick="closeModal('modelInfoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="model-info-loading" style="text-align: center; padding: 2rem;">
                    <div class="loading">Loading model information</div>
                </div>

                <!-- Error State -->
                <div id="model-info-error" style="display: none;" class="error-message"></div>

                <!-- Content -->
                <div id="model-info-content" style="display: none;">
                    <!-- Section 1: Basic Info -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; border-bottom: 2px solid var(--theme-border); padding-bottom: 0.5rem;">
                            üìã Basic Information
                        </h4>
                        <div class="info-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">Model Type:</label>
                                <div id="model-info-type">-</div>
                            </div>
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">Version:</label>
                                <div id="model-info-version">-</div>
                            </div>
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">Status:</label>
                                <div id="model-info-status">-</div>
                            </div>
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">File Size:</label>
                                <div id="model-info-size">-</div>
                            </div>
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">Created:</label>
                                <div id="model-info-created">-</div>
                            </div>
                            <div class="info-item">
                                <label style="font-weight: 600; color: var(--theme-text-muted); font-size: 0.85em;">Last Updated:</label>
                                <div id="model-info-updated">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Training Configuration -->
                    <div style="margin-bottom: 2rem;" id="model-info-training-section">
                        <h4 style="margin-bottom: 1rem; border-bottom: 2px solid var(--theme-border); padding-bottom: 0.5rem;">
                            ‚öôÔ∏è Training Configuration
                        </h4>
                        <div id="model-info-hyperparams" style="background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-sm); font-family: monospace; font-size: 0.9em;">
                            <!-- Hyperparameters will be injected here -->
                        </div>
                    </div>

                    <!-- Section 3: Performance Metrics -->
                    <div style="margin-bottom: 2rem;" id="model-info-metrics-section">
                        <h4 style="margin-bottom: 1rem; border-bottom: 2px solid var(--theme-border); padding-bottom: 0.5rem;">
                            üìä Performance Metrics
                        </h4>
                        <div id="model-info-metrics-cards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <!-- Metrics cards will be injected here -->
                        </div>
                    </div>

                    <!-- Section 4: Features Used -->
                    <div style="margin-bottom: 2rem;" id="model-info-features-section">
                        <h4 style="margin-bottom: 1rem; border-bottom: 2px solid var(--theme-border); padding-bottom: 0.5rem;">
                            üîß Features Used
                        </h4>
                        <div id="model-info-features" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- Feature badges will be injected here -->
                        </div>
                    </div>

                    <!-- Section 5: Training Data -->
                    <div style="margin-bottom: 1rem;" id="model-info-data-section">
                        <h4 style="margin-bottom: 1rem; border-bottom: 2px solid var(--theme-border); padding-bottom: 0.5rem;">
                            üìÖ Training Data Period
                        </h4>
                        <div id="model-info-data-period">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modelInfoModal')">Close</button>
                <button class="btn btn-primary" onclick="showVersionHistory()">üìä View History</button>
            </div>
        </div>
    </div>

    <!-- Version History Modal (Phase 1B) -->
    <div id="versionHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìä Version History - <span id="version-history-name"></span></h3>
                <button class="modal-close" onclick="closeModal('versionHistoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="version-history-loading" style="text-align: center; padding: 2rem;">
                    <div class="loading">Loading version history</div>
                </div>

                <!-- Error State -->
                <div id="version-history-error" style="display: none;" class="error-message"></div>

                <!-- Content -->
                <div id="version-history-content" style="display: none;">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--brand-primary);">
                        <strong>Latest Version:</strong> <span id="version-history-latest">-</span><br>
                        <strong>Total Versions:</strong> <span id="version-history-total">-</span>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Type</th>
                                <th>File Size</th>
                                <th>Metrics</th>
                            </tr>
                        </thead>
                        <tbody id="version-history-table-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('versionHistoryModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Configure & Train Modal (Phase 2) -->
    <div id="configureTrainModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configure & Train - <span id="config-train-name"></span></h3>
                <button class="modal-close" onclick="closeModal('configureTrainModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="config-train-loading" style="text-align: center; padding: 2rem;">
                    <div class="loading">Loading default parameters</div>
                </div>

                <!-- Error State -->
                <div id="config-train-error" style="display: none;" class="error-message"></div>

                <!-- Config Form -->
                <div id="config-train-form" style="display: none;">
                    <!-- Preset Selection -->
                    <div style="margin-bottom: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--brand-primary);">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            üìã Preset Configuration:
                        </label>
                        <select id="preset-select" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);">
                            <option value="standard">Standard (model-specific)</option>
                            <option value="deep" selected>Deep (model-specific)</option>
                            <option value="ultra">Ultra Deep (maximum data available)</option>
                            <option value="custom">Custom (Manual Configuration)</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--theme-text-muted);">
                            Presets are optimized for each model's data availability and training needs
                        </small>
                    </div>

                    <!-- Data Configuration -->
                    <fieldset style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm);">
                        <legend style="font-weight: 600; padding: 0 0.5rem;">üìÖ Data Configuration</legend>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Historical Data (days):</label>
                            <input type="number" id="config-days" min="90" max="7300" value="730"
                                   style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border);">
                            <small style="color: var(--theme-text-muted);">Range: 90-7300 days (~3 months to 20 years)</small>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Train/Val Split:</label>
                            <select id="config-split" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);">
                                <option value="0.7">70/30 (Train/Val)</option>
                                <option value="0.8" selected>80/20 (Train/Val) - Recommended</option>
                                <option value="0.9">90/10 (Train/Val)</option>
                            </select>
                        </div>
                    </fieldset>

                    <!-- Hyperparameters -->
                    <fieldset style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm);">
                        <legend style="font-weight: 600; padding: 0 0.5rem;">üîß Hyperparameters</legend>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Epochs:</label>
                                <input type="number" id="config-epochs" min="10" max="500" value="100"
                                       style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border);">
                                <small style="color: var(--theme-text-muted);">10-500</small>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Patience:</label>
                                <input type="number" id="config-patience" min="5" max="50" value="15"
                                       style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border);">
                                <small style="color: var(--theme-text-muted);">5-50</small>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Batch Size:</label>
                                <select id="config-batch" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);">
                                    <option value="8">8</option>
                                    <option value="16">16</option>
                                    <option value="32" selected>32 - Recommended</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Learning Rate:</label>
                                <select id="config-lr" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);">
                                    <option value="0.0001">0.0001</option>
                                    <option value="0.0005">0.0005</option>
                                    <option value="0.001" selected>0.001 - Recommended</option>
                                    <option value="0.005">0.005</option>
                                    <option value="0.01">0.01</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Volatility-specific (shown only for volatility models) -->
                    <fieldset id="volatility-params" style="display: none; margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm);">
                        <legend style="font-weight: 600; padding: 0 0.5rem;">üìä Volatility-Specific</legend>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Hidden Size:</label>
                            <select id="config-hidden" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);">
                                <option value="32">32</option>
                                <option value="64" selected>64 - Recommended</option>
                                <option value="128">128</option>
                                <option value="256">256</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Min R¬≤ Threshold:</label>
                            <input type="number" id="config-min-r2" min="0" max="1" step="0.1" value="0.5"
                                   style="width: 100%; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border);">
                            <small style="color: var(--theme-text-muted);">0.0-1.0 (minimum acceptable R¬≤)</small>
                        </div>
                    </fieldset>

                    <!-- Time Estimate -->
                    <div id="time-estimate" style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--brand-success);">
                        <strong>‚è±Ô∏è Estimated Training Time:</strong>
                        <p id="time-estimate-text" style="margin: 0.5rem 0 0 0; color: var(--theme-text-muted);"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('configureTrainModal')">Cancel</button>
                <button id="start-training-btn" class="btn btn-primary" onclick="submitTraining()" style="display: none;">
                    üöÄ Start Training
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();  // V√©rifie authentification + redirect si n√©cessaire
    // =================================

        import './components/nav.js';

        // Tabs functionality
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;

                // Remove active class from all
                tabButtons.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Add active class to clicked
                btn.classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Update URL hash
                window.location.hash = tabId;

                // Load tab content if needed
                loadTabContent(tabId);
            });
        });

        // Check URL hash on load (execute immediately, not in DOMContentLoaded)
        // This function runs when the script loads (after DOM is ready)
        function initializeTabFromHash() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const btn = document.querySelector(`[data-tab="${hash}"]`);
                if (btn) {
                    btn.click();
                } else {
                    loadTabContent('overview');
                }
            } else {
                loadTabContent('overview');
            }
        }

        // Also listen for hash changes (when clicking browser back/forward)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const btn = document.querySelector(`[data-tab="${hash}"]`);
                if (btn) {
                    btn.click();
                }
            }
        });

        // Load tab content
        async function loadTabContent(tabId) {
            console.log(`Loading tab: ${tabId}`);

            switch (tabId) {
                case 'overview':
                    await loadSystemStats();
                    break;
                case 'users':
                    await loadUsersTab();
                    break;
                case 'logs':
                    await loadLogsTab();
                    break;
                case 'cache':
                    await loadCacheTab();
                    break;
                case 'ml':
                    await loadMLTab();
                    break;
                case 'apikeys':
                    // Phase 4
                    break;
            }
        }

        // Load system stats
        async function loadSystemStats() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/status', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showError(`Access denied. Admin role required. Current user: "${activeUser}". Please switch to an admin user (e.g., "jack") using the user selector.`);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('System status:', data);

                // Update stats cards
                if (data.ok && data.data) {
                    const stats = data.data;
                    updateStatCard(0, stats.system?.total_users || 0);
                    updateStatCard(1, stats.system?.admin_users || 0);
                    updateStatCard(3, stats.ml?.models_count || 0);
                }

            } catch (error) {
                console.error('Failed to load system stats:', error);
                showError(`Failed to load stats: ${error.message}`);
            }
        }

        // Update stat card
        function updateStatCard(index, value) {
            const cards = document.querySelectorAll('.stat-card .stat-value');
            if (cards[index]) {
                cards[index].textContent = value;
            }
        }

        // Load users tab
        async function loadUsersTab() {
            const container = document.getElementById('tab-users');
            container.innerHTML = '<div class="loading">Loading users</div>';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/users', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        container.innerHTML = `<div class="error-message">Access denied. Admin role required.<br><br>Current user: <strong>"${activeUser}"</strong><br><br>Please switch to an admin user (e.g., "jack") using the user selector in the top right corner.</div>`;
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('Users data:', result);

                if (!result.ok || !result.data) {
                    throw new Error('Invalid response format');
                }

                const users = result.data;

                // Build users table
                let html = '<h2>User Management</h2>';
                html += '<div style="margin-bottom: 1rem;">';
                html += '<button class="btn btn-primary" onclick="showCreateUserModal()">‚ûï Create User</button>';
                html += '</div>';
                html += '<table class="data-table">';
                html += '<thead><tr>';
                html += '<th>User ID</th>';
                html += '<th>Label</th>';
                html += '<th>Roles</th>';
                html += '<th>Status</th>';
                html += '<th>Created</th>';
                html += '<th>Actions</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                users.forEach(user => {
                    html += '<tr>';
                    html += `<td><strong>${user.id}</strong></td>`;
                    html += `<td>${user.label}</td>`;
                    html += '<td>';
                    (user.roles || []).forEach(role => {
                        html += `<span class="badge ${role}">${role}</span>`;
                    });
                    html += '</td>';
                    html += `<td><span class="status-${user.status}">${user.status || 'active'}</span></td>`;
                    html += `<td>${formatDate(user.created_at)}</td>`;
                    html += '<td>';
                    html += `<button class="btn btn-secondary btn-small" onclick='editUser(${JSON.stringify(user)})'>‚úèÔ∏è Edit</button> `;
                    html += `<button class="btn btn-primary btn-small" onclick="showResetPasswordModal('${user.id}')" title="Reset user password">üîë Reset Password</button> `;
                    html += `<button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')">üóëÔ∏è Delete</button>`;
                    html += '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load users:', error);
                container.innerHTML = `<div class="error-message">Failed to load users: ${error.message}</div>`;
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US');
        }

        // Load logs tab
        let currentLogsPage = 0;
        const logsPageSize = 100;
        let currentLogsFile = 'app.log';
        let currentLogsLevel = '';
        let currentLogsSearch = '';
        let currentLogsSortBy = 'timestamp'; // Default sort by timestamp
        let currentLogsSortOrder = 'desc'; // Default: newest first

        function toggleLogsSort(sortBy) {
            if (currentLogsSortBy === sortBy) {
                // Toggle order if same column
                currentLogsSortOrder = currentLogsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // New column: default to desc for timestamp, desc for level
                currentLogsSortBy = sortBy;
                currentLogsSortOrder = 'desc';
            }
            // Reset to page 0 to see the first/last message based on new sort
            currentLogsPage = 0;
            loadLogsContent();
        }

        async function loadLogsTab() {
            const container = document.getElementById('tab-logs');
            container.innerHTML = '<h2>Logs Viewer</h2><div class="loading">Loading logs</div>';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Build filters UI
                let html = '<h2>Logs Viewer</h2>';
                html += '<div class="filters">';
                html += '<select id="logsFileSelect" onchange="changeLogsFile(this.value)">';
                html += '<option value="app.log">app.log</option>';
                html += '</select>';
                html += '<select id="logsLevelSelect" onchange="changeLogsLevel(this.value)">';
                html += '<option value="">All Levels</option>';
                html += '<option value="ERROR">ERROR</option>';
                html += '<option value="WARNING">WARNING</option>';
                html += '<option value="INFO">INFO</option>';
                html += '<option value="DEBUG">DEBUG</option>';
                html += '</select>';
                html += '<input type="text" id="logsSearchInput" placeholder="Search..." onchange="changeLogsSearch(this.value)">';
                html += '<button class="btn btn-primary" onclick="loadLogsContent()">üîç Search</button>';
                html += '</div>';
                html += '<div id="logsContent"><div class="loading">Loading logs</div></div>';

                container.innerHTML = html;

                // Load logs content
                await loadLogsContent();

            } catch (error) {
                console.error('Failed to load logs tab:', error);
                container.innerHTML = `<div class="error-message">Failed to load logs tab: ${error.message}</div>`;
            }
        }

        async function loadLogsContent() {
            const contentDiv = document.getElementById('logsContent');
            contentDiv.innerHTML = '<div class="loading">Loading logs</div>';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const offset = currentLogsPage * logsPageSize;

                // Build query params
                const params = new URLSearchParams({
                    filename: currentLogsFile,
                    offset: offset.toString(),
                    limit: logsPageSize.toString(),
                    sort_by: currentLogsSortBy,
                    sort_order: currentLogsSortOrder
                });
                if (currentLogsLevel) params.append('level', currentLogsLevel);
                if (currentLogsSearch) params.append('search', currentLogsSearch);

                const response = await fetch(`/admin/logs/read?${params}`, {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        contentDiv.innerHTML = '<div class="error-message">Access denied. Admin role required.</div>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('Logs data:', result);

                if (!result.ok || !result.data) {
                    throw new Error('Invalid response format');
                }

                const logs = result.data;
                const meta = result.meta;

                // Logs are already sorted by backend
                // Build logs table
                let html = '<table class="data-table">';
                html += '<thead><tr>';

                // Timestamp header (sortable)
                const timestampClass = currentLogsSortBy === 'timestamp'
                    ? `sortable sort-${currentLogsSortOrder}`
                    : 'sortable';
                html += `<th class="${timestampClass}" data-sort="timestamp">Timestamp</th>`;

                // Level header (sortable)
                const levelClass = currentLogsSortBy === 'level'
                    ? `sortable sort-${currentLogsSortOrder}`
                    : 'sortable';
                html += `<th class="${levelClass}" data-sort="level">Level</th>`;

                // Non-sortable headers
                html += '<th>Module</th>';
                html += '<th>Message</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                if (logs.length === 0) {
                    html += '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--theme-text-muted);">No logs found</td></tr>';
                } else {
                    logs.forEach(log => {
                        html += '<tr>';
                        html += `<td style="font-size: 0.85em; white-space: nowrap;">${log.timestamp}</td>`;
                        html += `<td><span class="badge ${log.level.toLowerCase()}">${log.level}</span></td>`;
                        html += `<td style="font-size: 0.85em;">${log.module}</td>`;
                        html += `<td style="font-size: 0.9em;">${log.message}</td>`;
                        html += '</tr>';
                    });
                }

                html += '</tbody></table>';

                // Pagination
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">';
                html += '<div style="color: var(--theme-text-muted); font-size: 0.9em;">';
                html += `Showing ${offset + 1}-${offset + logs.length} of ${meta.total} logs`;
                html += '</div>';
                html += '<div style="display: flex; gap: 0.5rem;">';
                if (currentLogsPage > 0) {
                    html += '<button class="btn btn-secondary" onclick="prevLogsPage()">‚Üê Previous</button>';
                }
                if (meta.has_more) {
                    html += '<button class="btn btn-secondary" onclick="nextLogsPage()">Next ‚Üí</button>';
                }
                html += '</div>';
                html += '</div>';

                contentDiv.innerHTML = html;

                // Add event listeners to sortable headers
                contentDiv.querySelectorAll('th[data-sort]').forEach(th => {
                    th.addEventListener('click', function() {
                        const sortBy = this.getAttribute('data-sort');
                        toggleLogsSort(sortBy);
                    });
                });

            } catch (error) {
                console.error('Failed to load logs content:', error);
                contentDiv.innerHTML = `<div class="error-message">Failed to load logs: ${error.message}</div>`;
            }
        }

        function changeLogsFile(file) {
            currentLogsFile = file;
            currentLogsPage = 0;
            loadLogsContent();
        }

        function changeLogsLevel(level) {
            currentLogsLevel = level;
            currentLogsPage = 0;
            loadLogsContent();
        }

        function changeLogsSearch(search) {
            currentLogsSearch = search;
            currentLogsPage = 0;
        }

        function prevLogsPage() {
            if (currentLogsPage > 0) {
                currentLogsPage--;
                loadLogsContent();
            }
        }

        function nextLogsPage() {
            currentLogsPage++;
            loadLogsContent();
        }

        // Show error
        function showError(message) {
            const container = document.querySelector('.admin-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);

            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Show success
        function showSuccess(message) {
            const container = document.querySelector('.admin-container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);

            setTimeout(() => successDiv.remove(), 5000);
        }

        // Modal functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function showCreateUserModal() {
            // Reset form
            document.getElementById('createUserForm').reset();
            // Show modal
            document.getElementById('createUserModal').classList.add('show');
        }

        async function submitCreateUser() {
            try {
                const userId = document.getElementById('newUserId').value.trim();
                const label = document.getElementById('newUserLabel').value.trim();
                const password = document.getElementById('newUserPassword').value;
                const passwordConfirm = document.getElementById('newUserPasswordConfirm').value;

                // Get selected roles
                const rolesCheckboxes = document.querySelectorAll('#newUserRoles input[type="checkbox"]:checked');
                const roles = Array.from(rolesCheckboxes).map(cb => cb.value);

                if (!userId || !label) {
                    showError('User ID and Label are required');
                    return;
                }

                if (!password || !passwordConfirm) {
                    showError('Password and confirmation are required');
                    return;
                }

                if (password.length < 8) {
                    showError('Password must be at least 8 characters');
                    return;
                }

                if (password !== passwordConfirm) {
                    showError('Passwords do not match');
                    return;
                }

                if (roles.length === 0) {
                    showError('At least one role must be selected');
                    return;
                }

                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': activeUser
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        label: label,
                        password: password,
                        roles: roles
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('User created:', result);

                closeModal('createUserModal');
                showSuccess(`User "${userId}" created successfully`);

                // Reload users list
                await loadUsersTab();

            } catch (error) {
                console.error('Failed to create user:', error);
                showError(`Failed to create user: ${error.message}`);
            }
        }

        function editUser(user) {
            // Fill form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserLabel').value = user.label;
            document.getElementById('editUserStatus').value = user.status || 'active';

            // Set roles checkboxes
            const checkboxes = document.querySelectorAll('#editUserRoles input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = (user.roles || []).includes(cb.value);
            });

            // Show modal
            document.getElementById('editUserModal').classList.add('show');
        }

        async function submitEditUser() {
            try {
                const userId = document.getElementById('editUserId').value;
                const label = document.getElementById('editUserLabel').value.trim();
                const status = document.getElementById('editUserStatus').value;

                // Get selected roles
                const rolesCheckboxes = document.querySelectorAll('#editUserRoles input[type="checkbox"]:checked');
                const roles = Array.from(rolesCheckboxes).map(cb => cb.value);

                if (!label) {
                    showError('Label is required');
                    return;
                }

                if (roles.length === 0) {
                    showError('At least one role must be selected');
                    return;
                }

                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': activeUser
                    },
                    body: JSON.stringify({
                        label: label,
                        roles: roles,
                        status: status
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('User updated:', result);

                closeModal('editUserModal');
                showSuccess(`User "${userId}" updated successfully`);

                // Reload users list
                await loadUsersTab();

            } catch (error) {
                console.error('Failed to update user:', error);
                showError(`Failed to update user: ${error.message}`);
            }
        }

        function deleteUser(userId) {
            // Fill modal
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserIdText').textContent = userId;

            // Reset to soft delete (safer default)
            document.querySelector('input[name="deleteType"][value="soft"]').checked = true;

            // Show modal
            document.getElementById('deleteUserModal').classList.add('show');
        }

        async function submitDeleteUser() {
            try {
                const userId = document.getElementById('deleteUserId').value;

                // Get selected delete type
                const deleteType = document.querySelector('input[name="deleteType"]:checked').value;
                const hardDelete = deleteType === 'hard';

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Build URL with hard_delete parameter if needed
                const url = `/admin/users/${userId}${hardDelete ? '?hard_delete=true' : ''}`;

                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'X-User': activeUser
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('User deleted:', result);

                closeModal('deleteUserModal');

                const deleteTypeText = hardDelete ? 'permanently' : 'successfully (soft delete)';
                showSuccess(`User "${userId}" deleted ${deleteTypeText}`);

                // Reload users list
                await loadUsersTab();

            } catch (error) {
                console.error('Failed to delete user:', error);
                showError(`Failed to delete user: ${error.message}`);
            }
        }

        // ====================================================================
        // Password Management
        // ====================================================================

        // Show Change My Password modal
        function showChangeMyPasswordModal() {
            // Reset form
            document.getElementById('changeMyPasswordForm').reset();
            // Show modal
            document.getElementById('changeMyPasswordModal').classList.add('show');
        }

        // Submit Change My Password
        async function submitChangeMyPassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validation
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showError('All fields are required');
                    return;
                }

                if (newPassword.length < 8) {
                    showError('New password must be at least 8 characters');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('New passwords do not match');
                    return;
                }

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Create FormData
                const formData = new URLSearchParams();
                formData.append('current_password', currentPassword);
                formData.append('new_password', newPassword);

                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-User': activeUser
                    },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || result.detail || 'Failed to change password');
                }

                closeModal('changeMyPasswordModal');
                showSuccess('Password changed successfully! Please login again with your new password.');

                // Logout after 2 seconds
                setTimeout(() => {
                    window.location.href = '/static/login.html';
                }, 2000);

            } catch (error) {
                console.error('Failed to change password:', error);
                showError(`Failed to change password: ${error.message}`);
            }
        }

        // Show Reset Password modal (admin only)
        function showResetPasswordModal(userId) {
            // Fill modal
            document.getElementById('resetPasswordUserId').value = userId;
            document.getElementById('resetPasswordUserIdText').textContent = userId;

            // Reset form
            document.getElementById('resetPasswordForm').reset();

            // Show modal
            document.getElementById('resetPasswordModal').classList.add('show');
        }

        // Submit Reset Password (admin only)
        async function submitResetPassword() {
            try {
                const userId = document.getElementById('resetPasswordUserId').value;
                const newPassword = document.getElementById('resetNewPassword').value;
                const confirmPassword = document.getElementById('resetConfirmPassword').value;

                // Validation
                if (!newPassword || !confirmPassword) {
                    showError('All fields are required');
                    return;
                }

                if (newPassword.length < 8) {
                    showError('New password must be at least 8 characters');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                const response = await fetch(`/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': activeUser
                    },
                    body: JSON.stringify({
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to reset password');
                }

                closeModal('resetPasswordModal');
                showSuccess(`Password reset successfully for user "${userId}"`);

            } catch (error) {
                console.error('Failed to reset password:', error);
                showError(`Failed to reset password: ${error.message}`);
            }
        }

        // Make functions globally accessible
        window.showChangeMyPasswordModal = showChangeMyPasswordModal;
        window.submitChangeMyPassword = submitChangeMyPassword;
        window.showResetPasswordModal = showResetPasswordModal;
        window.submitResetPassword = submitResetPassword;

        // Close modal on background click
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // Listen for user changes and reload current tab
        window.addEventListener('activeUserChanged', (event) => {
            console.log('User changed, reloading admin dashboard...', event.detail);

            // Get current active tab
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tab;
                // Small delay to ensure localStorage is updated
                setTimeout(() => {
                    loadTabContent(tabId);
                }, 100);
            }
        });

        // Export for debugging
        window.adminDashboard = {
            loadSystemStats,
            loadUsersTab,
            loadTabContent
        };

        // ====================================================================
        // Cache Management
        // ====================================================================

        // Load cache tab
        async function loadCacheTab() {
            console.log('Loading cache tab');
            await refreshCacheStats();
        }

        // Refresh cache stats
        async function refreshCacheStats() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/cache/stats', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch cache stats');
                }

                const result = await response.json();
                const data = result.data;

                // Update stats cards
                document.getElementById('cache-total-caches').textContent = data.total_caches || 0;
                document.getElementById('cache-total-entries').textContent = data.total_entries || 0;

                // Calculate valid and expired entries from caches
                let totalValid = 0;
                let totalExpired = 0;
                Object.values(data.caches || {}).forEach(cache => {
                    totalValid += cache.valid_entries || 0;
                    totalExpired += cache.expired_entries || 0;
                });

                document.getElementById('cache-valid-entries').textContent = totalValid;
                document.getElementById('cache-expired-entries').textContent = totalExpired;

                // Update caches table
                const tbody = document.getElementById('cache-table-body');
                if (Object.keys(data.caches || {}).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">No caches registered</td></tr>';
                    return;
                }

                tbody.innerHTML = Object.entries(data.caches).map(([name, cache]) => `
                    <tr>
                        <td><strong>${name}</strong><br><small style="color: var(--text-muted)">${cache.description || ''}</small></td>
                        <td>${cache.entries || 0}</td>
                        <td><span class="badge" style="background: var(--color-success-muted); color: var(--color-success)">${cache.valid_entries || 0}</span></td>
                        <td>${cache.expired_entries > 0 ? `<span class="badge" style="background: var(--color-warning-muted); color: var(--color-warning)">${cache.expired_entries}</span>` : '0'}</td>
                        <td>${cache.ttl || '-'}</td>
                        <td><span class="badge">${cache.type || 'unknown'}</span></td>
                        <td>
                            ${cache.type !== 'function_scope' ? `<button class="btn btn-small btn-danger" onclick="clearCacheIndividual('${name}')">Clear</button>` : '<span style="color: var(--text-muted)">N/A</span>'}
                        </td>
                    </tr>
                `).join('');

                console.log('‚úÖ Cache stats refreshed');

            } catch (error) {
                console.error('Error loading cache stats:', error);
                document.getElementById('cache-table-body').innerHTML = `
                    <tr><td colspan="7" class="error">Error loading cache stats: ${error.message}</td></tr>
                `;
            }
        }

        // Clear individual cache
        async function clearCacheIndividual(cacheName) {
            if (!confirm(`Clear cache "${cacheName}"?\n\nAll ${cacheName} entries will be deleted.`)) {
                return;
            }

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch(`/admin/cache/clear?cache_name=${encodeURIComponent(cacheName)}`, {
                    method: 'DELETE',
                    headers: { 'X-User': activeUser }
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to clear cache');
                }

                showCacheMessage(`‚úÖ Cache "${cacheName}" cleared successfully (${result.data.cleared_entries} entries)`, false);
                await refreshCacheStats();

            } catch (error) {
                console.error('Error clearing cache:', error);
                showCacheMessage(`‚ùå Error clearing cache: ${error.message}`, true);
            }
        }

        // Clear all caches
        async function clearAllCaches() {
            if (!confirm('Clear ALL caches?\n\nThis will delete all cached data from all caches. This action cannot be undone.')) {
                return;
            }

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/cache/clear?cache_name=all', {
                    method: 'DELETE',
                    headers: { 'X-User': activeUser }
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to clear caches');
                }

                showCacheMessage(`‚úÖ All caches cleared successfully (${result.data.total_cleared} total entries from ${result.data.caches_cleared} caches)`, false);
                await refreshCacheStats();

            } catch (error) {
                console.error('Error clearing all caches:', error);
                showCacheMessage(`‚ùå Error clearing caches: ${error.message}`, true);
            }
        }

        // Clear expired entries
        async function clearExpiredEntries() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/cache/clear-expired', {
                    method: 'POST',
                    headers: { 'X-User': activeUser }
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to clear expired entries');
                }

                showCacheMessage(`‚úÖ Expired entries cleared (${result.data.total_cleared} entries from ${result.data.caches_processed} caches)`, false);
                await refreshCacheStats();

            } catch (error) {
                console.error('Error clearing expired entries:', error);
                showCacheMessage(`‚ùå Error clearing expired entries: ${error.message}`, true);
            }
        }

        // Show cache message
        function showCacheMessage(message, isError = false) {
            const container = document.getElementById('cache-messages');
            const div = document.createElement('div');
            div.className = isError ? 'error-message' : 'success-message';
            div.textContent = message;
            container.appendChild(div);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        // ====================================================================
        // ML Models Management
        // ====================================================================

        // Load ML models tab
        async function loadMLTab() {
            console.log('Loading ML models tab');
            await refreshMLModels();
            await updateMLJobStats();
        }

        // Refresh ML models
        async function refreshMLModels() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/ml/models', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch ML models');
                }

                const result = await response.json();
                const models = result.data || [];

                // Update stats
                document.getElementById('ml-total-models').textContent = models.length;
                const deployedModels = models.filter(m => m.status === 'DEPLOYED' || m.status === 'deployed').length;
                document.getElementById('ml-deployed-models').textContent = deployedModels;

                // Update models table
                const tbody = document.getElementById('ml-models-table-body');
                if (models.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">No ML models registered</td></tr>';
                    return;
                }

                tbody.innerHTML = models.map(model => {
                    const statusBadge = getStatusBadge(model.status);
                    const trainingStatus = model.has_active_job
                        ? `<span class="badge" style="background: var(--color-warning-muted); color: var(--color-warning)">${model.active_job_status || 'training'}</span>`
                        : '<span style="color: var(--text-muted)">-</span>';

                    return `
                        <tr>
                            <td><strong>${model.name}</strong></td>
                            <td><span class="badge">${model.model_type || 'unknown'}</span></td>
                            <td>${model.version || 'N/A'}</td>
                            <td>${statusBadge}</td>
                            <td>${model.updated_at ? new Date(model.updated_at).toLocaleString('en-US', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'N/A'}</td>
                            <td>${trainingStatus}</td>
                            <td style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                <button class="btn btn-small btn-secondary" onclick="showModelInfo('${model.name}')" title="View detailed information">
                                    ‚ÑπÔ∏è
                                </button>
                                ${!model.has_active_job ?
                                    `<button class="btn btn-small btn-primary" onclick="showConfigureTrainModal('${model.name}', '${model.model_type || "unknown"}')" title="Configure & Retrain model">
                                        ‚öôÔ∏è Train
                                    </button>` :
                                    '<span style="color: var(--text-muted); font-size: 0.85em;">Training...</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');

                console.log('‚úÖ ML models refreshed');

            } catch (error) {
                console.error('Error loading ML models:', error);
                document.getElementById('ml-models-table-body').innerHTML = `
                    <tr><td colspan="7" class="error">Error loading ML models: ${error.message}</td></tr>
                `;
            }
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const statusMap = {
                'DEPLOYED': { color: 'var(--color-success)', bg: 'var(--color-success-muted)', text: 'DEPLOYED' },
                'deployed': { color: 'var(--color-success)', bg: 'var(--color-success-muted)', text: 'DEPLOYED' },
                'TRAINED': { color: 'var(--color-info)', bg: 'var(--color-info-muted)', text: 'TRAINED' },
                'trained': { color: 'var(--color-info)', bg: 'var(--color-info-muted)', text: 'TRAINED' },
                'TRAINING': { color: 'var(--color-warning)', bg: 'var(--color-warning-muted)', text: 'TRAINING' },
                'training': { color: 'var(--color-warning)', bg: 'var(--color-warning-muted)', text: 'TRAINING' },
                'FAILED': { color: 'var(--color-error)', bg: 'var(--color-error-muted)', text: 'FAILED' },
                'failed': { color: 'var(--color-error)', bg: 'var(--color-error-muted)', text: 'FAILED' }
            };

            const style = statusMap[status] || { color: 'var(--text-muted)', bg: '#eee', text: status };
            return `<span class="badge" style="background: ${style.bg}; color: ${style.color}">${style.text}</span>`;
        }

        // Trigger model training
        async function triggerTraining(modelName, modelType) {
            if (!confirm(`Trigger retraining for model "${modelName}"?\n\nThis will start a background training job.`)) {
                return;
            }

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch(`/admin/ml/train/${encodeURIComponent(modelName)}?model_type=${encodeURIComponent(modelType)}`, {
                    method: 'POST',
                    headers: { 'X-User': activeUser }
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to trigger training');
                }

                showMLMessage(`‚úÖ Training started for "${modelName}" (Job ID: ${result.data.job_id})`, false);
                await refreshMLModels();
                await updateMLJobStats();

            } catch (error) {
                console.error('Error triggering training:', error);
                showMLMessage(`‚ùå Error triggering training: ${error.message}`, true);
            }
        }

        // Load training jobs
        async function loadTrainingJobs() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/ml/jobs', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch training jobs');
                }

                const result = await response.json();
                const jobs = result.data || [];

                // Show jobs container
                document.getElementById('ml-jobs-container').style.display = 'block';

                // Update jobs table
                const tbody = document.getElementById('ml-jobs-table-body');
                if (jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">No training jobs</td></tr>';
                    return;
                }

                tbody.innerHTML = jobs.map(job => {
                    const statusBadge = getJobStatusBadge(job.status);
                    return `
                        <tr>
                            <td><code style="font-size: 0.85em;">${job.job_id}</code></td>
                            <td><strong>${job.model_name}</strong></td>
                            <td>${statusBadge}</td>
                            <td>${job.triggered_by}</td>
                            <td>${new Date(job.created_at).toLocaleString('en-US', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>
                            <td>${job.completed_at ? new Date(job.completed_at).toLocaleString('en-US', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-'}</td>
                            <td>
                                ${job.status === 'running' || job.status === 'pending' ?
                                    `<button class="btn btn-small btn-danger" onclick="cancelJob('${job.job_id}')">Cancel</button>` :
                                    '<span style="color: var(--text-muted)">-</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');

                console.log('‚úÖ Training jobs loaded');

            } catch (error) {
                console.error('Error loading training jobs:', error);
                showMLMessage(`‚ùå Error loading jobs: ${error.message}`, true);
            }
        }

        // Get job status badge
        function getJobStatusBadge(status) {
            const statusMap = {
                'pending': { color: 'var(--text-muted)', bg: '#eee', text: 'PENDING' },
                'running': { color: 'var(--color-warning)', bg: 'var(--color-warning-muted)', text: 'RUNNING' },
                'completed': { color: 'var(--color-success)', bg: 'var(--color-success-muted)', text: 'COMPLETED' },
                'failed': { color: 'var(--color-error)', bg: 'var(--color-error-muted)', text: 'FAILED' },
                'cancelled': { color: 'var(--text-muted)', bg: '#ddd', text: 'CANCELLED' }
            };

            const style = statusMap[status] || { color: 'var(--text-muted)', bg: '#eee', text: status };
            return `<span class="badge" style="background: ${style.bg}; color: ${style.color}">${style.text}</span>`;
        }

        // Hide training jobs
        function hideTrainingJobs() {
            document.getElementById('ml-jobs-container').style.display = 'none';
        }

        // Cancel training job
        async function cancelJob(jobId) {
            if (!confirm(`Cancel training job "${jobId}"?`)) {
                return;
            }

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch(`/admin/ml/jobs/${encodeURIComponent(jobId)}`, {
                    method: 'DELETE',
                    headers: { 'X-User': activeUser }
                });

                const result = await response.json();

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || 'Failed to cancel job');
                }

                showMLMessage(`‚úÖ Job "${jobId}" cancelled`, false);
                await loadTrainingJobs();
                await updateMLJobStats();

            } catch (error) {
                console.error('Error cancelling job:', error);
                showMLMessage(`‚ùå Error cancelling job: ${error.message}`, true);
            }
        }

        // Update ML job stats
        async function updateMLJobStats() {
            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const response = await fetch('/admin/ml/jobs', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) return;

                const result = await response.json();
                const jobs = result.data || [];

                const activeJobs = jobs.filter(j => j.status === 'running' || j.status === 'pending').length;
                const completedJobs = jobs.filter(j => j.status === 'completed').length;

                document.getElementById('ml-active-jobs').textContent = activeJobs;
                document.getElementById('ml-completed-jobs').textContent = completedJobs;

            } catch (error) {
                console.error('Error updating ML job stats:', error);
            }
        }

        // Show ML message
        function showMLMessage(message, isError = false) {
            const container = document.getElementById('ml-messages');
            const div = document.createElement('div');
            div.className = isError ? 'error-message' : 'success-message';
            div.textContent = message;
            container.appendChild(div);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        // ====================================================================
        // ML Models Info & History Modals (Phase 1 - Dec 2025)
        // ====================================================================

        let currentModelName = null; // Global pour partager entre modals

        async function showModelInfo(modelName) {
            currentModelName = modelName;

            // Open modal
            document.getElementById('modelInfoModal').classList.add('show');
            document.getElementById('model-info-name').textContent = modelName;

            // Show loading
            document.getElementById('model-info-loading').style.display = 'block';
            document.getElementById('model-info-error').style.display = 'none';
            document.getElementById('model-info-content').style.display = 'none';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Fetch model manifest from EXISTING endpoint
                const response = await fetch(`/api/ml/registry/models/${modelName}`, {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch model info: ${response.status}`);
                }

                const result = await response.json();
                const manifest = result.manifest || result.data?.manifest;

                if (!manifest) {
                    throw new Error('No manifest data returned');
                }

                // Populate modal
                populateModelInfo(manifest);

                // Hide loading, show content
                document.getElementById('model-info-loading').style.display = 'none';
                document.getElementById('model-info-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading model info:', error);

                // Show error
                document.getElementById('model-info-loading').style.display = 'none';
                document.getElementById('model-info-error').style.display = 'block';
                document.getElementById('model-info-error').textContent = `Error: ${error.message}`;
            }
        }

        function populateModelInfo(manifest) {
            // Basic info
            document.getElementById('model-info-type').textContent = manifest.model_type || 'unknown';
            document.getElementById('model-info-version').textContent = manifest.version || 'N/A';

            // Status badge
            const statusEl = document.getElementById('model-info-status');
            statusEl.innerHTML = getStatusBadge(manifest.status || 'unknown');

            // File size
            const sizeEl = document.getElementById('model-info-size');
            if (manifest.file_size) {
                const sizeMB = (manifest.file_size / (1024 * 1024)).toFixed(2);
                sizeEl.textContent = `${sizeMB} MB`;
            } else {
                sizeEl.textContent = 'N/A';
            }

            // Dates
            document.getElementById('model-info-created').textContent =
                manifest.created_at ? new Date(manifest.created_at).toLocaleString('en-US') : 'N/A';
            document.getElementById('model-info-updated').textContent =
                manifest.updated_at ? new Date(manifest.updated_at).toLocaleString('en-US') : 'N/A';

            // Training configuration
            if (manifest.hyperparameters || manifest.training_config) {
                const hyperparams = manifest.hyperparameters || manifest.training_config || {};
                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">';

                Object.entries(hyperparams).forEach(([key, value]) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                            <span style="color: var(--theme-text-muted);">${key}:</span>
                            <strong>${JSON.stringify(value)}</strong>
                        </div>
                    `;
                });

                html += '</div>';
                document.getElementById('model-info-hyperparams').innerHTML = html;
                document.getElementById('model-info-training-section').style.display = 'block';
            } else {
                document.getElementById('model-info-training-section').style.display = 'none';
            }

            // Performance metrics
            const valMetrics = manifest.validation_metrics || {};
            const testMetrics = manifest.test_metrics || {};
            const allMetrics = { ...valMetrics, ...testMetrics };

            if (Object.keys(allMetrics).length > 0) {
                let metricsHtml = '';

                Object.entries(allMetrics).forEach(([key, value]) => {
                    const displayValue = typeof value === 'number' ? value.toFixed(4) : value;
                    metricsHtml += `
                        <div class="metric-card" style="background: var(--theme-surface); padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.8em; color: var(--theme-text-muted); margin-bottom: 0.25rem;">${key}</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--theme-text);">${displayValue}</div>
                        </div>
                    `;
                });

                document.getElementById('model-info-metrics-cards').innerHTML = metricsHtml;
                document.getElementById('model-info-metrics-section').style.display = 'block';
            } else {
                document.getElementById('model-info-metrics-section').style.display = 'none';
            }

            // Features used
            if (manifest.features_used && manifest.features_used.length > 0) {
                let featuresHtml = '';
                manifest.features_used.forEach(feature => {
                    featuresHtml += `
                        <span class="badge" style="background: var(--brand-primary); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.85em;">
                            ${feature}
                        </span>
                    `;
                });
                document.getElementById('model-info-features').innerHTML = featuresHtml;
                document.getElementById('model-info-features-section').style.display = 'block';
            } else {
                document.getElementById('model-info-features-section').style.display = 'none';
            }

            // Training data period
            if (manifest.training_data_period) {
                const period = manifest.training_data_period;
                document.getElementById('model-info-data-period').innerHTML = `
                    <div style="background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-sm);">
                        <strong>Start:</strong> ${period.start_date || 'N/A'}<br>
                        <strong>End:</strong> ${period.end_date || 'N/A'}
                    </div>
                `;
                document.getElementById('model-info-data-section').style.display = 'block';
            } else {
                document.getElementById('model-info-data-section').style.display = 'none';
            }
        }

        async function showVersionHistory(modelName) {
            // Use currentModelName if no parameter provided (fixes onclick from modal footer)
            const targetModel = modelName || currentModelName;

            if (!targetModel) {
                console.error('No model name provided to showVersionHistory');
                return;
            }

            // Close model info modal if open
            closeModal('modelInfoModal');

            currentModelName = targetModel;

            // Open modal
            document.getElementById('versionHistoryModal').classList.add('show');
            document.getElementById('version-history-name').textContent = targetModel;

            // Show loading
            document.getElementById('version-history-loading').style.display = 'block';
            document.getElementById('version-history-error').style.display = 'none';
            document.getElementById('version-history-content').style.display = 'none';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Fetch version history from EXISTING endpoint
                const response = await fetch(`/api/ml/registry/models/${targetModel}/versions`, {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch version history: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success || !result.versions) {
                    throw new Error('No version data returned');
                }

                // Populate modal
                populateVersionHistory(result);

                // Hide loading, show content
                document.getElementById('version-history-loading').style.display = 'none';
                document.getElementById('version-history-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading version history:', error);

                // Show error
                document.getElementById('version-history-loading').style.display = 'none';
                document.getElementById('version-history-error').style.display = 'block';
                document.getElementById('version-history-error').textContent = `Error: ${error.message}`;
            }
        }

        function populateVersionHistory(data) {
            // Summary
            document.getElementById('version-history-latest').textContent = data.latest_version || 'N/A';
            document.getElementById('version-history-total').textContent = data.total_versions || 0;

            // Table
            const tbody = document.getElementById('version-history-table-body');

            if (data.versions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--theme-text-muted);">No version history available</td></tr>';
                return;
            }

            tbody.innerHTML = data.versions.map(version => {
                const sizeMB = version.file_size ? (version.file_size / (1024 * 1024)).toFixed(2) + ' MB' : 'N/A';
                const createdDate = version.created_at ? new Date(version.created_at).toLocaleString('en-US') : 'N/A';

                // Format metrics
                let metricsHtml = '-';
                if (version.validation_metrics && Object.keys(version.validation_metrics).length > 0) {
                    const metrics = version.validation_metrics;
                    const entries = Object.entries(metrics).slice(0, 3); // Show first 3 metrics
                    metricsHtml = entries.map(([k, v]) => {
                        const val = typeof v === 'number' ? v.toFixed(3) : v;
                        return `<small style="display: block;">${k}: <strong>${val}</strong></small>`;
                    }).join('');
                }

                return `
                    <tr>
                        <td><strong>${version.version}</strong></td>
                        <td>${getStatusBadge(version.status)}</td>
                        <td style="font-size: 0.85em;">${createdDate}</td>
                        <td><span class="badge">${version.model_type || 'unknown'}</span></td>
                        <td style="font-size: 0.85em;">${sizeMB}</td>
                        <td style="font-size: 0.85em;">${metricsHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        // ====================================================================
        // Configure & Train Modal (Phase 2)
        // ====================================================================

        let currentTrainingModel = {name: null, type: null};  // Store current model info

        // Preset configurations (model-specific to match backend defaults)
        const TRAINING_PRESETS = {
            // Stock regime detector presets (needs 20 years for all regimes)
            stock_regime_detector: {
                standard: { days: 1825, epochs: 100, patience: 15, description: '~8-12 min (5 years)' },
                deep: { days: 3650, epochs: 150, patience: 20, description: '~15-25 min (10 years)' },
                ultra: { days: 7300, epochs: 200, patience: 25, description: '~25-40 min (20 years, all regimes)' }
            },
            // Bitcoin regime detectors (max 13.7 years of reliable data since 2012)
            btc_regime_detector: {
                standard: { days: 1825, epochs: 150, patience: 20, description: '~10-15 min (5 years)' },
                deep: { days: 3650, epochs: 175, patience: 22, description: '~20-30 min (10 years)' },
                ultra: { days: 5000, epochs: 200, patience: 25, description: '~30-45 min (13.7 years max)' }
            },
            btc_regime_hmm: {
                standard: { days: 1825, epochs: 150, patience: 20, description: '~10-15 min (5 years)' },
                deep: { days: 3650, epochs: 175, patience: 22, description: '~20-30 min (10 years)' },
                ultra: { days: 5000, epochs: 200, patience: 25, description: '~30-45 min (13.7 years max)' }
            },
            // Volatility forecaster (2 years optimal for volatility patterns)
            volatility_forecaster: {
                standard: { days: 365, epochs: 100, patience: 15, description: '~5-8 min (1 year)' },
                deep: { days: 730, epochs: 150, patience: 20, description: '~10-15 min (2 years)' },
                ultra: { days: 1095, epochs: 200, patience: 25, description: '~15-25 min (3 years)' }
            },
            // Generic fallback (for unknown models)
            _generic: {
                standard: { days: 730, epochs: 100, patience: 15, description: '~5-10 min (2 years)' },
                deep: { days: 1825, epochs: 150, patience: 20, description: '~15-25 min (5 years)' },
                ultra: { days: 3650, epochs: 200, patience: 25, description: '~25-40 min (10 years)' }
            }
        };

        // Helper function to get presets for a specific model
        function getPresetsForModel(modelName) {
            return TRAINING_PRESETS[modelName] || TRAINING_PRESETS._generic;
        }

        async function showConfigureTrainModal(modelName, modelType) {
            currentTrainingModel = {name: modelName, type: modelType};

            // Open modal
            document.getElementById('configureTrainModal').classList.add('show');
            document.getElementById('config-train-name').textContent = modelName;

            // Show loading
            document.getElementById('config-train-loading').style.display = 'block';
            document.getElementById('config-train-error').style.display = 'none';
            document.getElementById('config-train-form').style.display = 'none';
            document.getElementById('start-training-btn').style.display = 'none';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Fetch default parameters from NEW endpoint
                const response = await fetch(`/admin/ml/models/${modelName}/default-params`, {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch default params: ${response.status}`);
                }

                const result = await response.json();
                const defaultConfig = result.data?.config || result.config;

                if (!defaultConfig) {
                    throw new Error('No config data returned');
                }

                // Populate form with default values
                populateConfigForm(defaultConfig, modelType);

                // Show/hide volatility-specific params
                document.getElementById('volatility-params').style.display =
                    (modelType === 'volatility') ? 'block' : 'none';

                // Setup preset selector listener
                setupPresetSelector();

                // Update time estimate initially
                updateTimeEstimate();

                // Hide loading, show form
                document.getElementById('config-train-loading').style.display = 'none';
                document.getElementById('config-train-form').style.display = 'block';
                document.getElementById('start-training-btn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error loading config form:', error);

                // Show error
                document.getElementById('config-train-loading').style.display = 'none';
                document.getElementById('config-train-error').style.display = 'block';
                document.getElementById('config-train-error').textContent = `Error: ${error.message}`;
            }
        }

        function populateConfigForm(config, modelType) {
            // Data config
            document.getElementById('config-days').value = config.days || 730;
            document.getElementById('config-split').value = config.train_val_split || 0.8;

            // Hyperparameters
            document.getElementById('config-epochs').value = config.epochs || 100;
            document.getElementById('config-patience').value = config.patience || 15;
            document.getElementById('config-batch').value = config.batch_size || 32;
            document.getElementById('config-lr').value = config.learning_rate || 0.001;

            // Volatility-specific
            if (modelType === 'volatility') {
                document.getElementById('config-hidden').value = config.hidden_size || 64;
                document.getElementById('config-min-r2').value = config.min_r2 || 0.5;
            }
        }

        function setupPresetSelector() {
            const presetSelect = document.getElementById('preset-select');
            presetSelect.addEventListener('change', (e) => {
                const presetName = e.target.value;

                if (presetName === 'custom') {
                    // Enable all inputs for custom configuration
                    return;
                }

                // Get presets for current model
                const modelPresets = getPresetsForModel(currentTrainingModel.name);
                const preset = modelPresets[presetName];
                if (preset) {
                    // Apply preset values
                    document.getElementById('config-days').value = preset.days;
                    document.getElementById('config-epochs').value = preset.epochs;
                    document.getElementById('config-patience').value = preset.patience;

                    // Update time estimate
                    updateTimeEstimate();
                }
            });

            // Also update estimate when inputs change
            const inputs = ['config-days', 'config-epochs'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateTimeEstimate);
            });
        }

        function updateTimeEstimate() {
            const days = parseInt(document.getElementById('config-days').value) || 730;
            const epochs = parseInt(document.getElementById('config-epochs').value) || 100;

            // Simple time estimation formula (very rough)
            const baseTime = (days / 365) * (epochs / 100);  // Relative to standard (365d, 100 epochs = 5 min)
            const estimatedMinutes = baseTime * 5;

            let timeText = '';
            if (estimatedMinutes < 3) {
                timeText = `GPU (RTX 4080): ~1-2 minutes<br>CPU: ~2-5 minutes`;
            } else if (estimatedMinutes < 8) {
                timeText = `GPU (RTX 4080): ~${Math.round(estimatedMinutes)}-${Math.round(estimatedMinutes * 1.5)} minutes<br>CPU: ~${Math.round(estimatedMinutes * 2)}-${Math.round(estimatedMinutes * 3)} minutes`;
            } else if (estimatedMinutes < 20) {
                timeText = `GPU (RTX 4080): ~${Math.round(estimatedMinutes)}-${Math.round(estimatedMinutes * 1.2)} minutes<br>CPU: ~${Math.round(estimatedMinutes * 2)}-${Math.round(estimatedMinutes * 2.5)} minutes`;
            } else {
                timeText = `GPU (RTX 4080): ~${Math.round(estimatedMinutes)}-${Math.round(estimatedMinutes * 1.5)} minutes<br>CPU: ~${Math.round(estimatedMinutes * 3)}-${Math.round(estimatedMinutes * 4)} minutes<br><em style="color: var(--theme-warning);">‚ö†Ô∏è Long training - consider using a preset with fewer epochs</em>`;
            }

            document.getElementById('time-estimate-text').innerHTML = timeText;
        }

        async function submitTraining() {
            const modelName = currentTrainingModel.name;
            const modelType = currentTrainingModel.type;

            if (!modelName || !modelType) {
                alert('Error: Model information missing');
                return;
            }

            // Gather config from form
            const config = {
                days: parseInt(document.getElementById('config-days').value),
                train_val_split: parseFloat(document.getElementById('config-split').value),
                epochs: parseInt(document.getElementById('config-epochs').value),
                patience: parseInt(document.getElementById('config-patience').value),
                batch_size: parseInt(document.getElementById('config-batch').value),
                learning_rate: parseFloat(document.getElementById('config-lr').value)
            };

            // Add volatility-specific params if applicable
            if (modelType === 'volatility') {
                config.hidden_size = parseInt(document.getElementById('config-hidden').value);
                config.min_r2 = parseFloat(document.getElementById('config-min-r2').value);
                config.symbols = ['BTC', 'ETH', 'SOL'];  // Could be made configurable
            }

            // Disable button and show loading
            const btn = document.getElementById('start-training-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Starting...';

            try {
                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // POST to train endpoint with config body
                const response = await fetch(`/admin/ml/train/${modelName}?model_type=${modelType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': activeUser
                    },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Training failed: ${response.status}`);
                }

                const result = await response.json();

                // Show success message
                alert(`‚úÖ Training started successfully!\n\nJob ID: ${result.data?.job_id || result.job_id}\nModel: ${modelName}\nConfig: Custom (${config.days}d, ${config.epochs} epochs)`);

                // Close modal
                closeModal('configureTrainModal');

                // Reload ML models table
                if (typeof loadMLTab === 'function') {
                    loadMLTab();
                }

            } catch (error) {
                console.error('Error starting training:', error);
                alert(`‚ùå Training failed: ${error.message}`);

                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üöÄ Start Training';
            }
        }

        // ====================================================================
        // Export functions to global scope for onclick handlers
        // ====================================================================

        window.showCreateUserModal = showCreateUserModal;
        window.submitCreateUser = submitCreateUser;
        window.editUser = editUser;
        window.submitEditUser = submitEditUser;
        window.deleteUser = deleteUser;
        window.submitDeleteUser = submitDeleteUser;
        window.closeModal = closeModal;
        window.loadLogsContent = loadLogsContent;
        window.changeLogsFile = changeLogsFile;
        window.changeLogsLevel = changeLogsLevel;
        window.changeLogsSearch = changeLogsSearch;
        window.prevLogsPage = prevLogsPage;
        window.nextLogsPage = nextLogsPage;
        window.refreshCacheStats = refreshCacheStats;
        window.clearCacheIndividual = clearCacheIndividual;
        window.clearAllCaches = clearAllCaches;
        window.clearExpiredEntries = clearExpiredEntries;
        window.refreshMLModels = refreshMLModels;
        window.triggerTraining = triggerTraining;
        window.loadTrainingJobs = loadTrainingJobs;
        window.hideTrainingJobs = hideTrainingJobs;
        window.cancelJob = cancelJob;
        window.showModelInfo = showModelInfo;
        window.showVersionHistory = showVersionHistory;
        window.showConfigureTrainModal = showConfigureTrainModal;  // NEW (Phase 2)
        window.submitTraining = submitTraining;  // NEW (Phase 2)

        // Initialize tab from URL hash (must be called after all functions are defined)
        initializeTabFromHash();
    </script>
</body>
</html>
