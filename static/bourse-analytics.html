<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Stock Analytics - SmartFolio</title>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <link rel="stylesheet" href="css/view-modes.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/saxo-dashboard.css">
    <link rel="stylesheet" href="css/bourse-analytics.css">
    <script type="module" src="components/data-freshness.js"></script>
    <script type="module" src="network-state-manager.js"></script>
    <script type="module" src="core/sentry-init.js"></script>
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/view-toggle.js"></script>
    <script type="module" src="components/domain-nav.js"></script>
    <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();
    // =================================

    // ===== VIEW MODE MANAGER (Feb 2026) =====
    import { ViewModeManager } from './core/view-mode-manager.js';
    ViewModeManager.init();
    // ========================================

    import { initDeepLinks } from './components/deep-links.js';
    import { wealthContextBar } from './components/WealthContextBar.js';
    import { safeFetch, cachedApiCall, hasCacheHit } from './core/fetcher.js';

    // Anchors for bourse-analytics.html
    initDeepLinks({
        'risk': 'Risk Analysis',
        'analytics': 'Analytics'
    });

    window.wealthContextBar = wealthContextBar;
    window.safeFetch = safeFetch;
    window.cachedApiCall = cachedApiCall;
    window.hasCacheHit = hasCacheHit;
    </script>
    <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- AI Chat Component (Global System) -->
    <link rel="stylesheet" href="/static/components/ai-chat.css">
    <script type="module">
        import { initAIChat } from '/static/components/ai-chat-init.js';
        initAIChat('bourse-analytics');
    </script>
</head>

<body>
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div>
                    <h1>üìä Stock Analytics</h1>
                    <p style="color: var(--theme-text-muted); margin: 0;">Risk Analysis & Advanced Analytics</p>
                </div>
                <span
                    id="cacheIndicator"
                    style="display: none; padding: 0.25rem 0.75rem; background: var(--success); color: white; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">
                    ‚ö° Cached
                </span>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <view-toggle></view-toggle>
                <button
                    id="btnForceRefresh"
                    onclick="loadBourseData(true)"
                    style="padding: 0.75rem 1.25rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"
                    title="Force data reload (bypass cache)">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- Navigation contextuelle Bourse Domain (Feb 2026) -->
        <domain-nav domain="bourse"></domain-nav>

        <!-- Main Content (initially empty) -->
        <div id="mainContent">
            <div class="loading">üìä Initial loading...</div>
        </div>

        <!-- Dashboard Content (hidden by default) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('risk', event)">Risk Analysis</button>
                <button class="tab-btn" onclick="switchTab('analytics', event)">Analytics</button>
            </div>

            <!-- Risk Tab -->
            <div id="risk" class="tab-content active">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Risk Score (Stocks)</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="exportRiskPDF()" style="padding: 0.5rem 1rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üìÑ Export PDF
                            </button>
                        </div>
                    </div>
                    <div id="riskSummary"><div class="loading">Computing‚Ä¶</div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">Main Metrics</h3></div>
                        <div id="riskMetrics" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">Concentration & Diversification</h3></div>
                        <div id="riskStructure" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div class="dashboard-card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">‚ö†Ô∏è Critical Alerts</h3>
                        <div class="card-badge" id="alertsBadge">0 active</div>
                    </div>
                    <div id="criticalAlerts">
                        <div style="padding: 1.5rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚úÖ No critical alerts. Portfolio within safe thresholds.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <!-- ML Insights Section -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">ü§ñ ML Insights & Predictions</h3>
                        <div class="card-badge" id="mlBadge">Loading...</div>
                    </div>
                    <div id="mlInsights"><div class="loading">Loading ML predictions‚Ä¶</div></div>
                </div>

                <!-- Advanced Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üìä Advanced Analytics
                    </h2>

                    <!-- Correlation Heatmap -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üîó Correlation Matrix & Clustering</h3>
                            <div class="card-badge" id="correlationBadge">Portfolio-wide</div>
                        </div>
                        <div id="correlationAnalysis"><div class="loading">Loading correlation matrix‚Ä¶</div></div>
                    </div>

                    <!-- Stress Testing -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üí• Stress Testing Scenarios</h3>
                            <div class="card-badge" id="stressBadge">Interactive</div>
                        </div>
                        <div id="stressTestingUI"><div class="loading">Loading stress testing‚Ä¶</div></div>
                    </div>

                    <!-- ML Regime History -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">ü§ñ ML Regime History & Forecast</h3>
                            <div class="card-badge" id="regimeBadge">SPY Benchmark</div>
                        </div>
                        <div id="regimeHistory"><div class="loading">Loading ML regime history‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Specialized Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üéØ Specialized Analytics
                    </h2>

                    <!-- Sector Rotation -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üìä Sector Rotation Analysis</h3>
                            <div class="card-badge" id="sectorBadge">Portfolio-wide</div>
                        </div>
                        <div id="sectorRotation"><div class="loading">Loading sector rotation data‚Ä¶</div></div>
                    </div>

                    <!-- Margin Monitoring -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">‚ö†Ô∏è Margin Monitoring</h3>
                            <div class="card-badge" id="marginBadge">Portfolio-wide</div>
                        </div>
                        <div id="marginMonitoring"><div class="loading">Loading margin data‚Ä¶</div></div>
                    </div>

                    <!-- Ticker-Specific Analytics -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">üîç Ticker-Specific Analysis</h3>
                            <select id="tickerSelector" style="padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text); font-size: 0.875rem;">
                                <option value="">Select a ticker...</option>
                            </select>
                        </div>

                        <div id="tickerAnalytics" style="display: none;">
                            <!-- Beta Forecast -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìà Beta Forecast vs SPY</h4>
                                <div id="betaForecast"><div class="loading">Loading beta forecast‚Ä¶</div></div>
                            </div>

                            <!-- Earnings Predictor -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÖ Earnings Impact Prediction</h4>
                                <div id="earningsPredictor"><div class="loading">Loading earnings data‚Ä¶</div></div>
                            </div>

                            <!-- Dividend Analysis -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üí∞ Dividend Analysis</h4>
                                <div id="dividendAnalysis"><div class="loading">Loading dividend data‚Ä¶</div></div>
                            </div>
                        </div>

                        <div id="tickerPlaceholder" style="padding: 2rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            üëÜ Select a ticker above to view Beta Forecast, Earnings Predictor, and Dividend Analysis
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let currentPortfolioData = null;
        let currentFileKey = null;
        let analyticsTabLoaded = false;
        let forceRefreshFlag = false;

        // Chart instances (prevent memory leaks)
        let regimeTimelineChartInstance = null;
        let stressTestChartInstance = null;
        let regimeProbabilitiesChartInstance = null;
        let betaForecastChartInstance = null;

        // Plotly lazy loading state
        let plotlyLoaded = false;
        let pdfLibsLoaded = false;

        function bourseCacheKey(section) {
            const user = localStorage.getItem('activeUser') || 'demo';
            return `bourse:${user}:${section}`;
        }

        function showCacheIndicator() {
            const el = document.getElementById('cacheIndicator');
            if (el) { el.style.display = 'inline-block'; }
        }

        function cacheOpts(fetchOpts = {}) {
            return { ...fetchOpts, forceRefresh: forceRefreshFlag };
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            debugLogger.debug('üöÄ Bourse Analytics page loaded');

            // Resolve source type from localStorage
            await resolveSourceType();

            // Load data
            await loadBourseData();
        });

        // Resolve source type dynamically (same logic as saxo-dashboard.html)
        async function resolveSourceType() {
            // ‚úÖ FIX: Read bourseSource dynamically from wealthContextBar first
            let bourseSource = window.wealthContextBar?.getContext()?.bourse;
            if (!bourseSource) {
                bourseSource = localStorage.getItem('bourseSource');
                debugLogger.debug(`‚ö†Ô∏è wealthContextBar not ready, using localStorage: ${bourseSource}`);
            }

            // Reset state
            currentFileKey = null;
            window.saxoSourceType = null;

            if (!bourseSource) {
                debugLogger.warn('No bourse source configured');
                return;
            }

            // Determine source type
            if (bourseSource === 'manual_bourse') {
                window.saxoSourceType = 'manual';
            } else if (bourseSource.startsWith('api:')) {
                window.saxoSourceType = 'api';
            } else if (bourseSource.startsWith('saxo:')) {
                window.saxoSourceType = 'csv';
                currentFileKey = bourseSource.substring(5); // Remove 'saxo:' prefix
            }

            debugLogger.debug(`üîç Source detection: ${bourseSource} ‚Üí ${window.saxoSourceType}`);
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tab if needed
            if (currentPortfolioData) {
                if (tabName === 'risk') {
                    loadRiskAnalytics();
                } else if (tabName === 'analytics') {
                    loadAnalyticsTab();
                }
            }
        }

        // ==================== DATA LOADING ====================
        async function loadBourseData(forceRefresh = false) {
            debugLogger.debug('üìä Loading Bourse data for Analytics...');
            forceRefreshFlag = forceRefresh;
            if (forceRefresh) {
                analyticsTabLoaded = false;
                document.getElementById('cacheIndicator').style.display = 'none';
            }

            try {
                document.getElementById('mainContent').innerHTML = '<div class="loading">üìä Loading stock market data...</div>';
                document.getElementById('dashboardContent').style.display = 'none';

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Check if source is configured
                if (!window.saxoSourceType) {
                    document.getElementById('mainContent').innerHTML = `
                        <div class="dashboard-card" style="padding: 3rem; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1.5rem;">üìä</div>
                            <h2 style="margin-bottom: 1rem; color: var(--theme-text);">Source not configured</h2>
                            <p style="color: var(--theme-text-muted); margin-bottom: 1.5rem;">
                                Please select a Stock data source in the Dashboard.
                            </p>
                            <a href="saxo-dashboard.html" class="btn primary" style="padding: 0.75rem 1.5rem; text-decoration: none;">
                                Go to Saxo Dashboard ‚Üí
                            </a>
                        </div>
                    `;
                    return;
                }

                // Get positions to have portfolio context
                let portfolioData = { positions: [], summary: {} };

                if (window.saxoSourceType === 'manual') {
                    const response = await window.safeFetch('/api/sources/v2/bourse/balances', {
                        headers: { 'X-User': activeUser }
                    });
                    if (response.ok) {
                        const data = response.data?.data || response.data;
                        const items = data?.data?.items || data?.items || [];
                        portfolioData.positions = items.map(item => ({
                            symbol: item.symbol || item.asset_name,
                            ticker: item.symbol || item.asset_name,
                            market_value_usd: Number(item.value_usd || item.value || 0)
                        }));
                    }
                } else if (window.saxoSourceType === 'api') {
                    const response = await window.safeFetch(`${window.getApiBase()}/api/saxo/api-positions`, {
                        headers: { 'X-User': activeUser }
                    });
                    if (response.status === 401) {
                        document.getElementById('mainContent').innerHTML = `
                            <div class="dashboard-card" style="padding: 3rem; text-align: center;">
                                <div style="font-size: 4rem; margin-bottom: 1.5rem;">üîê</div>
                                <h2 style="margin-bottom: 1rem; color: var(--theme-text);">Saxo Connection Required</h2>
                                <p style="color: var(--theme-text-muted); margin-bottom: 1.5rem;">
                                    Please connect to your Saxo Bank account to access analytics.
                                </p>
                                <a href="saxo-dashboard.html" class="btn primary" style="padding: 0.75rem 1.5rem; text-decoration: none;">
                                    Go to Saxo Dashboard ‚Üí
                                </a>
                            </div>
                        `;
                        return;
                    }
                    if (response.ok) {
                        const data = response.data?.data || response.data;
                        const innerData = data?.data || data;
                        portfolioData.positions = (innerData?.positions || []).map(pos => ({
                            symbol: pos.symbol,
                            ticker: pos.symbol,
                            market_value_usd: pos.market_value || 0
                        }));
                    }
                } else if (window.saxoSourceType === 'csv') {
                    let portfoliosUrl = '/api/saxo/portfolios';
                    if (currentFileKey) {
                        portfoliosUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                    }
                    const response = await window.safeFetch(`${window.getApiBase()}${portfoliosUrl}`, {
                        headers: { 'X-User': activeUser }
                    });
                    if (response.ok) {
                        const portfolios = response.data?.portfolios || [];
                        if (portfolios.length > 0) {
                            const portfolio = portfolios[0];
                            let detailUrl = `/api/saxo/portfolios/${portfolio.portfolio_id}`;
                            if (currentFileKey) {
                                detailUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                            }
                            const detailResponse = await window.safeFetch(`${window.getApiBase()}${detailUrl}`, {
                                headers: { 'X-User': activeUser }
                            });
                            if (detailResponse.ok) {
                                portfolioData = detailResponse.data;
                            }
                        }
                    }
                }

                currentPortfolioData = portfolioData;

                // Hide loading, show content
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Load active tab
                const activeTab = document.querySelector('.tab-btn.active')?.textContent?.trim();
                if (activeTab === 'Analytics') {
                    await loadAnalyticsTab();
                } else {
                    await loadRiskAnalytics();
                }

                forceRefreshFlag = false;
                debugLogger.debug('‚úÖ Bourse Analytics data loaded');

            } catch (error) {
                forceRefreshFlag = false;
                debugLogger.error('Error loading Bourse data:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div class="error-message">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // ==================== RISK ANALYTICS ====================
        async function loadRiskAnalytics() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                const key = bourseCacheKey('risk-dashboard');
                if (!forceRefreshFlag && window.hasCacheHit(key, 'bourse')) showCacheIndicator();
                else {
                    document.getElementById('riskSummary').innerHTML = '<div class="loading">Computing risk metrics‚Ä¶</div>';
                    document.getElementById('riskMetrics').innerHTML = '<div class="loading">‚Ä¶</div>';
                    document.getElementById('riskStructure').innerHTML = '<div class="loading">‚Ä¶</div>';
                }

                let riskUrl = `/api/risk/bourse/dashboard?user_id=${activeUser}`;
                if (window.saxoSourceType === 'manual') {
                    riskUrl += `&source=manual_bourse`;
                } else if (window.saxoSourceType === 'api') {
                    riskUrl += `&source=saxobank_api`;
                } else if (currentFileKey) {
                    riskUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const fullRiskUrl = `${window.getApiBase()}${riskUrl}`;
                const riskData = await window.cachedApiCall(key, fullRiskUrl, cacheOpts({ headers: { 'X-User': activeUser } }), 'bourse');

                const { risk, coverage, positions_count, total_value_usd } = riskData;
                const score = risk?.score ?? 0;
                const level = risk?.level ?? 'N/A';

                const getRiskColor = (lvl) => {
                    const levelUpper = String(lvl).toUpperCase();
                    if (levelUpper === 'LOW' || levelUpper === 'VERY_LOW') return 'var(--success)';
                    if (levelUpper === 'MEDIUM' || levelUpper === 'MODERATE') return 'var(--warning)';
                    if (levelUpper === 'HIGH' || levelUpper === 'VERY_HIGH') return 'var(--danger)';
                    if (levelUpper === 'CRITICAL') return '#8B0000';
                    return 'var(--theme-text-muted)';
                };

                const riskColor = getRiskColor(level);

                const metricWithTooltip = (label, tooltip) => `
                    <span class="metric-with-tooltip">
                        <strong>${label}</strong>
                        <span class="tooltip-icon" data-tooltip="${tooltip}">i</span>
                    </span>`;

                document.getElementById('riskSummary').innerHTML = `
                  <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;">
                      <div class="metric-large" style="color:${riskColor}">${score.toFixed(0)}<span style="font-size:1rem;color:var(--theme-text-muted);">/100</span></div>
                      <div class="metric-label">
                        ${metricWithTooltip('Risk Score (higher = safer)', 'Score de risque global (0-100)')}
                      </div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                      <div style="font-weight:600;font-size:1.25rem;color:${riskColor};margin-bottom:0.5rem;">${level}</div>
                      <div style="color:var(--theme-text-muted);font-size:0.875rem;">
                        ${positions_count || 0} positions ‚Ä¢ $${(total_value_usd || 0).toLocaleString()}
                      </div>
                      <div style="margin-top:0.5rem;color:var(--theme-text-muted);font-size:0.875rem;">
                        ${metricWithTooltip('Coverage: ' + (coverage*100).toFixed(0) + '%', 'Price data coverage')}
                      </div>
                    </div>
                  </div>`;

                const m = risk?.metrics || {};
                const formatPct = (val) => ((val ?? 0) * 100).toFixed(2);

                document.getElementById('riskMetrics').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr><td>${metricWithTooltip('VaR (95%, 1d)', 'Value at Risk')}</td><td style="color:var(--danger)">${formatPct(m.var_95_1d)}%</td></tr>
                      <tr><td>${metricWithTooltip('Volatility (30d)', '30-day volatility')}</td><td>${formatPct(m.volatility_30d)}%</td></tr>
                      <tr><td>${metricWithTooltip('Volatility (252d)', 'Annual volatility')}</td><td>${formatPct(m.volatility_252d)}%</td></tr>
                      <tr><td>${metricWithTooltip('Max Drawdown', 'Max loss from peak')}</td><td style="color:var(--danger)">${formatPct(m.max_drawdown)}%</td></tr>
                      <tr><td>${metricWithTooltip('Sharpe Ratio', 'Risk-adjusted return')}</td><td style="color:${(m.sharpe_ratio??0) > 1 ? 'var(--success)' : 'var(--theme-text)'}">${(m.sharpe_ratio??0).toFixed(2)}</td></tr>
                      <tr><td>${metricWithTooltip('Sortino Ratio', 'Sortino ratio')}</td><td>${(m.sortino_ratio??0).toFixed(2)}</td></tr>
                    </tbody>
                  </table>`;

                document.getElementById('riskStructure').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr><td>${metricWithTooltip('Beta (Portfolio)', 'Beta vs market')}</td><td>${(m.beta_portfolio??1.0).toFixed(2)}</td></tr>
                      <tr><td>${metricWithTooltip('Calmar Ratio', 'Return/Drawdown')}</td><td>${(m.calmar_ratio??0).toFixed(2)}</td></tr>
                      <tr><td>${metricWithTooltip('Volatility (90d)', '3-month volatility')}</td><td>${formatPct(m.volatility_90d)}%</td></tr>
                      <tr><td>${metricWithTooltip('VaR Method', 'Calculation method')}</td><td style="text-transform:capitalize;">${m.var_method || 'historical'}</td></tr>
                      <tr><td>${metricWithTooltip('Drawdown Days', 'Days since peak')}</td><td>${m.drawdown_days ?? 'N/A'}</td></tr>
                    </tbody>
                  </table>`;

            } catch (e) {
                debugLogger.error('Risk analytics load failed', e);
                document.getElementById('riskSummary').innerHTML = `
                  <div class="error-message"><strong>Loading error</strong><br>${e.message}</div>`;
            }

            // Load alerts in parallel
            loadCriticalAlerts().catch(err => debugLogger.warn('Alerts loading failed', err));
        }

        // ==================== CRITICAL ALERTS ====================
        async function loadCriticalAlerts() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                let alertsUrl = `/api/risk/bourse/alerts?user_id=${activeUser}`;
                if (window.saxoSourceType === 'manual') {
                    alertsUrl += `&source=manual_bourse`;
                } else if (window.saxoSourceType === 'api') {
                    alertsUrl += `&source=saxobank_api`;
                } else if (currentFileKey) {
                    alertsUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const fullAlertsUrl = `${window.getApiBase()}${alertsUrl}`;
                const data = await window.cachedApiCall(bourseCacheKey('alerts'), fullAlertsUrl, cacheOpts({ headers: { 'X-User': activeUser } }), 'bourse');
                const { critical, warnings, info, summary } = data;

                const totalAlerts = summary?.total || 0;
                const badge = document.getElementById('alertsBadge');

                if (totalAlerts === 0) {
                    badge.textContent = '0 active';
                    badge.style.background = 'var(--success)';
                    badge.style.color = 'white';
                    document.getElementById('criticalAlerts').innerHTML = `
                        <div class="alert-empty">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <div style="font-weight: 600; font-size: 1.125rem;">Healthy Portfolio</div>
                            <div style="font-size: 0.875rem;">No alerts detected.</div>
                        </div>
                    `;
                } else {
                    badge.textContent = `${totalAlerts} alert${totalAlerts > 1 ? 's' : ''}`;
                    badge.style.background = summary?.critical > 0 ? 'var(--danger)' : 'var(--warning)';
                    badge.style.color = 'white';

                    let html = '';
                    (critical || []).forEach(alert => {
                        html += renderAlert(alert, 'critical');
                    });
                    (warnings || []).forEach(alert => {
                        html += renderAlert(alert, 'warning');
                    });
                    (info || []).forEach(alert => {
                        html += renderAlert(alert, 'info');
                    });
                    document.getElementById('criticalAlerts').innerHTML = html;
                }

            } catch (e) {
                debugLogger.error('Critical alerts load failed', e);
                document.getElementById('criticalAlerts').innerHTML = `
                    <div class="alert-empty" style="color: var(--danger);">‚ö†Ô∏è Failed to load alerts</div>
                `;
            }
        }

        function renderAlert(alert, level) {
            const icons = { critical: 'üî¥', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const colors = { critical: 'var(--danger)', warning: 'var(--warning)', info: 'var(--info)' };
            return `
                <div class="alert alert-${level}" style="border-left: 4px solid ${colors[level]}; padding: 1rem; margin-bottom: 0.75rem; background: color-mix(in oklab, ${colors[level]} 10%, transparent); border-radius: var(--radius-sm);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${icons[level]} ${alert.title}</div>
                    <div style="font-size: 0.875rem; color: var(--theme-text-muted);">${alert.recommendation || alert.impact || ''}</div>
                </div>
            `;
        }

        // ==================== ANALYTICS TAB ====================
        async function loadAnalyticsTab() {
            if (analyticsTabLoaded) {
                debugLogger.debug('Analytics tab already loaded');
                return;
            }

            debugLogger.debug('Loading Analytics tab...');
            analyticsTabLoaded = true;

            Promise.all([
                loadMLInsights().catch(err => debugLogger.warn('ML insights failed', err)),
                loadAdvancedAnalytics().catch(err => debugLogger.warn('Advanced analytics failed', err)),
                loadSpecializedAnalytics().catch(err => debugLogger.warn('Specialized analytics failed', err))
            ]);
        }

        // ==================== ML INSIGHTS ====================
        async function loadMLInsights() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Get top stocks from portfolio for predictions
                const topStocks = currentPortfolioData?.summary?.top_holdings?.slice(0, 3) || [];
                const benchmark = 'SPY';
                const firstStockRaw = topStocks[0]?.symbol || currentPortfolioData?.positions?.[0]?.symbol || 'AAPL';
                const firstStock = firstStockRaw.split(':')[0];

                const regimeKey = bourseCacheKey('ml-regime');
                const forecastKey = bourseCacheKey('ml-forecast');
                if (!forceRefreshFlag && window.hasCacheHit(regimeKey, 'bourse')) showCacheIndicator();
                else document.getElementById('mlBadge').textContent = 'Analyzing...';

                const baseUrl = window.location.origin;
                const opts = cacheOpts();
                const [regime, volatility] = await Promise.all([
                    window.cachedApiCall(regimeKey, `${baseUrl}/api/ml/bourse/regime?benchmark=${benchmark}&lookback_days=7300`, opts, 'bourse').catch(() => ({})),
                    window.cachedApiCall(forecastKey, `${baseUrl}/api/ml/bourse/forecast?symbol=${firstStock}&lookback_days=365`, opts, 'bourse').catch(() => ({}))
                ]);

                if (!regime.current_regime && !volatility.predictions) {
                    throw new Error('ML services unavailable. Please check backend logs.');
                }

                const regimeColor = getRegimeColor(regime.current_regime);
                const regimeConfidence = ((regime.confidence || 0) * 100).toFixed(0);

                // Extract volatility predictions
                const vol1d = volatility.predictions?.['1d']?.predicted_volatility;
                const vol7d = volatility.predictions?.['7d']?.predicted_volatility;
                const vol30d = volatility.predictions?.['30d']?.predicted_volatility;

                document.getElementById('mlInsights').innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:1.5rem;">
                        <!-- Market Regime -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Market Regime</div>
                            <div style="font-size:1.25rem;font-weight:700;color:${regimeColor};margin-bottom:0.25rem;">
                                ${regime.current_regime || 'Unknown'}
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);">
                                Confidence: ${regimeConfidence}% ‚Ä¢ ${regime.benchmark || benchmark}
                            </div>
                        </div>

                        <!-- Volatility Forecast -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Volatility Forecast (${firstStock})</div>
                            <div style="display:flex;gap:1rem;align-items:baseline;">
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">1d</div>
                                    <div style="font-weight:600;">${vol1d ? (vol1d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">7d</div>
                                    <div style="font-weight:600;">${vol7d ? (vol7d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">30d</div>
                                    <div style="font-weight:600;">${vol30d ? (vol30d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);margin-top:0.5rem;">
                                Model: ${volatility.model_type || 'Historical'}
                            </div>
                        </div>

                        <!-- Regime Characteristics -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Regime Characteristics</div>
                            ${Object.entries(regime.characteristics || {})
                                .map(([key, value]) => `
                                    <div style="display:flex;justify-content:space-between;margin:0.25rem 0;">
                                        <span style="font-size:0.8rem;text-transform:capitalize;">${key}:</span>
                                        <span style="font-size:0.8rem;font-weight:600;color:var(--theme-text);">${value}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>

                    <!-- Regime Probabilities -->
                    ${Object.keys(regime.regime_probabilities || {}).length > 0 ? `
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.75rem;">Regime Probabilities</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;">
                                ${Object.entries(regime.regime_probabilities || {})
                                    .sort(([,a], [,b]) => b - a)
                                    .map(([regimeName, prob]) => `
                                        <div style="text-align:center;">
                                            <div style="font-weight:700;font-size:1.1rem;color:${getRegimeColor(regimeName)};">
                                                ${(prob * 100).toFixed(0)}%
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--theme-text-muted);margin-top:0.25rem;">
                                                ${regimeName}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Model Limitations -->
                    <div style="margin-top:1rem;padding:0.75rem;background:var(--warning-bg);border-radius:var(--radius-sm);border:1px solid var(--warning);font-size:0.875rem;color:var(--theme-text);">
                        <div style="font-weight:600;color:var(--warning);margin-bottom:0.5rem;">‚ö†Ô∏è Model Limitations</div>
                        <div style="line-height:1.5;">
                            ‚Ä¢ <strong>Historical Pattern Matching:</strong> High confidence indicates strong resemblance to past regime periods<br>
                            ‚Ä¢ <strong>Not Predictive:</strong> Cannot anticipate black swans or rapid regime shifts<br>
                            ‚Ä¢ <strong>Use with Caution:</strong> Combine with fundamental analysis and risk management
                        </div>
                    </div>
                `;

                document.getElementById('mlBadge').textContent = `${regime.model_type || 'ML'} Active`;
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--success) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--success)';

            } catch (error) {
                debugLogger.error('ML insights load failed', error);
                document.getElementById('mlInsights').innerHTML = `
                    <div style="padding:1rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius-md);">
                        <div style="color:var(--warning);margin-bottom:0.5rem;"><strong>‚ö†Ô∏è ML Predictions Unavailable</strong></div>
                        <div style="font-size:0.875rem;color:var(--theme-text-muted);">
                            ${error.message || 'Failed to load ML predictions'}
                            <br><small>Models may need training or data may be insufficient.</small>
                        </div>
                    </div>
                `;
                document.getElementById('mlBadge').textContent = 'Fallback';
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--warning) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--warning)';
            }
        }

        // ==================== ADVANCED ANALYTICS ====================
        async function loadAdvancedAnalytics() {
            await Promise.all([
                loadCorrelationAnalysis().catch(err => debugLogger.warn('Correlation failed', err)),
                loadStressTestingUI().catch(err => debugLogger.warn('Stress testing failed', err)),
                loadRegimeHistory().catch(err => debugLogger.warn('Regime history failed', err))
            ]);
        }

        async function loadPlotlyLib() {
            if (plotlyLoaded) return;
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
            plotlyLoaded = true;
        }

        async function loadCorrelationAnalysis() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                const key = bourseCacheKey('correlation');
                if (!forceRefreshFlag && window.hasCacheHit(key, 'bourse')) showCacheIndicator();
                else document.getElementById('correlationAnalysis').innerHTML = '<div class="loading">Loading visualization library‚Ä¶</div>';

                await loadPlotlyLib();

                if (!window.hasCacheHit(key, 'bourse') || forceRefreshFlag) {
                    document.getElementById('correlationAnalysis').innerHTML = '<div class="loading">Calculating correlations‚Ä¶</div>';
                }

                let url = `/api/risk/bourse/advanced/correlation?user_id=${activeUser}&method=pearson&lookback_days=252`;
                if (window.saxoSourceType === 'manual') {
                    url += `&source=manual_bourse`;
                } else if (window.saxoSourceType === 'api') {
                    url += `&source=saxobank_api`;
                } else if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const data = await window.cachedApiCall(key, globalConfig.getApiUrl(url), cacheOpts(), 'bourse');
                const corrMatrix = data.correlation_matrix || {};
                const labels = data.clustering?.labels || Object.keys(corrMatrix);
                const corrArray = labels.map(row => labels.map(col => corrMatrix[row]?.[col] || 0));

                const heatmapDiv = 'correlationHeatmap';
                const dendrogramDiv = 'correlationDendrogram';

                document.getElementById('correlationAnalysis').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <span style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_positions} positions analyzed ‚Ä¢ Avg correlation: ${(data.avg_correlation || 0).toFixed(3)}
                        </span>
                    </div>

                    <!-- Correlation Heatmap -->
                    <div id="${heatmapDiv}" style="width: 100%; height: 600px;"></div>

                    <!-- Clustering Dendrogram -->
                    <div style="margin-top: 2rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üå≥ Hierarchical Clustering Dendrogram
                        </h4>
                        <div id="${dendrogramDiv}" style="width: 100%; height: 400px;"></div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Dendrogram shows hierarchical grouping based on correlation similarity (Ward linkage)
                        </div>
                    </div>

                    ${data.max_pair ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.875rem;">
                            <strong>Max correlation:</strong> ${data.max_pair.pair.join(' & ')} (${data.max_pair.correlation.toFixed(3)})<br>
                            <strong>Min correlation:</strong> ${data.min_pair.pair.join(' & ')} (${data.min_pair.correlation.toFixed(3)})
                        </div>
                    ` : ''}
                `;

                // Create heatmap with Plotly
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-text').trim() || '#e2e8f0';

                const heatmapTrace = {
                    z: corrArray,
                    x: labels,
                    y: labels,
                    type: 'heatmap',
                    colorscale: [
                        [0, '#ef4444'],
                        [0.5, '#f3f4f6'],
                        [1, '#22c55e']
                    ],
                    zmid: 0,
                    colorbar: {
                        title: 'Correlation',
                        titleside: 'right',
                        tickfont: { color: textColor },
                        titlefont: { color: textColor }
                    },
                    hovertemplate: '%{y} & %{x}<br>Correlation: %{z:.3f}<extra></extra>'
                };

                const layout = {
                    title: {
                        text: 'üîó Position Correlation Heatmap',
                        font: { color: textColor, size: 16 }
                    },
                    xaxis: {
                        title: '',
                        tickangle: -45,
                        tickfont: { color: textColor }
                    },
                    yaxis: {
                        title: '',
                        tickfont: { color: textColor }
                    },
                    width: null,
                    height: 600,
                    margin: { l: 150, r: 50, t: 50, b: 100 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: textColor }
                };

                Plotly.newPlot(heatmapDiv, [heatmapTrace], layout, { responsive: true, displayModeBar: false });

                // Create dendrogram if linkage matrix available
                const linkageMatrix = data.clustering?.linkage_matrix || [];
                if (linkageMatrix && linkageMatrix.length > 0) {
                    createDendrogram(dendrogramDiv, linkageMatrix, labels);
                }

                document.getElementById('correlationBadge').textContent = `${labels.length} positions`;

            } catch (error) {
                debugLogger.error('Correlation analysis failed', error);
                document.getElementById('correlationAnalysis').innerHTML = `<div class="error-message">Failed: ${error.message}</div>`;
            }
        }

        // Create Dendrogram using Plotly
        function createDendrogram(divId, linkageMatrix, labels) {
            try {
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-text').trim() || '#e2e8f0';
                const lineColor = '#cbd5e1';

                const n = labels.length;
                const traces = [];

                // Draw lines connecting clusters
                linkageMatrix.forEach((link, i) => {
                    const [idx1, idx2, distance, count] = link;
                    const y1 = idx1 < n ? idx1 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx1 - n]));
                    const y2 = idx2 < n ? idx2 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx2 - n]));

                    traces.push({
                        x: [distance, distance],
                        y: [y1, y2],
                        mode: 'lines',
                        line: { color: lineColor, width: 2 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });

                    if (idx1 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y1, y1],
                            mode: 'lines',
                            line: { color: lineColor, width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                    if (idx2 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y2, y2],
                            mode: 'lines',
                            line: { color: lineColor, width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                });

                // Add leaf labels
                const leafTrace = {
                    x: Array(n).fill(0),
                    y: Array.from({length: n}, (_, i) => i),
                    mode: 'markers+text',
                    marker: { size: 8, color: '#3b82f6' },
                    text: labels,
                    textposition: 'middle left',
                    textfont: { size: 10, color: textColor },
                    showlegend: false,
                    hovertemplate: '%{text}<extra></extra>'
                };
                traces.push(leafTrace);

                const layout = {
                    title: '',
                    showlegend: false,
                    xaxis: {
                        title: 'Distance (Correlation Dissimilarity)',
                        titlefont: { color: textColor },
                        tickfont: { color: textColor },
                        zeroline: false,
                        showgrid: true,
                        gridcolor: 'rgba(100, 116, 139, 0.2)'
                    },
                    yaxis: {
                        title: '',
                        showticklabels: false,
                        zeroline: false,
                        showgrid: false
                    },
                    width: null,
                    height: 400,
                    margin: { l: 120, r: 50, t: 50, b: 60 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: textColor }
                };

                Plotly.newPlot(divId, traces, layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                debugLogger.error('Failed to create dendrogram', error);
                document.getElementById(divId).innerHTML = `
                    <div class="error-message" style="padding: 1rem;">Dendrogram visualization unavailable</div>
                `;
            }
        }

        async function loadStressTestingUI() {
            document.getElementById('stressTestingUI').innerHTML = `
                <!-- Predefined Scenarios -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìã Generic Scenarios</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                        <button onclick="runStressTest('market_crash')" style="padding: 0.75rem; border: 1px solid var(--danger); background: color-mix(in oklab, var(--danger) 10%, transparent); color: var(--danger); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                            üìâ Market Crash (-10%)
                        </button>
                        <button onclick="runStressTest('market_rally')" style="padding: 0.75rem; border: 1px solid var(--success); background: color-mix(in oklab, var(--success) 10%, transparent); color: var(--success); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                            üìà Market Rally (+10%)
                        </button>
                        <button onclick="runStressTest('moderate_selloff')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                            ‚ö†Ô∏è Moderate Selloff (-5%)
                        </button>
                        <button onclick="runStressTest('rate_hike')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                            üìä Rate Hike (-3%)
                        </button>
                    </div>
                </div>

                <!-- Historical Crisis Scenarios -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìú Historical Crisis Scenarios</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
                        <button onclick="runStressTest('covid_crash')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">ü¶† COVID-19 (2020)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-34% S&P 500</div>
                        </button>
                        <button onclick="runStressTest('financial_crisis_2008')" style="padding: 0.75rem; border: 1px solid #8B0000; background: color-mix(in oklab, #8B0000 10%, transparent); color: #8B0000; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">üè¶ Financial Crisis (2008)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-57% peak-to-trough</div>
                        </button>
                        <button onclick="runStressTest('dotcom_bubble')" style="padding: 0.75rem; border: 1px solid #4B0082; background: color-mix(in oklab, #4B0082 10%, transparent); color: #4B0082; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">üíª Dot-com Bubble (2000)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-78% NASDAQ</div>
                        </button>
                        <button onclick="runStressTest('black_monday_1987')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">üìâ Black Monday (1987)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-22% in 1 day</div>
                        </button>
                        <button onclick="runStressTest('flash_crash_2010')" style="padding: 0.75rem; border: 1px solid #FF6347; background: color-mix(in oklab, #FF6347 10%, transparent); color: #FF6347; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">‚ö° Flash Crash (2010)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-9% in minutes</div>
                        </button>
                        <button onclick="runStressTest('brexit_2016')" style="padding: 0.75rem; border: 1px solid #FF8C00; background: color-mix(in oklab, #FF8C00 10%, transparent); color: #FF8C00; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                            <div style="font-size: 0.875rem; font-weight: 700;">üá¨üáß Brexit (2016)</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">-12% FTSE</div>
                        </button>
                    </div>
                </div>

                <!-- Custom Scenario -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üéöÔ∏è Custom Scenario</h4>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                        <label style="flex: 0 0 120px; font-weight: 600;">Market Impact:</label>
                        <input type="range" id="customStressSlider" min="-30" max="30" value="0" step="1" style="flex: 1;" oninput="updateStressSliderValue()">
                        <span id="customStressValue" style="flex: 0 0 80px; font-weight: 700; font-size: 1.25rem;">0%</span>
                    </div>
                    <button onclick="runCustomStressTest()" style="padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                        üß™ Run Custom Test
                    </button>
                </div>

                <!-- Results Section -->
                <div id="stressTestResults" style="display: none;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìä Stress Test Results</h4>
                    <div id="stressTestChart" style="width: 100%; height: 300px; margin-bottom: 1rem;"></div>
                    <div id="stressTestMetrics"></div>
                </div>
            `;
        }

        function updateStressSliderValue() {
            const slider = document.getElementById('customStressSlider');
            const display = document.getElementById('customStressValue');
            const value = parseInt(slider.value);
            display.textContent = (value >= 0 ? '+' : '') + value + '%';
            display.style.color = value >= 0 ? 'var(--success)' : 'var(--danger)';
        }

        async function runCustomStressTest() {
            const slider = document.getElementById('customStressSlider');
            const impact = parseInt(slider.value) / 100;
            await runStressTestWithImpact(impact);
        }

        async function runStressTestWithImpact(impact) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=custom&impact=${impact}`;
                if (window.saxoSourceType === 'manual') {
                    url += `&source=manual_bourse`;
                } else if (window.saxoSourceType === 'api') {
                    url += `&source=saxobank_api`;
                } else if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await window.safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Stress test failed');

                const data = response.data || response;
                displayStressTestResults(data, `Custom (${(impact*100).toFixed(0)}%)`);

            } catch (error) {
                debugLogger.error('Custom stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }

        function displayStressTestResults(data, scenarioName) {
            const pnlPct = data.pnl_pct || 0;
            const totalPnl = data.total_pnl || 0;
            const valueBefore = data.total_value_before || 0;
            const valueAfter = data.total_value_after || 0;
            const pnlColor = pnlPct >= 0 ? 'var(--success)' : 'var(--danger)';

            document.getElementById('stressTestMetrics').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Scenario</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${scenarioName || data.scenario}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Total P&L</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: ${pnlColor};">
                            ${pnlPct >= 0 ? '+' : ''}$${totalPnl.toLocaleString('en-US', {maximumFractionDigits: 0})}
                            (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                        </div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Portfolio Value</div>
                        <div style="font-size: 1rem; font-weight: 600;">
                            $${valueBefore.toLocaleString()} ‚Üí $${valueAfter.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            // Create Chart.js impact chart
            const ctx = document.createElement('canvas');
            document.getElementById('stressTestChart').innerHTML = '';
            document.getElementById('stressTestChart').appendChild(ctx);

            // Destroy previous chart to prevent memory leak
            if (stressTestChartInstance) {
                stressTestChartInstance.destroy();
            }

            stressTestChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current', 'Stressed'],
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: [valueBefore, valueAfter],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Stress Test Impact: ${scenarioName || data.scenario}`,
                            font: { size: 14, weight: '600' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Portfolio Value ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Display position impacts if available (convert object to array)
            if (data.position_impacts && typeof data.position_impacts === 'object') {
                const impacts = Object.entries(data.position_impacts)
                    .map(([symbol, impact]) => ({ symbol, ...impact }))
                    .sort((a, b) => a.pnl - b.pnl)
                    .slice(0, 10);

                if (impacts.length > 0) {
                    const impactsHtml = `
                        <div style="margin-top: 1.5rem;">
                            <h5 style="font-weight: 600; margin-bottom: 0.75rem;">Position Impacts (Top 10)</h5>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="positions-table">
                                    <thead>
                                        <tr><th scope="col">Symbol</th><th scope="col">Before</th><th scope="col">After</th><th scope="col">P&L</th></tr>
                                    </thead>
                                    <tbody>
                                        ${impacts.map(p => `
                                            <tr>
                                                <td style="font-weight: 600;">${p.symbol}</td>
                                                <td>$${(p.value_before || 0).toLocaleString()}</td>
                                                <td>$${(p.value_after || 0).toLocaleString()}</td>
                                                <td style="color: ${p.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                                    ${p.pnl >= 0 ? '+' : ''}$${(p.pnl || 0).toLocaleString()}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    document.getElementById('stressTestMetrics').innerHTML += impactsHtml;
                }
            }
        }

        async function runStressTest(scenario) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=${scenario}`;
                if (window.saxoSourceType === 'manual') {
                    url += `&source=manual_bourse`;
                } else if (window.saxoSourceType === 'api') {
                    url += `&source=saxobank_api`;
                } else if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await window.safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Stress test failed');

                const data = response.data || response;
                displayStressTestResults(data, null);

            } catch (error) {
                debugLogger.error('Stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }

        // Helper: Get regime color
        function getRegimeColor(regime) {
            const colors = {
                'Bear Market': '#dc2626',
                'Correction': '#ea580c',
                'Bull Market': '#22c55e',
                'Expansion': '#3b82f6'
            };
            return colors[regime] || '#64748b';
        }

        // Helper: Get regime emoji
        function getRegimeEmoji(regime) {
            const emojis = {
                'Bear Market': 'üî¥',
                'Correction': 'üü†',
                'Bull Market': 'üü¢',
                'Expansion': 'üîµ'
            };
            return emojis[regime] || '‚ùì';
        }

        async function loadRegimeHistory() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                const key = bourseCacheKey('regime-history');
                if (!forceRefreshFlag && window.hasCacheHit(key, 'bourse')) showCacheIndicator();

                const regimeUrl = `/api/ml/bourse/regime?user_id=${activeUser}&benchmark=SPY&lookback_days=7300`;
                const regimeData = await window.cachedApiCall(key, globalConfig.getApiUrl(regimeUrl), cacheOpts(), 'bourse');

                // Detect absurd probabilities
                const probabilities = regimeData.regime_probabilities || {};
                const probValues = Object.values(probabilities);
                const hasAbsurdProbs = probValues.some(p => p === 1.0) && probValues.filter(p => p === 0).length >= 3;

                const fallbackWarning = hasAbsurdProbs ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--warning-bg); border: 1px solid var(--warning); border-radius: var(--radius-md);">
                        <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Model Confidence Issue Detected</div>
                        <div style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            The ML model shows abnormal confidence (100%). The model will be recalibrated.
                        </div>
                    </div>
                ` : '';

                document.getElementById('regimeHistory').innerHTML = `
                    ${fallbackWarning}
                    <!-- Current Regime Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Regime</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${getRegimeColor(regimeData.current_regime)};">
                                ${getRegimeEmoji(regimeData.current_regime)} ${regimeData.current_regime}
                            </div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Confidence</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(regimeData.confidence * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Benchmark</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${regimeData.benchmark}</div>
                        </div>
                    </div>

                    <!-- Regime Probabilities Chart -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üìä Regime Probabilities
                        </h4>
                        <canvas id="regimeProbabilitiesChart" style="max-height: 250px;" role="img" aria-label="Stock regime probabilities chart"></canvas>
                    </div>

                    <!-- Regime Timeline -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin: 0; color: var(--theme-text);">
                                üìà Market Regime History with SPY Price
                            </h4>
                            <div id="timeframeSelector" style="display: flex; gap: 0.25rem;">
                                <button class="timeframe-btn active" data-days="365" onclick="updateRegimeTimeline(365)">1Y</button>
                                <button class="timeframe-btn" data-days="730" onclick="updateRegimeTimeline(730)">2Y</button>
                                <button class="timeframe-btn" data-days="1825" onclick="updateRegimeTimeline(1825)">5Y</button>
                                <button class="timeframe-btn" data-days="3650" onclick="updateRegimeTimeline(3650)">10Y</button>
                            </div>
                        </div>
                        <canvas id="regimeTimelineChart" style="max-height: 350px;" role="img" aria-label="Stock regime detection timeline chart"></canvas>
                        <div id="regimeTimelineInfo" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Loading historical regime data...
                        </div>
                    </div>
                `;

                // Create Regime Probabilities Bar Chart
                createRegimeProbabilitiesChart(regimeData.regime_probabilities);

                // Create Regime Timeline
                window.currentRegimeData = regimeData;
                await createRegimeTimelineChart(regimeData, 365);

                document.getElementById('regimeBadge').textContent = `${regimeData.benchmark} ‚Ä¢ ${regimeData.current_regime}`;

            } catch (error) {
                debugLogger.error('Failed to load regime history', error);
                document.getElementById('regimeHistory').innerHTML = `
                    <div class="error-message">Failed to load ML regime history: ${error.message}</div>
                `;
            }
        }

        // Create Regime Probabilities Bar Chart
        function createRegimeProbabilitiesChart(probabilities) {
            const ctx = document.getElementById('regimeProbabilitiesChart');
            if (!ctx) return;

            const regimes = Object.keys(probabilities);
            const values = Object.values(probabilities);

            if (regimeProbabilitiesChartInstance) {
                regimeProbabilitiesChartInstance.destroy();
            }

            regimeProbabilitiesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: regimes,
                    datasets: [{
                        label: 'Probability',
                        data: values,
                        backgroundColor: regimes.map(r => getRegimeColor(r) + '80'),
                        borderColor: regimes.map(r => getRegimeColor(r)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Probability: ${(context.parsed.x * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Regime Timeline Chart
        async function createRegimeTimelineChart(regimeData, lookback_days = 365) {
            const ctx = document.getElementById('regimeTimelineChart');
            if (!ctx) return;

            try {
                document.getElementById('regimeTimelineInfo').innerHTML = '‚è≥ Loading historical data...';

                const baseUrl = window.location.origin;
                const historyUrl = `${baseUrl}/api/ml/bourse/regime-history?benchmark=${regimeData.benchmark || 'SPY'}&lookback_days=${lookback_days}`;
                const historyResponse = await window.safeFetch(historyUrl);

                if (!historyResponse?.ok) {
                    const errorMsg = historyResponse?.status === 503
                        ? 'ML service temporarily unavailable. Model may need initialization or yfinance data download.'
                        : `Failed to fetch regime history (status: ${historyResponse?.status || 'unknown'})`;
                    document.getElementById('regimeTimelineInfo').innerHTML = `‚ö†Ô∏è ${errorMsg}`;
                    return;
                }

                const historyData = historyResponse.data || historyResponse;

                // API returns: dates[], prices[], regimes[], regime_ids[]
                const dates = historyData.dates || [];
                const prices = historyData.prices || [];
                const regimes = historyData.regimes || [];

                if (dates.length === 0 || prices.length === 0) {
                    document.getElementById('regimeTimelineInfo').innerHTML = '‚ö†Ô∏è No historical regime data available';
                    return;
                }

                // Prepare data for Chart.js
                const regimeColors = regimes.map(r => getRegimeColor(r));

                if (regimeTimelineChartInstance) {
                    regimeTimelineChartInstance.destroy();
                }

                // Subsample data for better performance if > 250 points
                let displayLabels = dates;
                let displayPrices = prices;
                let displayColors = regimeColors;
                let displayRegimes = regimes;

                if (dates.length > 250) {
                    const sampleRate = Math.ceil(dates.length / 250);
                    displayLabels = dates.filter((_, i) => i % sampleRate === 0);
                    displayPrices = prices.filter((_, i) => i % sampleRate === 0);
                    displayColors = regimeColors.filter((_, i) => i % sampleRate === 0);
                    displayRegimes = regimes.filter((_, i) => i % sampleRate === 0);
                }

                // Get text color for theme compatibility
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-text').trim() || '#e2e8f0';
                const benchmark = historyData.benchmark || 'SPY';

                regimeTimelineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: `${benchmark} Price`,
                            data: displayPrices,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointBackgroundColor: displayColors,
                            pointBorderColor: displayColors,
                            pointRadius: lookback_days > 1825 ? 3 : 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: textColor,
                                    font: { size: 12 },
                                    generateLabels: function(chart) {
                                        return [
                                            { text: `${benchmark} Price`, fillStyle: '#8b5cf6', strokeStyle: '#8b5cf6', fontColor: textColor },
                                            { text: 'Bear Market', fillStyle: '#dc2626', fontColor: textColor },
                                            { text: 'Correction', fillStyle: '#f97316', fontColor: textColor },
                                            { text: 'Bull Market', fillStyle: '#22c55e', fontColor: textColor },
                                            { text: 'Expansion', fillStyle: '#3b82f6', fontColor: textColor }
                                        ];
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    afterLabel: function(context) {
                                        const idx = context.dataIndex;
                                        return `Regime: ${displayRegimes[idx] || 'Unknown'}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',
                                ticks: {
                                    maxTicksLimit: 12,
                                    maxRotation: 45,
                                    color: textColor
                                },
                                grid: { color: 'rgba(128, 128, 128, 0.1)' }
                            },
                            y: {
                                title: { display: true, text: 'Price (USD)', color: textColor },
                                ticks: { color: textColor },
                                grid: { color: 'rgba(128, 128, 128, 0.1)' }
                            }
                        }
                    }
                });

                // Update info using regime_distribution from API if available
                const totalDays = dates.length;
                let infoHtml = '';

                if (historyData.regime_distribution) {
                    // Use pre-calculated distribution from API
                    infoHtml = Object.entries(historyData.regime_distribution)
                        .map(([regime, data]) => `${getRegimeEmoji(regime)} ${regime}: ${data.percentage}%`)
                        .join(' ‚Ä¢ ');
                } else {
                    // Calculate from regimes array
                    const regimeCounts = {};
                    regimes.forEach(r => {
                        regimeCounts[r] = (regimeCounts[r] || 0) + 1;
                    });
                    infoHtml = Object.entries(regimeCounts)
                        .map(([regime, count]) => `${getRegimeEmoji(regime)} ${regime}: ${((count/totalDays)*100).toFixed(1)}%`)
                        .join(' ‚Ä¢ ');
                }

                document.getElementById('regimeTimelineInfo').innerHTML = `üìä ${totalDays} days analyzed ‚Ä¢ ${infoHtml}`;

            } catch (error) {
                debugLogger.error('Failed to create regime timeline', error);
                document.getElementById('regimeTimelineInfo').innerHTML = `‚ö†Ô∏è Error: ${error.message}`;
            }
        }

        // Update regime timeline with new timeframe
        async function updateRegimeTimeline(days) {
            // Update button states
            document.querySelectorAll('#timeframeSelector .timeframe-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });

            if (window.currentRegimeData) {
                await createRegimeTimelineChart(window.currentRegimeData, days);
            }
        }

        // ==================== SPECIALIZED ANALYTICS ====================
        async function loadSpecializedAnalytics() {
            await Promise.all([
                loadSectorRotation().catch(err => debugLogger.warn('Sector rotation failed', err)),
                loadMarginMonitoring().catch(err => debugLogger.warn('Margin monitoring failed', err))
            ]);
            populateTickerSelector();
        }

        async function loadSectorRotation() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                const key = bourseCacheKey('sector-rotation');
                if (!forceRefreshFlag && window.hasCacheHit(key, 'bourse')) showCacheIndicator();
                else document.getElementById('sectorRotation').innerHTML = '<div class="loading">Loading visualization library‚Ä¶</div>';

                await loadPlotlyLib();

                if (!window.hasCacheHit(key, 'bourse') || forceRefreshFlag) {
                    document.getElementById('sectorRotation').innerHTML = '<div class="loading">Analyzing sectors‚Ä¶</div>';
                }

                let url = `/api/risk/bourse/specialized/sector-rotation?user_id=${activeUser}&lookback_days=60`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const data = await window.cachedApiCall(key, globalConfig.getApiUrl(url), cacheOpts(), 'bourse');
                const sectors = data.sectors || {};
                const sortedSectors = Object.entries(sectors).sort((a, b) => (b[1].momentum || 0) - (a[1].momentum || 0));

                // Store for filtering
                window.sectorData = { sectors, sortedSectors, data };

                document.getElementById('sectorRotation').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); background: color-mix(in oklab, var(--${data.rotation_detected ? 'warning' : 'info'}) 10%, transparent); color: var(--${data.rotation_detected ? 'warning' : 'info'}); font-size: 0.75rem; font-weight: 600;">
                            ${data.rotation_detected ? 'üîÑ Rotation Detected' : 'üìä No Rotation'}
                        </div>
                        <span style="margin-left: 1rem; font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_sectors || Object.keys(sectors).length} sectors analyzed over ${data.lookback_days || 60} days
                        </span>
                    </div>

                    <!-- Portfolio Analysis - Alerts/Warnings/Opportunities -->
                    ${data.portfolio_analysis ? `
                        ${data.portfolio_analysis.alerts && data.portfolio_analysis.alerts.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--danger) 10%, transparent); border-left: 3px solid var(--danger); border-radius: var(--radius-sm);">
                                <strong style="color: var(--danger); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">‚ö†Ô∏è ALERTS</strong>
                                ${data.portfolio_analysis.alerts.map(alert => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${alert.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${alert.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.portfolio_analysis.warnings && data.portfolio_analysis.warnings.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--warning) 10%, transparent); border-left: 3px solid var(--warning); border-radius: var(--radius-sm);">
                                <strong style="color: var(--warning); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">‚ö° WARNINGS</strong>
                                ${data.portfolio_analysis.warnings.map(warning => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${warning.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${warning.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.portfolio_analysis.opportunities && data.portfolio_analysis.opportunities.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-left: 3px solid var(--success); border-radius: var(--radius-sm);">
                                <strong style="color: var(--success); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">üí° OPPORTUNITIES</strong>
                                ${data.portfolio_analysis.opportunities.map(opp => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${opp.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${opp.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    ` : ''}

                    <!-- Filters -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="sectorSearch" placeholder="üîç Search sectors..."
                            style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text);"
                            oninput="filterSectorTable()">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="filterSectors('all')" id="filterAll" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--brand-primary); color: white; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                All
                            </button>
                            <button onclick="filterSectors('hot')" id="filterHot" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üî• Hot
                            </button>
                            <button onclick="filterSectors('cold')" id="filterCold" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                ‚ùÑÔ∏è Cold
                            </button>
                        </div>
                    </div>

                    <table class="positions-table" id="sectorTable" style="margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th scope="col">Sector</th>
                                <th scope="col">Return</th>
                                <th scope="col">Weight</th>
                                <th scope="col">Momentum</th>
                                <th scope="col">Signal</th>
                                <th scope="col">Positions</th>
                            </tr>
                        </thead>
                        <tbody id="sectorTableBody">
                            ${sortedSectors.map(([name, d]) => {
                                const signalColor = d.signal === 'overweight' ? 'var(--success)' :
                                                   d.signal === 'underweight' ? 'var(--danger)' : 'var(--theme-text-muted)';
                                const signalIcon = d.signal === 'overweight' ? 'üî•' :
                                                  d.signal === 'underweight' ? '‚ùÑÔ∏è' : '‚ûñ';
                                const weight = d.weight !== undefined ? d.weight.toFixed(1) : '‚Äî';
                                return `
                                    <tr data-sector="${name}" data-signal="${d.signal}">
                                        <td style="font-weight: 600;">${name}</td>
                                        <td style="color: ${d.return >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                            ${d.return >= 0 ? '+' : ''}${d.return.toFixed(2)}%
                                        </td>
                                        <td style="font-weight: 600; color: var(--theme-text-muted);">${weight}%</td>
                                        <td>${d.momentum.toFixed(2)}x</td>
                                        <td style="color: ${signalColor}; font-weight: 600;">
                                            ${signalIcon} ${d.signal.toUpperCase()}
                                        </td>
                                        <td>${d.num_positions || '‚Äî'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                // Setup search filter
                document.getElementById('sectorSearch')?.addEventListener('input', filterSectorTable);

                document.getElementById('sectorBadge').textContent = `${data.hot_sectors?.length || 0} hot, ${data.cold_sectors?.length || 0} cold`;
                document.getElementById('sectorBadge').style.background = data.rotation_detected ?
                    'color-mix(in oklab, var(--warning) 10%, transparent)' : '';
                document.getElementById('sectorBadge').style.color = data.rotation_detected ? 'var(--warning)' : '';

            } catch (error) {
                debugLogger.error('Sector rotation failed', error);
                document.getElementById('sectorRotation').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load sector rotation data: ${error.message}
                    </div>
                `;
            }
        }

        // Filter sectors by signal type
        function filterSectors(filter) {
            const rows = document.querySelectorAll('#sectorTableBody tr');
            rows.forEach(row => {
                const signal = row.dataset.signal;
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'hot' && signal === 'overweight') {
                    row.style.display = '';
                } else if (filter === 'cold' && signal === 'underweight') {
                    row.style.display = '';
                } else if (filter !== 'all') {
                    row.style.display = 'none';
                }
            });

            // Update button styles
            document.querySelectorAll('.sector-filter-btn').forEach(btn => {
                btn.style.background = 'var(--theme-bg)';
                btn.style.color = 'var(--theme-text)';
            });
            const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--brand-primary)';
                activeBtn.style.color = 'white';
            }
        }

        // Filter sector table by search text
        function filterSectorTable() {
            const searchText = document.getElementById('sectorSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#sectorTableBody tr');
            rows.forEach(row => {
                const sectorName = row.dataset.sector?.toLowerCase() || '';
                row.style.display = sectorName.includes(searchText) ? '' : 'none';
            });
        }

        async function loadMarginMonitoring() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                const key = bourseCacheKey('margin');
                if (!forceRefreshFlag && window.hasCacheHit(key, 'bourse')) showCacheIndicator();
                else document.getElementById('marginMonitoring').innerHTML = '<div class="loading">Calculating margin metrics‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/margin?user_id=${activeUser}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const data = await window.cachedApiCall(key, globalConfig.getApiUrl(url), cacheOpts(), 'bourse');

                const warningLevel = data.warnings && data.warnings.length > 0 ?
                    (data.warnings.some(w => w.includes('CRITICAL')) ? 'danger' : 'warning') : 'success';

                const marginColor = data.margin_call_distance < 10 ? 'var(--danger)' :
                                   data.margin_call_distance < 20 ? 'var(--warning)' : 'var(--success)';

                document.getElementById('marginMonitoring').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Utilization</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.margin_utilization.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                $${(data.total_margin_used || 0).toLocaleString()} / $${(data.account_equity || 0).toLocaleString()}
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Leverage</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.current_leverage.toFixed(2)}x</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                Optimal: ${(data.optimal_leverage || 1).toFixed(2)}x
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Call Distance</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${marginColor};">${data.margin_call_distance.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                ${data.margin_call_distance >= 50 ? '‚úÖ Very Safe' :
                                  data.margin_call_distance >= 20 ? '‚ö†Ô∏è Monitor' : 'üö® Risk'}
                            </div>
                        </div>
                    </div>

                    ${data.warnings && data.warnings.length > 0 ? `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${warningLevel}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${warningLevel}); font-size: 0.875rem;">
                            <strong style="color: var(--${warningLevel});">‚ö†Ô∏è Warnings (${data.warnings.length}):</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: var(--${warningLevel});">
                                ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--success); font-size: 0.875rem; color: var(--success);">
                            ‚úÖ No margin warnings - Portfolio is healthy
                        </div>
                    `}

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('marginBadge').textContent = data.warnings && data.warnings.length > 0 ?
                    `${data.warnings.length} warnings` : 'Healthy';
                document.getElementById('marginBadge').style.background = `color-mix(in oklab, var(--${warningLevel}) 10%, transparent)`;
                document.getElementById('marginBadge').style.color = `var(--${warningLevel})`;

            } catch (error) {
                debugLogger.error('Margin monitoring failed', error);
                document.getElementById('marginMonitoring').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load margin data: ${error.message}
                    </div>
                `;
            }
        }

        function populateTickerSelector() {
            const selector = document.getElementById('tickerSelector');
            if (!currentPortfolioData || !currentPortfolioData.positions) return;

            const tickers = [...new Set(currentPortfolioData.positions.map(p => p.ticker || p.symbol))].filter(Boolean).sort();
            selector.innerHTML = '<option value="">Select a ticker...</option>' +
                tickers.map(ticker => `<option value="${ticker}">${ticker}</option>`).join('');

            selector.onchange = (e) => {
                const ticker = e.target.value;
                if (ticker) {
                    document.getElementById('tickerAnalytics').style.display = 'block';
                    document.getElementById('tickerPlaceholder').style.display = 'none';
                    loadTickerAnalytics(ticker);
                } else {
                    document.getElementById('tickerAnalytics').style.display = 'none';
                    document.getElementById('tickerPlaceholder').style.display = 'block';
                }
            };
        }

        async function loadTickerAnalytics(ticker) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            // Load all ticker analytics in parallel
            await Promise.all([
                loadBetaForecast(ticker, activeUser),
                loadEarningsPredictor(ticker, activeUser),
                loadDividendAnalysis(ticker, activeUser)
            ]);
        }

        // Load Beta Forecast for ticker
        async function loadBetaForecast(ticker, activeUser) {
            try {
                document.getElementById('betaForecast').innerHTML = '<div class="loading">Loading beta forecast‚Ä¶</div>';
                const url = `/api/risk/bourse/specialized/beta-forecast?user_id=${activeUser}&ticker=${ticker}&benchmark=SPY`;
                const response = await window.safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Beta forecast failed');

                const data = response.data || response;

                const trendColor = data.beta_trend === 'increasing' ? 'var(--danger)' :
                                  data.beta_trend === 'decreasing' ? 'var(--success)' : 'var(--theme-text-muted)';
                const trendIcon = data.beta_trend === 'increasing' ? 'üìà' :
                                 data.beta_trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';

                // Create canvas for chart
                const canvasId = `betaChart-${ticker}`;
                document.getElementById('betaForecast').innerHTML = `
                    <!-- Beta Rolling Chart -->
                    ${data.rolling_betas && data.rolling_betas.length > 0 ? `
                        <div style="margin-bottom: 1.5rem;">
                            <canvas id="${canvasId}" style="max-height: 250px;" role="img" aria-label="Rolling beta forecast chart"></canvas>
                        </div>
                    ` : ''}

                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Beta</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.current_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Forecast (EWMA)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.forecasted_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Trend</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${trendColor};">
                                ${trendIcon} ${data.beta_trend}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">R¬≤ (Fit Quality)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${((data.r_squared || 0) * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Annual Alpha</div>
                            <div style="font-size: 1rem; font-weight: 600; color: ${(data.alpha || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${(data.alpha || 0) >= 0 ? '+' : ''}${(data.alpha || 0).toFixed(2)}%
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Volatility Ratio</div>
                            <div style="font-size: 1rem; font-weight: 600;">${(data.volatility_ratio || 1).toFixed(2)}x vs SPY</div>
                        </div>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Based on ${data.observation_days || 252} days of returns ‚Ä¢ Forecast method: ${data.forecast_method || 'EWMA'}
                    </div>
                `;

                // Create Chart.js beta rolling chart if data available
                if (data.rolling_betas && data.rolling_betas.length > 0) {
                    const ctx = document.getElementById(canvasId)?.getContext('2d');
                    if (ctx) {
                        const labels = data.rolling_betas.map((_, i) => `-${data.rolling_betas.length - i}d`);

                        if (betaForecastChartInstance) {
                            betaForecastChartInstance.destroy();
                        }

                        betaForecastChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Rolling Beta (60d)',
                                        data: data.rolling_betas,
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.3
                                    },
                                    {
                                        label: 'Current Beta',
                                        data: new Array(data.rolling_betas.length).fill(data.current_beta),
                                        borderColor: 'rgba(255, 99, 132, 0.8)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        fill: false,
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'Forecast (EWMA)',
                                        data: new Array(data.rolling_betas.length).fill(data.forecasted_beta),
                                        borderColor: 'rgba(75, 192, 192, 0.8)',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        fill: false,
                                        pointRadius: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${ticker} Beta Rolling History vs SPY`,
                                        font: { size: 14, weight: '600' }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: { font: { size: 11 } }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        title: { display: true, text: 'Beta' }
                                    },
                                    x: {
                                        title: { display: true, text: 'Days Ago' },
                                        ticks: { maxTicksLimit: 10 }
                                    }
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                debugLogger.error('Beta forecast failed', error);
                document.getElementById('betaForecast').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load beta forecast: ${error.message}
                    </div>
                `;
            }
        }

        // Load Earnings Predictor for ticker
        async function loadEarningsPredictor(ticker, activeUser) {
            try {
                document.getElementById('earningsPredictor').innerHTML = '<div class="loading">Loading earnings data‚Ä¶</div>';
                const url = `/api/risk/bourse/specialized/earnings?user_id=${activeUser}&ticker=${ticker}`;
                const response = await window.safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Earnings predictor failed');

                const data = response.data || response;

                const alertColor = data.alert_level === 'high' ? 'var(--danger)' :
                                  data.alert_level === 'medium' ? 'var(--warning)' : 'var(--info)';

                document.getElementById('earningsPredictor').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Alert Level</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${alertColor}; text-transform: uppercase;">
                                ${data.alert_level}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Pre-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${((data.pre_earnings_vol || 0) * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Post-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${((data.post_earnings_vol || 0) * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Vol Increase</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">+${(data.vol_increase_pct || 0).toFixed(1)}%</div>
                        </div>
                    </div>

                    ${data.recommendation ? `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${data.alert_level === 'low' ? 'info' : 'warning'}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${data.alert_level === 'low' ? 'info' : 'warning'}); font-size: 0.875rem;">
                            <strong style="color: var(--${data.alert_level === 'low' ? 'info' : 'warning'});">üí° ${data.recommendation}</strong>
                        </div>
                    ` : ''}

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Avg post-earnings move: ${(data.avg_post_earnings_move || 0).toFixed(2)}%
                        ${data.next_earnings_date ? ` ‚Ä¢ Next earnings: ${data.next_earnings_date}` : ''}
                    </div>
                `;
            } catch (error) {
                debugLogger.error('Earnings predictor failed', error);
                document.getElementById('earningsPredictor').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load earnings data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Dividend Analysis for ticker
        async function loadDividendAnalysis(ticker, activeUser) {
            try {
                document.getElementById('dividendAnalysis').innerHTML = '<div class="loading">Loading dividend data‚Ä¶</div>';
                const url = `/api/risk/bourse/specialized/dividends?user_id=${activeUser}&ticker=${ticker}`;
                const response = await window.safeFetch(globalConfig.getApiUrl(url));

                const data = response.data || response;

                // Check if data is available
                if (!data.ok || !data.has_dividend_data || data.current_yield === 0) {
                    const errorMsg = data.error ? ` (${data.error})` : '';
                    document.getElementById('dividendAnalysis').innerHTML = `
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚ÑπÔ∏è No dividend data available for ${ticker}${errorMsg}
                        </div>
                    `;
                    return;
                }

                document.getElementById('dividendAnalysis').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Yield</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.current_yield.toFixed(2)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Annual Dividend</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">$${data.annual_dividend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Frequency</div>
                            <div style="font-size: 1rem; font-weight: 600; text-transform: capitalize;">${data.payout_frequency || 'quarterly'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Growth Rate (YoY)</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${(data.dividend_growth_rate || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${(data.dividend_growth_rate || 0) >= 0 ? '+' : ''}${(data.dividend_growth_rate || 0).toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    ${data.next_ex_dividend_date ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üìÖ Next Ex-Dividend:</strong> ${data.next_ex_dividend_date}
                            ${data.days_until_ex_dividend ? ` (in ${data.days_until_ex_dividend} days)` : ''}
                            <br><small>Expected price drop: ~${(data.avg_price_drop_ex_div || 0).toFixed(2)}%</small>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                debugLogger.error('Dividend analysis failed', error);
                document.getElementById('dividendAnalysis').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load dividend data: ${error.message}
                    </div>
                `;
            }
        }

        // ==================== PDF EXPORT ====================
        async function loadPDFLibraries() {
            if (pdfLibsLoaded) return;
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
            pdfLibsLoaded = true;
        }

        async function exportRiskPDF() {
            try {
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '‚è≥ Loading...';
                exportBtn.disabled = true;

                await loadPDFLibraries();
                exportBtn.innerHTML = '‚è≥ Generating...';

                const { jsPDF } = window.jspdf;
                const riskTab = document.getElementById('risk');

                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; background: white; padding: 20px; width: 800px;';
                tempContainer.innerHTML = `<div style="font-family: Arial; color: #000;"><h1 style="text-align: center;">üìä Risk Analytics Report</h1>${riskTab.innerHTML}</div>`;
                document.body.appendChild(tempContainer);

                await new Promise(resolve => setTimeout(resolve, 500));

                const canvas = await html2canvas(tempContainer, { scale: 2, backgroundColor: '#ffffff' });
                document.body.removeChild(tempContainer);

                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`Risk_Analytics_${new Date().toISOString().split('T')[0]}.pdf`);

                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

            } catch (error) {
                debugLogger.error('PDF export failed', error);
                alert('Failed to export PDF');
                event.target.innerHTML = 'üìÑ Export PDF';
                event.target.disabled = false;
            }
        }
    </script>
</body>
</html>
