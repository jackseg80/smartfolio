<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analytics (Beta) - Crypto Rebalancer</title>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
    <script type="module" src="components/nav.js"></script>
    <script type="module">
        import { initDeepLinks } from './components/deep-links.js';
        // Ancres pour analytics-equities.html
        initDeepLinks({
            'overview': 'Overview',
            'positions': 'Positions',
            'breakdown': 'Breakdown'
        });
    </script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--theme-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--theme-border);
        }

        .beta-badge {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--theme-text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            padding: 1.5rem;
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--theme-text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success);
            margin-bottom: 0.25rem;
        }

        .kpi-subtitle {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
        }

        .main-panels {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--theme-border);
            background: var(--theme-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            color: var(--theme-text);
        }

        .panel-content {
            padding: 1.5rem;
        }

        .action-bar {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-sm);
            background: var(--theme-surface);
            color: var(--theme-text);
            text-decoration: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--theme-hover);
            border-color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th,
        .positions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--theme-border);
        }

        .positions-table th {
            background: var(--theme-bg);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--theme-text-muted);
            cursor: pointer;
            user-select: none;
        }

        .positions-table th:hover {
            background: var(--theme-hover);
        }

        .positions-table td {
            font-size: 0.9rem;
        }

        .sort-indicator {
            margin-left: 0.5rem;
            opacity: 0.5;
        }

        .sort-active {
            opacity: 1;
            color: var(--primary);
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--theme-border-light);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            font-weight: 500;
        }

        .breakdown-value {
            font-weight: 600;
            color: var(--success);
        }

        .breakdown-bar {
            height: 6px;
            background: var(--theme-border-light);
            border-radius: 3px;
            margin: 0.25rem 0;
            overflow: hidden;
        }

        .breakdown-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-hover));
            border-radius: 3px;
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--theme-text-muted);
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--theme-text);
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--theme-text-muted);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--theme-border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-panels {
                grid-template-columns: 1fr;
            }

            .kpi-row {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                gap: 1rem;
            }

            .action-bar {
                flex-direction: column;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Info Banner - Sources System -->
    <div class="info-banner" style="background: var(--info-bg); border: 1px solid var(--info); color: var(--info); padding: 12px 16px; margin: 16px auto; max-width: 1200px; border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 18px;">‚ÑπÔ∏è</span>
        <span>
            <strong>New Sources system:</strong>
            Data imports are now done from
            <a href="settings.html#tab-sources" style="color: var(--info); text-decoration: underline;">Settings ‚Üí Sources</a>.
            This page displays already imported data.
        </span>
    </div>

    <div class="container">
        <!-- Lien retour -->
        <a href="dashboard.html" class="back-link">
            ‚Üê Dashboard
        </a>

        <!-- En-t√™te avec actions -->
        <div class="page-header">
            <div>
                <h1>üè¶ Stock Analytics
                    <span class="beta-badge">BETA</span>
                </h1>
                <p style="margin: 0; color: var(--theme-text-muted); font-size: 0.9rem;">
                    Detailed analysis of your Saxo portfolio (legacy reader)
                </p>
            </div>
            <div class="action-bar">
                <button class="btn" onclick="refreshData()">
                    üîÑ Refresh
                </button>
                <a href="settings.html#tab-sources" target="_blank" class="btn btn-primary">
                    üìÅ Manage Sources
                </a>
            </div>
        </div>

        <!-- KPIs en-t√™te -->
        <div id="overview" class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">Total Value</div>
                <div class="kpi-value" id="total-value">$0</div>
                <div class="kpi-subtitle">Stock Portfolio</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Positions</div>
                <div class="kpi-value" id="positions-count">0</div>
                <div class="kpi-subtitle">Instruments</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Last Import</div>
                <div class="kpi-value" id="last-import" style="font-size: 1.2rem;">n/a</div>
                <div class="kpi-subtitle">Date and time</div>
            </div>
        </div>

        <!-- Panneaux principaux -->
        <div class="main-panels">
            <!-- Positions -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title" id="positions">üìä Positions</div>
                    <div>
                        <select id="sort-select" class="btn" onchange="sortPositions()">
                            <option value="value">Sort by Value</option>
                            <option value="quantity">Sort by Quantity</option>
                            <option value="ticker">Sort by Ticker</option>
                        </select>
                    </div>
                </div>
                <div class="panel-content" id="positions-content">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        Loading positions...
                    </div>
                </div>
            </div>

            <!-- R√©partition -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title" id="breakdown">üìà Breakdown</div>
                    <div>
                        <select id="breakdown-type" class="btn" onchange="updateBreakdown()">
                            <option value="currency">By Currency</option>
                            <option value="sector">By Sector</option>
                        </select>
                    </div>
                </div>
                <div class="panel-content" id="breakdown-content">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { safeFetch } from './core/fetcher.js';
        import { fetchSaxoSummary, formatCurrency } from './modules/wealth-saxo-summary.js';
        import {
            groupBySector,
            groupByCurrency,
            sortByValue,
            formatMoney
        } from './modules/equities-utils.js';

        let currentPositions = [];
        let currentSort = 'value';

        // Fonction principale de chargement
        async function loadEquitiesData() {
            try {
                debugLogger.debug('üè¶ Loading equities analytics data...');

                // Charger le r√©sum√© pour les KPIs
                const summary = await fetchSaxoSummary();
                updateKPIs(summary);

                // Charger les positions d√©taill√©es
                const { ok, data } = await safeFetch(
                    window.globalConfig?.getApiUrl('/api/saxo/positions') || '/api/saxo/positions',
                    { timeout: 10000 }
                );

                if (!ok || !data) {
                    throw new Error('Impossible de charger les positions');
                }

                const positions = Array.isArray(data.positions) ? data.positions :
                                Array.isArray(data) ? data : [];

                currentPositions = positions;

                if (positions.length === 0) {
                    showEmptyState();
                } else {
                    renderPositionsTable(positions);
                    updateBreakdown();
                }

            } catch (error) {
                debugLogger.error('‚ùå Erreur chargement donn√©es bourse:', error);
                showErrorState(error.message);
            }
        }

        // Mise √† jour des KPIs
        function updateKPIs(summary) {
            document.getElementById('total-value').textContent = formatCurrency(summary.total_value);
            document.getElementById('positions-count').textContent = summary.positions_count.toString();
            document.getElementById('last-import').textContent = summary.asof || 'n/a';
        }

        // Rendu de la table des positions
        function renderPositionsTable(positions) {
            const content = document.getElementById('positions-content');

            if (positions.length === 0) {
                showEmptyState();
                return;
            }

            const sortedPositions = sortByValue(positions, currentSort);

            const tableHTML = `
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th onclick="changeSortAndRender('ticker')">
                                Ticker
                                <span class="sort-indicator ${currentSort === 'ticker' ? 'sort-active' : ''}">‚Üï</span>
                            </th>
                            <th onclick="changeSortAndRender('instrument')">Name</th>
                            <th onclick="changeSortAndRender('isin')">ISIN</th>
                            <th onclick="changeSortAndRender('quantity')">
                                Quantity
                                <span class="sort-indicator ${currentSort === 'quantity' ? 'sort-active' : ''}">‚Üï</span>
                            </th>
                            <th onclick="changeSortAndRender('price')">Price</th>
                            <th onclick="changeSortAndRender('value')">
                                Value
                                <span class="sort-indicator ${currentSort === 'value' ? 'sort-active' : ''}">‚Üï</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedPositions.map(pos => `
                            <tr>
                                <td><strong>${pos.instrument_symbol || pos.ticker || 'N/A'}</strong></td>
                                <td>${pos.instrument_name || pos.name || 'Unknown instrument'}</td>
                                <td style="font-family: monospace; font-size: 0.8rem;">
                                    ${pos.isin || 'N/A'}
                                </td>
                                <td>${formatQuantity(pos.quantity || pos.size || 0)}</td>
                                <td>${formatMoney(pos.price || pos.market_price || 0, pos.currency || 'USD')}</td>
                                <td><strong>${formatMoney(pos.market_value_usd || pos.market_value || pos.value || 0, 'USD')}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = tableHTML;
        }

        // Mise √† jour de la r√©partition
        function updateBreakdown() {
            const type = document.getElementById('breakdown-type').value;
            const content = document.getElementById('breakdown-content');

            if (currentPositions.length === 0) {
                content.innerHTML = '<div class="empty-state">No data available</div>';
                return;
            }

            let grouped;
            if (type === 'currency') {
                grouped = groupByCurrency(currentPositions);
            } else if (type === 'sector') {
                grouped = groupBySector(currentPositions);
            } else {
                content.innerHTML = '<div class="empty-state">Unsupported breakdown type</div>';
                return;
            }

            if (Object.keys(grouped).length === 0) {
                content.innerHTML = '<div class="empty-state">Data not available for this breakdown type</div>';
                return;
            }

            const total = Object.values(grouped).reduce((sum, val) => sum + val, 0);

            const breakdownHTML = Object.entries(grouped)
                .sort(([,a], [,b]) => b - a)
                .map(([key, value]) => {
                    const percentage = total > 0 ? (value / total * 100) : 0;
                    return `
                        <div class="breakdown-item">
                            <div>
                                <div class="breakdown-label">${key}</div>
                                <div class="breakdown-bar">
                                    <div class="breakdown-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="breakdown-value">
                                ${formatMoney(value, 'USD')} (${percentage.toFixed(1)}%)
                            </div>
                        </div>
                    `;
                }).join('');

            content.innerHTML = breakdownHTML;
        }

        // √âtat vide
        function showEmptyState() {
            const positionsContent = document.getElementById('positions-content');
            const breakdownContent = document.getElementById('breakdown-content');

            const emptyHTML = `
                <div class="empty-state">
                    <h3>No positions found</h3>
                    <p>Import a Saxo file to view your positions</p>
                    <a href="settings.html#tab-sources" target="_blank" class="btn btn-primary">üìÅ Configure Sources</a>
                </div>
            `;

            positionsContent.innerHTML = emptyHTML;
            breakdownContent.innerHTML = '<div class="empty-state">No data to analyze</div>';
        }

        // √âtat d'erreur
        function showErrorState(message) {
            const positionsContent = document.getElementById('positions-content');
            positionsContent.innerHTML = `
                <div class="empty-state">
                    <h3>‚ö†Ô∏è Loading error</h3>
                    <p>${message}</p>
                    <button class="btn" onclick="refreshData()">üîÑ Retry</button>
                </div>
            `;
        }

        // Helpers
        function formatQuantity(qty) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 4
            }).format(qty);
        }

        function changeSortAndRender(sortType) {
            currentSort = sortType;
            document.getElementById('sort-select').value = sortType;
            renderPositionsTable(currentPositions);
        }

        // Fonctions globales
        window.refreshData = loadEquitiesData;
        window.sortPositions = function() {
            currentSort = document.getElementById('sort-select').value;
            renderPositionsTable(currentPositions);
        };
        window.updateBreakdown = updateBreakdown;

        // Initialisation
        document.addEventListener('DOMContentLoaded', loadEquitiesData);
    </script>
</body>

</html>