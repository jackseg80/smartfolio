<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuration - SmartFolio</title>
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/settings.css">
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="components/tooltips.js"></script>

  <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="input-validator.js"></script>
  <script src="performance-optimizer.js"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <!-- Sources V2 - Category-based sources (V1 sources-manager.js deprecated) -->
  <script src="components/manual-source-editor.js"></script>
  <script src="sources-manager-v2.js"></script>

  <!-- AI Chat Component (Global System) -->
  <link rel="stylesheet" href="/static/components/ai-chat.css">
  <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();  // V√©rifie authentification + redirect si n√©cessaire
    // =================================

    import { initAIChat } from '/static/components/ai-chat-init.js';
    initAIChat('settings');
  </script>

  <style>
    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--theme-background);
      color: var(--theme-text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    header {
      position: sticky;
      top: 0;
      background: var(--theme-surface-elevated);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--theme-border);
      z-index: 10
    }

    .wrap {
      max-width: 95vw;
      margin: 0 auto;
      padding: 16px
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 800
    }

    h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600
    }

    h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600
    }

    .nav {
      display: flex;
      gap: 12px;
      margin: 12px 0
    }

    .nav a {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--theme-text-muted);
      border: 1px solid var(--theme-border);
      transition: all 0.2s
    }

    .nav a.active,
    .nav a:hover {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary)
    }

    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl)
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: .5rem;
      border-bottom: 1px solid var(--theme-border);
      margin-bottom: var(--space-md);
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: .6rem .9rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: 8px 8px 0 0;
      cursor: pointer;
    }

    .tab-btn.active {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .card.success {
      border-color: var(--success);
      background: var(--success-bg)
    }

    .card.warning {
      border-color: var(--warning);
      background: var(--warning-bg)
    }

    .form-group {
      margin-bottom: 20px
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--theme-text)
    }

    .form-group .help {
      font-size: 13px;
      color: var(--theme-text-muted);
      margin-top: 4px
    }

    .form-row {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px
    }

    .form-row.vertical {
      flex-direction: column;
      align-items: flex-start
    }

    input,
    select,
    textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      width: 100%;
      max-width: 400px;
      font-size: 14px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: var(--focus-ring);
    }

    button {
      padding: 10px 20px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn {
      background: var(--brand-primary);
      color: white
    }

    .btn:hover {
      background: var(--brand-primary-hover)
    }

    .btn.secondary {
      background: var(--theme-surface-elevated);
      color: var(--theme-text);
      border: 1px solid var(--theme-border)
    }

    .btn.danger {
      background: var(--danger);
      color: white
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 13px
    }

    .radio-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--theme-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s
    }

    .radio-option:hover {
      background: var(--brand-primary-subtle);
      border-color: var(--brand-primary)
    }

    .radio-option input[type="radio"] {
      width: auto;
      margin: 0
    }

    .radio-option.selected {
      background: var(--brand-primary-subtle);
      border-color: var(--brand-primary)
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-ok {
      background: var(--success);
      color: white
    }

    .status-warning {
      background: var(--warning);
      color: white
    }

    .status-error {
      background: var(--danger);
      color: white
    }

    .test-section {
      background: var(--theme-surface-elevated);
      border: 1px solid var(--theme-border);
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px
    }

    .test-result {
      font-family: monospace;
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--theme-text)
    }

    /* Grid responsive pour les cl√©s API */
    .api-keys-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    /* 2 colonnes sur √©crans larges (>1400px) */
    @media (min-width: 1400px) {
      .api-keys-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* 3 colonnes sur tr√®s larges √©crans (>2000px) */
    @media (min-width: 2000px) {
      .api-keys-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media(max-width: 768px) {
      .wrap {
        padding: 12px
      }

      .form-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px
      }

      .radio-group {
        flex-direction: column;
        gap: 8px
      }

      input,
      select,
      textarea {
        max-width: 100%
      }
    }
  </style>

</head>

<body>

  <main role="main">
  <div class="wrap">

    <!-- Tab header -->
    <div class="tabs" id="settings-tabs">
      <button class="tab-btn active" data-target="#tab-overview">Summary</button>
      <!-- <button class="tab-btn" data-target="#tab-data">Source</button> Ancien onglet masqu√© - utiliser Sources -->
      <button class="tab-btn" data-target="#tab-pricing">Pricing</button>
      <button class="tab-btn" data-target="#tab-api">API Keys</button>
      <button class="tab-btn" data-target="#tab-sources">Sources</button>
      <button class="tab-btn" data-target="#tab-interface">Interface</button>
      <button class="tab-btn" data-target="#tab-advanced">Advanced</button>
    </div>


    <!-- Overview Tab -->
    <section class="tab-panel active" id="tab-overview">
      <div class="card" id="global-status"
        data-tooltip="Global system status with API and service connection health indicators."
        data-source="Real-time connectivity tests">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <h3>üìä Global Status</h3>
            <div id="status-summary">Loading configuration...</div>
          </div>
          <div>
            <button class="btn secondary small" onclick="resetToDefaults()">üîÑ Reset</button>
          </div>
        </div>
      </div>

      <!-- Quick Settings: options les plus utilis√©es -->
      <div class="card" data-tooltip="Most common quick settings" data-source="globalConfig">
        <h3>‚öôÔ∏è Quick Settings</h3>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label for="quick_data_source">Data source</label>
            <select id="quick_data_source" aria-label="Data source"></select>
            <div class="help">Affects all dashboards (balances, analytics and rebalancing)</div>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label for="quick_pricing">Pricing mode</label>
            <select id="quick_pricing" aria-label="Pricing mode">
              <option value="local">üè† Local</option>
              <option value="auto">üöÄ Auto</option>
            </select>
            <div class="help">Local = prices from data, Auto = market prices</div>
          </div>
        </div>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label for="quick_min_usd">Seuil minimum (USD)</label>
            <input type="number" id="quick_min_usd" aria-label="Seuil minimum USD" min="0" step="0.01">
          </div>
          <div style="flex:1; min-width: 240px;">
            <label for="quick_currency">Display currency</label>
            <select id="quick_currency" aria-label="Display currency">
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="BTC">BTC (‚Çø)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label for="quick_theme">Theme</label>
            <select id="quick_theme" aria-label="Theme">
              <option value="auto">üåì Automatic</option>
              <option value="light">‚òÄÔ∏è Clair</option>
              <option value="dark">üåô Sombre</option>
            </select>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label for="quick_api_base_url">URL API backend</label>
            <input type="text" id="quick_api_base_url" aria-label="URL API backend" placeholder="http://127.0.0.1:8080" readonly style="background: var(--theme-surface-elevated); cursor: not-allowed;">
            <div class="help">Configuration serveur (.env) - lecture seule</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top: 8px; align-items: center;">
          <span style="color: var(--theme-text-muted); font-size: 13px;">‚úì Changes saved automatically</span>
        </div>
      </div>
    </section>

    <!-- Pricing Tab -->
    <section class="tab-panel" id="tab-pricing">
      <div class="card"
        data-tooltip="Reference pricing and currency configuration for portfolio value calculations."
        data-source="CoinGecko, CoinGlass, or manual prices">
        <h3>üí∞ Pricing & Currencies</h3>
        <div class="form-group">
          <label>Pricing mode</label>
          <div class="radio-group">
            <div class="radio-option" onclick="selectPricing('local')">
              <input type="radio" name="pricing" value="local" id="pricing_local">
              <label for="pricing_local">üè† <strong>Local</strong> - Prices from data</label>
            </div>
            <div class="radio-option" onclick="selectPricing('auto')">
              <input type="radio" name="pricing" value="auto" id="pricing_auto">
              <label for="pricing_auto">üöÄ <strong>Auto</strong> - Prix automatiques</label>
            </div>
          </div>
          <div class="help">Local uses prices in your data, Auto fetches current prices via API.</div>
        </div>

        <div class="form-row">
          <div style="flex: 1;">
            <label for="display_currency">Display currency</label>
            <select id="display_currency" aria-label="Display currency">
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="BTC">BTC (‚Çø)</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label for="min_usd_threshold">Seuil minimum (USD)</label>
            <input type="number" id="min_usd_threshold" aria-label="Seuil minimum USD" min="0" step="0.01" value="1.00">
          </div>
        </div>
        <div style="margin-top: 12px;">
          <span style="color: var(--theme-text-muted); font-size: 13px;">‚úì Changes saved automatically</span>
        </div>
      </div>
    </section>

    <!-- API Keys Tab -->
    <section class="tab-panel" id="tab-api">
      <div class="card"
        data-tooltip="Secure API key management for exchanges and data services (encrypted local storage)."
        data-source="Secure local storage + API validation">
        <h3>üîë API Keys</h3>

        <!-- Grid responsive pour les sections de cl√©s API -->
        <div class="api-keys-grid">

        <!-- ========== DATA SOURCES CRYPTO ========== -->
        <div style="margin-top: 24px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: var(--theme-text);">üìä Crypto Data Sources</h4>

          <!-- CoinTracking API Keys (group√©es ensemble) -->
          <div style="background: var(--theme-surface-elevated); border: 1px solid var(--theme-border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--brand-primary);">üìà CoinTracking API</strong>
              <span style="color: var(--theme-text-muted); font-size: 12px; margin-left: 8px;">(API Key + Secret requis ensemble)</span>
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label>CoinTracking API Key</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="password" id="cointracking_api_key" placeholder="Required for API source" style="flex: 1;">
                <button class="btn small secondary" onclick="toggleApiKeyVisibility('cointracking_api_key')"
                  style="min-width: 60px;">üëÅÔ∏è</button>
                <span id="cointracking_key_status" class="status-indicator status-warning"
                  style="font-size: 10px;">Empty</span>
              </div>
              <div class="help">CoinTracking API key for real-time balance access.</div>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>CoinTracking API Secret</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="password" id="cointracking_api_secret" placeholder="Required for API source"
                  style="flex: 1;">
                <button class="btn small secondary" onclick="toggleApiKeyVisibility('cointracking_api_secret')"
                  style="min-width: 60px;">üëÅÔ∏è</button>
                <span id="cointracking_secret_status" class="status-indicator status-warning"
                  style="font-size: 10px;">Empty</span>
              </div>
              <div class="help">CoinTracking secret key (generated with API key).</div>
            </div>
          </div>
        </div>

        <!-- ========== MARKET DATA ========== -->
        <div style="margin-top: 32px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: var(--theme-text);">üìâ Market Data</h4>

          <div style="background: var(--theme-surface-elevated); border: 1px solid var(--theme-border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div class="form-group" style="margin-bottom: 12px;">
              <label>CoinGecko API Key</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="password" id="coingecko_api_key" placeholder="Optional - for more requests"
                  style="flex: 1;">
                <button class="btn small secondary" onclick="toggleApiKeyVisibility('coingecko_api_key')"
                  style="min-width: 60px;">üëÅÔ∏è</button>
                <span id="coingecko_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
              </div>
              <div class="help">CoinGecko Demo API key for automatic classification and real-time crypto prices.</div>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label>FRED API Key (Federal Reserve Economic Data)</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="password" id="fred_api_key" placeholder="Key for historical Bitcoin data"
                  style="flex: 1;">
                <button class="btn small secondary" onclick="toggleApiKeyVisibility('fred_api_key')"
                  style="min-width: 60px;">üëÅÔ∏è</button>
                <span id="fred_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
              </div>
              <div class="help">Free FRED API key for complete Bitcoin history since 2014 (vs 365d CoinGecko).</div>
            </div>
          </div>
        </div>

        <!-- ========== AI CHAT ASSISTANTS ========== -->
        <div style="margin-top: 32px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: var(--theme-text);">ü§ñ AI Assistants (Choose one)</h4>

          <!-- AI Chat Keys (group√©es ensemble comme alternatives) -->
          <div style="background: var(--theme-surface-elevated); border: 1px solid var(--theme-border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="margin-bottom: 12px;">
              <strong style="color: var(--brand-primary);">üí¨ AI Chat Assistants</strong>
              <span style="color: var(--theme-text-muted); font-size: 12px; margin-left: 8px;">(Choose one or more)</span>
            </div>

            <!-- Groq API Key (FREE) -->
            <div class="form-group" style="margin-bottom: 12px;">
              <label>ü§ñ Groq API Key (Free - Recommended)</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="password" id="groq_api_key" placeholder="gsk_... (get your key at console.groq.com)"
                  style="flex: 1;">
                <button class="btn small secondary" onclick="toggleApiKeyVisibility('groq_api_key')"
                  style="min-width: 60px;">üëÅÔ∏è</button>
                <span id="groq_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
              </div>
              <div class="help">Free Groq API key for AI chat (Llama 3.3 70B). <a href="https://console.groq.com/keys" target="_blank" style="color: var(--brand-primary);">Get a free key ‚Üí</a></div>
            </div>

            <!-- S√©paration FREE / PREMIUM -->
            <div style="margin: 20px 0; padding-top: 16px; border-top: 2px solid var(--theme-border);">
              <button id="toggle-premium-keys-btn" class="btn secondary" onclick="togglePremiumKeys()"
                style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 10px 16px;">
                <span>üíé API Keys Premium (Payantes)</span>
                <span id="premium-keys-icon">‚ñº</span>
              </button>
            </div>

            <!-- Premium API Keys (Collapsible, closed by default) -->
            <div id="premium-keys-section" style="display: none; margin-top: 16px;">
              <div class="form-group" style="margin-bottom: 12px;">
                <label>üß† Claude API Key (Premium - Plus intelligent)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="password" id="claude_api_key" placeholder="sk-ant-... (get your key at console.anthropic.com)"
                    style="flex: 1;">
                  <button class="btn small secondary" onclick="toggleApiKeyVisibility('claude_api_key')"
                    style="min-width: 60px;">üëÅÔ∏è</button>
                  <span id="claude_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
                </div>
                <div class="help">Claude API key (paid) for premium AI chat (Sonnet 3.5, more intelligent). <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: var(--brand-primary);">Get a key ‚Üí</a></div>
              </div>

              <div class="form-group" style="margin-bottom: 12px;">
                <label>üöÄ Grok API Key (xAI - Premium)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="password" id="grok_api_key" placeholder="xai-... (get your key at console.x.ai)"
                    style="flex: 1;">
                  <button class="btn small secondary" onclick="toggleApiKeyVisibility('grok_api_key')"
                    style="min-width: 60px;">üëÅÔ∏è</button>
                  <span id="grok_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
                </div>
                <div class="help">Grok API key (xAI) for AI chat (Grok Beta). <a href="https://console.x.ai" target="_blank" style="color: var(--brand-primary);">Get a key ‚Üí</a></div>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label>ü§ñ OpenAI API Key (Premium - GPT)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="password" id="openai_api_key" placeholder="sk-... (get your key at platform.openai.com)"
                    style="flex: 1;">
                  <button class="btn small secondary" onclick="toggleApiKeyVisibility('openai_api_key')"
                    style="min-width: 60px;">üëÅÔ∏è</button>
                  <span id="openai_status" class="status-indicator status-warning" style="font-size: 10px;">Empty</span>
                </div>
                <div class="help">OpenAI API key (paid) for AI chat (GPT-4o). <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--brand-primary);">Get a key ‚Üí</a></div>
              </div>
            </div>
          </div>
        </div>

        </div><!-- Fin api-keys-grid -->

        <!-- SaxoBank OAuth Section -->
        <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--theme-border);">
          <h3 style="margin-bottom: 16px;">üè¶ SaxoBank OpenAPI (OAuth2)</h3>

          <div id="saxo-status-banner" class="status-indicator" style="margin-bottom: 16px;">
            <!-- Dynamically populated by JavaScript -->
            <span id="saxo-status-text">Loading status...</span>
          </div>

          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
            <button id="saxo-connect-btn" class="btn" onclick="initSaxoLogin()">
              üîê Connect to Saxo
            </button>
            <button id="saxo-disconnect-btn" class="btn danger" onclick="disconnectSaxo()" style="display: none;">
              üîì Disconnect
            </button>
            <button id="saxo-refresh-btn" class="btn secondary" onclick="refreshSaxoToken()" style="display: none;">
              üîÑ Refresh
            </button>
          </div>

          <div id="saxo-info" class="card" style="display: none; background: var(--theme-surface-elevated); padding: 12px;">
            <p style="margin: 4px 0;"><strong>Environnement:</strong> <span id="saxo-env">--</span></p>
            <p style="margin: 4px 0;"><strong>Token expire:</strong> <span id="saxo-expires">--</span></p>
            <p style="margin: 4px 0;"><strong>Last update:</strong> <span id="saxo-last-update">--</span></p>
          </div>

          <div class="help" style="margin-top: 8px;">
            ‚ö†Ô∏è Reconnection required every 24h (Self-Developer account limitation)
          </div>
        </div>

        <!-- Actions sp√©cifiques API Keys -->
        <div style="display:flex; flex-direction: column; gap:8px; margin: 8px 0 12px 0;">
          <button class="btn" onclick="saveAllSettings()">üíæ Save API Keys</button>
          <span style="color: var(--theme-text-muted); font-size: 13px;">
            ‚ö†Ô∏è API keys require manual save for security reasons
          </span>
        </div>


        <div class="test-section">
          <button class="btn secondary small" onclick="testApiKeys()">üß™ Tester les APIs</button>
          <div id="api-keys-test"></div>
        </div>
      </div>
    </section>


    <!-- Interface Tab -->
    <section class="tab-panel" id="tab-interface">

      <!-- Pr√©f√©rences Interface -->
      <div class="card"
        data-tooltip="User interface customization: themes, language, number format and shortcuts."
        data-source="Local user preferences">
        <h3>üé® Interface & Preferences</h3>

        <div class="form-group">
          <label>Interface theme</label>
          <div class="radio-group">
            <div class="radio-option" onclick="selectTheme('auto')">
              <input type="radio" name="theme" value="auto" id="theme_auto">
              <label for="theme_auto">üåì <strong>Automatic</strong> - Follows system preferences</label>
            </div>
            <div class="radio-option" onclick="selectTheme('light')">
              <input type="radio" name="theme" value="light" id="theme_light">
              <label for="theme_light">‚òÄÔ∏è <strong>Clair</strong> - Mode jour</label>
            </div>
            <div class="radio-option" onclick="selectTheme('dark')">
              <input type="radio" name="theme" value="dark" id="theme_dark">
              <label for="theme_dark">üåô <strong>Sombre</strong> - Mode nuit</label>
            </div>
          </div>
          <div class="help">The theme applies automatically on all pages of the application.</div>
        </div>

        <!-- ====== Apparence / Style UI ====== -->
        <div class="card">
          <h2>Apparence</h2>
          <div class="form-group">
            <label>Style UI</label>
            <div class="style-grid" style="display:flex;gap:12px;flex-wrap:wrap">
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="modern"> Modern
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="glass"> Glass
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="terminal"> Terminal
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="minimal"> Minimal
              </label>
            </div>
            <div class="help">Only changes the appearance (corners/shadows/surfaces). No impact on logic.
            </div>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const saved = window.globalConfig?.get?.('style') || 'modern';
            document.querySelectorAll('input[name="ui-style"]').forEach(r => {
              r.checked = (r.value === saved);
              r.addEventListener('change', e => {
                window.globalConfig?.set?.('style', e.target.value);
                window.applyAppearance?.();
              });
            });
            // s‚Äôassure que le style s‚Äôapplique si on arrive direct
            window.applyAppearance?.();
          });
        </script>

        <div class="form-row">
          <div style="flex: 1;">
            <label>URL API Backend</label>
            <input type="text" id="api_base_url" value="http://127.0.0.1:8080" readonly style="background: var(--theme-surface-elevated); cursor: not-allowed;">
            <div class="help">Configuration serveur (.env: API_BASE_URL) - lecture seule</div>
          </div>
          <div style="flex: 1;">
            <label>Auto-refresh frequency (min)</label>
            <input type="number" id="refresh_interval" min="1" max="60" value="5">
          </div>
        </div>

        <div class="form-group">
          <label>Active features</label>
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_coingecko_classification" checked>
              Classification automatique CoinGecko
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_portfolio_snapshots" checked>
              Snapshots automatiques du portfolio
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_performance_tracking" checked>
              Suivi de performance historique
            </label>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <span style="color: var(--theme-text-muted); font-size: 13px;">‚úì Changes saved automatically</span>
        </div>
      </div>
    </section>

<!-- Sources Tab V2 - Category-based Sources Management -->
<section class="tab-panel" id="tab-sources">
  <div class="card" data-tooltip="Manage your data sources by category (Crypto, Stock)"
    data-source="Modular sources system V2">
    <h3>üìä Data Sources</h3>
    <div class="help" style="margin-bottom: 16px;">
      Manage your crypto and stock sources independently. Each category can use a different source (manual entry, CSV import, real-time API).
    </div>

    <!-- Container for Sources V2 UI (dynamically rendered) -->
    <div id="sources-v2-container">
      <div class="loading-placeholder">
        <div class="spinner"></div>
        <span>Loading sources...</span>
      </div>
    </div>

  </div>
</section>

<!-- CSS sp√©cifique pour la section Sources -->
<style>
/* Grille des modules sources */
.modules-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

/* Cartes individuelles des modules */
.module-card {
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s ease;
}

.module-card:hover {
  border-color: var(--theme-accent);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.module-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

/* Badges de status */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
}

.status-badge.enabled, .status-badge.success {
  background: #d4edda;
  color: #155724;
}

.status-badge.warning {
  background: #fff3cd;
  color: #856404;
}

.status-badge.disabled, .status-badge.error {
  background: #f8d7da;
  color: #721c24;
}

/* Statistiques des modules */
.module-stats {
  margin: 12px 0;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 14px;
}

.stat-item .label {
  color: var(--theme-text-muted);
}

.stat-item .value {
  font-weight: 500;
}

/* Actions des modules */
.module-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

/* Loading placeholder */
.loading-placeholder {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: var(--theme-text-muted);
  font-style: italic;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--theme-border);
  border-top: 2px solid var(--theme-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Sources radio buttons compacts */
.sources-section {
  margin-top: 12px;
}

.sources-section h5 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--theme-text-muted);
}

.sources-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.source-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-size: 13px;
}

.source-option:hover {
  background-color: var(--theme-surface-elevated);
}

.source-option input[type="radio"] {
  margin: 0;
  flex-shrink: 0;
  width: 14px;
  height: 14px;
}

.source-details {
  flex: 1;
  line-height: 1.3;
}

.source-details small {
  color: var(--theme-text-muted);
  font-size: 11px;
}

.legacy {
  color: #fd7e14;
  font-weight: 500;
}

/* Status grid am√©lior√© */
.status-grid .value.error {
  color: #dc3545;
}

.status-grid .value.warning {
  color: #fd7e14;
}

.status-grid .value.success {
  color: #28a745;
}

/* CSS pour la modal d'upload */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
  transition: opacity 0.2s ease;
}

.modal-content {
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--theme-border);
  background: var(--theme-surface-elevated);
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--theme-text-secondary);
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: var(--theme-surface);
  color: var(--theme-text);
}

.modal-body {
  padding: 20px;
  max-height: 50vh;
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid var(--theme-border);
  background: var(--theme-surface-elevated);
}

/* Zone d'upload */
.upload-area {
  border: 2px dashed var(--theme-border);
  border-radius: 8px;
  padding: 32px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--theme-surface-elevated);
  margin: 16px 0;
}

.upload-area:hover {
  border-color: var(--theme-accent);
  background: var(--theme-surface);
}

.upload-area.drag-over {
  border-color: var(--theme-success);
  background: rgba(40, 167, 69, 0.1);
}

.upload-placeholder {
  color: var(--theme-text-secondary);
  font-size: 16px;
}

/* Liste des fichiers */
.file-list {
  margin: 16px 0;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--theme-surface-elevated);
  border: 1px solid var(--theme-border);
  border-radius: 6px;
  margin-bottom: 8px;
}

.file-name {
  font-weight: 500;
}

.file-size {
  color: var(--theme-text-secondary);
  font-size: 14px;
}

/* Barre de progression */
.upload-progress {
  margin: 16px 0;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--theme-surface-elevated);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  background: var(--theme-accent);
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  text-align: center;
  font-size: 14px;
  color: var(--theme-text-secondary);
}

/* ============================================
   Sources V2 - Category-based UI
   ============================================ */
.sources-v2-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;
}

/* 2 colonnes sur √©crans larges */
@media (min-width: 1200px) {
  .sources-v2-container {
    grid-template-columns: 1fr 1fr;
  }
}

.category-section {
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 12px;
  padding: 20px;
}

.category-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--theme-border);
}

.category-icon {
  font-size: 24px;
}

.category-header h4 {
  margin: 0;
  flex: 1;
  font-size: 18px;
}

.status-badge.active {
  background: #d4edda;
  color: #155724;
}

.status-badge.not_configured {
  background: #e2e3e5;
  color: #383d41;
}

.source-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.source-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.group-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--theme-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.source-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--theme-surface-elevated);
}

.source-option:hover {
  border-color: var(--theme-accent);
}

.source-option.active {
  border-color: var(--theme-accent);
  background: rgba(var(--theme-accent-rgb), 0.1);
}

.source-option input[type="radio"] {
  margin: 0;
  width: 18px;
  height: 18px;
}

.source-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.source-info strong {
  display: block;
  font-size: 14px;
}

.source-config-panel {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--theme-border);
}

/* Manual Source Editor Styles */
.manual-source-editor {
  margin-top: 8px;
}

.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.header-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-info h4 {
  margin: 0;
  font-size: 16px;
}

.header-total .total-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--theme-success);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--theme-text-muted);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.empty-state .hint {
  font-size: 13px;
  margin-top: 8px;
}

.table-container {
  overflow-x: auto;
  margin: 16px 0;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th,
.data-table td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--theme-border);
}

.data-table th {
  font-weight: 600;
  background: var(--theme-surface-elevated);
  color: var(--theme-text-muted);
  font-size: 12px;
  text-transform: uppercase;
}

.data-table tbody tr:hover {
  background: var(--theme-surface-elevated);
}

.data-table .actions {
  white-space: nowrap;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  font-size: 16px;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.btn-icon:hover {
  opacity: 1;
}

.add-form {
  margin-top: 20px;
  padding: 16px;
  background: var(--theme-surface-elevated);
  border-radius: 8px;
}

.add-form h5 {
  margin: 0 0 16px 0;
  font-size: 14px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-size: 12px;
  font-weight: 500;
  color: var(--theme-text-muted);
}

.form-group input,
.form-group select {
  padding: 8px 12px;
  border: 1px solid var(--theme-border);
  border-radius: 6px;
  background: var(--theme-surface);
  color: var(--theme-text);
  font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--theme-accent);
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

/* Modal Styles for V2 */
.modal-overlay.hidden {
  display: none;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--theme-surface);
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--theme-border);
}

.modal-header h4 {
  margin: 0;
}

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--theme-text-muted);
}

.close-modal:hover {
  color: var(--theme-text);
}

/* ============================================
   CSV File Manager - P0 Improvements
   ============================================ */
.csv-file-manager-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Active File Card */
.active-file-section {
  margin-bottom: 8px;
}

.active-file-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background: var(--theme-surface-elevated);
  border: 2px solid var(--success);
  border-radius: 12px;
  transition: all 0.2s ease;
}

.active-file-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.active-file-card .file-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.active-file-card .file-icon {
  font-size: 24px;
}

.active-file-card .file-details {
  flex: 1;
}

.active-file-card .file-name {
  font-weight: 600;
  font-size: 14px;
  color: var(--theme-text);
  margin-bottom: 4px;
}

.active-file-card .file-meta {
  font-size: 12px;
  color: var(--theme-text-muted);
}

.active-file-card .file-actions {
  display: flex;
  gap: 8px;
}

/* Other Files Dropdown */
.other-files-section {
  margin-top: 8px;
}

.dropdown-toggle {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--theme-text);
  font-weight: 500;
}

.dropdown-toggle:hover {
  background: var(--theme-surface-elevated);
  border-color: var(--theme-accent);
}

.dropdown-icon {
  transition: transform 0.3s ease;
}

.dropdown-content {
  margin-top: 8px;
  padding: 8px;
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  max-height: 400px;
  overflow-y: auto;
}

.dropdown-content.hidden {
  display: none;
}

/* File Items in Dropdown */
.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  margin-bottom: 6px;
  background: var(--theme-surface-elevated);
  border: 1px solid var(--theme-border);
  border-radius: 6px;
  transition: all 0.2s ease;
}

.file-item:last-child {
  margin-bottom: 0;
}

.file-item:hover {
  border-color: var(--theme-accent);
  background: var(--theme-surface);
}

.file-item .file-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.file-item .file-icon {
  font-size: 18px;
}

.file-item .file-details {
  flex: 1;
}

.file-item .file-name-small {
  font-size: 13px;
  font-weight: 500;
  color: var(--theme-text);
}

.file-item .file-meta-small {
  font-size: 11px;
  color: var(--theme-text-muted);
  margin-top: 2px;
}

.file-item .file-actions-small {
  display: flex;
  gap: 6px;
}

/* Button Icons */
.btn-icon-small {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  opacity: 0.7;
  transition: opacity 0.2s;
  padding: 4px;
}

.btn-icon-small:hover {
  opacity: 1;
}

.btn-icon-small.danger:hover {
  color: var(--danger);
}

.btn-icon-small.activate-btn {
  filter: grayscale(0);
}

.btn-icon-small.activate-btn:hover {
  opacity: 1;
  transform: scale(1.15);
}

/* Empty State */
.empty-state-small {
  text-align: center;
  padding: 24px;
  color: var(--theme-text-muted);
  font-size: 13px;
}

/* Drag & Drop Zone - P2 */
.drag-drop-zone {
  margin-top: 16px;
  padding: 32px 16px;
  border: 2px dashed var(--theme-border);
  border-radius: 12px;
  background: var(--theme-surface);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.drag-drop-zone:hover {
  border-color: var(--theme-accent);
  background: color-mix(in oklab, var(--theme-accent) 5%, var(--theme-surface));
}

.drag-drop-zone.drag-over {
  border-color: var(--success);
  background: color-mix(in oklab, var(--success) 10%, var(--theme-surface));
  border-style: solid;
  transform: scale(1.02);
}

.drag-drop-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.drag-icon {
  font-size: 48px;
  opacity: 0.5;
}

.drag-text {
  font-size: 16px;
  font-weight: 500;
  color: var(--theme-text);
  margin: 0;
}

.drag-hint {
  font-size: 12px;
  color: var(--theme-text-muted);
  margin: 0;
}

/* Preview Modal Enhancements */
.csv-preview-modal .summary-card {
  flex: 1;
  min-width: 120px;
  padding: 12px;
  background: var(--theme-surface-elevated);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  text-align: center;
}

.csv-preview-modal .summary-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--theme-text-muted);
  margin-bottom: 4px;
}

.csv-preview-modal .summary-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--theme-text);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .active-file-card {
    flex-direction: column;
    align-items: flex-start;
  }

  .active-file-card .file-actions {
    width: 100%;
    justify-content: flex-end;
    margin-top: 12px;
  }

  .file-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .file-item .file-actions-small {
    width: 100%;
    justify-content: flex-end;
    margin-top: 8px;
  }

  .csv-preview-modal .modal-content {
    width: 95%;
    max-width: none;
  }
}

/* ============================================
   P1/P2 Features - Health Status & Comparison
   ============================================ */

/* Category Header Actions */
.category-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--theme-border);
}

.category-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}

/* Health Status Bar */
.health-status-bar {
  margin-bottom: 16px;
}

.health-bar {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  border-radius: 8px;
  background: var(--theme-surface-elevated);
  border-left: 4px solid var(--theme-border);
}

.health-bar.success {
  border-left-color: var(--success);
  background: color-mix(in oklab, var(--success) 5%, var(--theme-surface-elevated));
}

.health-bar.warning {
  border-left-color: var(--warning);
  background: color-mix(in oklab, var(--warning) 5%, var(--theme-surface-elevated));
}

.health-bar.error {
  border-left-color: var(--danger);
  background: color-mix(in oklab, var(--danger) 5%, var(--theme-surface-elevated));
}

.health-metric {
  display: flex;
  align-items: center;
  gap: 6px;
}

.metric-icon {
  font-size: 18px;
}

.metric-value {
  font-weight: 600;
  font-size: 16px;
  color: var(--theme-text);
}

.metric-label {
  font-size: 12px;
  color: var(--theme-text-muted);
}

.health-icon {
  font-size: 20px;
}

.health-text {
  font-size: 14px;
  color: var(--theme-text);
}

/* Comparison Modal */
.comparison-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.comparison-card {
  padding: 16px;
  background: var(--theme-surface-elevated);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  transition: all 0.2s ease;
}

.comparison-card.available {
  border-color: var(--success);
}

.comparison-card.unavailable {
  opacity: 0.6;
}

.comparison-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--theme-border);
}

.comparison-header h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
}

.comparison-metrics {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.comparison-metrics .metric {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.comparison-metrics .metric-label {
  font-size: 12px;
  color: var(--theme-text-muted);
}

.comparison-metrics .metric-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--theme-text);
}

.empty-comparison {
  text-align: center;
  padding: 16px 8px;
  color: var(--theme-text-muted);
  font-size: 13px;
}

/* Insights Section */
.insights-section {
  margin-top: 16px;
  padding: 12px 16px;
  border-radius: 8px;
  border-left: 4px solid var(--theme-accent);
  background: var(--theme-surface-elevated);
}

.insights-section.warning {
  border-left-color: var(--warning);
  background: color-mix(in oklab, var(--warning) 5%, var(--theme-surface-elevated));
}

.insights-section.success {
  border-left-color: var(--success);
  background: color-mix(in oklab, var(--success) 5%, var(--theme-surface-elevated));
}

.insights-section h5 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
}

.insights-section p {
  margin: 0;
  font-size: 13px;
  color: var(--theme-text);
}

/* ============================================
   History Modal - P2
   ============================================ */
.history-timeline {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.history-entry {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  background: var(--theme-surface-elevated);
  border-radius: 8px;
  border-left: 3px solid var(--theme-accent);
}

.history-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.history-content {
  flex: 1;
}

.history-change {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 14px;
  margin-bottom: 4px;
}

.history-change .old-source {
  color: var(--theme-text-muted);
}

.history-change .arrow {
  color: var(--theme-accent);
  font-weight: bold;
}

.history-change .new-source {
  color: var(--theme-text);
  font-weight: 600;
}

.history-time {
  font-size: 12px;
  color: var(--theme-text-muted);
}

/* ============================================
   Recommendations Modal - P2
   ============================================ */
.recommendations-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.recommendation-card {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  background: var(--theme-surface-elevated);
  border-radius: 8px;
  border-left: 4px solid var(--theme-border);
}

.recommendation-card.warning {
  border-left-color: var(--warning);
  background: color-mix(in oklab, var(--warning) 5%, var(--theme-surface-elevated));
}

.recommendation-card.info {
  border-left-color: var(--theme-accent);
  background: color-mix(in oklab, var(--theme-accent) 5%, var(--theme-surface-elevated));
}

.recommendation-card.success {
  border-left-color: var(--success);
  background: color-mix(in oklab, var(--success) 5%, var(--theme-surface-elevated));
}

.recommendation-card.priority-high {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.rec-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.rec-content {
  flex: 1;
}

.rec-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--theme-text);
  margin-bottom: 6px;
}

.rec-message {
  font-size: 13px;
  color: var(--theme-text);
  line-height: 1.5;
}

/* Responsive - P1/P2 */
@media (max-width: 768px) {
  .health-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .comparison-grid {
    grid-template-columns: 1fr;
  }

  .category-header {
    flex-wrap: wrap;
  }

  .category-header-actions {
    width: 100%;
    justify-content: flex-end;
  }
}
</style>

<!-- JavaScript d'initialisation -->

<script src="modules/settings-sources-utils.js"></script>


    <!-- Advanced Tab -->
    <section class="tab-panel" id="tab-advanced">

      <!-- Configuration & Donn√©es -->
      <div class="card"
        data-tooltip="User configuration backup and restore."
        data-source="Internal system functions">
        <h3>üíæ Configuration & Data</h3>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn secondary" onclick="exportSettings()">üì§ Export Config</button>
          <button class="btn secondary" onclick="importSettings()">üì• Import Config</button>
          <button class="btn danger" onclick="resetAllData()">‚ö†Ô∏è Full Reset</button>
        </div>
      </div>

      <!-- Cache Management -->
      <div class="card"
        data-tooltip="Advanced local and backend cache management to optimize performance."
        data-source="Redis + LocalStorage">
        <h3>üóÑÔ∏è Cache Management</h3>
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
          <button class="btn secondary" onclick="clearLocalCache()">üóëÔ∏è Clear Local Cache</button>
          <button class="btn secondary" onclick="clearBackendCache()">üîÑ Clear Backend Cache</button>
          <button class="btn secondary" onclick="showCacheStats()">üìä Cache Statistics</button>
        </div>
        <div id="cache-stats-display" style="font-size: 13px; color: var(--theme-text-muted);"></div>
      </div>

      <!-- Logs & Diagnostics -->
      <div class="card"
        data-tooltip="System log viewer and network diagnostics."
        data-source="Logs backend + API health checks">
        <h3>üìã Logs & Diagnostics</h3>
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
          <button class="btn secondary" onclick="viewRecentLogs()">üëÅÔ∏è View Recent Logs</button>
          <button class="btn secondary" onclick="downloadLogs()">üì• Download Logs</button>
          <button class="btn secondary" onclick="pingBackend()">üèì Latency Test</button>
        </div>
        <div id="logs-display" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background: var(--theme-surface-elevated); padding: 8px; border-radius: 6px; display: none;"></div>
        <div id="ping-results" style="margin-top: 8px; font-size: 13px;"></div>
      </div>

      <!-- Detailed Diagnostics -->
      <div class="card"
        data-tooltip="Individual component tests for precise diagnostics."
        data-source="Tests API granulaires">
        <h3>üîç Detailed Diagnostics</h3>
        <div class="test-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 12px;">
          <button class="btn small secondary" onclick="testRedis()">üî¥ Redis</button>
          <button class="btn small secondary" onclick="testMLModels()">ü§ñ ML Models</button>
          <button class="btn small secondary" onclick="testRiskAPI()">üõ°Ô∏è Risk API</button>
          <button class="btn small secondary" onclick="testAlerts()">üîî Alerts</button>
          <button class="btn small secondary" onclick="testSaxo()">üìä Saxo</button>
          <button class="btn small secondary" onclick="testWealth()">üí∞ Wealth</button>
          <button class="btn small secondary" onclick="testSources()">üìÅ Sources</button>
          <button class="btn small secondary" onclick="testGovernance()">‚öôÔ∏è Governance</button>
        </div>
        <div id="detailed-test-results" class="test-result" style="margin-top: 12px;"></div>
      </div>

      <!-- Complete System Test -->
      <div class="card"
        data-tooltip="Global test of all critical system components."
        data-source="Tests API complets">
        <h3>üß™ Complete System Test</h3>
        <p style="font-size: 13px; color: var(--theme-text-muted); margin-bottom: 12px;">
          Runs a complete battery of tests covering all components: Backend, Redis, ML, Risk, Alerts, Saxo, Wealth, Sources, Governance, and more.
        </p>
        <button class="btn" onclick="runFullSystemTest()">üöÄ Lancer Test Complet</button>
        <div id="full-system-test"></div>
      </div>

      <!-- Admin Quick Access (conditional) -->
      <div class="card" id="admin-quick-access" style="display: none;"
        data-tooltip="Quick access to admin dashboard (administrators only)."
        data-source="RBAC - Admin role required">
        <h3>üëë Administration</h3>
        <p style="font-size: 13px; color: var(--theme-text-muted); margin-bottom: 12px;">
          Quick access to system administration functions.
        </p>
        <button class="btn" onclick="location.href='admin-dashboard.html'">
          üéõÔ∏è Open Admin Dashboard
        </button>
      </div>

    </section>

  </div>
  </main>

  <script src="modules/settings-tabs-controller.js"></script>
  <script type="module" src="modules/settings-main-controller.js"></script>



  <script>
    // Initialisation automatique de la navigation simple
    document.addEventListener('DOMContentLoaded', function () {
      /* unified nav enabled via components/nav.js; legacy init removed */

      // Check if we're in OAuth popup callback
      const urlParams = new URLSearchParams(window.location.search);
      const status = urlParams.get('status');

      if (status === 'connected' && window.opener) {
        // We're in the OAuth popup and connection succeeded
        // Close the popup automatically
        window.close();
        return;
      }

      if (status === 'error' && window.opener) {
        // Connection failed in popup
        const message = urlParams.get('message') || 'Unknown error';
        alert('‚ùå OAuth Error: ' + decodeURIComponent(message));
        window.close();
        return;
      }

      // Initialize Saxo OAuth status (only if not in popup)
      updateSaxoOAuthStatus();
    });

    // ===== Premium Keys Toggle =====
    function togglePremiumKeys() {
      const section = document.getElementById('premium-keys-section');
      const icon = document.getElementById('premium-keys-icon');

      if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñ≤';
      } else {
        section.style.display = 'none';
        icon.textContent = '‚ñº';
      }
    }

    // ===== API Key Visibility Toggle =====
    function toggleApiKeyVisibility(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      if (input.type === 'password') {
        input.type = 'text';
      } else {
        input.type = 'password';
      }
    }

    // ===== SaxoBank OAuth Functions =====

    async function updateSaxoOAuthStatus() {
      try {
        const activeUser = localStorage.getItem('activeUser') || 'demo';
        const response = await fetch('/api/saxo/auth/status', {
          headers: { 'X-User': activeUser }
        });

        if (!response.ok) throw new Error('Failed to fetch status');

        const data = await response.json();
        const status = data.data;

        const statusBanner = document.getElementById('saxo-status-banner');
        const statusText = document.getElementById('saxo-status-text');
        const connectBtn = document.getElementById('saxo-connect-btn');
        const disconnectBtn = document.getElementById('saxo-disconnect-btn');
        const refreshBtn = document.getElementById('saxo-refresh-btn');
        const infoCard = document.getElementById('saxo-info');

        // Determine state based on new "status" field (or fallback to legacy "connected" field)
        const connectionState = status.status || (status.connected ? 'connected' : 'disconnected');

        if (connectionState === 'connected') {
          // Connected state
          statusBanner.className = 'status-indicator status-ok';
          statusText.textContent = '‚úÖ Connected to Saxo Bank API';

          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'inline-block';
          refreshBtn.style.display = 'inline-block';
          infoCard.style.display = 'block';

          // Update info
          document.getElementById('saxo-env').textContent = status.environment === 'sim' ? 'Simulation' : 'Production (Live)';
          document.getElementById('saxo-expires').textContent = new Date(status.expires_at).toLocaleString('en-US');
          document.getElementById('saxo-last-update').textContent = new Date(status.last_update).toLocaleString('en-US');
        } else if (connectionState === 'expired') {
          // Token expired state - Auto-disconnect silencieusement
          try {
            await fetch('/api/saxo/auth/disconnect', {
              method: 'POST',
              headers: { 'X-User': activeUser }
            });
          } catch (err) {
            console.warn('Auto-disconnect failed (non-critical):', err);
          }

          // Afficher comme d√©connect√©
          statusBanner.className = 'status-indicator status-warning';
          statusText.textContent = '‚ö†Ô∏è Session expired - Please reconnect';

          connectBtn.style.display = 'inline-block';
          disconnectBtn.style.display = 'none';  // D√©j√† d√©connect√©
          refreshBtn.style.display = 'none';
          infoCard.style.display = 'none';
        } else {
          // Disconnected state (no tokens)
          statusBanner.className = 'status-indicator status-warning';
          statusText.textContent = '‚ö†Ô∏è Not connected';

          connectBtn.style.display = 'inline-block';
          disconnectBtn.style.display = 'none';
          refreshBtn.style.display = 'none';
          infoCard.style.display = 'none';
        }
      } catch (error) {
        console.error('Error fetching Saxo status:', error);
        const statusBanner = document.getElementById('saxo-status-banner');
        const statusText = document.getElementById('saxo-status-text');
        statusBanner.className = 'status-indicator status-error';
        statusText.textContent = '‚ùå Error retrieving status';
      }
    }

    async function initSaxoLogin() {
      try {
        const activeUser = localStorage.getItem('activeUser') || 'demo';
        const response = await fetch('/api/saxo/auth/login', {
          headers: { 'X-User': activeUser }
        });

        if (!response.ok) throw new Error('Failed to generate login URL');

        const data = await response.json();
        const authUrl = data.data.authorization_url;

        // Open OAuth popup
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        const popup = window.open(
          authUrl,
          'SaxoLogin',
          `width=${width},height=${height},left=${left},top=${top}`
        );

        // Poll for completion
        const pollInterval = setInterval(async () => {
          if (popup.closed) {
            clearInterval(pollInterval);
            await updateSaxoOAuthStatus();
            const banner = document.getElementById('saxo-status-banner');
            if (banner.className.includes('status-ok')) {
              alert('‚úÖ Saxo connection successful!');
            }
          }
        }, 2000);
      } catch (error) {
        console.error('Error initiating Saxo login:', error);
        alert('‚ùå Error connecting to Saxo: ' + error.message);
      }
    }

    async function disconnectSaxo() {
      if (!confirm('Do you really want to disconnect from Saxo Bank API?')) {
        return;
      }

      try {
        const activeUser = localStorage.getItem('activeUser') || 'demo';
        const response = await fetch('/api/saxo/auth/disconnect', {
          method: 'POST',
          headers: { 'X-User': activeUser }
        });

        // Always refresh status, even if disconnect had issues
        await updateSaxoOAuthStatus();

        if (response.ok) {
          alert('‚úÖ Successfully disconnected');
        } else {
          // Disconnect endpoint is now graceful, but show warning if unexpected error
          console.warn('Disconnect returned non-ok status, but state cleared');
          alert('‚ö†Ô∏è Tokens deleted (session may have already expired)');
        }
      } catch (error) {
        console.error('Error disconnecting from Saxo:', error);
        // Still try to update status
        await updateSaxoOAuthStatus();
        alert('‚ö†Ô∏è Network error, but local tokens removed');
      }
    }

    async function refreshSaxoToken() {
      try {
        const activeUser = localStorage.getItem('activeUser') || 'demo';
        const response = await fetch('/api/saxo/auth/refresh', {
          method: 'POST',
          headers: { 'X-User': activeUser }
        });

        if (!response.ok) {
          const data = await response.json();
          if (response.status === 401) {
            alert('‚ö†Ô∏è Token expired - please reconnect');
            await updateSaxoOAuthStatus();
            return;
          }
          throw new Error(data.error || 'Failed to refresh token');
        }

        await updateSaxoOAuthStatus();
        alert('‚úÖ Token refreshed successfully');
      } catch (error) {
        console.error('Error refreshing Saxo token:', error);
        alert('‚ùå Error refreshing: ' + error.message);
      }
    }

    // ===== Sources V2 Initialization =====
    // Initialize SourcesManagerV2 when the Sources tab is activated
    let sourcesManagerV2Instance = null;

    async function initializeSourcesV2() {
      if (sourcesManagerV2Instance) {
        // Already initialized, just re-render
        await sourcesManagerV2Instance.renderUI('sources-v2-container');
        return;
      }

      try {
        console.log('[Settings] Initializing Sources V2...');
        sourcesManagerV2Instance = new SourcesManagerV2();
        await sourcesManagerV2Instance.renderUI('sources-v2-container');
        console.log('[Settings] Sources V2 initialized successfully');
      } catch (error) {
        console.error('[Settings] Error initializing Sources V2:', error);
        const container = document.getElementById('sources-v2-container');
        if (container) {
          container.innerHTML = `
            <div class="error-state" style="text-align: center; padding: 40px 20px; color: var(--danger);">
              <div style="font-size: 48px; margin-bottom: 12px;">‚ùå</div>
              <div style="font-size: 16px; font-weight: 600;">Loading Error</div>
              <div style="font-size: 13px; margin-top: 8px; color: var(--theme-text-muted);">${error.message}</div>
              <button class="btn secondary" onclick="initializeSourcesV2()" style="margin-top: 16px;">
                üîÑ Retry
              </button>
            </div>
          `;
        }
      }
    }

    // Initialize Sources V2 when Sources tab becomes visible
    document.addEventListener('DOMContentLoaded', function() {
      // Listen for tab changes
      const sourcesTabBtn = document.querySelector('[data-target="#tab-sources"]');
      if (sourcesTabBtn) {
        sourcesTabBtn.addEventListener('click', function() {
          // Defer initialization to next tick to ensure tab is visible
          setTimeout(() => initializeSourcesV2(), 100);
        });
      }

      // If Sources tab is already active on page load, initialize immediately
      const sourcesTab = document.getElementById('tab-sources');
      if (sourcesTab && sourcesTab.classList.contains('active')) {
        initializeSourcesV2();
      }
    });
  </script>
</body>

</html>