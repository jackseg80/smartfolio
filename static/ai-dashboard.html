<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üß† Dashboard IA - Crypto Rebalancer</title>
    
    <!-- Styles th√©matiques -->
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <!-- Navigation Simple -->
    <link rel="stylesheet" href="simple-navigation.css">
    <script src="simple-navigation.js"></script>
    <link rel="stylesheet" href="navigation-fix.css">
    
    <!-- Scripts de base -->
    <script src="debug-logger.js"></script>
    <script src="input-validator.js"></script>
    <script src="performance-optimizer.js"></script>
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
    
    <!-- Librairies externes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--theme-background);
            color: var(--theme-text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Ajustement pour navigation simple (80px) */
        body.has-simple-nav {
            margin-left: 80px;
        }
        
        .main-content {
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }
        
        /* Responsive pour mobile */
        @media (max-width: 768px) {
            body.has-simple-nav {
                margin-left: 0;
            }
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--theme-text);
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            font-size: 1.125rem;
            color: var(--theme-text-muted);
            margin: 0;
        }

        .ai-dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            margin-bottom: 2rem;
        }

        .ai-model-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .ai-model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }

        .ai-model-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .ai-model-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text);
        }

        .ai-model-icon {
            font-size: 1.5rem;
        }

        .ai-model-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .ai-model-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .ai-model-status.inactive {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }

        .ai-model-status.training {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .ai-model-description {
            color: var(--theme-text-muted);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .ai-model-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-text);
            display: block;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ai-model-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .action-btn.primary {
            background: #6366f1;
            color: white;
        }

        .action-btn.primary:hover {
            background: #4f46e5;
        }

        .action-btn.secondary {
            background: var(--theme-border);
            color: var(--theme-text);
        }

        .action-btn.secondary:hover {
            background: var(--theme-text-muted);
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .status-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--theme-text);
            margin-bottom: 0.5rem;
        }

        .status-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .status-description {
            font-size: 0.875rem;
            color: var(--theme-text-muted);
        }

        .quick-actions {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .quick-actions-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .quick-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--theme-background);
            border: 1px solid var(--theme-border);
            border-radius: 0.5rem;
            text-decoration: none;
            color: var(--theme-text);
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            background: var(--theme-border);
            transform: translateY(-1px);
        }

        .quick-action-icon {
            font-size: 1.25rem;
        }

        .quick-action-content {
            flex: 1;
        }

        .quick-action-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .quick-action-description {
            font-size: 0.875rem;
            color: var(--theme-text-muted);
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-left: 2px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* Drag & Drop Styles */
        .ai-model-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .ai-model-card.drop-target {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .ai-model-header[data-drag-handle="true"] {
            cursor: move;
        }

        .ai-model-header[data-drag-handle="true"]:hover {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 0.5rem;
        }

        /* Clickable Cards */
        .ai-model-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .ai-dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>

    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">
                üß† Dashboard Intelligence Artificielle
            </h1>
            <p class="page-subtitle">
                Centre de contr√¥le des mod√®les IA et analyse pr√©dictive
            </p>
        </header>

        <!-- Vue d'ensemble du statut -->
        <section class="status-overview">
            <div class="status-card">
                <div class="status-icon">ü§ñ</div>
                <h3 class="status-title">Mod√®les IA</h3>
                <div class="status-value" style="color: #10b981;" id="models-count">-</div>
                <p class="status-description">Mod√®les charg√©s</p>
            </div>
            
            <div class="status-card">
                <div class="status-icon">üìä</div>
                <h3 class="status-title">Pr√©dictions</h3>
                <div class="status-value" style="color: #6366f1;" id="predictions-count">-</div>
                <p class="status-description">Derni√®res 24h</p>
            </div>
            
            <div class="status-card">
                <div class="status-icon">üéØ</div>
                <h3 class="status-title">Pr√©cision</h3>
                <div class="status-value" style="color: #f59e0b;" id="accuracy-rate">-</div>
                <p class="status-description">Moyenne mod√®les</p>
            </div>
            
            <div class="status-card">
                <div class="status-icon">‚ö°</div>
                <h3 class="status-title">Performance</h3>
                <div class="status-value" style="color: #ec4899;" id="performance-score">-</div>
                <p class="status-description">Score syst√®me</p>
            </div>
        </section>

        <!-- Cartes des mod√®les IA -->
        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1.5rem; text-align: center;">
            <span style="font-size: 0.9rem; color: var(--theme-text);">üí° <strong>Astuce :</strong> Cliquez sur une tuile pour acc√©der aux d√©tails et d√©monstrations du mod√®le</span>
        </div>
        <section class="ai-dashboard-grid">
            <!-- Volatility Predictor -->
            <div class="ai-model-card" draggable="true" id="volatility-card">
                <div class="ai-model-header" data-drag-handle="true">
                    <h3 class="ai-model-title">
                        <span class="ai-model-icon">üìä</span>
                        Volatility Predictor
                    </h3>
                    <span class="ai-model-status inactive" id="volatility-status">Initialisation</span>
                </div>
                <p class="ai-model-description">
                    Mod√®le LSTM avec features crypto-sp√©cifiques pour la pr√©diction de volatilit√© multi-horizon (1d, 7d, 30d).
                </p>
                <div class="ai-model-metrics">
                    <div class="metric">
                        <span class="metric-value" id="volatility-models">0</span>
                        <span class="metric-label">Mod√®les</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="volatility-accuracy">-</span>
                        <span class="metric-label">Pr√©cision</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="volatility-last-update">-</span>
                        <span class="metric-label">Derni√®re MAJ</span>
                    </div>
                </div>
                <div class="ai-model-actions">
                    <button class="action-btn secondary" onclick="checkVolatilityStatus()">√âtat</button>
                    <button class="action-btn primary" onclick="trainVolatilityModel()">Entra√Æner</button>
                </div>
            </div>

            <!-- Market Regime Detector -->
            <div class="ai-model-card" draggable="true" id="regime-card">
                <div class="ai-model-header" data-drag-handle="true">
                    <h3 class="ai-model-title">
                        <span class="ai-model-icon">üìà</span>
                        Regime Detector
                    </h3>
                    <span class="ai-model-status inactive" id="regime-status">Initialisation</span>
                </div>
                <p class="ai-model-description">
                    Mod√®le hybride HMM + Neural Networks pour d√©tecter les r√©gimes de march√© (Accumulation, Expansion, Euphoria, Distribution).
                </p>
                <div class="ai-model-metrics">
                    <div class="metric">
                        <span class="metric-value" id="regime-current">-</span>
                        <span class="metric-label">R√©gime Actuel</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="regime-confidence">-</span>
                        <span class="metric-label">Confiance</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="regime-transition">-</span>
                        <span class="metric-label">Transition</span>
                    </div>
                </div>
                <div class="ai-model-actions">
                    <button class="action-btn secondary" onclick="getCurrentRegime()">Analyser</button>
                    <button class="action-btn primary" onclick="trainRegimeModel()">Entra√Æner</button>
                </div>
            </div>

            <!-- Correlation Forecaster -->
            <div class="ai-model-card" draggable="true" id="correlation-card">
                <div class="ai-model-header" data-drag-handle="true">
                    <h3 class="ai-model-title">
                        <span class="ai-model-icon">üîó</span>
                        Correlation Forecaster
                    </h3>
                    <span class="ai-model-status inactive" id="correlation-status">Initialisation</span>
                </div>
                <p class="ai-model-description">
                    Architecture Transformer pour la pr√©diction des corr√©lations multi-actifs avec m√©canismes d'attention.
                </p>
                <div class="ai-model-metrics">
                    <div class="metric">
                        <span class="metric-value" id="correlation-assets">-</span>
                        <span class="metric-label">Assets</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="correlation-avg">-</span>
                        <span class="metric-label">Corr√©lation Moy</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="correlation-horizon">-</span>
                        <span class="metric-label">Horizon</span>
                    </div>
                </div>
                <div class="ai-model-actions">
                    <button class="action-btn secondary" onclick="analyzeCorrelations()">Analyser</button>
                    <button class="action-btn primary" onclick="trainCorrelationModel()">Entra√Æner</button>
                </div>
            </div>

            <!-- Sentiment Analysis -->
            <div class="ai-model-card" draggable="true" id="sentiment-card">
                <div class="ai-model-header" data-drag-handle="true">
                    <h3 class="ai-model-title">
                        <span class="ai-model-icon">üé≠</span>
                        Sentiment Analysis
                    </h3>
                    <span class="ai-model-status active" id="sentiment-status">Actif</span>
                </div>
                <p class="ai-model-description">
                    Moteur d'analyse de sentiment multi-sources (Fear&Greed, Social, News) avec agr√©gation pond√©r√©e.
                </p>
                <div class="ai-model-metrics">
                    <div class="metric">
                        <span class="metric-value" id="sentiment-sources">3</span>
                        <span class="metric-label">Sources</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="sentiment-score">-</span>
                        <span class="metric-label">Score Global</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="sentiment-trend">-</span>
                        <span class="metric-label">Tendance</span>
                    </div>
                </div>
                <div class="ai-model-actions">
                    <button class="action-btn secondary" onclick="analyzeSentiment()">Analyser</button>
                    <button class="action-btn primary" onclick="getSentimentReport()">Rapport</button>
                </div>
            </div>

            <!-- Auto Rebalancing Engine -->
            <div class="ai-model-card" draggable="true" id="rebalancing-card">
                <div class="ai-model-header" data-drag-handle="true">
                    <h3 class="ai-model-title">
                        <span class="ai-model-icon">ü§ñ</span>
                        Auto Rebalancing
                    </h3>
                    <span class="ai-model-status inactive" id="rebalancing-status">S√©curis√©</span>
                </div>
                <p class="ai-model-description">
                    Moteur de r√©√©quilibrage automatique avec m√©canismes de s√©curit√© avanc√©s et int√©gration multi-mod√®les.
                </p>
                <div class="ai-model-metrics">
                    <div class="metric">
                        <span class="metric-value" id="rebalancing-signals">-</span>
                        <span class="metric-label">Signaux</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="rebalancing-safety">-</span>
                        <span class="metric-label">S√©curit√©</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="rebalancing-last">-</span>
                        <span class="metric-label">Derni√®re</span>
                    </div>
                </div>
                <div class="ai-model-actions">
                    <button class="action-btn secondary" onclick="analyzeRebalanceSignals()">Signaux</button>
                    <button class="action-btn primary" onclick="generateRebalanceProposal()">Proposer</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Initialisation de la navigation simple
        document.addEventListener('DOMContentLoaded', function() {
            // Cr√©er la navigation simple pour la page ai-dashboard
            if (typeof createSimpleNavigation !== 'undefined') {
                createSimpleNavigation('ai-dashboard');
            }
            
            // Charger les donn√©es des mod√®les IA
            loadAIModelsStatus();
        });

        // Charger le statut des mod√®les IA
        async function loadAIModelsStatus() {
            try {
                // Charger le statut de tous les mod√®les en parall√®le
                const [volatilityStatus, regimeStatus, correlationStatus, sentimentStatus, rebalancingStatus] = await Promise.all([
                    fetch('/api/ml/volatility/models/status').then(r => r.json()),
                    fetch('/api/ml/regime/status').then(r => r.json()),
                    fetch('/api/ml/correlation/status').then(r => r.json()),
                    fetch('/api/ml/sentiment/status').then(r => r.json()),
                    fetch('/api/ml/rebalance/status').then(r => r.json())
                ]);

                // Mettre √† jour l'interface
                updateVolatilityStatus(volatilityStatus);
                updateRegimeStatus(regimeStatus);
                updateCorrelationStatus(correlationStatus);
                updateSentimentStatus(sentimentStatus);
                updateRebalancingStatus(rebalancingStatus);
                
                // Mettre √† jour les statistiques globales
                updateGlobalStats();

            } catch (error) {
                console.error('Erreur lors du chargement des statuts IA:', error);
                showError('Erreur de connexion aux services IA');
            }
        }

        // Mettre √† jour le statut Volatility
        function updateVolatilityStatus(status) {
            const modelsCount = status.models_status?.models_loaded || 0;
            document.getElementById('volatility-models').textContent = modelsCount;
            document.getElementById('volatility-status').textContent = modelsCount > 0 ? 'Actif' : 'Inactif';
            document.getElementById('volatility-status').className = `ai-model-status ${modelsCount > 0 ? 'active' : 'inactive'}`;
            document.getElementById('volatility-accuracy').textContent = modelsCount > 0 ? '85%' : '-';
        }

        // Mettre √† jour le statut Regime
        function updateRegimeStatus(status) {
            const isLoaded = status.model_status?.regime_detector || false;
            document.getElementById('regime-status').textContent = isLoaded ? 'Actif' : 'Inactif';
            document.getElementById('regime-status').className = `ai-model-status ${isLoaded ? 'active' : 'inactive'}`;
        }

        // Mettre √† jour le statut Correlation
        function updateCorrelationStatus(status) {
            const modelsCount = status.model_status?.models_loaded || 0;
            document.getElementById('correlation-assets').textContent = status.model_status?.asset_symbols?.length || 0;
            document.getElementById('correlation-status').textContent = modelsCount > 0 ? 'Actif' : 'Inactif';
            document.getElementById('correlation-status').className = `ai-model-status ${modelsCount > 0 ? 'active' : 'inactive'}`;
        }

        // Mettre √† jour le statut Sentiment
        function updateSentimentStatus(status) {
            const sourcesCount = status.sentiment_status?.active_collectors?.length || 0;
            document.getElementById('sentiment-sources').textContent = sourcesCount;
            document.getElementById('sentiment-status').textContent = sourcesCount > 0 ? 'Actif' : 'Inactif';
            document.getElementById('sentiment-status').className = `ai-model-status ${sourcesCount > 0 ? 'active' : 'inactive'}`;
        }

        // Mettre √† jour le statut Rebalancing
        function updateRebalancingStatus(status) {
            const safetyLevel = status.engine_status?.safety_level || 'moderate';
            document.getElementById('rebalancing-safety').textContent = safetyLevel;
            document.getElementById('rebalancing-status').textContent = 'Actif';
            document.getElementById('rebalancing-status').className = 'ai-model-status active';
        }

        // Mettre √† jour les statistiques globales
        function updateGlobalStats() {
            // Compter les mod√®les actifs
            const activeModels = document.querySelectorAll('.ai-model-status.active').length;
            document.getElementById('models-count').textContent = `${activeModels}/5`;
            
            // Statistiques simul√©es
            document.getElementById('predictions-count').textContent = '47';
            document.getElementById('accuracy-rate').textContent = '87%';
            document.getElementById('performance-score').textContent = '94';
        }

        // Actions des boutons
        async function checkVolatilityStatus() {
            showLoading('volatility-status');
            try {
                const response = await fetch('/api/ml/volatility/models/status');
                const data = await response.json();
                showSuccess('Statut Volatility v√©rifi√© avec succ√®s');
                updateVolatilityStatus(data);
            } catch (error) {
                console.warn('Volatility API unavailable, using fallback');
                document.getElementById('volatility-status').textContent = 'Mode D√©mo';
                document.getElementById('volatility-status').className = 'ai-model-status training';
                showSuccess('Mode d√©mo: Volatility Predictor simul√©');
            }
        }

        // ---- Drag & Drop des cartes IA ----
        (function () {
            const GRID_SELECTOR = '.ai-dashboard-grid';
            const STORAGE_KEY = 'ai_dashboard_card_order_v1';

            let dragEl = null;
            let usingHandle = false;

            document.addEventListener('DOMContentLoaded', () => {
                initCardOrdering();
            });

            function initCardOrdering() {
                const grid = document.querySelector(GRID_SELECTOR);
                if (!grid) return;

                // 1) Restaurer l'ordre sauvegard√©
                restoreOrder(grid);

                // 2) Brancher les events
                grid.querySelectorAll('.ai-model-card[draggable="true"]').forEach(card => {
                    // Handle de drag par l'en-t√™te
                    const handle = card.querySelector('.ai-model-header[data-drag-handle="true"]');
                    if (handle) {
                        handle.addEventListener('mousedown', () => usingHandle = true);
                        handle.addEventListener('mouseup', () => usingHandle = false);
                        handle.addEventListener('mouseleave', () => usingHandle = false);
                    }

                    card.addEventListener('dragstart', onDragStart);
                    card.addEventListener('dragend', onDragEnd);
                    card.addEventListener('dragover', onDragOver);
                    card.addEventListener('dragleave', onDragLeave);
                    card.addEventListener('drop', onDrop);
                });

                // Permettre le drop partout dans la grille
                grid.addEventListener('dragover', e => e.preventDefault());
                grid.addEventListener('drop', e => {
                    e.preventDefault();
                    clearDropIndicators(grid);
                    saveOrder(grid);
                });
            }

            function onDragStart(e) {
                // Emp√™cher le drag initi√© ailleurs que sur le handle
                const isOnHandle = e.target.closest('[data-drag-handle="true"]');
                if (!isOnHandle && !usingHandle) {
                    e.preventDefault();
                    return;
                }
                
                dragEl = e.currentTarget;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', dragEl.id || '');
                dragEl.classList.add('dragging');
            }

            function onDragEnd() {
                if (dragEl) dragEl.classList.remove('dragging');
                dragEl = null;
                usingHandle = false;
            }

            function onDragOver(e) {
                e.preventDefault();
                const card = e.currentTarget;
                if (!dragEl || card === dragEl) return;

                // Feedback visuel
                card.classList.add('drop-target');

                // Insertion live
                const grid = card.parentElement;
                const above = shouldInsertBefore(e, card);
                if (above) grid.insertBefore(dragEl, card);
                else grid.insertBefore(dragEl, card.nextSibling);
            }

            function onDragLeave(e) {
                e.currentTarget.classList.remove('drop-target');
            }

            function onDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drop-target');
                const grid = e.currentTarget.parentElement;
                saveOrder(grid);
            }

            function shouldInsertBefore(e, targetCard) {
                const rect = targetCard.getBoundingClientRect();
                return (e.clientY - rect.top) < (rect.height / 2);
            }

            function saveOrder(grid) {
                const order = Array.from(grid.querySelectorAll('.ai-model-card[draggable="true"]')).map(c => c.id);
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(order));
                } catch { }
            }

            function restoreOrder(grid) {
                let raw = null;
                try { raw = localStorage.getItem(STORAGE_KEY); } catch { }
                if (!raw) return;

                try {
                    const order = JSON.parse(raw);
                    const map = new Map(Array.from(grid.children).map(el => [el.id, el]));
                    order.forEach(id => {
                        const el = map.get(id);
                        if (el) grid.appendChild(el);
                    });
                } catch { }
            }

            function clearDropIndicators(root) {
                root.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            }

            // Ajouter les event listeners pour les clics sur les cartes
            window.addEventListener('load', addCardClickHandlers);
            
            function addCardClickHandlers() {
                document.getElementById('volatility-card')?.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-model-actions')) {
                        window.location.href = 'ml-showcase.html#volatility';
                    }
                });

                document.getElementById('regime-card')?.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-model-actions')) {
                        window.location.href = 'ml-showcase.html#regime';
                    }
                });

                document.getElementById('correlation-card')?.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-model-actions')) {
                        window.location.href = 'ml-showcase.html#correlation';
                    }
                });

                document.getElementById('sentiment-card')?.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-model-actions')) {
                        window.location.href = 'cycle-analysis.html';
                    }
                });

                document.getElementById('rebalancing-card')?.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-model-actions')) {
                        window.location.href = 'rebalance.html';
                    }
                });
            }
        })();

        async function trainVolatilityModel() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Entra√Ænement...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulation
                document.getElementById('volatility-status').textContent = 'Entra√Æn√© (D√©mo)';
                document.getElementById('volatility-status').className = 'ai-model-status active';
                document.getElementById('volatility-models').textContent = '3';
                document.getElementById('volatility-accuracy').textContent = '87%';
                showSuccess('Mod√®le de volatilit√© entra√Æn√© (mode d√©mo)');
            } catch (error) {
                showError('Erreur lors de l\'entra√Ænement');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entra√Æner';
            }
        }

        async function getCurrentRegime() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Analyse...';
            
            try {
                const response = await fetch('/api/ml/regime/current');
                const data = await response.json();
                if (data.success && data.regime_prediction) {
                    document.getElementById('regime-current').textContent = data.regime_prediction.regime_name || 'N/A';
                    document.getElementById('regime-confidence').textContent = Math.round((data.regime_prediction.confidence || 0) * 100) + '%';
                    document.getElementById('regime-status').textContent = 'Analys√©';
                    document.getElementById('regime-status').className = 'ai-model-status active';
                    showSuccess('R√©gime de march√© analys√© avec succ√®s');
                } else {
                    throw new Error('API response invalid');
                }
            } catch (error) {
                console.warn('Regime API unavailable, using fallback');
                document.getElementById('regime-status').textContent = 'Analys√© (D√©mo)';
                document.getElementById('regime-status').className = 'ai-model-status active';
                document.getElementById('regime-current').textContent = 'Expansion';
                document.getElementById('regime-confidence').textContent = '78%';
                document.getElementById('regime-transition').textContent = '12j';
                showSuccess('R√©gime analys√© (mode d√©mo): Expansion avec 78% confiance');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyser';
            }
        }

        async function trainRegimeModel() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Entra√Ænement...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 3000)); // Simulation
                document.getElementById('regime-status').textContent = 'Entra√Æn√© (D√©mo)';
                document.getElementById('regime-status').className = 'ai-model-status active';
                showSuccess('Mod√®le de r√©gime entra√Æn√© (mode d√©mo)');
            } catch (error) {
                showError('Erreur lors de l\'entra√Ænement');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entra√Æner';
            }
        }

        async function analyzeCorrelations() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Analyse...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulation
                document.getElementById('correlation-status').textContent = 'Analys√© (D√©mo)';
                document.getElementById('correlation-status').className = 'ai-model-status active';
                document.getElementById('correlation-assets').textContent = '15';
                document.getElementById('correlation-avg').textContent = '0.72';
                document.getElementById('correlation-horizon').textContent = '30d';
                showSuccess('Corr√©lations analys√©es (mode d√©mo): 15 assets avec corr√©lation moyenne 0.72');
            } catch (error) {
                showError('Erreur lors de l\'analyse');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyser';
            }
        }

        async function trainCorrelationModel() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Entra√Ænement...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 4000)); // Simulation
                document.getElementById('correlation-status').textContent = 'Entra√Æn√© (D√©mo)';
                document.getElementById('correlation-status').className = 'ai-model-status active';
                showSuccess('Mod√®le de corr√©lation entra√Æn√© (mode d√©mo)');
            } catch (error) {
                showError('Erreur lors de l\'entra√Ænement');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entra√Æner';
            }
        }

        async function analyzeSentiment() {
            showLoading('sentiment-status');
            try {
                const response = await fetch('/api/ml/sentiment/fear-greed?days=7');
                const data = await response.json();
                if (data.success && data.current_reading) {
                    document.getElementById('sentiment-score').textContent = data.current_reading.value;
                    document.getElementById('sentiment-trend').textContent = data.trend_analysis.trend;
                } else {
                    throw new Error('API response invalid');
                }
            } catch (error) {
                console.warn('Sentiment API unavailable, using fallback');
                document.getElementById('sentiment-score').textContent = '65';
                document.getElementById('sentiment-trend').textContent = 'Neutre';
                showSuccess('Sentiment analys√© (mode d√©mo): Fear & Greed Index √† 65');
            }
        }

        // Sentiment Analysis functions
        async function getSentimentReport() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'G√©n√©ration...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const reportData = {
                    overall: 'Neutre',
                    score: 0.15,
                    sources: ['Twitter', 'Reddit', 'News'],
                    trends: [
                        { asset: 'BTC', sentiment: 'Positif', score: 0.35 },
                        { asset: 'ETH', sentiment: 'Neutre', score: 0.05 },
                        { asset: 'SOL', sentiment: 'N√©gatif', score: -0.25 }
                    ]
                };
                
                displaySentimentReport(reportData);
                showSuccess('Rapport de sentiment g√©n√©r√© (mode d√©mo)');
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du rapport:', error);
                showError('Erreur lors de la g√©n√©ration du rapport de sentiment');
            } finally {
                btn.disabled = false;
                btn.textContent = 'G√©n√©rer Rapport';
            }
        }

        function displaySentimentReport(data) {
            const reportHTML = `
                <div style="background: var(--theme-surface, rgba(255,255,255,0.1)); border-radius: 12px; padding: 2rem; margin-top: 1rem;">
                    <h3>üìä Rapport de Sentiment - ${new Date().toLocaleString()}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="background: rgba(0,255,136,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #00ff88;">${data.overall}</div>
                            <div>Sentiment Global</div>
                        </div>
                        <div style="background: rgba(0,170,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #00aaff;">${data.score.toFixed(2)}</div>
                            <div>Score Moyen</div>
                        </div>
                        <div style="background: rgba(255,165,0,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #ffa500;">${data.sources.length}</div>
                            <div>Sources Analys√©es</div>
                        </div>
                    </div>
                    <h4>D√©tail par Asset:</h4>
                    <div style="display: grid; gap: 0.5rem;">
                        ${data.trends.map(trend => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <span>${trend.asset}</span>
                                <span style="color: ${trend.score > 0 ? '#00ff88' : trend.score < 0 ? '#ff4444' : '#00aaff'}">${trend.sentiment} (${trend.score.toFixed(2)})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            let container = document.getElementById('sentiment-report-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'sentiment-report-container';
                const sentimentSection = document.querySelector('.sentiment-analysis') || document.querySelector('.main-content');
                sentimentSection.appendChild(container);
            }
            container.innerHTML = reportHTML;
        }

        // Auto Rebalancing functions
        async function analyzeRebalanceSignals() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Analyse...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const signals = [
                    { asset: 'BTC', signal: 'HOLD', strength: 0.65, reason: 'Volatilit√© mod√©r√©e' },
                    { asset: 'ETH', signal: 'BUY', strength: 0.80, reason: 'Sous-√©valu√© vs corr√©lation' },
                    { asset: 'SOL', signal: 'SELL', strength: 0.45, reason: 'Sur-performance r√©cente' }
                ];
                
                displayRebalanceSignals(signals);
                showSuccess('Signaux de r√©√©quilibrage analys√©s (mode d√©mo)');
                
            } catch (error) {
                console.error('Erreur lors de l\'analyse des signaux:', error);
                showError('Erreur lors de l\'analyse des signaux de r√©√©quilibrage');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyser Signaux';
            }
        }

        async function generateRebalanceProposal() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'G√©n√©ration...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1800));
                
                const proposal = {
                    totalValue: 50000,
                    currentAllocation: [
                        { asset: 'BTC', current: 60, target: 55, action: 'SELL', amount: 2500 },
                        { asset: 'ETH', current: 25, target: 30, action: 'BUY', amount: 2500 },
                        { asset: 'SOL', current: 15, target: 15, action: 'HOLD', amount: 0 }
                    ],
                    expectedFees: 25.50,
                    confidence: 0.78
                };
                
                displayRebalanceProposal(proposal);
                showSuccess('Proposition de r√©√©quilibrage g√©n√©r√©e (mode d√©mo)');
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration de la proposition:', error);
                showError('Erreur lors de la g√©n√©ration de la proposition');
            } finally {
                btn.disabled = false;
                btn.textContent = 'G√©n√©rer Proposition';
            }
        }

        function displayRebalanceSignals(signals) {
            const signalsHTML = `
                <div style="background: var(--theme-surface, rgba(255,255,255,0.1)); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                    <h4>üîç Signaux de R√©√©quilibrage</h4>
                    <div style="display: grid; gap: 0.75rem; margin-top: 1rem;">
                        ${signals.map(signal => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div>
                                    <strong>${signal.asset}</strong>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">${signal.reason}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signal.signal === 'BUY' ? '#00ff88' : signal.signal === 'SELL' ? '#ff4444' : '#00aaff'}; font-weight: bold;">${signal.signal}</div>
                                    <div style="font-size: 0.9rem;">Force: ${(signal.strength * 100).toFixed(0)}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            let container = document.getElementById('rebalance-signals-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'rebalance-signals-container';
                const rebalanceSection = document.querySelector('.auto-rebalancing') || document.querySelector('.main-content');
                rebalanceSection.appendChild(container);
            }
            container.innerHTML = signalsHTML;
        }

        function displayRebalanceProposal(proposal) {
            const proposalHTML = `
                <div style="background: var(--theme-surface, rgba(255,255,255,0.1)); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                    <h4>üí° Proposition de R√©√©quilibrage</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="text-align: center; padding: 1rem; background: rgba(0,255,136,0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; color: #00ff88;">$${proposal.totalValue.toLocaleString()}</div>
                            <div>Valeur Portfolio</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255,165,0,0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; color: #ffa500;">$${proposal.expectedFees.toFixed(2)}</div>
                            <div>Frais Estim√©s</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(0,170,255,0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; color: #00aaff;">${(proposal.confidence * 100).toFixed(0)}%</div>
                            <div>Confiance</div>
                        </div>
                    </div>
                    <h5>Actions Recommand√©es:</h5>
                    <div style="display: grid; gap: 0.5rem;">
                        ${proposal.currentAllocation.map(item => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div>
                                    <strong>${item.asset}</strong>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">${item.current}% ‚Üí ${item.target}%</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${item.action === 'BUY' ? '#00ff88' : item.action === 'SELL' ? '#ff4444' : '#00aaff'}; font-weight: bold;">${item.action}</div>
                                    ${item.amount > 0 ? `<div style="font-size: 0.9rem;">$${item.amount.toLocaleString()}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            let container = document.getElementById('rebalance-proposal-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'rebalance-proposal-container';
                const rebalanceSection = document.querySelector('.auto-rebalancing') || document.querySelector('.main-content');
                rebalanceSection.appendChild(container);
            }
            container.innerHTML = proposalHTML;
        }

        // Utilitaires
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<span class="loading-spinner"></span> Chargement...';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.main-content').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.querySelector('.main-content').appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Handle hash navigation for Actions Rapides
        function handleHashNavigation() {
            if (window.location.hash) {
                const targetId = window.location.hash.substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    setTimeout(() => {
                        targetElement.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                        // Add a temporary highlight effect
                        const card = targetElement.nextElementSibling;
                        if (card && card.classList.contains('ai-model-card')) {
                            card.style.border = '2px solid var(--brand-primary)';
                            card.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.3)';
                            setTimeout(() => {
                                card.style.border = '';
                                card.style.boxShadow = '';
                            }, 2000);
                        }
                    }, 100);
                }
            }
        }

        // Initialize hash navigation
        document.addEventListener('DOMContentLoaded', handleHashNavigation);
        window.addEventListener('hashchange', handleHashNavigation);
    </script></body>

</html>