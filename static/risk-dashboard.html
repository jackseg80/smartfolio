<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - SmartFolio</title>

  <!-- ThÃ¨me/compat identiques Ã  ta page actuelle -->
  <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partagÃ©s existants -->
  <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
  <script type="module" src="network-state-manager.js"></script> <!-- Network resilience layer -->
  <script src="appearance.js"></script> <!-- Critical: must load before first paint to avoid theme flash -->
  <script src="lazy-loader.js"></script>

  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>  <!-- âœ… SSOT hydration -->
  <script type="module" src="core/fetcher.js"></script>

  <!-- CCS modules ESM (kept for risk score calculations) -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>

  <!-- Unified asset groups system -->
  <script type="module" src="shared-asset-groups.js"></script>

  <!-- Chart.js will be lazy-loaded when needed -->

  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Navigation unifiÃ©e (conditionnelle) -->
  <script type="module">
    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Risk Dashboard Orchestrator -->
  <script type="module" src="modules/risk-dashboard-main.js"></script>
</head>

<body>
  <div id="backend-fallback-banner" class="hidden">
    âš  Backend indisponible â€” mode prudent (cap rÃ©duit).
  </div>

  <div class="wrap">
    <!-- Compact Header Controls -->
    <div class="page-header">
      <div class="page-title">
        <h1>Risk Dashboard</h1>
      </div>
      <div class="header-controls">
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
        <div class="dropdown">
          <button class="icon-btn" id="options-menu-btn" title="Options" aria-label="More options" aria-haspopup="true" aria-expanded="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="3" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="13" r="1.5" fill="currentColor"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="options-menu">
            <button class="dropdown-item" id="force-refresh-btn" title="Clear cache and recalculate all scores">
              <span class="item-icon">ðŸ§¹</span>
              <span class="item-text">Force Refresh</span>
            </button>
            <button class="dropdown-item" id="force-cycle-refresh-btn" title="Clear cycle cache and reload cycles only">
              <span class="item-icon">ðŸ”„</span>
              <span class="item-text">Refresh Cycles</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="test-endpoint-btn" title="Test API connection (dev only)">
              <span class="item-icon">ðŸ§ª</span>
              <span class="item-text">Test API</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Layout Simple: Main Content uniquement (sidebar remplacÃ©e par Web Component flyout-panel) -->
    <div class="dashboard-layout">
      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <!-- Tabs -->
        <div class="tabs" role="tablist">
          <button class="tab-button active" data-tab="risk" role="tab" aria-selected="true" aria-controls="risk-tab">Risk Overview</button>
          <button class="tab-button" data-tab="cycles" role="tab" aria-selected="false" aria-controls="cycles-tab">Market Cycles</button>
        </div>

        <!-- Quick Links to Other Pages -->
        <div class="quick-links" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
          <a href="rebalance.html" class="quick-link-btn" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--theme-surface-elevated); border: 1px solid var(--theme-border); border-radius: var(--radius-md); color: var(--theme-text); text-decoration: none; font-size: 14px; transition: all 0.2s;">
            <span>ðŸŽ¯</span> Strategic Targets
          </a>
          <a href="monitoring.html" class="quick-link-btn" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--theme-surface-elevated); border: 1px solid var(--theme-border); border-radius: var(--radius-md); color: var(--theme-text); text-decoration: none; font-size: 14px; transition: all 0.2s;">
            <span>ðŸš¨</span> Alerts History
          </a>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab" role="tabpanel" aria-labelledby="risk-overview">
            <div id="risk-overview-badge-container" class="badge-container"></div>

            <!-- Persistent Controls (do not get replaced by dynamic render) -->
            <div id="risk-dashboard-content">
              <div class="loading">Loading risk metrics...</div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab" role="tabpanel" aria-labelledby="cycles">
            <div id="cycles-badge-container" class="badge-container"></div>
            <div id="cycles-content">
              <div class="loading">Loading cycle analysis...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partagÃ© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module" src="modules/risk-dashboard-main-controller.js"></script>


  <!-- Flyout Panel System -->

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est Ã©pinglÃ©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // DÃ©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="280" persist-key="risk_dashboard_flyout">
    <span slot="title">ðŸŽ¯ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

</body>

</html>
