<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - SmartFolio</title>

  <!-- ThÃ¨me/compat identiques Ã  ta page actuelle -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/view-modes.css">
    <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/print.css" media="print">

  <!-- Scripts partagÃ©s existants -->
  <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
  <script type="module" src="components/data-freshness.js"></script>
  <script type="module" src="network-state-manager.js"></script> <!-- Network resilience layer -->
    <script type="module" src="core/sentry-init.js"></script>
  <script src="appearance.js"></script> <!-- Critical: must load before first paint to avoid theme flash -->
  <script src="lazy-loader.js"></script>

  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>  <!-- âœ… SSOT hydration -->
  <script type="module" src="core/fetcher.js"></script>

  <!-- CCS modules ESM (kept for risk score calculations) -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>

  <!-- Auto-load calibrated cycle parameters (synced with cycle-analysis.html) -->
  <script type="module">
    import { autoLoadCalibratedParams, listenForCalibrationUpdates } from './modules/cycle-params-loader.js';

    // Charger les paramÃ¨tres calibrÃ©s au dÃ©marrage
    document.addEventListener('DOMContentLoaded', async () => {
      await autoLoadCalibratedParams();
      listenForCalibrationUpdates(); // Ã‰couter les mises Ã  jour depuis cycle-analysis.html
    });
  </script>

  <!-- Unified asset groups system -->
  <script type="module" src="shared-asset-groups.js"></script>

  <!-- Chart.js for Bitcoin Regime charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script
      src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script
      src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
      // Register Chart.js plugins (required for btc-regime-chart.js)
      if (window.Chart && window.ChartDataLabels && !window.__di_dl_registered__) {
          window.Chart.register(window.ChartDataLabels);
          window.Chart.defaults.set('plugins.datalabels', { display: false });
          window.__di_dl_registered__ = true;
          console.debug('âœ… chartjs-plugin-datalabels registered');
      }
      if (window.Chart && window.ChartAnnotation && !window.__di_annotation_registered__) {
          window.Chart.register(window.ChartAnnotation);
          window.__di_annotation_registered__ = true;
          console.debug('âœ… chartjs-plugin-annotation registered');
      }
  </script>

  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Critical inline skeleton CSS (prevents FOUC during load) -->
  <style>
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 100%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: var(--radius-md, 6px);
      color: transparent !important;
      user-select: none;
    }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-row { display: flex; gap: var(--space-md, 12px); margin-bottom: var(--space-md, 12px); }
    .skeleton-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-lg, 16px); }
    .skeleton-card {
      background: var(--theme-surface, #1e1e2e);
      border: 1px solid var(--theme-border, #2a2a3a);
      border-radius: var(--radius-lg, 8px);
      padding: var(--space-lg, 16px);
    }
  </style>

  <!-- View Mode System (Feb 2026) -->
  <script type="module" src="components/view-toggle.js"></script>
  <script type="module" src="components/domain-nav.js"></script>

  <!-- Navigation unifiÃ©e (conditionnelle) -->
  <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();  // VÃ©rifie authentification + redirect si nÃ©cessaire
    // =================================

    // ===== VIEW MODE MANAGER (Feb 2026) =====
    import { ViewModeManager } from './core/view-mode-manager.js';
    ViewModeManager.init();
    // ========================================

    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Risk Dashboard Orchestrator -->
  <script type="module" src="modules/risk-dashboard-main.js"></script>

  <!-- Market Regimes modules (migrated from ai-dashboard.html - Dec 2025) -->
  <script type="module">
    import { initializeBTCRegimeChart } from './modules/btc-regime-chart.js';
    import { initializeETHRegimeChart } from './modules/eth-regime-chart.js';
    import { initializeStockRegimeHistory, openStockRegimeHistory, closeStockRegimeHistory } from './modules/stock-regime-history.js';

    // Expose globally for tab switching
    window.initializeBTCRegimeChart = initializeBTCRegimeChart;
    window.initializeETHRegimeChart = initializeETHRegimeChart;
    window.openStockRegimeHistory = openStockRegimeHistory;
    window.closeStockRegimeHistory = closeStockRegimeHistory;
  </script>

  <!-- AI Chat Styles -->
  <link rel="stylesheet" href="/static/components/ai-chat.css">
</head>

<body>
  <div id="backend-fallback-banner" class="hidden">
    âš  Backend unavailable â€” prudent mode (reduced cap).
  </div>

  <div class="wrap">
    <!-- Compact Header Controls -->
    <div class="page-header">
      <div class="page-title">
        <h1>Risk Dashboard</h1>
      </div>
      <div class="header-controls">
        <button id="pdf-export-btn" class="btn btn-secondary pdf-hide" style="font-size:0.8rem;padding:6px 12px;" title="Export page as PDF" onclick="import('./modules/pdf-export.js').then(m=>m.exportPageToPDF({element:document.querySelector('.wrap'),title:'Risk Dashboard',filename:'risk-dashboard',button:this}))">Export PDF</button>
        <view-toggle></view-toggle>
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
        <div class="dropdown">
          <button class="icon-btn" id="options-menu-btn" title="Options" aria-label="More options" aria-haspopup="true" aria-expanded="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="3" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="13" r="1.5" fill="currentColor"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="options-menu">
            <button class="dropdown-item" id="force-refresh-btn" title="Clear cache and recalculate all scores">
              <span class="item-icon">ðŸ§¹</span>
              <span class="item-text">Force Refresh</span>
            </button>
            <button class="dropdown-item" id="force-cycle-refresh-btn" title="Clear cycle cache and reload cycles only">
              <span class="item-icon">ðŸ”„</span>
              <span class="item-text">Refresh Cycles</span>
            </button>
            <div class="dropdown-divider pro-only"></div>
            <button class="dropdown-item pro-only" id="test-endpoint-btn" title="Test API connection (dev only)">
              <span class="item-icon">ðŸ§ª</span>
              <span class="item-text">Test API</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation contextuelle Risk Domain (Feb 2026) -->
    <domain-nav domain="risk"></domain-nav>

    <!-- Layout Simple: Main Content uniquement (sidebar remplacÃ©e par Web Component flyout-panel) -->
    <div class="dashboard-layout">
      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <!-- Tabs -->
        <div class="tabs" role="tablist">
          <button class="tab-button active" data-tab="risk" role="tab" aria-selected="true" aria-controls="risk-tab">Risk Overview</button>
          <button class="tab-button pro-only" data-tab="cycles" role="tab" aria-selected="false" aria-controls="cycles-tab">Market Cycles</button>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab" role="tabpanel" aria-labelledby="risk-overview">
            <div id="risk-overview-badge-container" class="badge-container"></div>

            <!-- Persistent Controls (do not get replaced by dynamic render) -->
            <!-- min-height prevents CLS (Cumulative Layout Shift) during load -->
            <div id="risk-dashboard-content" style="min-height: 800px;">
              <!-- Skeleton loading (replaced by JS once data arrives) -->
              <div class="skeleton-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px;">
                <div class="skeleton-card"><div class="skeleton" style="height: 14px; width: 50%; margin-bottom: 8px;"></div><div class="skeleton" style="height: 28px; width: 70%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 14px; width: 50%; margin-bottom: 8px;"></div><div class="skeleton" style="height: 28px; width: 70%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 14px; width: 50%; margin-bottom: 8px;"></div><div class="skeleton" style="height: 28px; width: 70%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 14px; width: 50%; margin-bottom: 8px;"></div><div class="skeleton" style="height: 28px; width: 70%;"></div></div>
              </div>
              <div class="skeleton-grid">
                <div class="skeleton-card"><div class="skeleton" style="height: 18px; width: 40%; margin-bottom: 16px;"></div><div class="skeleton" style="height: 12px; width: 90%; margin-bottom: 10px;"></div><div class="skeleton" style="height: 12px; width: 80%; margin-bottom: 10px;"></div><div class="skeleton" style="height: 12px; width: 70%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 18px; width: 40%; margin-bottom: 16px;"></div><div class="skeleton" style="height: 12px; width: 85%; margin-bottom: 10px;"></div><div class="skeleton" style="height: 12px; width: 75%; margin-bottom: 10px;"></div><div class="skeleton" style="height: 12px; width: 65%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 18px; width: 40%; margin-bottom: 16px;"></div><div class="skeleton" style="height: 12px; width: 90%; margin-bottom: 10px;"></div><div class="skeleton" style="height: 12px; width: 70%;"></div></div>
              </div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab" role="tabpanel" aria-labelledby="cycles">
            <div id="cycles-badge-container" class="badge-container"></div>
            <!-- min-height prevents CLS during load -->
            <div id="cycles-content" style="min-height: 600px;">
              <!-- Skeleton loading (replaced by JS once data arrives) -->
              <div class="skeleton-grid">
                <div class="skeleton-card"><div class="skeleton" style="height: 18px; width: 45%; margin-bottom: 16px;"></div><div class="skeleton" style="height: 200px; width: 100%; margin-bottom: 12px;"></div><div class="skeleton" style="height: 12px; width: 60%;"></div></div>
                <div class="skeleton-card"><div class="skeleton" style="height: 18px; width: 45%; margin-bottom: 16px;"></div><div class="skeleton" style="height: 200px; width: 100%; margin-bottom: 12px;"></div><div class="skeleton" style="height: 12px; width: 60%;"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partagÃ© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module" src="modules/risk-dashboard-main-controller.js"></script>

  <!-- Flyout Panel System -->

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est Ã©pinglÃ©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // DÃ©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="280" persist-key="risk_dashboard_flyout">
    <span slot="title">ðŸŽ¯ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

  <!-- AI Chat Components -->
  <script type="module">
    import { initAIChat } from '/static/components/ai-chat-init.js';

    // Initialize AI Chat for risk dashboard page
    initAIChat('risk-dashboard');
  </script>

</body>

</html>
