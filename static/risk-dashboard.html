<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - SmartFolio</title>

  <!-- Th√®me/compat identiques √† ta page actuelle -->
  <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partag√©s existants -->
  <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
  <script type="module" src="network-state-manager.js"></script> <!-- Network resilience layer -->
  <script src="appearance.js"></script> <!-- Critical: must load before first paint to avoid theme flash -->
  <script src="lazy-loader.js"></script>

  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>  <!-- ‚úÖ SSOT hydration -->
  <script type="module" src="core/fetcher.js"></script>

  <!-- CCS modules ESM (kept for risk score calculations) -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>

  <!-- Unified asset groups system -->
  <script type="module" src="shared-asset-groups.js"></script>

  <!-- Chart.js for Bitcoin Regime charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script
      src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script
      src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
      // Register Chart.js plugins (required for btc-regime-chart.js)
      if (window.Chart && window.ChartDataLabels && !window.__di_dl_registered__) {
          window.Chart.register(window.ChartDataLabels);
          window.Chart.defaults.set('plugins.datalabels', { display: false });
          window.__di_dl_registered__ = true;
          console.debug('‚úÖ chartjs-plugin-datalabels registered');
      }
      if (window.Chart && window.ChartAnnotation && !window.__di_annotation_registered__) {
          window.Chart.register(window.ChartAnnotation);
          window.__di_annotation_registered__ = true;
          console.debug('‚úÖ chartjs-plugin-annotation registered');
      }
  </script>

  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Navigation unifi√©e (conditionnelle) -->
  <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();  // V√©rifie authentification + redirect si n√©cessaire
    // =================================

    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Risk Dashboard Orchestrator -->
  <script type="module" src="modules/risk-dashboard-main.js"></script>

  <!-- Market Regimes modules (migrated from ai-dashboard.html - Dec 2025) -->
  <script type="module">
    import { initializeBTCRegimeChart } from './modules/btc-regime-chart.js';
    import { initializeETHRegimeChart } from './modules/eth-regime-chart.js';
    import { initializeStockRegimeHistory, openStockRegimeHistory, closeStockRegimeHistory } from './modules/stock-regime-history.js';

    // Expose globally for tab switching
    window.initializeBTCRegimeChart = initializeBTCRegimeChart;
    window.initializeETHRegimeChart = initializeETHRegimeChart;
    window.openStockRegimeHistory = openStockRegimeHistory;
    window.closeStockRegimeHistory = closeStockRegimeHistory;
  </script>

  <!-- AI Chat Styles -->
  <link rel="stylesheet" href="/static/components/ai-chat.css">
</head>

<body>
  <div id="backend-fallback-banner" class="hidden">
    ‚ö† Backend indisponible ‚Äî mode prudent (cap r√©duit).
  </div>

  <div class="wrap">
    <!-- Compact Header Controls -->
    <div class="page-header">
      <div class="page-title">
        <h1>Risk Dashboard</h1>
      </div>
      <div class="header-controls">
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
        <div class="dropdown">
          <button class="icon-btn" id="options-menu-btn" title="Options" aria-label="More options" aria-haspopup="true" aria-expanded="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="3" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="13" r="1.5" fill="currentColor"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="options-menu">
            <button class="dropdown-item" id="force-refresh-btn" title="Clear cache and recalculate all scores">
              <span class="item-icon">üßπ</span>
              <span class="item-text">Force Refresh</span>
            </button>
            <button class="dropdown-item" id="force-cycle-refresh-btn" title="Clear cycle cache and reload cycles only">
              <span class="item-icon">üîÑ</span>
              <span class="item-text">Refresh Cycles</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="test-endpoint-btn" title="Test API connection (dev only)">
              <span class="item-icon">üß™</span>
              <span class="item-text">Test API</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Layout Simple: Main Content uniquement (sidebar remplac√©e par Web Component flyout-panel) -->
    <div class="dashboard-layout">
      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <!-- Tabs -->
        <div class="tabs" role="tablist">
          <button class="tab-button active" data-tab="risk" role="tab" aria-selected="true" aria-controls="risk-tab">Risk Overview</button>
          <button class="tab-button" data-tab="cycles" role="tab" aria-selected="false" aria-controls="cycles-tab">Market Cycles</button>
          <button class="tab-button" data-tab="regimes" role="tab" aria-selected="false" aria-controls="regimes-tab">Market Regimes</button>
          <button class="tab-button" data-tab="advanced" role="tab" aria-selected="false" aria-controls="advanced-tab">Advanced Risk</button>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab" role="tabpanel" aria-labelledby="risk-overview">
            <div id="risk-overview-badge-container" class="badge-container"></div>

            <!-- Persistent Controls (do not get replaced by dynamic render) -->
            <div id="risk-dashboard-content">
              <div class="loading">Loading risk metrics...</div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab" role="tabpanel" aria-labelledby="cycles">
            <div id="cycles-badge-container" class="badge-container"></div>
            <div id="cycles-content">
              <div class="loading">Loading cycle analysis...</div>
            </div>
          </div>

          <!-- R√©gimes de March√© Tab (migrated from ai-dashboard.html - Dec 2025) -->
          <div class="tab-pane" id="regimes-tab" role="tabpanel" aria-labelledby="regimes">
            <div id="regimes-badge-container" class="badge-container"></div>

            <!-- Section 1: Stock Market Regime -->
            <div class="ml-card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon" aria-hidden="true">üìà</span>
                        Stock Market Regime Detection (HMM)
                    </div>
                    <div class="card-actions">
                        <button id="refresh-stock-regime" class="btn primary">üîÑ Refresh</button>
                        <button id="view-stock-history" class="btn secondary">üìä View Probabilities</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="status-grid"
                        style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="status-item">
                            <span class="status-label">Current Regime</span>
                            <span class="status-value" id="stock-regime-name">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Confidence</span>
                            <span class="status-value" id="stock-regime-confidence">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Model</span>
                            <span class="status-value">Hidden Markov Model</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Thresholds</span>
                            <span class="status-value" style="font-size: 0.85rem;">Bear: DD‚â§-20% (60d)</span>
                        </div>
                    </div>

                    <div
                        style="margin-top: 1rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--info);">
                        <strong>‚ÑπÔ∏è Stock Market Detection:</strong>
                        <ul
                            style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                            <li><strong>HMM Model:</strong> Statistical pattern recognition for market regimes
                            </li>
                            <li><strong>States:</strong> Bull, Bear, Sideways, Distribution</li>
                            <li><strong>Thresholds:</strong> Traditional stock market parameters (DD ‚â§ -20%, 60
                                days)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 2: Bitcoin Regime Detection -->
            <div class="btc-regime-section ml-card" style="margin-bottom: 2rem;" id="btc-regime-section">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <div class="card-title">
                        <span class="card-icon" aria-hidden="true">‚Çø</span>
                        Bitcoin Regime Detection (Hybrid System)
                        <small
                            style="font-size: 0.75rem; font-weight: 400; color: var(--theme-text-muted); margin-left: 0.5rem;">
                            Rule-Based + HMM Fusion
                        </small>
                    </div>
                </div>

                <!-- Current Regime Summary Cards -->
                <div class="btc-regime-summary"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Current Regime -->
                    <div class="metric-card">
                        <h5>Current Regime</h5>
                        <div class="metric-value">
                            <span id="btc-current-regime-name" class="regime-chip">Loading...</span>
                        </div>
                        <small>Hybrid Detection</small>
                    </div>

                    <!-- Confidence -->
                    <div class="metric-card">
                        <h5>Confidence</h5>
                        <div class="metric-value" id="btc-current-regime-confidence">--</div>
                        <small>Detection Certainty</small>
                    </div>

                    <!-- Detection Method -->
                    <div class="metric-card">
                        <h5>Detection Method</h5>
                        <div class="metric-value">
                            <span id="btc-current-regime-method" class="detection-method">--</span>
                        </div>
                        <small>Rule-Based or HMM</small>
                    </div>

                    <!-- Rule Reason (conditional) -->
                    <div class="metric-card" id="btc-regime-reason-card" style="display: none;">
                        <h5>Rule Trigger</h5>
                        <div class="metric-value" style="font-size: 0.85rem;" id="btc-current-regime-reason">--
                        </div>
                        <small>Detection Criteria</small>
                    </div>
                </div>

                <!-- Timeframe Selector -->
                <div class="btc-regime-timeframe-selector"
                    style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button data-days="365" class="timeframe-btn active">1 Year</button>
                    <button data-days="730" class="timeframe-btn">2 Years</button>
                    <button data-days="1825" class="timeframe-btn">5 Years</button>
                    <button data-days="3650" class="timeframe-btn">10 Years</button>
                </div>

                <!-- Loading/Error Messages -->
                <div id="btc-regime-loading-message"
                    style="display: none; text-align: center; padding: 2rem; color: var(--theme-text-muted);">
                    ‚è≥ Loading Bitcoin regime data...
                </div>
                <div id="btc-regime-error-message"
                    style="display: none; text-align: center; padding: 2rem; color: var(--danger);">
                    <!-- Error message will be inserted here -->
                </div>

                <!-- Timeline Chart -->
                <div id="btc-regime-chart-container"
                    style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border); margin-bottom: 2rem; min-height: 550px;">
                    <canvas id="btc-regime-timeline-chart" style="height: 500px; width: 100%;"></canvas>
                </div>

                <!-- Regime Probabilities Chart -->
                <div class="btc-regime-probabilities-container"
                    style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border);">
                    <canvas id="btc-regime-probabilities-chart" style="max-height: 300px;"></canvas>
                </div>

                <!-- Regime Legend -->
                <div class="btc-regime-legend"
                    style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-surface-elevated); border-radius: var(--radius-sm); display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
                    <div class="legend-item">
                        <span class="regime-chip bear"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Bear
                            Market</span>
                        <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD ‚â§
                            -50%, 30d+</small>
                    </div>
                    <div class="legend-item">
                        <span class="regime-chip correction"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Correction</span>
                        <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD
                            10-50% or Vol >60%</small>
                    </div>
                    <div class="legend-item">
                        <span class="regime-chip bull"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Bull
                            Market</span>
                        <small style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">DD >
                            -20%, Vol <60%</small>
                    </div>
                    <div class="legend-item">
                        <span class="regime-chip expansion"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">Expansion</span>
                        <small
                            style="display: block; margin-top: 0.25rem; color: var(--theme-text-muted);">Recovery
                            +30%/mo</small>
                    </div>
                </div>

                <!-- Info Footer -->
                <div
                    style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg); border-left: 3px solid var(--brand-primary); border-radius: var(--radius-sm);">
                    <strong>‚ÑπÔ∏è About Hybrid Detection:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                        <li><strong>Rule-Based (‚â•85% confidence):</strong> Clear cases using drawdown, duration,
                            and trend thresholds</li>
                        <li><strong>HMM (nuanced):</strong> Statistical model for corrections and consolidations
                        </li>
                        <li><strong>Crypto-Adjusted:</strong> Thresholds adapted for Bitcoin volatility (3x
                            higher than stocks)</li>
                        <li><strong>Events:</strong> Mt.Gox, FTX, COVID crashes annotated for context</li>
                    </ul>
                </div>
            </div>

            <!-- Section 2.5: Ethereum Regime Detection -->
            <div class="ml-card" style="margin-bottom: 2rem;" id="eth-regime-section">
                <div class="card-header" style="margin-bottom: 1.5rem;">
                    <div class="card-title">
                        <span class="card-icon" aria-hidden="true">‚ü†</span>
                        Ethereum Regime Detection (Hybrid System)
                        <small
                            style="font-size: 0.75rem; font-weight: 400; color: var(--theme-text-muted); margin-left: 0.5rem;">
                            Rule-Based + HMM Fusion
                        </small>
                    </div>
                </div>

                <!-- Current Regime Summary Cards -->
                <div class="eth-regime-summary"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Current Regime -->
                    <div class="metric-card">
                        <h5>Current Regime</h5>
                        <div class="metric-value">
                            <span id="eth-current-regime-name" class="regime-chip">Loading...</span>
                        </div>
                        <small>Hybrid Detection</small>
                    </div>

                    <!-- Confidence -->
                    <div class="metric-card">
                        <h5>Confidence</h5>
                        <div class="metric-value" id="eth-current-regime-confidence">--</div>
                        <small>Detection Certainty</small>
                    </div>

                    <!-- Detection Method -->
                    <div class="metric-card">
                        <h5>Detection Method</h5>
                        <div class="metric-value">
                            <span id="eth-current-regime-method" class="detection-method">--</span>
                        </div>
                        <small>Rule-Based or HMM</small>
                    </div>

                    <!-- Rule Reason (conditional) -->
                    <div class="metric-card" id="eth-regime-reason-card" style="display: none;">
                        <h5>Rule Trigger</h5>
                        <div class="metric-value" style="font-size: 0.85rem;" id="eth-current-regime-reason">--
                        </div>
                        <small>Detection Criteria</small>
                    </div>
                </div>

                <!-- Historical Timeline -->
                <div style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border); margin-bottom: 2rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">Historical Regime Timeline</h4>
                        <div class="eth-regime-timeframe-selector" style="display: flex; gap: 0.5rem;">
                            <button class="timeframe-btn active" data-days="365">1Y</button>
                            <button class="timeframe-btn" data-days="730">2Y</button>
                            <button class="timeframe-btn" data-days="1825">5Y</button>
                        </div>
                    </div>
                    <div id="eth-regime-chart-container" style="position: relative; height: 500px; width: 100%;">
                        <canvas id="eth-regime-timeline-chart" style="position: absolute; top: 0; left: 0; height: 100%; width: 100%;"></canvas>
                    </div>
                    <div id="eth-regime-error-message" class="error-state" style="display: none;"></div>
                </div>

                <!-- Info Note -->
                <div
                    style="margin-bottom: 1rem; padding: 1rem; background: var(--theme-bg); border-left: 3px solid var(--success); border-radius: var(--radius-sm);">
                    <strong>‚ÑπÔ∏è About Ethereum Detection:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                        <li><strong>Same Hybrid System:</strong> Uses identical rule-based + HMM fusion as
                            Bitcoin</li>
                        <li><strong>Crypto-Adjusted Thresholds:</strong> Bear ‚â§ -50% (30d+), Bull > -20% (vol
                            <60%), Expansion +30%/mo</li>
                        <li><strong>Timeline Chart:</strong> Interactive regime visualization with price history
                            section)</li>
                    </ul>
                </div>
            </div>

            <!-- Section 3: Cross-Asset Comparison -->
            <div class="ml-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon" aria-hidden="true">üìä</span>
                        Cross-Asset Regime Comparison
                    </div>
                </div>
                <div class="card-content">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--theme-surface-elevated); text-align: left;">
                                    <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Asset
                                    </th>
                                    <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Current
                                        Regime</th>
                                    <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                                        Confidence</th>
                                    <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                                        Detection Method</th>
                                    <th style="padding: 0.75rem; border: 1px solid var(--theme-border);">Bear
                                        Threshold</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td
                                        style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">
                                        üìà Stock Market</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                                        <span id="comparison-stock-regime" class="regime-chip">--</span>
                                    </td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);"
                                        id="comparison-stock-confidence">--</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">HMM
                                        Only</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§
                                        -20%, 60d</td>
                                </tr>
                                <tr>
                                    <td
                                        style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">
                                        ‚Çø Bitcoin</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                                        <span id="comparison-btc-regime" class="regime-chip">--</span>
                                    </td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);"
                                        id="comparison-btc-confidence">--</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);"
                                        id="comparison-btc-method">--</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§
                                        -50%, 30d</td>
                                </tr>
                                <tr>
                                    <td
                                        style="padding: 0.75rem; border: 1px solid var(--theme-border); font-weight: 600;">
                                        ‚ü† Ethereum</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">
                                        <span id="comparison-eth-regime" class="regime-chip">--</span>
                                    </td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);"
                                        id="comparison-eth-confidence">--</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);"
                                        id="comparison-eth-method">--</td>
                                    <td style="padding: 0.75rem; border: 1px solid var(--theme-border);">DD ‚â§
                                        -50%, 30d</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div
                        style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <strong>üìå Key Differences:</strong>
                        <ul
                            style="margin: 0.5rem 0 0 1.5rem; color: var(--theme-text-muted); font-size: 0.9rem;">
                            <li><strong>Stock Market:</strong> Pure HMM statistical model, traditional
                                thresholds</li>
                            <li><strong>Bitcoin & Ethereum:</strong> Hybrid Rule-Based + HMM, crypto-adjusted
                                thresholds (3x higher volatility)</li>
                            <li><strong>Why Different?</strong> Crypto volatility (60-100% annual) vs Stocks
                                (15-25%) requires distinct detection logic</li>
                        </ul>
                    </div>
                </div>
                <div class="card-actions">
                    <button id="refresh-comparison" class="btn primary">üîÑ Refresh Comparison</button>
                    <button id="export-comparison" class="btn secondary">üíæ Export Data</button>
                </div>
            </div>
          </div>

          <!-- Advanced Risk Tab (Phase 3A) -->
          <div class="tab-pane" id="advanced-tab" role="tabpanel" aria-labelledby="advanced">
            <div id="advanced-badge-container" class="badge-container"></div>
            <div id="advanced-risk-content">
              <div class="loading">Loading advanced risk analysis...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partag√© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module" src="modules/risk-dashboard-main-controller.js"></script>

  <!-- Phase 3A: Advanced Risk Analysis -->
  <script type="module">
    import { store } from './core/risk-dashboard-store.js';

    // ====== Phase 3A: Advanced Risk Analysis ======

    async function loadAdvancedRiskComponents() {
      try {
        // Check if advanced panel already exists
        if (document.querySelector('.advanced-risk-panel')) {
          console.debug('Advanced Risk Components already loaded');
          return; // Already loaded
        }

        // Add advanced sections to the Advanced Risk tab
        const advancedContent = document.getElementById('advanced-risk-content');

        // Clear the loading message
        advancedContent.innerHTML = '';

        // Create Advanced Risk Analysis Panel
        const advancedPanel = document.createElement('div');
        advancedPanel.className = 'advanced-section advanced-risk-panel';
        advancedPanel.innerHTML = `
            <div class="risk-grid two-col-advanced">
              <div class="left-stack">
                <!-- Group Risk Index (GRI) -->
                <div class="risk-card">
                  <h4>Group Risk Index (GRI)</h4>
                  <div id="gri-analysis-content">
                    <div class="loading">Loading GRI analysis...</div>
                  </div>
                </div>
                <!-- Monte Carlo -->
                <div class="risk-card">
                  <h4>Monte Carlo Simulation</h4>
                  <div id="monte-carlo-content">
                    <div class="loading">Loading simulations...</div>
                  </div>
                </div>
                <!-- Risk Attribution -->
                <div class="risk-card">
                  <h4>Risk Attribution</h4>
                  <div id="risk-attribution-content">
                    <div class="loading">Loading attribution analysis...</div>
                  </div>
                </div>
              </div>
              <div class="right-stack">
                <!-- Stress Testing (free height on the right) -->
                <div class="risk-card">
                  <h4>Stress Testing</h4>
                  <div id="stress-test-content">
                    <div class="loading">Loading stress tests...</div>
                  </div>
                </div>
              </div>
            </div>
          `;

        advancedContent.appendChild(advancedPanel);

        // Load actual Phase 3A data
        await loadPhase3AData();

      } catch (error) {
        console.error('Error loading advanced risk components:', error);
        window.showToast?.('Failed to load advanced risk analysis', 'error');
      }
    }

    async function loadPhase3AData() {
      try {
        // Get Phase 3A status using globalConfig.apiRequest
        const statusData = await window.globalConfig.apiRequest('/api/phase3/status');

        if (statusData.phase_3a_advanced_risk?.status === 'active') {
          // Load GRI analysis
          await loadGRIAnalysis();
          // Load stress testing scenarios
          await loadStressTestScenarios();
          // Load Monte Carlo results
          await loadMonteCarloResults();
          // Load Risk Attribution
          await loadRiskAttribution();
        } else {
          document.getElementById('gri-analysis-content').innerHTML =
            '<div class="warning">Advanced Risk Engine not available</div>';
        }
      } catch (error) {
        console.error('Error loading Phase 3A data:', error);
      }
    }

    // Debug metadata banner function
    function showDebugMetadataBanner(meta) {
      let banner = document.getElementById('debug-metadata-banner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'debug-metadata-banner';
        banner.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
          background: color-mix(in oklab, var(--info) 90%, transparent);
          border-bottom: 1px solid var(--info);
          color: var(--theme-text); padding: 0.5rem 1rem; font-size: 0.8rem;
          display: flex; justify-content: space-between; align-items: center;
        `;
        document.body.appendChild(banner);
      }

      banner.innerHTML = `
        <div>
          üè∑Ô∏è <strong>Debug Metadata:</strong>
          User: <code>${meta.user_id}</code> |
          Source: <code>${meta.source_id}</code> |
          Taxonomy: <code>${meta.taxonomy_version}:${meta.taxonomy_hash}</code> |
          Generated: <code>${new Date(meta.generated_at).toLocaleTimeString()}</code>
          ${meta.correlation_id ? `| ID: <code>${meta.correlation_id}</code>` : ''}
        </div>
        <button onclick="this.parentElement.style.display='none'" style="background:none;border:none;color:var(--theme-text);cursor:pointer;font-size:1.2rem;">√ó</button>
      `;
    }

    async function loadGRIAnalysis() {
      try {
        // Get data from API risk dashboard for GRI analysis using globalConfig.apiRequest
        const minUsd = window.globalConfig.get('min_usd_threshold') || 1.0;
        const priceDays = 365;
        const corrDays = 90;

        const data = await window.globalConfig.apiRequest('/api/risk/dashboard', {
          params: {
            price_history_days: priceDays,
            lookback_days: corrDays,
            min_usd: minUsd,
            risk_version: 'v2_active',
            use_dual_window: true
          }
        });

        if (!data.success) {
          throw new Error(data.message || 'API request failed');
        }

        // Display debug metadata banner if debug mode is enabled
        if (localStorage.getItem('debug_metadata') === 'true' && data.meta) {
          showDebugMetadataBanner(data.meta);
        }

        const metrics = data.risk_metrics;
        const exposureByGroup = metrics.exposure_by_group || {};
        const gri = metrics.group_risk_index || 0;

        // Convert exposure to display format
        const topGroups = Object.entries(exposureByGroup)
          .sort(([, a], [, b]) => b - a)
          .map(([name, weight]) => ({
            name,
            weight: Math.round(weight * 100),
            weight_raw: weight
          }));

        // Color coding for GRI score
        const griColor = gri < 3 ? 'var(--success)' : gri < 6 ? 'var(--warning)' : 'var(--danger)';
        const griLevel = gri < 3 ? 'LOW' : gri < 6 ? 'MEDIUM' : 'HIGH';

        // Group risk levels - Calculated by backend V2 engine (services/risk_scoring.py)
        const GROUP_RISK_LEVELS = {
          'Stablecoins': 5, 'BTC': 2, 'ETH': 3, 'L2/Scaling': 5,
          'DeFi': 5, 'AI/Data': 5, 'SOL': 6, 'L1/L0 majors': 6,
          'Gaming/NFT': 6, 'Others': 7, 'Memecoins': 9
        };

        console.debug('üìä GRI groups from API:', Object.keys(exposureByGroup));

        document.getElementById('gri-analysis-content').innerHTML = `
            <div class="gri-overview">
              <div class="var-method">
                <span class="method-label hinted" data-key="gri_index">
                  Group Risk Index (GRI)
                </span>
                <span class="var-value" style="color: ${griColor}">${gri.toFixed(1)}/10</span>
              </div>
              <div class="var-method">
                <span class="method-label hinted" data-key="gri_level">
                  Risk Level
                </span>
                <span class="var-value">${griLevel}</span>
              </div>
              <div class="var-method">
                <span class="method-label hinted" data-key="groups_count">
                  Groups Count
                </span>
                <span class="var-value">${Object.keys(exposureByGroup).length}</span>
              </div>
            </div>
            <div class="gri-groups">
              <h5 class="hinted" data-key="gri_groups_header">
                Exposition & Risque par Groupe
              </h5>
              ${topGroups.map(group => {
                const riskLevel = GROUP_RISK_LEVELS[group.name] || 5;
                const riskColor = riskLevel < 3 ? '#9ece6a' :
                                  riskLevel < 6 ? '#e0af68' :
                                  riskLevel < 8 ? '#ff9e64' :
                                  '#f7768e';

                if (!(group.name in GROUP_RISK_LEVELS)) {
                  console.warn('‚ö†Ô∏è Group name not in risk levels:', group.name, '(using fallback 5/10)');
                }

                return `
                  <div class="var-method hinted" data-key="group:${group.name}" data-risk-level="${riskLevel}" style="position: relative; padding: 0.75rem 0.75rem 0.75rem 0.75rem; background: var(--theme-bg); border-radius: 6px; margin-bottom: 0.5rem; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${group.weight}%; background: ${riskColor}; opacity: 0.15; border-radius: 6px; transition: width 0.3s ease;"></div>
                    <div style="position: relative; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                      <span class="method-label" style="font-weight: 500;">${group.name}</span>
                      <span class="var-value" style="font-weight: 600;">${group.weight}%</span>
                    </div>
                    <span style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); font-size: 0.7rem; padding: 2px 6px; background: ${riskColor}; color: white; border-radius: 3px; font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                      ${riskLevel}/10
                    </span>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="gri-interpretation">
              <div class="metric-interpretation hinted" data-key="gri_interpretation">
                ${gri < 3 ? '‚úÖ Portfolio faible risque' :
            gri < 6 ? '‚ö†Ô∏è Portfolio risque mod√©r√©' :
              'üö® Portfolio haut risque - Consid√©rer diversifier'}
              </div>
            </div>
          `;

        // Call decorateRiskTooltips to initialize all tooltips
        setTimeout(() => {
          window.decorateRiskTooltips?.();
        }, 100);

      } catch (error) {
        console.error('Error loading GRI Analysis:', error);
        document.getElementById('gri-analysis-content').innerHTML =
          '<div class="error">Failed to load GRI analysis from API</div>';
      }
    }

    async function loadStressTestScenarios() {
      try {
        // ‚úÖ NEW: Load real scenarios from backend API
        const response = await window.globalConfig.apiRequest('/api/risk/stress-scenarios');

        if (!response || !response.scenarios) {
          throw new Error('No scenarios returned from API');
        }

        const scenarios = response.scenarios;

        const scenariosHtml = scenarios.map(scenario => `
            <div class="scenario-card" onclick="window.runStressTest('${scenario.id}')">
              <div class="scenario-header">
                <h5>${scenario.name}</h5>
                <span class="scenario-probability">${(scenario.probability_10y * 100).toFixed(0)}% / 10 ans</span>
              </div>
              <div class="scenario-impact">
                Impact: ${scenario.impact_range.min}% √† ${scenario.impact_range.max}%
              </div>
              <div class="scenario-duration">
                Dur√©e: ${scenario.duration}
              </div>
              <div class="scenario-context">
                ${scenario.context}
              </div>
            </div>
          `).join('');

        document.getElementById('stress-test-content').innerHTML = `
            <div class="stress-scenarios">
              <div class="scenarios-header">
                <p class="scenarios-description">
                  Sc√©narios historiques et hypoth√©tiques pour √©valuer la r√©silience du portefeuille
                </p>
              </div>
              ${scenariosHtml}
              <div class="scenarios-footer">
                <button class="btn-secondary" onclick="window.runAllStressTests()">
                  üß™ Lancer tous les tests
                </button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--theme-text-muted);">
                  üí° Cliquez sur un sc√©nario pour voir l'impact r√©el sur votre portfolio
                </p>
              </div>
            </div>
          `;

        window.stressScenarios = scenarios;

      } catch (error) {
        console.error('Error loading stress test scenarios:', error);
        document.getElementById('stress-test-content').innerHTML =
          '<div class="error">Erreur de chargement des sc√©narios de stress</div>';
      }
    }

    // ‚úÖ NEW: Real stress test execution
    window.runStressTest = async function (scenarioId) {
      try {
        window.showToast?.(`Calcul de l'impact du sc√©nario ${scenarioId}...`, 'info');

        const response = await window.globalConfig.apiRequest(`/api/risk/stress-test-portfolio?scenario_id=${scenarioId}`, {
          method: 'POST'
        });

        if (!response.success) {
          throw new Error(response.message || 'Stress test failed');
        }

        const result = response.result;

        // Afficher les r√©sultats dans un modal
        const modalHtml = `
          <div style="padding: 1.5rem;">
            <h3>${result.scenario_name}</h3>
            <p style="color: var(--theme-text-muted); margin-bottom: 1.5rem;">${result.scenario_description}</p>

            <div class="stress-results">
              <h4>Impact Portfolio</h4>
              <div class="metric-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="metric">
                  <span class="label">Perte totale</span>
                  <span class="value" style="color: var(--danger); font-size: 1.5rem; font-weight: 700;">
                    ${result.portfolio_impact.loss_pct.toFixed(1)}%
                  </span>
                  <span class="sublabel">$${result.portfolio_impact.loss_usd.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
                </div>
                <div class="metric">
                  <span class="label">Valeur finale</span>
                  <span class="value" style="font-size: 1.5rem; font-weight: 700;">
                    $${result.portfolio_impact.value_after.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                  </span>
                  <span class="sublabel">Initial: $${result.portfolio_impact.value_before.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
                </div>
              </div>

              <h4>Pires Groupes Impact√©s</h4>
              <div style="margin-bottom: 1.5rem;">
                ${result.worst_groups.map(g => `
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--theme-bg); margin-bottom: 0.5rem; border-radius: 4px;">
                    <span>${g.group}</span>
                    <span style="color: var(--danger); font-weight: 600;">${g.loss_pct.toFixed(1)}% ($${g.loss_usd.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})})</span>
                  </div>
                `).join('')}
              </div>

              <div style="font-size: 0.85rem; color: var(--theme-text-muted);">
                <strong>M√©tadonn√©es:</strong><br/>
                Probabilit√© 10 ans: ${(result.metadata.probability_10y * 100).toFixed(1)}%<br/>
                Dur√©e estim√©e: ${result.metadata.duration_estimate}
              </div>
            </div>

            <button onclick="this.closest('.modal').remove()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Fermer
            </button>
          </div>
        `;

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
        modal.innerHTML = `<div style="background: var(--theme-surface); border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">${modalHtml}</div>`;
        document.body.appendChild(modal);

        window.showToast?.(`Impact calcul√©: ${result.portfolio_impact.loss_pct.toFixed(1)}%`, 'success');

      } catch (error) {
        console.error('Stress test failed:', error);
        window.showToast?.(`Erreur: ${error.message}`, 'error');
      }
    };

    window.runAllStressTests = async function () {
      const scenarios = window.stressScenarios || [];
      if (scenarios.length === 0) {
        window.showToast?.('Aucun sc√©nario charg√©', 'warning');
        return;
      }

      window.showToast?.(`Lancement de ${scenarios.length} tests de stress...`, 'info');

      for (const scenario of scenarios) {
        await window.runStressTest(scenario.id);
        await new Promise(resolve => setTimeout(resolve, 1000));  // Pause 1s entre chaque
      }
    };

    window.createCustomScenario = function () {
      window.showToast?.('Fonctionnalit√© de sc√©narios personnalis√©s √† venir', 'info');
    };

    async function loadMonteCarloResults() {
      // ‚úÖ NEW: Show button instead of auto-calculating (10-30 seconds is too long)
      const container = document.getElementById('monte-carlo-content');

      // Check if we have cached results in sessionStorage
      const cached = sessionStorage.getItem('monte_carlo_result');
      if (cached) {
        try {
          const result = JSON.parse(cached);
          renderMonteCarloResultsUI(result);
          return;
        } catch (e) {
          console.warn('Failed to parse cached Monte Carlo results:', e);
          sessionStorage.removeItem('monte_carlo_result');
        }
      }

      // Show initial state with button
      container.innerHTML = `
        <div style="text-align: center; padding: 3rem 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üé≤</div>
          <h4 style="margin-bottom: 1rem;">Simulation Monte Carlo</h4>
          <p style="color: var(--theme-text-muted); margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
            G√©n√®re 10,000 sc√©narios bas√©s sur les distributions historiques r√©elles de rendements.
            Calcule les probabilit√©s de pertes et les sc√©narios extr√™mes.
          </p>
          <button
            onclick="window.runMonteCarloSimulation()"
            style="padding: 1rem 2rem; background: var(--brand-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.2s;"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'"
          >
            üöÄ Lancer la Simulation (10-30 sec)
          </button>
          <p style="font-size: 0.85rem; color: var(--theme-text-muted); margin-top: 1rem;">
            Le r√©sultat sera mis en cache pendant cette session
          </p>
        </div>
      `;
    }

    /**
     * Run Monte Carlo simulation (user-triggered)
     */
    window.runMonteCarloSimulation = async function() {
      try {
        const container = document.getElementById('monte-carlo-content');

        // Show loading
        container.innerHTML = `
          <div class="loading" style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; animation: spin 2s linear infinite;">‚è≥</div>
            <p style="margin-top: 1rem; font-size: 1.1rem; font-weight: 600;">Ex√©cution simulation Monte Carlo...</p>
            <p style="font-size: 0.85rem; color: var(--theme-text-muted); margin-top: 0.5rem;">
              10,000 simulations en cours (10-30 secondes)...
            </p>
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
          </div>
        `;

        const response = await window.globalConfig.apiRequest('/api/risk/monte-carlo', {
          params: {
            num_simulations: 10000,
            horizon_days: 30,
            confidence_level: 0.95,
            price_history_days: 365
          }
        });

        if (!response.success) {
          throw new Error(response.message || 'Monte Carlo simulation failed');
        }

        const result = response.result;

        // Cache result in sessionStorage
        sessionStorage.setItem('monte_carlo_result', JSON.stringify(result));

        // Render results
        renderMonteCarloResultsUI(result);

        window.showToast?.('‚úÖ Simulation termin√©e avec succ√®s', 'success');

      } catch (error) {
        console.error('Error running Monte Carlo simulation:', error);
        const container = document.getElementById('monte-carlo-content');
        container.innerHTML = `
          <div class="error" style="text-align: center; padding: 2rem;">
            ‚ùå Erreur lors du calcul Monte Carlo: ${error.message}<br/>
            <button onclick="window.runMonteCarloSimulation()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--brand-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
              R√©essayer
            </button>
          </div>
        `;
      }
    };

    /**
     * Render Monte Carlo results UI
     * @param {Object} result - Monte Carlo simulation result
     */
    function renderMonteCarloResultsUI(result) {
      const container = document.getElementById('monte-carlo-content');
      container.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <p style="font-size: 0.85rem; color: var(--theme-text-muted); margin: 0; font-style: italic;">
              Simulation de ${result.simulation_params.num_simulations.toLocaleString()} sc√©narios bas√©e sur les distributions historiques r√©elles de rendements.
              Horizon: ${result.simulation_params.horizon_days} jours.
            </p>
            <button
              onclick="sessionStorage.removeItem('monte_carlo_result'); window.runMonteCarloSimulation();"
              style="padding: 0.5rem 1rem; background: var(--theme-surface); color: var(--theme-text); border: 1px solid var(--theme-border); border-radius: 4px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;"
              title="Relancer le calcul avec de nouvelles donn√©es"
            >
              üîÑ Re-calculer
            </button>
          </div>
          <div class="monte-carlo-summary">
            <div class="sim-stat hinted" data-key="mc_simulations">
              <span class="stat-label">Simulations</span>
              <span class="stat-value">${result.simulation_params.num_simulations.toLocaleString()}</span>
            </div>
            <div class="sim-stat hinted" data-key="mc_worst_case">
              <span class="stat-label">Pire sc√©nario (P1)</span>
              <span class="stat-value text-danger">${result.scenarios.worst_case_pct.toFixed(1)}%</span>
            </div>
            <div class="sim-stat hinted" data-key="mc_best_case">
              <span class="stat-label">Meilleur sc√©nario (P99)</span>
              <span class="stat-value text-success">${result.scenarios.best_case_pct.toFixed(1)}%</span>
            </div>
          </div>

          <div class="monte-carlo-stats" style="margin-top: 1.5rem;">
            <h5 style="margin-bottom: 1rem;">Statistiques Distribution</h5>
            <div class="monte-carlo-summary">
              <div class="sim-stat">
                <span class="stat-label">Rendement moyen</span>
                <span class="stat-value">${result.statistics.mean_return_pct.toFixed(2)}%</span>
              </div>
              <div class="sim-stat">
                <span class="stat-label">Rendement m√©dian</span>
                <span class="stat-value">${result.statistics.median_return_pct.toFixed(2)}%</span>
              </div>
              <div class="sim-stat">
                <span class="stat-label">√âcart-type</span>
                <span class="stat-value">${result.statistics.std_return_pct.toFixed(2)}%</span>
              </div>
            </div>
          </div>

          <div class="monte-carlo-risk" style="margin-top: 1.5rem;">
            <h5 style="margin-bottom: 1rem;">Probabilit√©s de Perte</h5>
            <div class="monte-carlo-summary">
              <div class="sim-stat hinted" data-key="mc_loss_5">
                <span class="stat-label">Perte >5%</span>
                <span class="stat-value">${(result.loss_probabilities.prob_loss_5 * 100).toFixed(1)}%</span>
              </div>
              <div class="sim-stat hinted" data-key="mc_loss_10">
                <span class="stat-label">Perte >10%</span>
                <span class="stat-value">${(result.loss_probabilities.prob_loss_10 * 100).toFixed(1)}%</span>
              </div>
              <div class="sim-stat hinted" data-key="mc_loss_20">
                <span class="stat-label">Perte >20%</span>
                <span class="stat-value text-danger">${(result.loss_probabilities.prob_loss_20 * 100).toFixed(1)}%</span>
              </div>
              <div class="sim-stat hinted" data-key="mc_loss_30">
                <span class="stat-label">Perte >30%</span>
                <span class="stat-value text-danger">${(result.loss_probabilities.prob_loss_30 * 100).toFixed(1)}%</span>
              </div>
            </div>
          </div>

          <div class="monte-carlo-var" style="margin-top: 1.5rem;">
            <h5 style="margin-bottom: 1rem;">VaR/CVaR Monte Carlo</h5>
            <div class="monte-carlo-summary">
              <div class="sim-stat">
                <span class="stat-label">VaR 95%</span>
                <span class="stat-value">${result.risk_metrics.var_95_pct.toFixed(2)}%</span>
              </div>
              <div class="sim-stat">
                <span class="stat-label">CVaR 95%</span>
                <span class="stat-value">${result.risk_metrics.cvar_95_pct.toFixed(2)}%</span>
              </div>
              <div class="sim-stat">
                <span class="stat-label">VaR 99%</span>
                <span class="stat-value">${result.risk_metrics.var_99_pct.toFixed(2)}%</span>
              </div>
              <div class="sim-stat">
                <span class="stat-label">CVaR 99%</span>
                <span class="stat-value">${result.risk_metrics.cvar_99_pct.toFixed(2)}%</span>
              </div>
            </div>
          </div>

          <div class="monte-carlo-chart" style="margin-top: 2rem;">
            <h5 style="margin-bottom: 1rem;">üìä Distribution des Rendements (${result.simulation_params.horizon_days} jours)</h5>
            <div style="background: var(--theme-surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--theme-border);">
              <canvas id="monte-carlo-distribution-chart" style="max-height: 400px;"></canvas>
            </div>
          </div>

          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg); border-radius: 4px; font-size: 0.85rem; color: var(--theme-text-muted);">
            <strong>‚ÑπÔ∏è M√©thodologie:</strong><br/>
            Simulations bas√©es sur distributions r√©elles (${result.simulation_params.num_assets} assets, ${result.simulation_params.num_simulations.toLocaleString()} runs).<br/>
            Pr√©serve les corr√©lations historiques entre assets (matrice de covariance).<br/>
            Calcul√©: ${new Date(result.timestamp).toLocaleString('fr-FR')}
            ${sessionStorage.getItem('monte_carlo_result') ? ' <span style="color: var(--success);">(üì¶ Mis en cache)</span>' : ''}
          </div>
        `;

      // ‚úÖ NEW: Render distribution chart
      setTimeout(() => {
        window.decorateRiskTooltips?.();
        renderMonteCarloDistributionChart(result);
      }, 100);
    }

    // ‚úÖ FIX: Expose loadMonteCarloResults globally for retry button
    window.loadMonteCarloResults = loadMonteCarloResults;

    /**
     * Render Monte Carlo distribution chart
     * @param {Object} result - Monte Carlo simulation result
     */
    function renderMonteCarloDistributionChart(result) {
      const canvas = document.getElementById('monte-carlo-distribution-chart');
      if (!canvas) {
        console.warn('Monte Carlo chart canvas not found');
        return;
      }

      const ctx = canvas.getContext('2d');

      // Destroy existing chart if any
      if (window.monteCarloChart) {
        window.monteCarloChart.destroy();
      }

      // Generate histogram data from percentiles
      const percentiles = result.distribution_percentiles;
      const labels = [];
      const data = [];

      // Create bins from percentiles (approximate histogram)
      // We'll use percentiles as representative points
      const percentileKeys = Object.keys(percentiles).map(Number).sort((a, b) => a - b);

      // Create histogram-like data
      const bins = [];
      for (let i = 0; i < percentileKeys.length - 1; i++) {
        const p1 = percentileKeys[i];
        const p2 = percentileKeys[i + 1];
        const midValue = (percentiles[p1] + percentiles[p2]) / 2;
        const frequency = p2 - p1; // Approximate frequency

        bins.push({
          x: midValue.toFixed(1),
          y: frequency
        });
      }

      // Extract values for chart
      bins.forEach(bin => {
        labels.push(bin.x + '%');
        data.push(bin.y);
      });

      // Color bins based on positive/negative
      const backgroundColors = bins.map(bin => {
        const value = parseFloat(bin.x);
        if (value < -result.risk_metrics.var_95_pct) {
          return 'rgba(239, 68, 68, 0.7)'; // Dark red (VaR breach)
        } else if (value < 0) {
          return 'rgba(251, 146, 60, 0.7)'; // Orange (losses)
        } else {
          return 'rgba(34, 197, 94, 0.7)'; // Green (gains)
        }
      });

      // Get theme colors
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-text').trim() || '#ffffff';
      const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-border').trim() || '#333333';

      // Create chart
      window.monteCarloChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Fr√©quence (%)',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = parseFloat(labels[context.dataIndex]);
                  const freq = context.parsed.y;
                  return `Rendement: ${value.toFixed(1)}% | Fr√©quence: ${freq.toFixed(1)}%`;
                }
              }
            },
            annotation: {
              annotations: {
                // VaR 95% line
                var95Line: {
                  type: 'line',
                  xMin: bins.findIndex(b => parseFloat(b.x) >= -result.risk_metrics.var_95_pct),
                  xMax: bins.findIndex(b => parseFloat(b.x) >= -result.risk_metrics.var_95_pct),
                  borderColor: 'rgb(239, 68, 68)',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    display: true,
                    content: `VaR 95%: ${result.risk_metrics.var_95_pct.toFixed(1)}%`,
                    position: 'start',
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    color: '#ffffff',
                    font: {
                      size: 10
                    }
                  }
                },
                // Median line
                medianLine: {
                  type: 'line',
                  xMin: bins.findIndex(b => parseFloat(b.x) >= result.statistics.median_return_pct),
                  xMax: bins.findIndex(b => parseFloat(b.x) >= result.statistics.median_return_pct),
                  borderColor: 'rgb(59, 130, 246)',
                  borderWidth: 2,
                  borderDash: [3, 3],
                  label: {
                    display: true,
                    content: `M√©diane: ${result.statistics.median_return_pct.toFixed(1)}%`,
                    position: 'end',
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    color: '#ffffff',
                    font: {
                      size: 10
                    }
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Rendement (%)',
                color: textColor,
                font: {
                  size: 12,
                  weight: 'bold'
                }
              },
              ticks: {
                color: textColor,
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                color: gridColor,
                display: true
              }
            },
            y: {
              title: {
                display: true,
                text: 'Fr√©quence (%)',
                color: textColor,
                font: {
                  size: 12,
                  weight: 'bold'
                }
              },
              ticks: {
                color: textColor
              },
              grid: {
                color: gridColor,
                display: true
              }
            }
          }
        }
      });

      console.debug('‚úÖ Monte Carlo distribution chart rendered');
    }

    async function loadRiskAttribution() {
      const el = document.getElementById('risk-attribution-content');
      if (!el) return;
      try {
        const minUsd = window.globalConfig.get('min_usd_threshold') || 1.0;
        const priceDays = 365;
        const corrDays = 90;

        const data = await window.globalConfig.apiRequest('/api/risk/dashboard', {
          params: {
            price_history_days: priceDays,
            lookback_days: corrDays,
            min_usd: minUsd,
            risk_version: 'v2_active',
            use_dual_window: true
          }
        });
        if (!data.success) {
          throw new Error(data.message || 'API request failed');
        }

        const riskMetrics = data.risk_metrics;
        const correlationMetrics = data.correlation_metrics || {};

        el.innerHTML = `
            <p style="font-size: 0.85rem; color: var(--theme-text-muted); margin-bottom: 1rem; font-style: italic;">
              Analyse de la structure du risque et de la diversification du portefeuille.
            </p>
            <div class="var-methods">
              <div class="sim-stat hinted" data-key="diversification_ratio" data-value="${correlationMetrics.diversification_ratio || 0}" style="justify-content:space-between;">
                <span class="stat-label">Diversification Ratio</span>
                <span class="stat-value">${(correlationMetrics.diversification_ratio || 0).toFixed(2)}</span>
              </div>
              <div class="sim-stat hinted" data-key="effective_assets" data-value="${correlationMetrics.effective_assets || 0}" style="justify-content:space-between;">
                <span class="stat-label">Effective Assets</span>
                <span class="stat-value">${Math.round(correlationMetrics.effective_assets || 0)}</span>
              </div>
            </div>
          `;

        setTimeout(() => {
          window.decorateRiskTooltips?.();
        }, 100);

      } catch (e) {
        console.warn('Risk attribution load failed:', e);
        el.innerHTML = `<div class="warning">Erreur lors du calcul d'attribution: ${e.message}</div>`;
      }
    }

    // Make functions globally available (called by switchTab in main controller)
    window.loadAdvancedRiskComponents = loadAdvancedRiskComponents;
  </script>

  <!-- Flyout Panel System -->

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="280" persist-key="risk_dashboard_flyout">
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

  <!-- AI Chat Components -->
  <script type="module">
    import { initAIChat } from '/static/components/ai-chat-init.js';

    // Initialize AI Chat for risk dashboard page
    initAIChat('risk-dashboard');
  </script>

  <!-- Market Regimes Tab JavaScript (migrated from ai-dashboard.html - Dec 2025) -->
  <script>
    // Helper to fetch user config
    async function fetchUserConfig() {
      if (window.globalConfig && typeof window.globalConfig.get === 'function') {
        return {
          api_base_url: window.globalConfig.get('api_base_url') || window.location.origin
        };
      }
      return { api_base_url: window.location.origin };
    }

    // Load Stock Market regime data
    async function loadStockRegimeData() {
      try {
        const config = await fetchUserConfig();
        const endpoint = `${config.api_base_url}/api/ml/bourse/regime?benchmark=SPY&lookback_days=365`;
        debugLogger.debug('üì° Fetching stock regime from:', endpoint);

        const response = await fetch(endpoint);
        debugLogger.debug('üì° Stock regime response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          debugLogger.debug('üì° Stock regime data received:', data);

          if (data.current_regime && data.confidence !== undefined) {
            const regimeName = data.current_regime;
            const confidencePercent = (data.confidence * 100).toFixed(1);

            // Apply regime chip with proper class for coloring
            const regimeEl = document.getElementById('stock-regime-name');
            regimeEl.textContent = regimeName;
            regimeEl.className = 'regime-chip ' + regimeName.toLowerCase().replace(' ', '-').replace('_', '-');

            // Style confidence based on value
            const confidenceEl = document.getElementById('stock-regime-confidence');
            confidenceEl.textContent = confidencePercent + '%';
            const conf = data.confidence;
            confidenceEl.style.color = conf >= 0.8 ? 'var(--success)' : conf >= 0.6 ? 'var(--warning)' : 'var(--danger)';

            debugLogger.debug('‚úÖ Stock regime loaded:', regimeName, confidencePercent + '%');
          } else {
            debugLogger.warn('‚ö†Ô∏è No current_regime in response');
            document.getElementById('stock-regime-name').textContent = 'N/A';
            document.getElementById('stock-regime-confidence').textContent = 'N/A';
          }
        } else {
          const errorText = await response.text();
          debugLogger.error('‚ùå Stock regime API error:', response.status, errorText);
          document.getElementById('stock-regime-name').textContent = 'API Error';
          document.getElementById('stock-regime-confidence').textContent = '--';
        }
      } catch (error) {
        debugLogger.error('‚ùå Failed to load stock regime:', error);
        document.getElementById('stock-regime-name').textContent = 'Error';
        document.getElementById('stock-regime-confidence').textContent = '--';
      }
    }

    // Load Ethereum regime data
    async function loadEthereumRegimeData() {
      try {
        const config = await fetchUserConfig();
        const endpoint = `${config.api_base_url}/api/ml/crypto/regime?symbol=ETH&lookback_days=365`;
        debugLogger.debug('üì° Fetching ETH regime from:', endpoint);

        const response = await fetch(endpoint);
        debugLogger.debug('üì° ETH regime response status:', response.status);

        if (response.ok) {
          const rawData = await response.json();
          debugLogger.debug('üì° ETH regime data received:', rawData);

          const data = rawData.data || rawData;

          if (data.current_regime && data.confidence !== undefined) {
            const regimeName = data.current_regime;
            const confidencePercent = (data.confidence * 100).toFixed(1);
            const detectionMethod = data.detection_method;
            const ruleReason = data.rule_reason;

            const regimeChip = document.getElementById('eth-current-regime-name');
            regimeChip.textContent = regimeName;
            regimeChip.className = 'regime-chip ' + regimeName.toLowerCase().replace(' ', '-');

            document.getElementById('eth-current-regime-confidence').textContent = confidencePercent + '%';

            const methodBadge = document.getElementById('eth-current-regime-method');
            methodBadge.textContent = detectionMethod === 'rule_based' ? 'Rule-Based' : 'HMM';
            methodBadge.className = 'detection-method ' + detectionMethod;

            const reasonCard = document.getElementById('eth-regime-reason-card');
            if (ruleReason) {
              document.getElementById('eth-current-regime-reason').textContent = ruleReason;
              reasonCard.style.display = 'block';
            } else {
              reasonCard.style.display = 'none';
            }

            debugLogger.debug('‚úÖ ETH regime loaded:', regimeName, confidencePercent + '%', detectionMethod);
          } else {
            debugLogger.warn('‚ö†Ô∏è No current_regime in ETH response');
            document.getElementById('eth-current-regime-name').textContent = 'N/A';
            document.getElementById('eth-current-regime-confidence').textContent = 'N/A';
          }
        } else {
          const errorText = await response.text();
          debugLogger.error('‚ùå ETH regime API error:', response.status, errorText);
          document.getElementById('eth-current-regime-name').textContent = 'API Error';
          document.getElementById('eth-current-regime-confidence').textContent = '--';
        }
      } catch (error) {
        debugLogger.error('‚ùå Failed to load ETH regime:', error);
        document.getElementById('eth-current-regime-name').textContent = 'Error';
        document.getElementById('eth-current-regime-confidence').textContent = '--';
      }
    }

    // Store cross-asset comparison data for export
    let crossAssetComparisonData = null;

    // Load cross-asset comparison data
    async function loadCrossAssetComparison() {
      try {
        const config = await fetchUserConfig();
        debugLogger.debug('üì° Fetching cross-asset comparison data...');

        const btcResponse = await fetch(`${config.api_base_url}/api/ml/crypto/regime?symbol=BTC&lookback_days=365`);
        let btcData = btcResponse.ok ? await btcResponse.json() : null;

        const stockResponse = await fetch(`${config.api_base_url}/api/ml/bourse/regime?benchmark=SPY&lookback_days=365`);
        let stockData = stockResponse.ok ? await stockResponse.json() : null;

        const ethResponse = await fetch(`${config.api_base_url}/api/ml/crypto/regime?symbol=ETH&lookback_days=365`);
        let ethData = ethResponse.ok ? await ethResponse.json() : null;

        // Store data for export
        crossAssetComparisonData = {
          timestamp: new Date().toISOString(),
          stock: stockData,
          btc: btcData?.data || btcData,
          eth: ethData?.data || ethData
        };

        // Helper to get regime CSS class
        const getRegimeClass = (regime) => regime ? regime.toLowerCase().replace(' ', '-').replace('_', '-') : 'unknown';

        if (stockData && stockData.current_regime) {
          const stockEl = document.getElementById('comparison-stock-regime');
          stockEl.textContent = stockData.current_regime;
          stockEl.className = 'regime-chip ' + getRegimeClass(stockData.current_regime);
          document.getElementById('comparison-stock-confidence').textContent = (stockData.confidence * 100).toFixed(1) + '%';
        }

        if (btcData) {
          const btc = btcData.data || btcData;
          if (btc.current_regime) {
            const btcEl = document.getElementById('comparison-btc-regime');
            btcEl.textContent = btc.current_regime;
            btcEl.className = 'regime-chip ' + getRegimeClass(btc.current_regime);
            document.getElementById('comparison-btc-confidence').textContent = (btc.confidence * 100).toFixed(1) + '%';
            document.getElementById('comparison-btc-method').textContent = btc.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM';
          }
        }

        if (ethData) {
          const eth = ethData.data || ethData;
          if (eth.current_regime) {
            const ethEl = document.getElementById('comparison-eth-regime');
            ethEl.textContent = eth.current_regime;
            ethEl.className = 'regime-chip ' + getRegimeClass(eth.current_regime);
            document.getElementById('comparison-eth-confidence').textContent = (eth.confidence * 100).toFixed(1) + '%';
            document.getElementById('comparison-eth-method').textContent = eth.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM';
          }
        }

        debugLogger.debug('‚úÖ Cross-asset comparison loaded');
      } catch (error) {
        debugLogger.error('‚ùå Failed to load cross-asset comparison:', error);
      }
    }

    // Export cross-asset comparison data
    function exportCrossAssetComparison(format = 'json') {
      if (!crossAssetComparisonData) {
        if (window.toast) window.toast.showError('No data available. Please refresh first.');
        return;
      }

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      let blob, filename;

      if (format === 'json') {
        const jsonData = JSON.stringify(crossAssetComparisonData, null, 2);
        blob = new Blob([jsonData], { type: 'application/json' });
        filename = `cross-asset-comparison_${timestamp}.json`;
      } else if (format === 'csv') {
        // Create CSV with flattened data
        const csvRows = [];
        csvRows.push('Asset,Regime,Confidence (%),Detection Method,Drawdown (%),Volatility (%),Trend 30d (%)');

        const formatRow = (asset, data) => {
          if (!data) return null;
          return [
            asset,
            data.current_regime || 'N/A',
            ((data.confidence || 0) * 100).toFixed(1),
            data.detection_method === 'rule_based' ? 'Rule-Based' : 'HMM',
            ((data.drawdown_from_peak || 0) * 100).toFixed(1),
            ((data.market_volatility || 0) * 100).toFixed(1),
            ((data.trend_30d || 0) * 100).toFixed(1)
          ].join(',');
        };

        const stockRow = formatRow('S&P 500 (SPY)', crossAssetComparisonData.stock);
        const btcRow = formatRow('Bitcoin (BTC)', crossAssetComparisonData.btc);
        const ethRow = formatRow('Ethereum (ETH)', crossAssetComparisonData.eth);

        if (stockRow) csvRows.push(stockRow);
        if (btcRow) csvRows.push(btcRow);
        if (ethRow) csvRows.push(ethRow);

        const csvContent = csvRows.join('\n');
        blob = new Blob([csvContent], { type: 'text/csv' });
        filename = `cross-asset-comparison_${timestamp}.csv`;
      }

      // Trigger download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      if (window.toast) window.toast.showSuccess(`Exported as ${filename}`);
    }

    // Setup button event listeners for Market Regimes tab
    function setupRegimesTabButtons() {
      document.getElementById('refresh-stock-regime')?.addEventListener('click', async () => {
        await loadStockRegimeData();
        if (window.toast) window.toast.showSuccess('Stock regime data refreshed');
      });

      document.getElementById('view-stock-history')?.addEventListener('click', () => {
        if (window.openStockRegimeHistory) {
          window.openStockRegimeHistory();
        } else {
          if (window.toast) window.toast.showError('Stock regime history module not loaded');
        }
      });

      document.getElementById('refresh-comparison')?.addEventListener('click', async () => {
        await loadCrossAssetComparison();
        if (window.toast) window.toast.showSuccess('Comparison data refreshed');
      });

      document.getElementById('export-comparison')?.addEventListener('click', () => {
        // Ask for format preference
        const format = confirm('Click OK for JSON, Cancel for CSV') ? 'json' : 'csv';
        exportCrossAssetComparison(format);
      });
    }

    // Initialize Market Regimes tab on first click
    let regimesTabInitialized = false;
    document.addEventListener('DOMContentLoaded', () => {
      const regimesTabBtn = document.querySelector('[data-tab="regimes"]');
      if (regimesTabBtn) {
        regimesTabBtn.addEventListener('click', async () => {
          if (!regimesTabInitialized) {
            regimesTabInitialized = true;
            debugLogger.debug('üéØ Initializing Market Regimes tab...');

            try {
              if (window.initializeBTCRegimeChart) {
                await window.initializeBTCRegimeChart('btc-regime-section');
              }
              if (window.initializeETHRegimeChart) {
                await window.initializeETHRegimeChart();
              }
              await loadStockRegimeData();
              await loadEthereumRegimeData();
              await loadCrossAssetComparison();
              setupRegimesTabButtons();
              debugLogger.debug('‚úÖ Market Regimes tab fully initialized');
            } catch (error) {
              debugLogger.error('‚ùå Error initializing Market Regimes tab:', error);
            }
          }
        });
      }
    });
  </script>

</body>

</html>
