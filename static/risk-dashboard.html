<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - SmartFolio</title>

  <!-- Th√®me/compat identiques √† ta page actuelle -->
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partag√©s existants -->
  <script src="debug-logger.js"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script src="lazy-loader.js"></script>

  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js?v=20251022fix"></script>  <!-- ‚úÖ SSOT hydration -->
  <script type="module" src="core/fetcher.js"></script>

  <!-- CCS modules ESM -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>

  <!-- Unified asset groups system -->
  <script type="module" src="shared-asset-groups.js"></script>

  <!-- Chart.js will be lazy-loaded when needed -->

  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Navigation unifi√©e (conditionnelle) -->
  <script type="module">
    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Risk Dashboard Orchestrator -->
  <script type="module" src="modules/risk-dashboard-main.js"></script>
</head>

<body>
  <div id="backend-fallback-banner">
    ‚ö† Backend indisponible ‚Äî mode prudent (cap r√©duit).
  </div>

  <div class="wrap">
    <!-- Compact Header Controls -->
    <div class="page-header">
      <div class="page-title">
        <h1>Risk Dashboard</h1>
      </div>
      <div class="header-controls">
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
        <div class="dropdown">
          <button class="icon-btn" id="options-menu-btn" title="Options" aria-label="More options" aria-haspopup="true" aria-expanded="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="3" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="13" r="1.5" fill="currentColor"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="options-menu">
            <button class="dropdown-item" id="force-refresh-btn" title="Clear cache and recalculate all scores">
              <span class="item-icon">üßπ</span>
              <span class="item-text">Force Refresh</span>
            </button>
            <button class="dropdown-item" id="force-cycle-refresh-btn" title="Clear cycle cache and reload cycles only">
              <span class="item-icon">üîÑ</span>
              <span class="item-text">Refresh Cycles</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="test-endpoint-btn" title="Test API connection (dev only)">
              <span class="item-icon">üß™</span>
              <span class="item-text">Test API</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Layout Simple: Main Content uniquement (sidebar remplac√©e par Web Component flyout-panel) -->
    <div class="dashboard-layout">
      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <div class="tabs" role="tablist">
          <button class="tab-button active" data-tab="risk" role="tab" aria-selected="true" aria-controls="risk-tab">Risk Overview</button>
          <button class="tab-button" data-tab="cycles" role="tab" aria-selected="false" aria-controls="cycles-tab">Market Cycles</button>
          <button class="tab-button" data-tab="targets" role="tab" aria-selected="false" aria-controls="targets-tab">Strategic Targets</button>
          <button class="tab-button" data-tab="alerts" role="tab" aria-selected="false" aria-controls="alerts-tab">Alerts History</button>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab" role="tabpanel" aria-labelledby="risk-overview">
            <div id="risk-overview-badge-container" class="badge-container"></div>

            <!-- Persistent Controls (do not get replaced by dynamic render) -->
            <div id="risk-dashboard-content">
              <div class="loading">Loading risk metrics...</div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab" role="tabpanel" aria-labelledby="cycles">
            <div id="cycles-badge-container" class="badge-container"></div>
            <div id="cycles-content">
              <div class="loading">Loading cycle analysis...</div>
            </div>
          </div>

          <!-- Strategic Targets Tab -->
          <div class="tab-pane" id="targets-tab" role="tabpanel" aria-labelledby="targets">
            <div id="targets-badge-container" class="badge-container"></div>
            <div id="targets-content">
              <div class="loading">Loading strategic targets...</div>
            </div>
          </div>

          <!-- Alerts History Tab -->
          <div class="tab-pane" id="alerts-tab" role="tabpanel" aria-labelledby="alerts">
            <div id="alerts-content">
              <div class="alerts-header">
                <h3>üö® Alerts History</h3>
                <div class="alerts-controls">
                  <select id="alerts-severity-filter" data-action="filter-alerts">
                    <option value="" selected>All Severities</option>
                    <option value="S1">S1 - Info</option>
                    <option value="S2">S2 - Warning</option>
                    <option value="S3">S3 - Critical</option>
                  </select>
                  <select id="alerts-type-filter" data-action="filter-alerts">
                    <option value="" selected>All Types</option>
                    <option value="VOL_Q90_CROSS">High Volatility</option>
                    <option value="REGIME_FLIP">Regime Change</option>
                    <option value="CORR_HIGH">High Correlation</option>
                    <option value="CONTRADICTION_SPIKE">ML Contradiction</option>
                    <option value="DECISION_DROP">Low Confidence</option>
                    <option value="EXEC_COST_SPIKE">High Exec Cost</option>
                  </select>
                  <select id="alerts-period-filter" data-action="filter-alerts">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                  </select>
                  <button class="refresh-btn" data-action="refresh-alerts">Refresh</button>
                </div>
              </div>

              <div id="alerts-history-content">
                <div class="loading">Loading alerts history...</div>
              </div>

              <div class="alerts-pagination" id="alerts-pagination" style="display: none;">
                <button id="alerts-prev-btn" data-action="alerts-prev" disabled>Previous</button>
                <span id="alerts-page-info">Page 1 of 1</span>
                <button id="alerts-next-btn" data-action="alerts-next" disabled>Next</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partag√© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module" src="modules/risk-dashboard-main-controller.js"></script>

  <script type="module" src="modules/risk-dashboard-alerts-controller.js"></script>

  <!-- PHASE 2A: Toast Container -->
  <div id="toast-container">
    <!-- Toasts will appear here -->
  </div>

  <!-- Fixed button outside toast container -->
  <div id="toast-buttons" class="toast-clear-button">
    <button id="clear-all-toasts-btn" data-action="clear-all-toasts">üóëÔ∏è Clear All Alerts</button>
  </div>

  <!-- PHASE 2A: Alert Detail Modal -->
  <div class="modal-overlay" id="alert-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">
          <span class="modal-severity-badge" id="modal-severity-badge">S3</span>
          <span id="modal-alert-type">VOL_Q90_CROSS</span>
        </h2>
        <button class="modal-close" data-action="close-alert-modal">&times;</button>
      </div>

      <div class="modal-body">
        <!-- Alert Overview -->
        <div class="modal-section">
          <div class="modal-section-title">Alert Overview</div>
          <div class="alert-metadata" id="alert-overview">
            <div class="metadata-item">
              <span class="metadata-label">Alert ID</span>
              <span class="metadata-value" id="modal-alert-id">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Created</span>
              <span class="metadata-value" id="modal-created-at">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Current Value</span>
              <span class="metadata-value" id="modal-current-value">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Threshold</span>
              <span class="metadata-value" id="modal-threshold">-</span>
            </div>
          </div>
        </div>

        <!-- ML Signals Snapshot -->
        <div class="modal-section">
          <div class="modal-section-title">ML Signals Snapshot</div>
          <div class="signals-grid" id="signals-snapshot">
            <!-- Dynamic signal cards will be inserted here -->
          </div>
        </div>

        <!-- Suggested Action -->
        <div class="modal-section">
          <div class="modal-section-title">Suggested Action</div>
          <div class="suggested-action" id="suggested-action">
            <div class="action-type" id="action-type">Apply Policy</div>
            <div class="action-details" id="action-details">Mode: Slow, Cap Daily: 4%, Ramp Hours: 24</div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-action modal-action-secondary" data-action="close-alert-modal">Close</button>
        <button class="modal-action modal-action-secondary" data-action="snooze-alert" id="snooze-btn">Snooze
          30m</button>
        <button class="modal-action modal-action-primary" data-action="acknowledge-alert"
          id="ack-btn">Acknowledge</button>
        <button class="modal-action modal-action-danger" data-action="apply-action" id="apply-btn"
          style="display:none;">Apply Action</button>
      </div>
    </div>
  </div>

  <!-- Bitcoin Cycle Chart Lazy Loading Component -->
  <script type="module" src="components/bitcoin-cycle-chart.js"></script>

  <!-- Flyout Panel System -->

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="280" persist-key="risk_dashboard_flyout" pinned>
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

</body>

</html>
