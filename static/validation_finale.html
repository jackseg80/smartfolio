<!DOCTYPE html>
<html>
<head>
  <title>ðŸŽ¯ Validation Finale FRED</title>
  <style>
    body { font-family: system-ui; margin: 2rem; }
    .test { margin: 1rem 0; padding: 1rem; border-radius: 8px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { padding: 0.5rem 1rem; margin: 0.25rem; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Validation Finale - IntÃ©gration FRED</h1>
  <p>Test complet pour valider que le graphique Bitcoin Cycle utilise les donnÃ©es FRED depuis 2014</p>

  <button class="btn-primary" onclick="runValidation()">ðŸš€ Lancer Validation ComplÃ¨te</button>
  <button class="btn-success" onclick="goToRiskDashboard()">ðŸ“Š Aller au Risk Dashboard</button>
  
  <div id="results"></div>

  <script>
    function addTest(title, result, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test ${type}`;
      div.innerHTML = `<h3>${title}</h3><p>${result}</p>`;
      results.appendChild(div);
    }

    async function runValidation() {
      document.getElementById('results').innerHTML = '';
      addTest('ðŸ”„ DÃ©marrage', 'Validation complÃ¨te en cours...', 'info');
      
      // Test 1: Proxy FRED
      try {
        const response = await fetch('/proxy/fred/bitcoin?start_date=2014-01-01&limit=5');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data.length > 0) {
            const firstYear = new Date(data.data[0].time).getFullYear();
            addTest('âœ… Test 1: Proxy FRED', 
              `SUCCÃˆS - Proxy fonctionne, ${data.data.length} points, depuis ${firstYear}, total disponible: ${data.raw_count}`, 
              'success');
          } else {
            addTest('âŒ Test 1: Proxy FRED', `Ã‰CHEC - ${data.error}`, 'error');
            return;
          }
        } else {
          addTest('âŒ Test 1: Proxy FRED', `Ã‰CHEC - HTTP ${response.status}`, 'error');
          return;
        }
      } catch (e) {
        addTest('âŒ Test 1: Proxy FRED', `Ã‰CHEC - ${e.message}`, 'error');
        return;
      }

      // Test 2: fetchBitcoinHistoricalData complÃ¨te
      try {
        async function fetchBitcoinHistoricalData() {
          try {
            const proxyUrl = '/proxy/fred/bitcoin?start_date=2014-01-01';
            const r = await fetch(proxyUrl);
            if (!r.ok) throw new Error(`Proxy HTTP ${r.status}: ${r.statusText}`);
            const result = await r.json();
            
            if (result.success && result.data && result.data.length > 0) {
              return { 
                data: result.data.map(point => ({ time: point.time, price: point.price })), 
                source: result.source 
              };
            } else {
              throw new Error(result.error || 'No data');
            }
          } catch (e) {
            throw new Error('FRED Proxy failed: ' + e.message);
          }
        }

        const bitcoinData = await fetchBitcoinHistoricalData();
        
        if (bitcoinData.data.length > 0) {
          const first = bitcoinData.data[0];
          const last = bitcoinData.data[bitcoinData.data.length - 1];
          const firstDate = new Date(first.time);
          const lastDate = new Date(last.time);
          const firstYear = firstDate.getFullYear();
          
          addTest('âœ… Test 2: fetchBitcoinHistoricalData', 
            `SUCCÃˆS - ${bitcoinData.data.length} points, depuis ${firstYear}, source: ${bitcoinData.source}`, 
            'success');
            
          if (firstYear <= 2014) {
            addTest('ðŸŽ¯ Test 3: Historique Complet', 
              `PARFAIT - DonnÃ©es depuis ${firstYear}, historique Bitcoin complet disponible!`, 
              'success');
          } else {
            addTest('âš ï¸ Test 3: Historique Complet', 
              `PARTIEL - DonnÃ©es depuis ${firstYear} seulement`, 
              'error');
          }
        } else {
          addTest('âŒ Test 2: fetchBitcoinHistoricalData', 'Ã‰CHEC - Aucune donnÃ©e', 'error');
          return;
        }
      } catch (e) {
        addTest('âŒ Test 2: fetchBitcoinHistoricalData', `Ã‰CHEC - ${e.message}`, 'error');
        return;
      }

      // Test 4: Format donnÃ©es Chart.js
      try {
        const testData = [{ time: Date.now(), price: 100000 }];
        const chartData = testData.map(point => ({
          x: point.time,
          y: point.price
        }));
        
        if (chartData.length > 0 && chartData[0].x && chartData[0].y) {
          addTest('âœ… Test 4: Format Chart.js', 
            `SUCCÃˆS - DonnÃ©es correctement formatÃ©es pour Chart.js`, 
            'success');
        } else {
          addTest('âŒ Test 4: Format Chart.js', 'Ã‰CHEC - Format incorrect', 'error');
        }
      } catch (e) {
        addTest('âŒ Test 4: Format Chart.js', `Ã‰CHEC - ${e.message}`, 'error');
      }

      // Conclusion
      addTest('ðŸŽ‰ Validation ComplÃ¨te', 
        `RÃ‰USSIE! Le graphique Bitcoin Cycle devrait maintenant afficher les donnÃ©es complÃ¨tes depuis 2014. 
         Vous pouvez maintenant calibrer votre modÃ¨le sigmoÃ¯de sur l'historique rÃ©el complet.`, 
        'success');
    }

    function goToRiskDashboard() {
      window.open('/static/risk-dashboard.html', '_blank');
    }

    // Auto-validation
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(runValidation, 1000);
    });
  </script>
</body>
</html>