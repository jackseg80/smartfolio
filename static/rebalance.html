<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebalancing - SmartFolio</title>
  <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/rebalance.css">
  <link rel="stylesheet" href="components/governance-panel.css">
  <script src="global-config.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/fetcher.js"></script>
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js?v=20251022fix"></script>
  <script type="module">
    // ===== AUTH GUARD (Dec 2025) =====
    import { checkAuth } from './core/auth-guard.js';
    await checkAuth();  // V√©rifie authentification + redirect si n√©cessaire
    // =================================

    import { initDeepLinks } from './components/deep-links.js';
    import { wealthContextBar } from './components/WealthContextBar.js';

    // Anchors for rebalance.html: #proposed-targets #optimization #funding-plan #dca-schedule #constraints
    initDeepLinks({
      'proposed-targets': 'Proposed Targets',
      'optimization': 'Optimization',
      'funding-plan': 'Funding Plan',
      'dca-schedule': 'DCA Schedule',
      'constraints': 'Constraints'
    });

    // Expose wealthContextBar globally for use in main script
    window.wealthContextBar = wealthContextBar;
  </script>


  <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="input-validator.js"></script>
  <script src="performance-optimizer.js"></script>
  <script src="appearance.js"></script>

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapt layout when sidebar is pinned
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // Shift only content, not menu
  </script>

  <script type="module" src="components/tooltips.js"></script>
</head>

<body>

  <!-- Unified Risk Flyout Panel -->
  <flyout-panel position="left" width="340" persist-key="rebalance_flyout">
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

  <main class="wrap" style="padding-top: var(--space-lg);">
    <!-- Governance Panel (Decision Engine) -->
    <div id="governance-container"></div>

    <!-- Rebalancing Strategies -->
    <div id="proposed-targets" class="card" style="margin-bottom: 16px;">
      <h3 style="display:flex; align-items:center; justify-content:space-between;">
        <span style="cursor:pointer" onclick="toggleStrategiesSection()">üéØ Predefined Strategies</span>
        <span style="display:flex; align-items:center; gap:8px">
          <span class="small muted">View:</span>
          <button class="btn btn-sm btn-secondary" id="btnViewDetailed">Detailed</button>
          <button class="btn btn-sm" id="btnViewCompact"
            style="background: var(--theme-surface-elevated);">Compact</button>
          <span id="strategies-toggle" style="cursor:pointer; transition: transform .3s; margin-left:8px"
            onclick="toggleStrategiesSection()">‚ñº</span>
        </span>
      </h3>
      <div id="strategies-content">
        <div id="strategies-container" style="display: grid; gap: 12px; margin-top: 12px;">
          <div style="text-align: center; padding: 20px; color: var(--theme-text-muted);">
            Chargement des strat√©gies...
          </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border);">
          <!-- Ligne 1: Contr√¥les et boutons -->
          <div class="row" style="gap: 8px; flex-wrap: wrap; align-items: center;">
            <!-- Param√®tres compacts -->
            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: var(--theme-surface-elevated); border-radius: 4px; border: 1px solid var(--theme-border);">
              <label class="switch" style="margin: 0;">
                <input type="checkbox" id="sub-allocation-toggle">
                <span class="slider"></span>
              </label>
              <span id="sub-allocation-label" style="font-size: 12px; font-weight: 600; color: var(--brand-primary); white-space: nowrap;">
                Proportionnel
              </span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--theme-surface-elevated); border-radius: 4px; border: 1px solid var(--theme-border);">
              <label for="min-trade-input" style="font-size: 12px; white-space: nowrap;">Min:</label>
              <input type="number" id="min-trade-input" value="25" min="1" max="1000" step="1"
                aria-label="Montant minimum de trade en dollars am√©ricains"
                style="width: 60px; padding: 2px 4px; border: 1px solid var(--theme-border); border-radius: 3px; font-size: 12px;">
              <span style="font-size: 11px; color: var(--theme-text-muted);">USD</span>
            </div>
            <div id="priority-status" style="display: none; font-size: 11px; color: var(--brand-primary); padding: 4px 8px;">
              <span id="universe-source"></span> ‚Ä¢ <span id="universe-timestamp"></span>
            </div>

            <!-- S√©parateur vertical -->
            <div style="border-left: 1px solid var(--theme-border); height: 32px; margin: 0 4px;"></div>

            <!-- Boutons d'action strat√©gies -->
            <button id="apply-strategy-btn" class="btn btn-sm" style="background: var(--success);" disabled>
              ‚úÖ Appliquer
            </button>
            <button id="reset-strategy-btn" class="btn btn-sm btn-secondary">
              üîÑ Reset
            </button>
            <button id="refresh-dynamic-btn" class="btn btn-sm" style="background: var(--warning);"
              onclick="window.refreshDynamicStrategy()">
              üéØ Sync CCS
            </button>

            <!-- S√©parateur vertical -->
            <div style="border-left: 1px solid var(--theme-border); height: 32px; margin: 0 4px;"></div>

            <!-- Boutons d'export -->
            <button id="btnCsv" class="btn btn-sm btn-secondary" disabled>CSV</button>
            <button id="btnJson" class="btn btn-sm btn-secondary" disabled>JSON</button>
            <button id="btnCopyJson" class="btn btn-sm btn-secondary" disabled>üìã Copier</button>
          </div>

          <!-- Ligne 2: Pills de status (centr√©) -->
          <div class="row" style="gap: 8px; margin-top: 8px; justify-content: center; flex-wrap: nowrap; align-items: center;">
            <span id="selected-strategy-info" class="pill" style="display: none;">
              Aucune strat√©gie s√©lectionn√©e
            </span>
            <span id="dynamicTargetsIndicator" class="pill" style="background:var(--warning);color:white;display:none;">
              üéØ Targets dynamiques
            </span>
            <span id="total" class="pill">Total : ‚Äî</span>
            <span id="status" class="pill">Pr√™t.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Donuts -->
    <section class="card" style="margin-bottom: 16px;">
      <h3>R√©partition</h3>
      <div class="grid g2">
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div class="small muted">Actuelle</div>
          <div id="donutCurrent"></div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div class="small muted">Cible</div>
          <div id="donutTarget"></div>
        </div>
      </div>
      <div id="legend" class="legend mt8" style="justify-content: center;"></div>
    </section>

    <!-- R√©sum√© -->
    <section id="dca-schedule" class="card" style="margin-bottom: 16px;">
      <h3>R√©sum√© par groupe</h3>
      <div id="summary" class="grid g3 mt8"></div>
    </section>

    <!-- Actions -->
    <section id="funding-plan" class="card" style="margin-bottom: 16px;">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <h3>Actions</h3>
        <div id="pricing-badge"></div>
      </div>
      <div style="overflow:auto;max-height:50vh;border:1px solid var(--theme-border);border-radius:var(--radius-md)">
        <table id="tblActions">
          <thead>
            <tr>
              <th class="sortable" data-sort="group">group <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="alias">alias <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="symbol">symbol <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="action">action <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="usd">usd <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="est_quantity">est_quantity <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="price_used">price_used <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="location">location <span class="sort-arrow">‚áÖ</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Unknown aliases -->
    <section id="constraints" class="card" style="margin-bottom: 16px;">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h3>Unknown aliases</h3>
          <div class="small">Par d√©faut, <strong>Others</strong> est pr√©s√©lectionn√©.</div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end">
          <div>
            <label class="small">Tout vers</label><br />
            <select id="bulk_group">
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="Stablecoins">Stablecoins</option>
              <option value="SOL">SOL</option>
              <option value="L1/L0 majors">L1/L0 majors</option>
              <option value="L2/Scaling">L2/Scaling</option>
              <option value="DeFi">DeFi</option>
              <option value="AI/Data">AI/Data</option>
              <option value="Gaming/NFT">Gaming/NFT</option>
              <option value="Memecoins">Memecoins</option>
              <option value="Others" selected>Others</option>
            </select>
            <button id="btnBulkAdd" class="btn btn-ghost">Ajouter tout</button>
          </div>
          <div id="alias-manager-button" style="display: none;">
            <button class="btn btn-sm btn-secondary" onclick="openAliasManager()"
              title="Ouvrir l'interface de gestion des aliases">
              üè∑Ô∏è Alias Manager
            </button>
          </div>
        </div>
      </div>
      <div id="unknownList" class="small mt16"></div>
    </section>
  </main>

  <script type="module" src="modules/rebalance-controller.js"></script>


  <script type="module">
    import { GovernancePanel } from './components/GovernancePanel.js';

    // Initialize Governance Panel (Decision Engine) for rebalance page
    document.addEventListener('DOMContentLoaded', async function () {
      const governanceContainer = document.getElementById('governance-container');
      if (governanceContainer) {
        debugLogger.debug('üèõÔ∏è Initializing Governance Panel for rebalance...');
        const governancePanel = new GovernancePanel(governanceContainer);

        // Auto-refresh initial state (silent to avoid toast on page load)
        setTimeout(() => {
          governancePanel.refreshState({ silent: true });
        }, 1000);

        // Store reference globally for debugging
        window.governancePanel = governancePanel;
        debugLogger.debug('‚úÖ Governance Panel initialized');
      }
    });
  </script>

</body>

</html>