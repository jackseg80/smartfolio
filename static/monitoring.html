<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring - SmartFolio</title>

    <!-- Theme/compat -->
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <link rel="stylesheet" href="css/view-modes.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/risk-dashboard.css">

    <!-- Shared scripts -->
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
    <script type="module" src="components/data-freshness.js"></script>
    <script type="module" src="network-state-manager.js"></script>
    <script type="module" src="core/sentry-init.js"></script>
    <script type="module" src="components/view-toggle.js"></script>

    <!-- Navigation + Auth Guard -->
    <script type="module">
        import { checkAuth } from './core/auth-guard.js';
        await checkAuth();

        import { ViewModeManager } from './core/view-mode-manager.js';
        ViewModeManager.init();

        if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
            import('./components/nav.js');
        }
    </script>

    <style>
        /* ===== Health Banner ===== */
        .health-banner {
            display: flex;
            align-items: center;
            gap: var(--space-4, 1rem);
            padding: var(--space-4, 1rem) var(--space-6, 1.5rem);
            border-radius: var(--radius-lg, 0.5rem);
            border: 1px solid var(--theme-border);
            margin-bottom: var(--space-6, 1.5rem);
            transition: all 0.3s ease;
        }
        .health-banner.healthy {
            background: color-mix(in oklab, var(--color-success-500, #10b981) 10%, transparent);
            border-color: var(--color-success-500, #10b981);
        }
        .health-banner.degraded {
            background: color-mix(in oklab, var(--color-warning-500, #f59e0b) 10%, transparent);
            border-color: var(--color-warning-500, #f59e0b);
        }
        .health-banner.unhealthy {
            background: color-mix(in oklab, var(--color-danger-500, #ef4444) 10%, transparent);
            border-color: var(--color-danger-500, #ef4444);
        }
        .health-banner-icon { font-size: 2rem; }
        .health-banner-text { flex: 1; }
        .health-banner-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--theme-text);
        }
        .health-banner-subtitle {
            font-size: 0.85rem;
            color: var(--theme-text-muted);
            margin-top: 2px;
        }

        /* ===== KPI Grid ===== */
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg, 0.5rem);
            padding: 1rem;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s ease;
        }
        .kpi-card:hover { border-color: var(--brand-primary, #3b82f6); }
        .kpi-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .kpi-icon { font-size: 1.25rem; }
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--theme-text);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            transition: color 0.3s ease;
        }
        .kpi-details {
            font-size: 0.8rem;
            color: var(--theme-text-muted);
            line-height: 1.5;
        }

        /* ===== Status Colors ===== */
        .status-healthy { color: var(--color-success-600, #047857); }
        .status-warning { color: var(--color-warning-700, #92400e); }
        .status-critical { color: var(--color-danger-600, #b91c1c); }
        .status-unknown { color: var(--theme-text-muted); }

        /* ===== Status Badge ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .status-badge.healthy {
            background: color-mix(in oklab, var(--color-success-500, #10b981) 15%, transparent);
            color: var(--color-success-600, #047857);
        }
        .status-badge.degraded, .status-badge.warning {
            background: color-mix(in oklab, var(--color-warning-500, #f59e0b) 15%, transparent);
            color: var(--color-warning-700, #92400e);
        }
        .status-badge.unhealthy, .status-badge.critical {
            background: color-mix(in oklab, var(--color-danger-500, #ef4444) 15%, transparent);
            color: var(--color-danger-600, #b91c1c);
        }
        .status-badge.unknown, .status-badge.disabled {
            background: color-mix(in oklab, var(--theme-text-muted) 15%, transparent);
            color: var(--theme-text-muted);
        }

        /* ===== Section Heading ===== */
        .section-heading {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--theme-text);
            margin: 2rem 0 1rem 0;
            padding-top: 1.5rem;
            border-top: 1px solid var(--theme-border);
        }
        .section-heading:first-of-type {
            border-top: none;
            padding-top: 0;
        }

        /* ===== Alerts Filters ===== */
        .filters-compact {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters-compact label {
            font-size: 0.8rem;
            color: var(--theme-text-muted);
            margin-right: 4px;
        }
        .filters-compact select {
            padding: 4px 8px;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-sm, 0.25rem);
            background: var(--theme-surface);
            color: var(--theme-text);
            font-size: 0.85rem;
        }
        .filter-spacer { margin-left: 12px; }

        /* ===== Monitoring Table ===== */
        .table-container {
            overflow: auto;
            max-height: 600px;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md, 0.375rem);
        }
        .monitoring-table {
            width: 100%;
            border-collapse: collapse;
        }
        .monitoring-table thead tr {
            background: var(--theme-surface-elevated, var(--theme-surface));
            border-bottom: 2px solid var(--theme-border);
        }
        .monitoring-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--theme-text);
        }
        .monitoring-table td {
            padding: 12px;
            font-size: 0.85rem;
            color: var(--theme-text);
        }
        .monitoring-table tbody tr {
            border-bottom: 1px solid var(--theme-border);
            transition: background 0.15s ease;
        }
        .monitoring-table tbody tr:hover {
            background: color-mix(in oklab, var(--brand-primary, #3b82f6) 5%, transparent);
        }

        /* ===== Pagination ===== */
        .pagination-controls {
            display: none;
            margin-top: 12px;
            text-align: center;
            padding: 8px;
        }
        .pagination-controls.visible { display: block; }
        .pagination-btn {
            background: var(--brand-primary, #3b82f6);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius-sm, 0.25rem);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease;
        }
        .pagination-btn:hover { background: color-mix(in oklab, var(--brand-primary, #3b82f6) 80%, black); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info {
            margin: 0 16px;
            color: var(--theme-text);
            font-size: 0.85rem;
        }

        /* ===== Loading / Empty ===== */
        .loading-placeholder {
            padding: 40px;
            text-align: center;
            color: var(--theme-text-muted);
        }

        /* ===== Last Update Footer ===== */
        .last-update {
            text-align: center;
            color: var(--theme-text-muted);
            font-size: 0.8rem;
            margin-top: 2rem;
            padding: 1rem;
            border-top: 1px solid var(--theme-border);
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .monitoring-grid {
                grid-template-columns: 1fr;
            }
            .filters-compact {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-spacer { margin-left: 0; }
        }
        @media (min-width: 1400px) {
            .monitoring-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <h1>System Monitoring</h1>
            </div>
            <div class="header-controls">
                <view-toggle></view-toggle>
                <div class="timestamp" id="last-update">Loading...</div>
                <button class="icon-btn" id="refresh-btn" title="Refresh all" aria-label="Refresh all data">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- ===== Health Banner ===== -->
        <div id="health-banner" class="health-banner healthy">
            <div class="health-banner-icon" id="health-icon">--</div>
            <div class="health-banner-text">
                <div class="health-banner-title" id="health-title">Checking system health...</div>
                <div class="health-banner-subtitle" id="health-subtitle">Connecting to backend services...</div>
            </div>
            <span class="status-badge unknown" id="health-badge">loading</span>
        </div>

        <!-- ===== KPI Cards ===== -->
        <div class="monitoring-grid" id="kpi-grid">
            <!-- KPI 1: System Status -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">&#9889;</div>
                    <div class="kpi-title">System Status</div>
                </div>
                <div id="kpi-system-value" class="kpi-value status-unknown">--</div>
                <div class="kpi-details">
                    <div>API: <span id="kpi-api-status">--</span></div>
                    <div>Redis: <span id="kpi-redis-status">--</span></div>
                    <div>ML: <span id="kpi-ml-status">--</span></div>
                </div>
            </div>

            <!-- KPI 2: Active Alerts -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">&#128680;</div>
                    <div class="kpi-title">Active Alerts</div>
                </div>
                <div id="kpi-alerts-value" class="kpi-value status-unknown">--</div>
                <div class="kpi-details">
                    <div>Engine: <span id="kpi-alerts-engine">--</span></div>
                    <div>Escalations today: <span id="kpi-alerts-escalations">--</span></div>
                    <div>Filtered (anti-noise): <span id="kpi-alerts-filtered">--</span></div>
                </div>
            </div>

            <!-- KPI 3: Circuit Breakers (Pro) -->
            <div class="kpi-card pro-only">
                <div class="kpi-header">
                    <div class="kpi-icon">&#128279;</div>
                    <div class="kpi-title">Circuit Breakers</div>
                </div>
                <div id="kpi-cb-value" class="kpi-value status-unknown">--</div>
                <div class="kpi-details" id="kpi-cb-details">
                    <div>All circuits nominal</div>
                </div>
            </div>

            <!-- KPI 4: Scheduler (Pro) -->
            <div class="kpi-card pro-only">
                <div class="kpi-header">
                    <div class="kpi-icon">&#128197;</div>
                    <div class="kpi-title">Scheduler</div>
                </div>
                <div id="kpi-sched-value" class="kpi-value status-unknown">--</div>
                <div class="kpi-details" id="kpi-sched-details">
                    <div>Jobs: <span id="kpi-sched-count">--</span></div>
                    <div>Status: <span id="kpi-sched-status">--</span></div>
                </div>
            </div>
        </div>

        <!-- ===== Alerts History ===== -->
        <div>
            <h2 class="section-heading">Alerts History</h2>

            <!-- Filters -->
            <div class="filters-compact">
                <label for="alerts-severity-filter">Severity:</label>
                <select id="alerts-severity-filter">
                    <option value="">All</option>
                    <option value="S1">S1</option>
                    <option value="S2">S2</option>
                    <option value="S3">S3</option>
                </select>

                <label class="filter-spacer" for="alerts-type-filter">Type:</label>
                <select id="alerts-type-filter">
                    <option value="">All</option>
                    <option value="VOL_Q90_CROSS">High Vol</option>
                    <option value="REGIME_FLIP">Regime</option>
                    <option value="CONTRADICTION_SPIKE">Contradiction</option>
                    <option value="DECISION_DROP">Low Conf</option>
                    <option value="EXEC_COST_SPIKE">Exec Cost</option>
                </select>

                <label class="filter-spacer" for="alerts-period-filter">Period:</label>
                <select id="alerts-period-filter">
                    <option value="7">7d</option>
                    <option value="30" selected>30d</option>
                    <option value="90">90d</option>
                </select>
            </div>

            <!-- Alerts Table -->
            <div id="alerts-history-content" class="table-container">
                <div class="loading-placeholder">Loading alerts history...</div>
            </div>

            <!-- Pagination -->
            <div id="alerts-pagination" class="pagination-controls">
                <button id="alerts-prev-btn" class="pagination-btn" disabled>Previous</button>
                <span id="alerts-page-info" class="pagination-info">Page 1 of 1</span>
                <button id="alerts-next-btn" class="pagination-btn" disabled>Next</button>
            </div>
        </div>

        <!-- ===== Footer ===== -->
        <div class="last-update">
            Last updated: <span id="global-timestamp">--</span> |
            Auto-refresh: <span id="auto-refresh-status">Active (30s)</span>
        </div>
    </div>

    <script type="module">
    import { apiCall } from './core/fetcher.js';

    // ===== CONFIGURATION =====
    const REFRESH_INTERVAL_MS = 30_000;
    let refreshTimer = null;

    // ===== ALERTS STATE =====
    let alertsHistoryData = [];
    let currentAlertsPage = 1;
    let totalAlertsPages = 1;
    const ALERTS_PER_PAGE = 20;

    // ===== DATA FETCHING =====

    async function fetchHealthAll() {
        const result = await apiCall('/health/all');
        if (!result.ok) return null;
        return result.data?.data || result.data;
    }

    async function fetchAlertsActive(filters = {}) {
        const params = new URLSearchParams();
        params.append('limit', '100');
        params.append('offset', '0');
        params.append('include_snoozed', 'true');
        if (filters.severity) params.append('severity_filter', filters.severity);
        if (filters.type) params.append('type_filter', filters.type);

        const result = await apiCall(`/api/alerts/active?${params.toString()}`);
        if (!result.ok) return [];
        // /api/alerts/active returns raw list (no success_response wrapper)
        return Array.isArray(result.data) ? result.data : (result.data?.data || []);
    }

    async function fetchAlertsHealth() {
        const result = await apiCall('/api/alerts/health');
        if (!result.ok) return null;
        return result.data?.data || result.data;
    }

    async function fetchSchedulerHealth() {
        // 503 = scheduler disabled (RUN_SCHEDULER != 1), don't retry
        const result = await apiCall('/api/scheduler/health', { maxRetries: 0 });
        if (!result.ok) return null;
        return result.data?.data || result.data;
    }

    // ===== RENDERING =====

    function renderHealthBanner(health) {
        const banner = document.getElementById('health-banner');
        const icon = document.getElementById('health-icon');
        const title = document.getElementById('health-title');
        const subtitle = document.getElementById('health-subtitle');
        const badge = document.getElementById('health-badge');

        if (!health) {
            banner.className = 'health-banner unhealthy';
            icon.textContent = '\u274C';
            title.textContent = 'Unable to reach backend';
            subtitle.textContent = 'API server may be down or unreachable';
            badge.className = 'status-badge unhealthy';
            badge.textContent = 'offline';
            return;
        }

        const status = health.overall_status || 'unknown';
        banner.className = `health-banner ${status}`;

        if (status === 'healthy') {
            icon.textContent = '\u2705';
            title.textContent = 'All Systems Operational';
        } else if (status === 'degraded') {
            icon.textContent = '\u26A0\uFE0F';
            title.textContent = 'Some Systems Degraded';
        } else {
            icon.textContent = '\u274C';
            title.textContent = 'System Issues Detected';
        }

        // Count components by status
        const components = health.components || {};
        const counts = { healthy: 0, degraded: 0, unhealthy: 0, unknown: 0, disabled: 0 };
        for (const comp of Object.values(components)) {
            const s = comp.status || 'unknown';
            counts[s] = (counts[s] || 0) + 1;
        }
        const total = Object.keys(components).length;
        subtitle.textContent = `${counts.healthy}/${total} components healthy` +
            (counts.degraded ? ` | ${counts.degraded} degraded` : '') +
            (counts.unhealthy ? ` | ${counts.unhealthy} unhealthy` : '') +
            (health.environment ? ` | env: ${health.environment}` : '');

        badge.className = `status-badge ${status}`;
        badge.textContent = status;
    }

    function renderKPISystem(health) {
        const el = document.getElementById('kpi-system-value');
        if (!health) {
            el.textContent = 'Offline';
            el.className = 'kpi-value status-critical';
            return;
        }

        const status = health.overall_status || 'unknown';
        el.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        el.className = `kpi-value status-${status === 'healthy' ? 'healthy' : status === 'degraded' ? 'warning' : 'critical'}`;

        const comps = health.components || {};
        document.getElementById('kpi-api-status').textContent = comps.api?.status || '--';
        document.getElementById('kpi-redis-status').textContent =
            comps.redis?.status === 'healthy' ? `healthy (${comps.redis.keys || 0} keys)` : (comps.redis?.status || '--');
        document.getElementById('kpi-ml-status').textContent =
            comps.ml?.status || '--';
    }

    function renderKPIAlerts(alerts, alertsHealth) {
        const el = document.getElementById('kpi-alerts-value');
        const count = Array.isArray(alerts) ? alerts.length : 0;

        el.textContent = count.toString();
        el.className = `kpi-value ${count === 0 ? 'status-healthy' : count < 5 ? 'status-warning' : 'status-critical'}`;

        if (alertsHealth) {
            document.getElementById('kpi-alerts-engine').textContent = alertsHealth.engine_status || '--';
            document.getElementById('kpi-alerts-escalations').textContent = alertsHealth.escalations_today ?? '--';
            const antiNoise = alertsHealth.anti_noise_stats || {};
            const totalFiltered = (antiNoise.dedup_filtered || 0) + (antiNoise.rate_limit_filtered || 0) + (antiNoise.budget_filtered || 0);
            document.getElementById('kpi-alerts-filtered').textContent = totalFiltered.toString();
        }
    }

    function renderKPICircuitBreakers(health) {
        const el = document.getElementById('kpi-cb-value');
        const details = document.getElementById('kpi-cb-details');
        const cbData = health?.components?.circuit_breakers;

        if (!cbData || !cbData.circuits) {
            el.textContent = 'Unknown';
            el.className = 'kpi-value status-unknown';
            return;
        }

        const circuits = cbData.circuits;
        const names = Object.keys(circuits);
        const openCircuits = names.filter(n => circuits[n].state === 'open');
        const halfOpen = names.filter(n => circuits[n].state === 'half_open');

        if (openCircuits.length === 0 && halfOpen.length === 0) {
            el.textContent = `${names.length}/${names.length}`;
            el.className = 'kpi-value status-healthy';
            details.innerHTML = '<div>All circuits closed</div>';
        } else {
            const closed = names.length - openCircuits.length - halfOpen.length;
            el.textContent = `${closed}/${names.length}`;
            el.className = `kpi-value ${openCircuits.length > 0 ? 'status-critical' : 'status-warning'}`;
            let html = '';
            for (const name of openCircuits) {
                html += `<div>${name}: <strong style="color:var(--color-danger-600)">OPEN</strong> (${circuits[name].failure_count || 0} failures)</div>`;
            }
            for (const name of halfOpen) {
                html += `<div>${name}: <strong style="color:var(--color-warning-700)">HALF-OPEN</strong></div>`;
            }
            details.innerHTML = html;
        }
    }

    function renderKPIScheduler(scheduler) {
        const el = document.getElementById('kpi-sched-value');
        const detailsEl = document.getElementById('kpi-sched-details');

        if (!scheduler) {
            el.textContent = 'Disabled';
            el.className = 'kpi-value status-unknown';
            detailsEl.innerHTML = '<div>Scheduler not running</div>';
            return;
        }

        const count = scheduler.jobs_count ?? 0;
        const enabled = scheduler.enabled !== false;

        el.textContent = enabled ? `${count} jobs` : 'Disabled';
        el.className = `kpi-value ${enabled ? 'status-healthy' : 'status-warning'}`;

        // Always rebuild details HTML (avoid stale element references)
        let html = `<div>Jobs: ${count}</div><div>Status: ${enabled ? 'Running' : 'Disabled'}</div>`;
        if (scheduler.jobs && typeof scheduler.jobs === 'object') {
            const jobNames = Object.keys(scheduler.jobs).slice(0, 3);
            for (const name of jobNames) {
                const job = scheduler.jobs[name];
                const nextRun = job.next_run ? new Date(job.next_run).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '--';
                html += `<div>${job.name || name}: next ${nextRun}</div>`;
            }
        }
        detailsEl.innerHTML = html;
    }

    // ===== ALERTS TABLE =====

    const ALERT_TEMPLATES = {
        'VOL_Q90_CROSS': {
            'S1': { action: 'Volatility monitoring', impact_base: 0.5 },
            'S2': { action: 'Exposure reduction (Slow mode)', impact_base: 2.0 },
            'S3': { action: 'Immediate trading halt (Freeze)', impact_base: 8.0 }
        },
        'EXEC_COST_SPIKE': {
            'S1': { action: 'Execution cost monitoring', impact_base: 0.2 },
            'S2': { action: 'Trading slowdown (Slow mode)', impact_base: 1.5 },
            'S3': { action: 'Trading halt (Freeze mode)', impact_base: 4.0 }
        },
        'DECISION_DROP': {
            'S1': { action: 'Decision confidence monitoring', impact_base: 0.4 },
            'S2': { action: 'Cautious allocation mode', impact_base: 2.2 },
            'S3': { action: 'Ultra-conservative mode (Freeze)', impact_base: 9.0 }
        }
    };

    function formatAlert(alert) {
        const template = ALERT_TEMPLATES[alert.alert_type]?.[alert.severity] ||
            { action: `Alert ${alert.alert_type}`, impact_base: 1.0 };
        const impact_euro = 100000 * template.impact_base / 100;
        return {
            action: template.action,
            impact: impact_euro >= 1 ? `\u20AC${Math.round(impact_euro).toLocaleString()}` : `\u20AC${impact_euro.toFixed(2)}`
        };
    }

    function filterAlertsByPeriod(alerts, days) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return alerts.filter(a => new Date(a.created_at) >= cutoff);
    }

    function renderAlertsTable(alerts) {
        const container = document.getElementById('alerts-history-content');

        if (!alerts || alerts.length === 0) {
            container.innerHTML = '<div class="loading-placeholder">No alerts found for the selected filters.</div>';
            document.getElementById('alerts-pagination').classList.remove('visible');
            return;
        }

        totalAlertsPages = Math.ceil(alerts.length / ALERTS_PER_PAGE);
        const startIdx = (currentAlertsPage - 1) * ALERTS_PER_PAGE;
        const pageAlerts = alerts.slice(startIdx, startIdx + ALERTS_PER_PAGE);

        let html = `
            <table class="monitoring-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Severity</th>
                        <th>Type</th>
                        <th class="pro-only">Action</th>
                        <th class="pro-only">Impact</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const alert of pageAlerts) {
            const formatted = formatAlert(alert);
            const time = new Date(alert.created_at).toLocaleString();
            const sevColor = alert.severity === 'S3' ? 'var(--color-danger-600)' :
                             alert.severity === 'S2' ? 'var(--color-warning-700)' : 'var(--color-info-600, #1d4ed8)';
            const status = alert.acknowledged_at ? 'Acknowledged' :
                          (alert.snooze_until && new Date(alert.snooze_until) > new Date()) ? 'Snoozed' : 'Active';
            const statusIcon = status === 'Acknowledged' ? '\u2705' : status === 'Snoozed' ? '\u23F8\uFE0F' : '\uD83D\uDEA8';

            html += `
                <tr>
                    <td>${time}</td>
                    <td style="color:${sevColor};font-weight:600">${alert.severity}</td>
                    <td>${alert.alert_type}</td>
                    <td class="pro-only">${formatted.action}</td>
                    <td class="pro-only" style="font-weight:600">${formatted.impact}</td>
                    <td>${statusIcon} ${status}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;

        // Pagination
        document.getElementById('alerts-page-info').textContent = `Page ${currentAlertsPage} of ${totalAlertsPages}`;
        document.getElementById('alerts-prev-btn').disabled = currentAlertsPage === 1;
        document.getElementById('alerts-next-btn').disabled = currentAlertsPage === totalAlertsPages;
        document.getElementById('alerts-pagination').classList.toggle('visible', totalAlertsPages > 1);
    }

    function getCurrentFilters() {
        return {
            severity: document.getElementById('alerts-severity-filter')?.value || '',
            type: document.getElementById('alerts-type-filter')?.value || ''
        };
    }

    async function refreshAlerts() {
        const filters = getCurrentFilters();
        const period = parseInt(document.getElementById('alerts-period-filter')?.value || '30');

        try {
            let alerts = await fetchAlertsActive(filters);
            alerts = filterAlertsByPeriod(alerts, period);
            alertsHistoryData = alerts;
            currentAlertsPage = 1;
            renderAlertsTable(alerts);
        } catch (error) {
            console.error('[Monitoring] Error refreshing alerts:', error);
        }
    }

    // ===== ORCHESTRATION =====

    async function refreshAll() {
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.disabled = true;

        try {
            // Parallel fetch of all public endpoints
            const [health, alerts, alertsHealth, scheduler] = await Promise.all([
                fetchHealthAll(),
                fetchAlertsActive(getCurrentFilters()),
                fetchAlertsHealth(),
                fetchSchedulerHealth()
            ]);

            // Render KPI cards
            renderHealthBanner(health);
            renderKPISystem(health);
            renderKPIAlerts(alerts, alertsHealth);
            renderKPICircuitBreakers(health);
            renderKPIScheduler(scheduler);

            // Alerts table
            const period = parseInt(document.getElementById('alerts-period-filter')?.value || '30');
            alertsHistoryData = filterAlertsByPeriod(alerts, period);
            currentAlertsPage = 1;
            renderAlertsTable(alertsHistoryData);

            // Update timestamp
            document.getElementById('global-timestamp').textContent = new Date().toLocaleTimeString('en-US');
            document.getElementById('last-update').textContent = `Updated ${new Date().toLocaleTimeString('en-US')}`;

        } catch (error) {
            console.error('[Monitoring] Refresh failed:', error);
        } finally {
            refreshBtn.disabled = false;
        }
    }

    // ===== EVENT HANDLERS =====

    document.getElementById('refresh-btn').addEventListener('click', refreshAll);

    document.getElementById('alerts-prev-btn').addEventListener('click', () => {
        if (currentAlertsPage > 1) {
            currentAlertsPage--;
            renderAlertsTable(alertsHistoryData);
        }
    });

    document.getElementById('alerts-next-btn').addEventListener('click', () => {
        if (currentAlertsPage < totalAlertsPages) {
            currentAlertsPage++;
            renderAlertsTable(alertsHistoryData);
        }
    });

    ['alerts-severity-filter', 'alerts-type-filter', 'alerts-period-filter'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', refreshAlerts);
    });

    // ===== INITIALIZATION =====

    await refreshAll();
    refreshTimer = setInterval(refreshAll, REFRESH_INTERVAL_MS);

    window.addEventListener('beforeunload', () => {
        if (refreshTimer) clearInterval(refreshTimer);
    });
    </script>
</body>
</html>
