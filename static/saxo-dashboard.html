<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Dashboard Bourse - Crypto Rebalancer</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module">
        import { initDeepLinks } from './components/deep-links.js';
        import { wealthContextBar } from './components/WealthContextBar.js';
        import { safeFetch } from './modules/http.js';

        // Ancres pour saxo-dashboard.html
        initDeepLinks({
            'overview': 'Vue d\'ensemble',
            'positions': 'Positions',
            'allocation': 'Allocation',
            'performance': 'Performance'
        });

        window.wealthContextBar = wealthContextBar;
        window.safeFetch = safeFetch;
    </script>
    <script src="debug-logger.js"></script>
  <script src="global-config.js"></script>
    <script src="appearance.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Plotly.js for dendrograms (via jsdelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>

    <!-- jsPDF and html2canvas for PDF export (via jsdelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--theme-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--theme-border);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .dashboard-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .card-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            background: var(--theme-bg);
            color: var(--theme-text-muted);
            border: 1px solid var(--theme-border);
        }

        .metric-large {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--theme-text-muted);
            font-size: 0.875rem;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .allocation-item {
            text-align: center;
            padding: 1rem;
            background: var(--theme-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--theme-border);
        }

        .allocation-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--brand-primary);
        }

        .allocation-label {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
            margin-top: 0.25rem;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .positions-table th,
        .positions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--theme-border);
        }

        .positions-table th {
            background: var(--theme-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .positions-table tr:hover {
            background: var(--theme-bg);
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
        }

        .asset-class-badge {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .asset-class-stock {
            background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
            color: var(--brand-primary);
        }

        .asset-class-etf {
            background: color-mix(in oklab, var(--success) 10%, transparent);
            color: var(--success);
        }

        .asset-class-bond {
            background: color-mix(in oklab, var(--warning) 10%, transparent);
            color: var(--warning);
        }

        .asset-class-cfd {
            background: color-mix(in oklab, #FF6B6B 10%, transparent);
            color: #FF6B6B;
        }

        .asset-class-other {
            background: color-mix(in oklab, var(--info) 10%, transparent);
            color: var(--info);
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .currency-item {
            padding: 0.75rem;
            text-align: center;
            background: var(--theme-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--theme-border);
        }

        .currency-percentage {
            font-weight: 700;
            color: var(--brand-primary);
        }

        .currency-code {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--theme-text-muted);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--theme-text-muted);
        }

        .error-message {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .refresh-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all var(--transition-fast);
        }

        .refresh-btn:hover {
            background: color-mix(in oklab, var(--brand-primary) 80%, black);
        }


        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--theme-border);
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--theme-text-muted);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .tab-btn.active {
            color: var(--brand-primary);
            border-bottom-color: var(--brand-primary);
        }

        .tab-btn:hover:not(.active) {
            color: var(--theme-text);
            background: var(--theme-bg);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: var(--radius-md);
            border-left: 4px solid;
            background: var(--theme-surface);
        }

        .alert-critical {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .alert-warning {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .alert-info {
            border-left-color: var(--info);
            background: rgba(59, 130, 246, 0.1);
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-value {
            font-size: 0.875rem;
            color: var(--theme-text-muted);
            margin-bottom: 0.25rem;
        }

        .alert-impact {
            font-size: 0.875rem;
            color: var(--theme-text-muted);
            margin-bottom: 0.5rem;
        }

        .alert-recommendation {
            font-size: 0.875rem;
            padding: 0.5rem;
            background: var(--theme-bg);
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
        }

        .alert-deadline {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .acknowledge-btn {
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            border-radius: 4px;
            color: var(--theme-text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }

        .acknowledge-btn:hover {
            background: var(--theme-bg-tertiary);
            border-color: var(--success);
            color: var(--success);
        }

        .acknowledge-btn:active {
            transform: scale(0.98);
        }

        .acknowledge-btn.acknowledged {
            background: var(--success);
            color: white;
            border-color: var(--success);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .alert-empty {
            text-align: center;
            padding: 2rem;
            color: var(--theme-text-muted);
        }

        .alert-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-critical {
            background: var(--danger);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-info {
            background: var(--info);
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1>üìà Dashboard Bourse (Saxo Bank)</h1>
                <p style="color: var(--theme-text-muted); margin: 0;">Analyse de votre portefeuille actions</p>
            </div>
        </div>


        <!-- Main Content (initially empty, filled by loadCurrentSaxoData) -->
        <div id="mainContent">
            <div class="loading">üìä Chargement initial...</div>
        </div>

        <!-- Dashboard Content (hidden by default) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview', event)">Vue d'ensemble</button>
                <button class="tab-btn" onclick="switchTab('positions', event)">Positions</button>
                <button class="tab-btn" onclick="switchTab('allocation', event)">Allocation</button>
                <button class="tab-btn" onclick="switchTab('currencies', event)">Devises</button>
                <button class="tab-btn" onclick="switchTab('risk', event)">Risk</button>
                <button class="tab-btn" onclick="switchTab('analytics', event)">Analytics</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Portfolio Summary -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Portfolio Summary</h3>
                            <div class="card-badge" id="portfolioBadge">Read-Only</div>
                        </div>
                        <div id="portfolioSummary">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Asset Allocation -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Asset Allocation</h3>
                        </div>
                        <div id="assetAllocation">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Top Holdings -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Top 10 Holdings</h3>
                    </div>
                    <div id="topHoldings">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div id="positions" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">All Positions</h3>
                        <div class="card-badge" id="positionsCount">0 positions</div>
                    </div>
                    <div id="allPositions">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Allocation Tab -->
            <div id="allocation" class="tab-content">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">By Asset Class</h3>
                        </div>
                        <div id="assetClassBreakdown">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Top Holdings by Value</h3>
                        </div>
                        <div id="holdingsByValue">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currencies Tab -->
            <div id="currencies" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Currency Exposure</h3>
                    </div>
                    <div id="currencyExposure">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <!-- Risk Tab (Essential Metrics Only) -->
            <div id="risk" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Risk Score (Bourse)</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="exportRiskPDF()" style="padding: 0.5rem 1rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üìÑ Export PDF
                            </button>
                            <button onclick="switchTab('analytics', event)" style="padding: 0.5rem 1rem; background: var(--theme-border); color: var(--theme-text); border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üî¨ Advanced Analytics ‚Üí
                            </button>
                        </div>
                    </div>
                    <div id="riskSummary"><div class="loading">Calcul en cours‚Ä¶</div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">M√©triques principales</h3></div>
                        <div id="riskMetrics" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">Concentration & Diversification</h3></div>
                        <div id="riskStructure" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Alerts Section (placeholder for critical warnings) -->
                <div class="dashboard-card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">‚ö†Ô∏è Critical Alerts</h3>
                        <div class="card-badge" id="alertsBadge">0 active</div>
                    </div>
                    <div id="criticalAlerts">
                        <div style="padding: 1.5rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚úÖ No critical alerts. Portfolio within safe thresholds.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab (Advanced Features) -->
            <div id="analytics" class="tab-content">
                <!-- ML Insights Section -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">ü§ñ ML Insights & Predictions</h3>
                        <div class="card-badge" id="mlBadge">Loading...</div>
                    </div>
                    <div id="mlInsights"><div class="loading">Chargement des pr√©dictions ML‚Ä¶</div></div>
                </div>

                <!-- Advanced Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üìä Advanced Analytics
                    </h2>

                    <!-- Correlation Heatmap -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üîó Correlation Matrix & Clustering</h3>
                            <div class="card-badge" id="correlationBadge">Portfolio-wide</div>
                        </div>
                        <div id="correlationAnalysis"><div class="loading">Loading correlation matrix‚Ä¶</div></div>
                    </div>

                    <!-- Stress Testing -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üí• Stress Testing Scenarios</h3>
                            <div class="card-badge" id="stressBadge">Interactive</div>
                        </div>
                        <div id="stressTestingUI"><div class="loading">Loading stress testing‚Ä¶</div></div>
                    </div>

                    <!-- ML Regime History -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">ü§ñ ML Regime History & Forecast</h3>
                            <div class="card-badge" id="regimeBadge">SPY Benchmark</div>
                        </div>
                        <div id="regimeHistory"><div class="loading">Loading ML regime history‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Specialized Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üéØ Specialized Analytics
                    </h2>

                    <!-- Sector Rotation -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üìä Sector Rotation Analysis</h3>
                            <div class="card-badge" id="sectorBadge">Portfolio-wide</div>
                        </div>
                        <div id="sectorRotation"><div class="loading">Loading sector rotation data‚Ä¶</div></div>
                    </div>

                    <!-- Margin Monitoring -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">‚ö†Ô∏è Margin Monitoring</h3>
                            <div class="card-badge" id="marginBadge">Portfolio-wide</div>
                        </div>
                        <div id="marginMonitoring"><div class="loading">Loading margin data‚Ä¶</div></div>
                    </div>

                    <!-- Ticker-Specific Analytics -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">üîç Ticker-Specific Analysis</h3>
                            <select id="tickerSelector" style="padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text); font-size: 0.875rem;">
                                <option value="">Select a ticker...</option>
                            </select>
                        </div>

                        <div id="tickerAnalytics" style="display: none;">
                            <!-- Beta Forecast -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìà Beta Forecast vs SPY</h4>
                                <div id="betaForecast"><div class="loading">Loading beta forecast‚Ä¶</div></div>
                            </div>

                            <!-- Earnings Predictor -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÖ Earnings Impact Prediction</h4>
                                <div id="earningsPredictor"><div class="loading">Loading earnings data‚Ä¶</div></div>
                            </div>

                            <!-- Dividend Analysis -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üí∞ Dividend Analysis</h4>
                                <div id="dividendAnalysis"><div class="loading">Loading dividend data‚Ä¶</div></div>
                            </div>
                        </div>

                        <div id="tickerPlaceholder" style="padding: 2rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            üëÜ Select a ticker above to view Beta Forecast, Earnings Predictor, and Dividend Analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPortfolioData = null;
        let currentWealthContext = {
            module: 'bourse'
        };
        let currentFileKey = null;  // Track selected Saxo file

        // Initialize wealth context integration
        function initWealthContextIntegration() {
            debugLogger.debug('üè¶ Initializing WealthContextBar integration for Saxo dashboard...');

            if (!window.wealthContextBar) {
                debugLogger.warn('WealthContextBar not available');
                return;
            }

            // Set initial context to bourse module only (preserve other context values)
            window.wealthContextBar.setContext(currentWealthContext);

            // Listen for context changes
            window.addEventListener('wealth:change', (event) => {
                debugLogger.debug('Wealth context changed in Saxo dashboard:', event.detail);
                currentWealthContext = { ...event.detail };

                // Update UI based on context changes
                updateContextualDisplay();
            });

            debugLogger.debug('‚úÖ WealthContextBar integrated for Saxo dashboard');
        }

        function updateContextualDisplay() {
            // Update currency display based on context
            if (currentPortfolioData && currentWealthContext.currency !== 'USD') {
                // Could implement currency conversion here
                debugLogger.debug(`Display currency preference: ${currentWealthContext.currency}`);
            }

            // Reset analytics tab loaded flag when source changes (force reload)
            analyticsTabLoaded = false;
        }

        // Refresh active tab content (called after data reload)
        function refreshActiveTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            debugLogger.debug(`üîÑ Refreshing active tab: ${tabId}`);

            // Reload data for the active tab
            if (currentPortfolioData) {
                switch (tabId) {
                    case 'overview':
                        loadOverviewData(currentPortfolioData);
                        break;
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'allocation':
                        loadAllocationDetails();
                        break;
                    case 'currencies':
                        loadCurrencyDetails();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                    case 'analytics':
                        loadAnalyticsTab();
                        break;
                }
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by data attribute or text content
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tab if needed
            if (currentPortfolioData) {
                switch (tabName) {
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'allocation':
                        loadAllocationDetails();
                        break;
                    case 'currencies':
                        loadCurrencyDetails();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                    case 'analytics':
                        loadAnalyticsTab();
                        break;
                }
            }
        }

        // Load Risk Tab (essential metrics only)
        async function loadRiskAnalytics() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('riskSummary').innerHTML = '<div class="loading">Calcul des m√©triques de risque‚Ä¶</div>';
                document.getElementById('riskMetrics').innerHTML = '<div class="loading">‚Ä¶</div>';
                document.getElementById('riskStructure').innerHTML = '<div class="loading">‚Ä¶</div>';

                // Build URL with file_key if available
                let riskUrl = `/api/risk/bourse/dashboard?user_id=${activeUser}`;
                if (currentFileKey) {
                    riskUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading risk with file_key: ${currentFileKey}`);
                }

                const response = await safeFetch(globalConfig.getApiUrl(riskUrl));
                if (!response?.ok) throw new Error('risk endpoint failed');

                const { risk, coverage, positions_count, total_value_usd } = response.data || response;
                const score = risk?.score ?? 0;
                const level = risk?.level ?? 'N/A';

                // Get risk level color
                const getRiskColor = (lvl) => {
                    const levelUpper = String(lvl).toUpperCase();
                    if (levelUpper === 'LOW' || levelUpper === 'VERY_LOW') return 'var(--success)';
                    if (levelUpper === 'MEDIUM' || levelUpper === 'MODERATE') return 'var(--warning)';
                    if (levelUpper === 'HIGH' || levelUpper === 'VERY_HIGH') return 'var(--danger)';
                    if (levelUpper === 'CRITICAL') return '#8B0000';
                    return 'var(--theme-text-muted)';
                };

                const riskColor = getRiskColor(level);

                // Risk Summary with enhanced UI
                document.getElementById('riskSummary').innerHTML = `
                  <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;">
                      <div class="metric-large" style="color:${riskColor}">${score.toFixed(0)}<span style="font-size:1rem;color:var(--theme-text-muted);">/100</span></div>
                      <div class="metric-label">Risk Score (higher = safer)</div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                      <div style="font-weight:600;font-size:1.25rem;color:${riskColor};margin-bottom:0.5rem;">${level}</div>
                      <div style="color:var(--theme-text-muted);font-size:0.875rem;">
                        ${positions_count || 0} positions ‚Ä¢ $${(total_value_usd || 0).toLocaleString()}
                      </div>
                      <div style="margin-top:0.5rem;color:var(--theme-text-muted);font-size:0.875rem;">
                        Coverage: ${(coverage*100).toFixed(0)}%
                      </div>
                    </div>
                  </div>`;

                const m = risk?.metrics || {};

                // Format percentage values (convert to %)
                const formatPct = (val) => ((val ?? 0) * 100).toFixed(2);

                // Key Metrics Table
                document.getElementById('riskMetrics').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td><strong>VaR (95%, 1d)</strong></td>
                        <td style="color:var(--danger)">${formatPct(m.var_95_1d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (30d)</strong></td>
                        <td>${formatPct(m.volatility_30d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (252d)</strong></td>
                        <td>${formatPct(m.volatility_252d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Max Drawdown</strong></td>
                        <td style="color:var(--danger)">${formatPct(m.max_drawdown)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Sharpe Ratio</strong></td>
                        <td style="color:${(m.sharpe_ratio??0) > 1 ? 'var(--success)' : 'var(--theme-text)'}">${(m.sharpe_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Sortino Ratio</strong></td>
                        <td>${(m.sortino_ratio??0).toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>`;

                // Additional Metrics
                document.getElementById('riskStructure').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td><strong>Beta (Portfolio)</strong></td>
                        <td>${(m.beta_portfolio??1.0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Calmar Ratio</strong></td>
                        <td>${(m.calmar_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (90d)</strong></td>
                        <td>${formatPct(m.volatility_90d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>VaR Method</strong></td>
                        <td style="text-transform:capitalize;">${m.var_method || 'historical'}</td>
                      </tr>
                      <tr>
                        <td><strong>Drawdown Days</strong></td>
                        <td>${m.drawdown_days ?? 'N/A'}</td>
                      </tr>
                    </tbody>
                  </table>`;

            } catch (e) {
                debugLogger.error('Risk analytics load failed', e);
                document.getElementById('riskSummary').innerHTML = `
                  <div class="error-message">
                    <strong>Erreur de chargement</strong><br>
                    ${e.message}<br>
                    <small style="opacity:0.8;">V√©rifiez que yfinance est install√© et que les donn√©es sont disponibles.</small>
                  </div>`;
                document.getElementById('riskMetrics').innerHTML = '';
                document.getElementById('riskStructure').innerHTML = '';
            }

            // Load alerts in parallel (non-blocking)
            loadCriticalAlerts().catch(err => {
                debugLogger.warn('Alerts loading failed (non-blocking)', err);
            });
        }

        // Load Critical Alerts (async, non-blocking)
        async function loadCriticalAlerts() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Build URL with file_key if available
                let alertsUrl = `/api/risk/bourse/alerts?user_id=${activeUser}`;
                if (currentFileKey) {
                    alertsUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(alertsUrl));
                if (!response?.ok) {
                    throw new Error('Alerts endpoint failed');
                }

                const data = response.data || response;
                const { critical, warnings, info, summary } = data;

                // Update badge
                const totalAlerts = summary?.total || 0;
                const badge = document.getElementById('alertsBadge');
                if (totalAlerts === 0) {
                    badge.textContent = '0 active';
                    badge.style.background = 'var(--success)';
                    badge.style.color = 'white';
                } else if (summary?.critical > 0) {
                    badge.textContent = `${summary.critical} critical`;
                    badge.style.background = 'var(--danger)';
                    badge.style.color = 'white';
                } else if (summary?.warning > 0) {
                    badge.textContent = `${summary.warning} warning`;
                    badge.style.background = 'var(--warning)';
                    badge.style.color = 'white';
                } else {
                    badge.textContent = `${summary?.info || 0} info`;
                    badge.style.background = 'var(--info)';
                    badge.style.color = 'white';
                }

                // Build HTML
                let html = '';

                // Critical alerts
                if (critical && critical.length > 0) {
                    critical.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-critical" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    üî¥ ${alert.title}
                                    <span class="alert-badge badge-critical">CRITICAL</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Valeur:</strong> ${alert.value}
                                    <span style="color: var(--theme-text-muted);">(seuil: ${alert.threshold})</span>
                                </div>
                                <div class="alert-impact">
                                    <strong>Impact:</strong> ${alert.impact}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Recommandation:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    ‚è∞ Action requise: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // Warning alerts
                if (warnings && warnings.length > 0) {
                    warnings.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-warning" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    ‚ö†Ô∏è ${alert.title}
                                    <span class="alert-badge badge-warning">WARNING</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Valeur:</strong> ${alert.value}
                                    <span style="color: var(--theme-text-muted);">(seuil: ${alert.threshold})</span>
                                </div>
                                <div class="alert-impact">
                                    <strong>Impact:</strong> ${alert.impact || alert.details || 'Surveillance recommand√©e'}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Recommandation:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    ‚è∞ Action sugg√©r√©e: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // Info alerts
                if (info && info.length > 0) {
                    info.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-info" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    ‚ÑπÔ∏è ${alert.title}
                                    <span class="alert-badge badge-info">INFO</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Contexte:</strong> ${alert.value || alert.impact}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Opportunit√©:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    üìÖ Horizon: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // If no alerts, show success message
                if (totalAlerts === 0) {
                    html = `
                        <div class="alert-empty">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">
                                Portfolio Sain
                            </div>
                            <div style="font-size: 0.875rem;">
                                Aucune alerte d√©tect√©e. Toutes les m√©triques sont dans les zones s√ªres.
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 1rem; opacity: 0.7;">
                                Calibr√© pour profil mod√©r√© ‚Ä¢ Gestion active hebdomadaire
                            </div>
                        </div>
                    `;
                }

                document.getElementById('criticalAlerts').innerHTML = html;

            } catch (e) {
                debugLogger.error('Critical alerts load failed', e);
                document.getElementById('criticalAlerts').innerHTML = `
                    <div class="alert-empty" style="color: var(--danger);">
                        ‚ö†Ô∏è Erreur de chargement des alertes<br>
                        <small>${e.message}</small>
                    </div>
                `;
                document.getElementById('alertsBadge').textContent = 'Error';
                document.getElementById('alertsBadge').style.background = 'var(--danger)';
            }
        }

        // Acknowledge Alert Function
        async function acknowledgeAlert(alertId, buttonElement) {
            if (!alertId) {
                console.error('No alert ID provided');
                return;
            }

            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Update button state immediately (optimistic UI)
                buttonElement.textContent = 'En cours...';
                buttonElement.disabled = true;

                // Call acknowledge endpoint
                const acknowledgeUrl = `/api/risk/bourse/alerts/${alertId}/acknowledge?user_id=${activeUser}`;
                const response = await safeFetch(globalConfig.getApiUrl(acknowledgeUrl), {
                    method: 'POST'
                });

                if (!response?.ok) {
                    throw new Error('Acknowledge failed');
                }

                // Update button to acknowledged state
                buttonElement.classList.add('acknowledged');
                buttonElement.textContent = '‚úì Alerte vue';

                // Remove alert from DOM after short delay
                setTimeout(() => {
                    const alertCard = buttonElement.closest('.alert');
                    if (alertCard) {
                        alertCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        alertCard.style.opacity = '0';
                        alertCard.style.transform = 'scale(0.95)';

                        setTimeout(() => {
                            alertCard.remove();

                            // Update badge count
                            const remainingAlerts = document.querySelectorAll('.alert:not(.alert-empty)').length;
                            const badge = document.getElementById('alertsBadge');
                            if (remainingAlerts === 0) {
                                badge.textContent = '0 active';
                                badge.style.background = 'var(--success)';
                                badge.style.color = 'white';

                                // Show success message
                                document.getElementById('criticalAlerts').innerHTML = `
                                    <div class="alert-empty">
                                        <div style="font-size: 2.5rem;">‚úÖ</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; margin: 1rem 0;">Portfolio Sain</div>
                                        <p style="max-width: 600px; margin: 0 auto; line-height: 1.6;">
                                            Aucune alerte active pour votre profil mod√©r√© (moyen-long terme, gestion active hebdomadaire).
                                        </p>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                }, 500);

                debugLogger.info(`Alert ${alertId} acknowledged successfully`);

            } catch (e) {
                debugLogger.error('Failed to acknowledge alert', e);

                // Restore button state on error
                buttonElement.textContent = 'Erreur - R√©essayer';
                buttonElement.disabled = false;
                buttonElement.style.background = 'var(--danger)';
                buttonElement.style.color = 'white';

                // Reset after 2 seconds
                setTimeout(() => {
                    buttonElement.textContent = 'Marquer comme vu';
                    buttonElement.style.background = '';
                    buttonElement.style.color = '';
                }, 2000);
            }
        }

        // Track if analytics tab has been loaded (for lazy loading)
        let analyticsTabLoaded = false;

        // Load Analytics Tab (ML + Advanced + Specialized)
        async function loadAnalyticsTab() {
            // Lazy loading - only load once
            if (analyticsTabLoaded) {
                debugLogger.debug('Analytics tab already loaded, skipping...');
                return;
            }

            debugLogger.debug('Loading Analytics tab for the first time...');
            analyticsTabLoaded = true;

            // Load all analytics sections in parallel
            Promise.all([
                loadMLInsights().catch(err => {
                    debugLogger.warn('ML insights loading failed (non-blocking)', err);
                }),
                loadAdvancedAnalytics().catch(err => {
                    debugLogger.warn('Advanced analytics loading failed (non-blocking)', err);
                }),
                loadSpecializedAnalytics().catch(err => {
                    debugLogger.warn('Specialized analytics loading failed (non-blocking)', err);
                })
            ]);
        }

        // Load ML Insights & Predictions (async, non-blocking)
        async function loadMLInsights() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                document.getElementById('mlBadge').textContent = 'Analyzing...';

                // Get top 3 stocks from portfolio for predictions
                const topStocks = currentPortfolioData?.summary?.top_holdings?.slice(0, 3) || [];
                if (topStocks.length === 0) {
                    document.getElementById('mlInsights').innerHTML = '<div class="no-data">Aucune position disponible pour ML</div>';
                    document.getElementById('mlBadge').textContent = 'No data';
                    return;
                }

                const benchmark = 'SPY'; // S&P500 as default benchmark
                const firstStock = topStocks[0]?.symbol || 'AAPL';

                // Fetch ML predictions in parallel (direct URLs, no globalConfig params)
                // Use 20 years (7300 days) for regime to capture 4-5 full market cycles (dot-com, 2008, COVID, 2022)
                const baseUrl = window.location.origin;
                const [regimeRes, volatilityRes] = await Promise.all([
                    safeFetch(`${baseUrl}/api/ml/bourse/regime?benchmark=${benchmark}&lookback_days=7300`),
                    safeFetch(`${baseUrl}/api/ml/bourse/forecast?symbol=${firstStock}&lookback_days=365`)
                ]);

                const regime = regimeRes?.data || regimeRes || {};
                const volatility = volatilityRes?.data || volatilityRes || {};

                // Get regime color
                const getRegimeColor = (reg) => {
                    const r = String(reg).toLowerCase();
                    if (r.includes('bull')) return 'var(--success)';
                    if (r.includes('bear')) return 'var(--danger)';
                    if (r.includes('consolidation')) return 'var(--warning)';
                    return 'var(--info)';
                };

                const regimeColor = getRegimeColor(regime.current_regime);
                const regimeConfidence = ((regime.confidence || 0) * 100).toFixed(0);

                // Extract volatility predictions
                const vol1d = volatility.predictions?.['1d']?.predicted_volatility;
                const vol7d = volatility.predictions?.['7d']?.predicted_volatility;
                const vol30d = volatility.predictions?.['30d']?.predicted_volatility;

                // Build ML Insights HTML
                document.getElementById('mlInsights').innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:1.5rem;">
                        <!-- Market Regime -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Market Regime</div>
                            <div style="font-size:1.25rem;font-weight:700;color:${regimeColor};margin-bottom:0.25rem;">
                                ${regime.current_regime || 'Unknown'}
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);">
                                Confidence: ${regimeConfidence}% ‚Ä¢ ${regime.benchmark || benchmark}
                            </div>
                        </div>

                        <!-- Volatility Forecast -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Volatility Forecast (${firstStock})</div>
                            <div style="display:flex;gap:1rem;align-items:baseline;">
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">1d</div>
                                    <div style="font-weight:600;">${vol1d ? (vol1d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">7d</div>
                                    <div style="font-weight:600;">${vol7d ? (vol7d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">30d</div>
                                    <div style="font-weight:600;">${vol30d ? (vol30d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);margin-top:0.5rem;">
                                Model: ${volatility.model_type || 'Historical'}
                            </div>
                        </div>

                        <!-- Regime Characteristics -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Regime Characteristics</div>
                            ${Object.entries(regime.characteristics || {})
                                .map(([key, value]) => `
                                    <div style="display:flex;justify-content:space-between;margin:0.25rem 0;">
                                        <span style="font-size:0.8rem;text-transform:capitalize;">${key}:</span>
                                        <span style="font-size:0.8rem;font-weight:600;color:var(--theme-text);">${value}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>

                    <!-- Additional Regime Probabilities -->
                    ${Object.keys(regime.regime_probabilities || {}).length > 0 ? `
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.75rem;">Regime Probabilities</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;">
                                ${Object.entries(regime.regime_probabilities || {})
                                    .sort(([,a], [,b]) => b - a)
                                    .map(([regimeName, prob]) => `
                                        <div style="text-align:center;">
                                            <div style="font-weight:700;font-size:1.1rem;color:${getRegimeColor(regimeName)};">
                                                ${(prob * 100).toFixed(0)}%
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--theme-text-muted);margin-top:0.25rem;">
                                                ${regimeName}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top:1rem;padding:0.75rem;background:var(--info-bg);border-radius:var(--radius-sm);border:1px solid var(--info);font-size:0.875rem;color:var(--info);">
                        <strong>Note:</strong> ML predictions are based on ${volatility.lookback_days || 365} days of historical data.
                        ${volatility.note || regime.note ? `<br><em>${volatility.note || regime.note}</em>` : ''}
                    </div>
                `;

                document.getElementById('mlBadge').textContent = `${regime.model_type || 'ML'} Active`;
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--success) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--success)';

            } catch (error) {
                debugLogger.error('ML insights load failed', error);
                document.getElementById('mlInsights').innerHTML = `
                    <div style="padding:1rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius-md);">
                        <div style="color:var(--warning);margin-bottom:0.5rem;"><strong>‚ö†Ô∏è ML Predictions Unavailable</strong></div>
                        <div style="font-size:0.875rem;color:var(--theme-text-muted);">
                            ${error.message || 'Failed to load ML predictions'}
                            <br><small>Models may need training or data may be insufficient.</small>
                        </div>
                    </div>
                `;
                document.getElementById('mlBadge').textContent = 'Fallback';
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--warning) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--warning)';
            }
        }

        // ==================== ADVANCED ANALYTICS ====================

        // Load all advanced analytics (called from loadRiskAnalytics)
        async function loadAdvancedAnalytics() {
            // Load advanced analytics in parallel
            await Promise.all([
                loadCorrelationAnalysis().catch(err => debugLogger.warn('Correlation analysis failed', err)),
                loadStressTestingUI().catch(err => debugLogger.warn('Stress testing failed', err)),
                loadRegimeHistory().catch(err => debugLogger.warn('Regime history failed', err))
            ]);
        }

        // Load Correlation Matrix & Heatmap
        async function loadCorrelationAnalysis() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('correlationAnalysis').innerHTML = '<div class="loading">Calculating correlations‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/correlation?user_id=${activeUser}&method=pearson&lookback_days=252`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Correlation analysis failed');

                const data = response.data || response;

                // Create Plotly heatmap
                const corrMatrix = data.correlation_matrix || {};
                const labels = data.clustering?.labels || Object.keys(corrMatrix);

                // Convert corrMatrix object to 2D array for Plotly
                const corrArray = labels.map(row =>
                    labels.map(col => corrMatrix[row]?.[col] || 0)
                );

                const heatmapDiv = 'correlationHeatmap';
                const dendrogramDiv = 'correlationDendrogram';
                document.getElementById('correlationAnalysis').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <span style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_positions} positions analyzed ‚Ä¢ Avg correlation: ${(data.avg_correlation || 0).toFixed(3)}
                        </span>
                    </div>

                    <!-- Correlation Heatmap -->
                    <div id="${heatmapDiv}" style="width: 100%; height: 600px;"></div>

                    <!-- Clustering Dendrogram -->
                    <div style="margin-top: 2rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üå≥ Hierarchical Clustering Dendrogram
                        </h4>
                        <div id="${dendrogramDiv}" style="width: 100%; height: 400px;"></div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Dendrogram shows hierarchical grouping of positions based on correlation similarity (Ward linkage)
                        </div>
                    </div>

                    ${data.max_pair ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.875rem;">
                            <strong>Max correlation:</strong> ${data.max_pair.pair.join(' & ')} (${data.max_pair.correlation.toFixed(3)})<br>
                            <strong>Min correlation:</strong> ${data.min_pair.pair.join(' & ')} (${data.min_pair.correlation.toFixed(3)})
                        </div>
                    ` : ''}
                `;

                // Plot heatmap with Plotly
                const heatmapTrace = {
                    z: corrArray,
                    x: labels,
                    y: labels,
                    type: 'heatmap',
                    colorscale: [
                        [0, '#ef4444'],      // Red (negative correlation)
                        [0.5, '#f3f4f6'],    // Gray (no correlation)
                        [1, '#22c55e']       // Green (positive correlation)
                    ],
                    zmid: 0,
                    colorbar: {
                        title: 'Correlation',
                        titleside: 'right'
                    },
                    hovertemplate: '%{y} & %{x}<br>Correlation: %{z:.3f}<extra></extra>'
                };

                const layout = {
                    title: 'üîó Position Correlation Heatmap',
                    xaxis: { title: '', tickangle: -45 },
                    yaxis: { title: '' },
                    width: null,
                    height: 600,
                    margin: { l: 100, r: 50, t: 100, b: 100 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot(heatmapDiv, [heatmapTrace], layout, { responsive: true, displayModeBar: false });

                // Create dendrogram if linkage matrix available
                const linkageMatrix = data.clustering?.linkage_matrix || [];
                if (linkageMatrix && linkageMatrix.length > 0) {
                    createDendrogram(dendrogramDiv, linkageMatrix, labels);
                }

                document.getElementById('correlationBadge').textContent = `${labels.length} positions`;

            } catch (error) {
                debugLogger.error('Correlation analysis failed', error);
                document.getElementById('correlationAnalysis').innerHTML = `
                    <div class="error-message">Failed to load correlation matrix: ${error.message}</div>
                `;
            }
        }

        // Create Dendrogram using Plotly
        function createDendrogram(divId, linkageMatrix, labels) {
            try {
                // Plotly requires dendrogram data in specific format
                // linkageMatrix from scipy: [[idx1, idx2, distance, count], ...]

                // Simple dendrogram visualization using scatter plot
                // (Full dendrogram requires complex transformation, so we use simplified visualization)

                // Create hierarchical tree structure visualization
                const n = labels.length;
                const traces = [];

                // Draw horizontal lines connecting clusters
                linkageMatrix.forEach((link, i) => {
                    const [idx1, idx2, distance, count] = link;
                    const y1 = idx1 < n ? idx1 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx1 - n]));
                    const y2 = idx2 < n ? idx2 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx2 - n]));

                    // Horizontal line
                    traces.push({
                        x: [distance, distance],
                        y: [y1, y2],
                        mode: 'lines',
                        line: { color: '#64748b', width: 2 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });

                    // Vertical connectors
                    if (idx1 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y1, y1],
                            mode: 'lines',
                            line: { color: '#64748b', width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                    if (idx2 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y2, y2],
                            mode: 'lines',
                            line: { color: '#64748b', width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                });

                // Add leaf labels
                const leafTrace = {
                    x: Array(n).fill(0),
                    y: Array.from({length: n}, (_, i) => i),
                    mode: 'markers+text',
                    marker: { size: 8, color: '#3b82f6' },
                    text: labels,
                    textposition: 'middle left',
                    textfont: { size: 10 },
                    showlegend: false,
                    hovertemplate: '%{text}<extra></extra>'
                };
                traces.push(leafTrace);

                const layout = {
                    title: '',
                    showlegend: false,
                    xaxis: {
                        title: 'Distance (Correlation Dissimilarity)',
                        zeroline: false,
                        showgrid: true,
                        gridcolor: 'rgba(100, 116, 139, 0.1)'
                    },
                    yaxis: {
                        title: '',
                        showticklabels: false,
                        zeroline: false,
                        showgrid: false
                    },
                    width: null,
                    height: 400,
                    margin: { l: 120, r: 50, t: 50, b: 60 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot(divId, traces, layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                debugLogger.error('Failed to create dendrogram', error);
                document.getElementById(divId).innerHTML = `
                    <div class="error-message" style="padding: 1rem;">Dendrogram visualization unavailable</div>
                `;
            }
        }

        // Load Stress Testing UI with sliders
        async function loadStressTestingUI() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestingUI').innerHTML = `
                    <!-- Predefined Scenarios -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìã Generic Scenarios</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                            <button onclick="runStressTest('market_crash')" style="padding: 0.75rem; border: 1px solid var(--danger); background: color-mix(in oklab, var(--danger) 10%, transparent); color: var(--danger); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìâ Market Crash (-10%)
                            </button>
                            <button onclick="runStressTest('market_rally')" style="padding: 0.75rem; border: 1px solid var(--success); background: color-mix(in oklab, var(--success) 10%, transparent); color: var(--success); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìà Market Rally (+10%)
                            </button>
                            <button onclick="runStressTest('moderate_selloff')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                ‚ö†Ô∏è Moderate Selloff (-5%)
                            </button>
                            <button onclick="runStressTest('rate_hike')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìä Rate Hike (-3%)
                            </button>
                        </div>
                    </div>

                    <!-- Historical Crisis Scenarios -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìú Historical Crisis Scenarios</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
                            <button onclick="runStressTest('covid_crash')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">ü¶† COVID-19 (2020)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-34% S&P 500</div>
                            </button>
                            <button onclick="runStressTest('financial_crisis_2008')" style="padding: 0.75rem; border: 1px solid #8B0000; background: color-mix(in oklab, #8B0000 10%, transparent); color: #8B0000; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üè¶ Financial Crisis (2008)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-57% peak-to-trough</div>
                            </button>
                            <button onclick="runStressTest('dotcom_bubble')" style="padding: 0.75rem; border: 1px solid #4B0082; background: color-mix(in oklab, #4B0082 10%, transparent); color: #4B0082; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üíª Dot-com Bubble (2000)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-78% NASDAQ</div>
                            </button>
                            <button onclick="runStressTest('black_monday_1987')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üìâ Black Monday (1987)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-22% in 1 day</div>
                            </button>
                            <button onclick="runStressTest('flash_crash_2010')" style="padding: 0.75rem; border: 1px solid #FF6347; background: color-mix(in oklab, #FF6347 10%, transparent); color: #FF6347; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">‚ö° Flash Crash (2010)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-9% in minutes</div>
                            </button>
                            <button onclick="runStressTest('brexit_2016')" style="padding: 0.75rem; border: 1px solid #FF8C00; background: color-mix(in oklab, #FF8C00 10%, transparent); color: #FF8C00; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üá¨üáß Brexit (2016)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-12% FTSE</div>
                            </button>
                        </div>
                    </div>

                    <!-- Custom Scenario -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üéöÔ∏è Custom Scenario</h4>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <label style="flex: 0 0 120px; font-weight: 600;">Market Impact:</label>
                            <input type="range" id="customStressSlider" min="-30" max="30" value="0" step="1" style="flex: 1;">
                            <span id="customStressValue" style="flex: 0 0 80px; font-weight: 700; font-size: 1.25rem;">0%</span>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button onclick="runCustomStressTest()" style="padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üß™ Run Custom Test
                            </button>
                            <button id="saveScenarioBtn" onclick="saveCurrentScenario()" style="padding: 0.75rem 1.5rem; background: var(--success); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; display: none;">
                                üíæ Save Scenario
                            </button>
                        </div>
                    </div>

                    <!-- Saved Scenarios -->
                    <div id="savedScenariosSection" style="margin-bottom: 1.5rem; display: none;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÅ Saved Scenarios</h4>
                        <div id="savedScenariosList" style="display: flex; flex-wrap: wrap; gap: 0.75rem;"></div>
                    </div>

                    <!-- Results -->
                    <div id="stressTestResults" style="display: none;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìä Stress Test Results</h4>
                        <div id="stressTestChart" style="width: 100%; height: 300px; margin-bottom: 1rem;"></div>
                        <div id="stressTestMetrics"></div>
                    </div>
                `;

                // Update slider value display
                document.getElementById('customStressSlider').addEventListener('input', function(e) {
                    const val = e.target.value;
                    document.getElementById('customStressValue').textContent = (val >= 0 ? '+' : '') + val + '%';
                });

                // Load saved scenarios
                loadSavedScenarios();

            } catch (error) {
                debugLogger.error('Stress testing UI failed', error);
                document.getElementById('stressTestingUI').innerHTML = `
                    <div class="error-message">Failed to load stress testing: ${error.message}</div>
                `;
            }
        }

        // Run stress test with predefined scenario
        async function runStressTest(scenario) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=${scenario}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Stress test failed');

                const data = response.data || response;

                displayStressTestResults(data);

            } catch (error) {
                debugLogger.error('Stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `
                    <div class="error-message">Stress test failed: ${error.message}</div>
                `;
            }
        }

        // Run custom stress test
        async function runCustomStressTest() {
            const impactPct = parseFloat(document.getElementById('customStressSlider').value) / 100;
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running custom stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=custom&market_shock=${impactPct}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Custom stress test failed');

                const data = response.data || response;

                displayStressTestResults(data);

            } catch (error) {
                debugLogger.error('Custom stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `
                    <div class="error-message">Custom stress test failed: ${error.message}</div>
                `;
            }
        }

        // Display stress test results
        function displayStressTestResults(data) {
            // Fix: Use pnl_pct instead of impact_pct
            const pnlPct = data.pnl_pct || 0;
            const totalPnl = data.total_pnl || 0;
            const valueBefore = data.total_value_before || 0;
            const valueAfter = data.total_value_after || 0;

            const pnlColor = pnlPct >= 0 ? 'var(--success)' : 'var(--danger)';

            document.getElementById('stressTestMetrics').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Scenario</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${data.scenario}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Total P&L</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: ${pnlColor};">
                            ${pnlPct >= 0 ? '+' : ''}$${totalPnl.toLocaleString('en-US', {maximumFractionDigits: 0})}
                            (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                        </div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Portfolio Value</div>
                        <div style="font-size: 1rem; font-weight: 600;">
                            $${valueBefore.toLocaleString()} ‚Üí $${valueAfter.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            // Create Chart.js impact chart
            const ctx = document.createElement('canvas');
            document.getElementById('stressTestChart').innerHTML = '';
            document.getElementById('stressTestChart').appendChild(ctx);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current', 'Stressed'],
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: [valueBefore, valueAfter],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Stress Test Impact: ${data.scenario}`,
                            font: { size: 14, weight: '600' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Portfolio Value ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Show save button only for custom scenarios
            const saveBtn = document.getElementById('saveScenarioBtn');
            if (saveBtn && data.scenario === 'custom') {
                saveBtn.style.display = 'inline-block';
                // Store current scenario data for saving (normalize field names)
                window.currentStressTestData = {
                    ...data,
                    impact_pct: pnlPct  // Add for backwards compatibility with saveCurrentScenario
                };
            } else if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        }

        // ==================== SAVED SCENARIOS MANAGEMENT ====================

        // Load saved scenarios from localStorage
        function loadSavedScenarios() {
            try {
                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                const listDiv = document.getElementById('savedScenariosList');
                const sectionDiv = document.getElementById('savedScenariosSection');

                if (scenarios.length === 0) {
                    sectionDiv.style.display = 'none';
                    return;
                }

                sectionDiv.style.display = 'block';
                listDiv.innerHTML = scenarios.map((scenario, idx) => {
                    const color = scenario.impact >= 0 ? 'var(--success)' : 'var(--danger)';
                    return `
                        <div style="padding: 0.75rem; border: 1px solid ${color}; background: color-mix(in oklab, ${color} 5%, transparent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; min-width: 200px;">
                            <div onclick="loadSavedScenario(${idx})" style="cursor: pointer; flex: 1;">
                                <div style="font-weight: 600; color: ${color};">${scenario.name}</div>
                                <div style="font-size: 0.8rem; color: var(--theme-text-muted);">${scenario.impact >= 0 ? '+' : ''}${scenario.impact}%</div>
                            </div>
                            <button onclick="deleteSavedScenario(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.25rem; padding: 0.25rem;">
                                √ó
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                debugLogger.error('Failed to load saved scenarios', error);
            }
        }

        // Save current scenario
        function saveCurrentScenario() {
            try {
                const data = window.currentStressTestData;
                if (!data) {
                    alert('No stress test results to save');
                    return;
                }

                const name = prompt('Enter a name for this scenario:', `Custom ${data.impact_pct.toFixed(1)}%`);
                if (!name) return;

                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                scenarios.push({
                    name: name,
                    impact: parseFloat(data.impact_pct.toFixed(2)),
                    timestamp: new Date().toISOString()
                });

                localStorage.setItem('savedStressScenarios', JSON.stringify(scenarios));
                loadSavedScenarios();

                // Hide save button after saving
                document.getElementById('saveScenarioBtn').style.display = 'none';

                debugLogger.info('Scenario saved', { name, impact: data.impact_pct });

            } catch (error) {
                debugLogger.error('Failed to save scenario', error);
                alert('Failed to save scenario: ' + error.message);
            }
        }

        // Load a saved scenario
        async function loadSavedScenario(index) {
            try {
                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                const scenario = scenarios[index];
                if (!scenario) return;

                // Set slider to saved value
                const slider = document.getElementById('customStressSlider');
                if (slider) {
                    slider.value = scenario.impact;
                    document.getElementById('customStressValue').textContent =
                        (scenario.impact >= 0 ? '+' : '') + scenario.impact + '%';
                }

                // Run the test
                await runCustomStressTest();

            } catch (error) {
                debugLogger.error('Failed to load saved scenario', error);
                alert('Failed to load scenario: ' + error.message);
            }
        }

        // Delete a saved scenario
        function deleteSavedScenario(index) {
            try {
                if (!confirm('Delete this saved scenario?')) return;

                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                scenarios.splice(index, 1);
                localStorage.setItem('savedStressScenarios', JSON.stringify(scenarios));
                loadSavedScenarios();

                debugLogger.info('Scenario deleted', { index });

            } catch (error) {
                debugLogger.error('Failed to delete scenario', error);
                alert('Failed to delete scenario: ' + error.message);
            }
        }

        // Load ML Regime History Chart
        async function loadRegimeHistory() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Fetch current regime (20 years for 4-5 full market cycles: dot-com, 2008, COVID, 2022)
                const regimeUrl = `/api/ml/bourse/regime?user_id=${activeUser}&benchmark=SPY&lookback_days=7300`;
                const regimeResponse = await safeFetch(globalConfig.getApiUrl(regimeUrl));
                if (!regimeResponse?.ok) throw new Error('Regime detection failed');

                const regimeData = regimeResponse.data || regimeResponse;

                // Detect absurd probabilities (one regime at 100%, others at 0%)
                const probabilities = regimeData.regime_probabilities || {};
                const probValues = Object.values(probabilities);
                const hasAbsurdProbs = probValues.some(p => p === 1.0) && probValues.filter(p => p === 0).length >= 3;

                // Fallback message if model is overconfident
                const fallbackWarning = hasAbsurdProbs ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--warning-bg); border: 1px solid var(--warning); border-radius: var(--radius-md);">
                        <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Model Confidence Issue Detected</div>
                        <div style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            Le mod√®le ML affiche une confiance anormale (100%). Cela indique un probl√®me de calibration.
                            Le mod√®le sera r√©entra√Æn√© automatiquement au prochain appel.<br>
                            <strong>Note:</strong> ${regimeData.note || regimeData.model_type === 'moving_average_fallback' ? 'Utilisation du fallback MA-based pour le moment.' : 'Les probabilit√©s peuvent √™tre peu fiables.'}
                        </div>
                    </div>
                ` : '';

                // Create regime history visualization
                document.getElementById('regimeHistory').innerHTML = `
                    ${fallbackWarning}
                    <!-- Current Regime Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Regime</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${getRegimeColor(regimeData.current_regime)};">
                                ${getRegimeEmoji(regimeData.current_regime)} ${regimeData.current_regime}
                            </div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Confidence</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(regimeData.confidence * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Benchmark</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${regimeData.benchmark}</div>
                        </div>
                    </div>

                    <!-- Regime Probabilities Chart -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üìä Regime Probabilities
                        </h4>
                        <canvas id="regimeProbabilitiesChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Regime Timeline (Simulated) -->
                    <div>
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üìà Market Timeline with SPY Price
                        </h4>
                        <canvas id="regimeTimelineChart" style="max-height: 300px;"></canvas>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Timeline shows simulated regime transitions over last 12 months with SPY price overlay
                        </div>
                    </div>
                `;

                // Create Regime Probabilities Bar Chart
                createRegimeProbabilitiesChart(regimeData.regime_probabilities);

                // Create Regime Timeline with Price Overlay
                await createRegimeTimelineChart(regimeData);

                document.getElementById('regimeBadge').textContent = `${regimeData.benchmark} ‚Ä¢ ${regimeData.current_regime}`;

            } catch (error) {
                debugLogger.error('Failed to load regime history', error);
                document.getElementById('regimeHistory').innerHTML = `
                    <div class="error-message">Failed to load ML regime history: ${error.message}</div>
                `;
            }
        }

        // Helper: Get regime color
        function getRegimeColor(regime) {
            const colors = {
                'Bull Market': '#22c55e',
                'Bear Market': '#ef4444',
                'Consolidation': '#94a3b8',
                'Distribution': '#f59e0b'
            };
            return colors[regime] || '#64748b';
        }

        // Helper: Get regime emoji
        function getRegimeEmoji(regime) {
            const emojis = {
                'Bull Market': 'üêÇ',
                'Bear Market': 'üêª',
                'Consolidation': '‚ÜîÔ∏è',
                'Distribution': 'üìä'
            };
            return emojis[regime] || '‚ùì';
        }

        // Create Regime Probabilities Bar Chart
        function createRegimeProbabilitiesChart(probabilities) {
            const ctx = document.getElementById('regimeProbabilitiesChart');
            if (!ctx) return;

            const regimes = Object.keys(probabilities);
            const values = Object.values(probabilities);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: regimes,
                    datasets: [{
                        label: 'Probability',
                        data: values,
                        backgroundColor: regimes.map(r => getRegimeColor(r) + '80'),
                        borderColor: regimes.map(r => getRegimeColor(r)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Probability: ${(context.parsed.x * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            title: { display: true, text: 'Probability' }
                        },
                        y: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // Create Regime Timeline with SPY Price Overlay
        async function createRegimeTimelineChart(regimeData) {
            const ctx = document.getElementById('regimeTimelineChart');
            if (!ctx) return;

            // Generate simulated historical data (last 12 months)
            const now = new Date();
            const labels = [];
            const prices = [];
            const regimeColors = [];

            // Simulate SPY price movement (roughly $400-460 range over 12 months)
            const basePrice = 400;
            const currentRegime = regimeData.current_regime;

            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(now);
                monthDate.setMonth(now.getMonth() - (11 - i));
                labels.push(monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));

                // Simulate price trend based on regime
                let price = basePrice + (i * 5); // Base uptrend
                if (currentRegime === 'Bull Market') {
                    price += Math.random() * 20;
                } else if (currentRegime === 'Bear Market') {
                    price -= Math.random() * 15;
                } else {
                    price += (Math.random() - 0.5) * 10;
                }
                prices.push(price);

                // Simulate regime transitions (mostly current regime)
                if (i < 4) {
                    regimeColors.push(getRegimeColor('Consolidation'));
                } else if (i < 8) {
                    regimeColors.push(getRegimeColor('Bull Market'));
                } else {
                    regimeColors.push(getRegimeColor(currentRegime));
                }
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'SPY Price',
                        data: prices,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: regimeColors,
                        pointBorderColor: regimeColors,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `SPY: $${context.parsed.y.toFixed(2)}`;
                                },
                                afterLabel: function(context) {
                                    // Show regime color meaning
                                    return 'Colored dots indicate regime transitions';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                // COVID crash annotation
                                covid: {
                                    type: 'line',
                                    xMin: 2,
                                    xMax: 2,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: 'üìâ Market Event',
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'SPY Price ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Time Period' }
                        }
                    }
                }
            });
        }

        // ==================== SPECIALIZED ANALYTICS ====================

        // Load all specialized analytics (called from loadRiskAnalytics)
        async function loadSpecializedAnalytics() {
            // Load portfolio-wide analytics
            await Promise.all([
                loadSectorRotation().catch(err => debugLogger.warn('Sector rotation failed', err)),
                loadMarginMonitoring().catch(err => debugLogger.warn('Margin monitoring failed', err))
            ]);

            // Populate ticker selector
            populateTickerSelector();
        }

        // Load Sector Rotation Analysis
        async function loadSectorRotation() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('sectorRotation').innerHTML = '<div class="loading">Analyzing sectors‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/sector-rotation?user_id=${activeUser}&lookback_days=60`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Sector rotation failed');

                const data = response.data || response;
                const sectors = data.sectors || {};
                const hotSectors = data.hot_sectors || [];
                const coldSectors = data.cold_sectors || [];

                // Sort sectors by momentum
                const sortedSectors = Object.entries(sectors)
                    .sort((a, b) => (b[1].momentum || 0) - (a[1].momentum || 0));

                document.getElementById('sectorRotation').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); background: color-mix(in oklab, var(--${data.rotation_detected ? 'warning' : 'info'}) 10%, transparent); color: var(--${data.rotation_detected ? 'warning' : 'info'}); font-size: 0.75rem; font-weight: 600;">
                            ${data.rotation_detected ? 'üîÑ Rotation Detected' : 'üìä No Rotation'}
                        </div>
                        <span style="margin-left: 1rem; font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_sectors} sectors analyzed over ${data.lookback_days} days
                        </span>
                    </div>

                    <!-- Hierarchical Clustering Dendrogram -->
                    ${data.clustering ? `
                        <div id="dendrogramPlot" style="margin-bottom: 1.5rem; background: var(--theme-bg); border-radius: var(--radius-sm); padding: 1rem;"></div>
                    ` : ''}

                    <!-- Filters & Search -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="sectorSearch" placeholder="üîç Search sectors..."
                            style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text);">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="filterSectors('all')" id="filterAll" class="sector-filter-btn active" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--brand-primary); color: white; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                All
                            </button>
                            <button onclick="filterSectors('hot')" id="filterHot" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üî• Hot
                            </button>
                            <button onclick="filterSectors('cold')" id="filterCold" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                ‚ùÑÔ∏è Cold
                            </button>
                        </div>
                    </div>

                    <table class="positions-table" id="sectorTable" style="margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th onclick="sortSectorTable('name')" style="cursor: pointer; user-select: none;">
                                    Sector <span id="sortName">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('return')" style="cursor: pointer; user-select: none;">
                                    Return <span id="sortReturn">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('momentum')" style="cursor: pointer; user-select: none;">
                                    Momentum <span id="sortMomentum">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('signal')" style="cursor: pointer; user-select: none;">
                                    Signal <span id="sortSignal">‚ÜïÔ∏è</span>
                                </th>
                                <th>Positions</th>
                            </tr>
                        </thead>
                        <tbody id="sectorTableBody">
                            ${sortedSectors.map(([name, data]) => {
                                const signalColor = data.signal === 'overweight' ? 'var(--success)' :
                                                   data.signal === 'underweight' ? 'var(--danger)' : 'var(--theme-text-muted)';
                                const signalIcon = data.signal === 'overweight' ? 'üî•' :
                                                  data.signal === 'underweight' ? '‚ùÑÔ∏è' : '‚ûñ';
                                return `
                                    <tr data-sector="${name}" data-signal="${data.signal}" data-momentum="${data.momentum}" data-return="${data.return}">
                                        <td style="font-weight: 600;">${name}</td>
                                        <td style="color: ${data.return >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                            ${data.return >= 0 ? '+' : ''}${data.return.toFixed(2)}%
                                        </td>
                                        <td>${data.momentum.toFixed(2)}x</td>
                                        <td style="color: ${signalColor}; font-weight: 600;">
                                            ${signalIcon} ${data.signal.toUpperCase()}
                                        </td>
                                        <td>${data.num_positions}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                // Add event listener for search
                document.getElementById('sectorSearch').addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#sectorTableBody tr');
                    rows.forEach(row => {
                        const sectorName = row.dataset.sector.toLowerCase();
                        row.style.display = sectorName.includes(searchTerm) ? '' : 'none';
                    });
                });

                // Create dendrogram if clustering data available
                if (data.clustering && data.clustering.linkage_matrix) {
                    // Convert linkage matrix to Plotly format
                    const linkageMatrix = data.clustering.linkage_matrix;
                    const labels = data.clustering.labels;

                    // Color sectors by momentum
                    const sectorColors = labels.map(label => {
                        const sectorData = sectors[label];
                        if (!sectorData) return '#888888';

                        const momentum = sectorData.momentum || 0;
                        if (momentum > 1) return '#22c55e'; // Green for hot
                        if (momentum < -1) return '#ef4444'; // Red for cold
                        return '#6b7280'; // Gray for neutral
                    });

                    // Create dendrogram trace
                    const trace = {
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#888888', width: 2 },
                        marker: { size: 8, color: sectorColors },
                        hovertemplate: '<b>%{text}</b><extra></extra>',
                        text: labels
                    };

                    // Build dendrogram manually from scipy linkage matrix
                    // Format: [i, j, distance, num_leaves]
                    const n = labels.length;
                    const icoord = [];
                    const dcoord = [];

                    // Simple dendrogram rendering (horizontal layout)
                    for (let i = 0; i < linkageMatrix.length; i++) {
                        const [idx1, idx2, dist, count] = linkageMatrix[i];
                        const x1 = idx1 < n ? idx1 : ((idx1 - n) * 2);
                        const x2 = idx2 < n ? idx2 : ((idx2 - n) * 2);
                        const y = dist;

                        icoord.push([x1, x1, x2, x2]);
                        dcoord.push([0, y, y, 0]);
                    }

                    const layout = {
                        title: {
                            text: 'üìä Sector Clustering (Ward Linkage)',
                            font: { size: 14, weight: 600 }
                        },
                        xaxis: {
                            title: 'Sectors',
                            ticktext: labels,
                            tickvals: labels.map((_, i) => i),
                            tickangle: -45
                        },
                        yaxis: {
                            title: 'Distance (1 - |Correlation|)',
                            zeroline: false
                        },
                        height: 300,
                        margin: { l: 60, r: 20, t: 50, b: 100 },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        hovermode: 'closest'
                    };

                    // Use Plotly's built-in dendrogram support
                    const plotData = [{
                        type: 'scatter',
                        x: labels.map((_, i) => i),
                        y: labels.map(label => sectors[label]?.momentum || 0),
                        mode: 'markers+text',
                        marker: {
                            size: 15,
                            color: sectorColors,
                            line: { width: 2, color: '#ffffff' }
                        },
                        text: labels,
                        textposition: 'top center',
                        textfont: { size: 10 },
                        hovertemplate: '<b>%{text}</b><br>Momentum: %{y:.2f}x<extra></extra>'
                    }];

                    Plotly.newPlot('dendrogramPlot', plotData, layout, { responsive: true, displayModeBar: false });
                }

                document.getElementById('sectorBadge').textContent = `${hotSectors.length} hot, ${coldSectors.length} cold`;
                document.getElementById('sectorBadge').style.background = data.rotation_detected ?
                    'color-mix(in oklab, var(--warning) 10%, transparent)' : '';
                document.getElementById('sectorBadge').style.color = data.rotation_detected ? 'var(--warning)' : '';

            } catch (error) {
                debugLogger.error('Sector rotation failed', error);
                document.getElementById('sectorRotation').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load sector rotation data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Margin Monitoring
        async function loadMarginMonitoring() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('marginMonitoring').innerHTML = '<div class="loading">Calculating margin metrics‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/margin?user_id=${activeUser}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Margin monitoring failed');

                const data = response.data || response;

                const warningLevel = data.warnings.length > 0 ?
                    (data.warnings.some(w => w.includes('CRITICAL')) ? 'danger' : 'warning') : 'success';

                // Margin call distance color
                const marginColor = data.margin_call_distance < 10 ? 'var(--danger)' :
                                   data.margin_call_distance < 20 ? 'var(--warning)' : 'var(--success)';

                document.getElementById('marginMonitoring').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Utilization</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.margin_utilization.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                $${(data.total_margin_used || 0).toLocaleString()} / $${(data.account_equity || 0).toLocaleString()}
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Leverage</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.current_leverage.toFixed(2)}x</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                Optimal: ${data.optimal_leverage.toFixed(2)}x
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Call Distance</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${marginColor};">${data.margin_call_distance.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                ${data.margin_call_distance >= 50 ? '‚úÖ Very Safe' :
                                  data.margin_call_distance >= 20 ? '‚ö†Ô∏è Monitor' : 'üö® Risk'}
                            </div>
                        </div>
                    </div>

                    ${data.warnings.length > 0 ? `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${warningLevel}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${warningLevel}); font-size: 0.875rem;">
                            <strong style="color: var(--${warningLevel});">‚ö†Ô∏è Warnings (${data.warnings.length}):</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: var(--${warningLevel});">
                                ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--success); font-size: 0.875rem; color: var(--success);">
                            ‚úÖ No margin warnings - Portfolio is healthy
                        </div>
                    `}

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('marginBadge').textContent = data.warnings.length > 0 ?
                    `${data.warnings.length} warnings` : 'Healthy';
                document.getElementById('marginBadge').style.background = `color-mix(in oklab, var(--${warningLevel}) 10%, transparent)`;
                document.getElementById('marginBadge').style.color = `var(--${warningLevel})`;

            } catch (error) {
                debugLogger.error('Margin monitoring failed', error);
                document.getElementById('marginMonitoring').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load margin data: ${error.message}
                    </div>
                `;
            }
        }

        // Populate ticker selector with portfolio tickers
        function populateTickerSelector() {
            const selector = document.getElementById('tickerSelector');
            if (!currentPortfolioData || !currentPortfolioData.positions) {
                return;
            }

            // Get unique tickers from positions
            const tickers = [...new Set(currentPortfolioData.positions.map(p => p.ticker || p.symbol))].filter(Boolean).sort();

            selector.innerHTML = '<option value="">Select a ticker...</option>' +
                tickers.map(ticker => `<option value="${ticker}">${ticker}</option>`).join('');

            // Add change event listener
            selector.onchange = (e) => {
                const ticker = e.target.value;
                if (ticker) {
                    document.getElementById('tickerAnalytics').style.display = 'block';
                    document.getElementById('tickerPlaceholder').style.display = 'none';
                    loadTickerSpecificAnalytics(ticker);
                } else {
                    document.getElementById('tickerAnalytics').style.display = 'none';
                    document.getElementById('tickerPlaceholder').style.display = 'block';
                }
            };
        }

        // Load ticker-specific analytics (Beta, Earnings, Dividends)
        async function loadTickerSpecificAnalytics(ticker) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            // Load all ticker analytics in parallel
            await Promise.all([
                loadBetaForecast(ticker, activeUser),
                loadEarningsPredictor(ticker, activeUser),
                loadDividendAnalysis(ticker, activeUser)
            ]);
        }

        // Load Beta Forecast for ticker
        async function loadBetaForecast(ticker, activeUser) {
            try {
                document.getElementById('betaForecast').innerHTML = '<div class="loading">Loading beta forecast‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/beta-forecast?user_id=${activeUser}&ticker=${ticker}&benchmark=SPY`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Beta forecast failed');

                const data = response.data || response;

                const trendColor = data.beta_trend === 'increasing' ? 'var(--danger)' :
                                  data.beta_trend === 'decreasing' ? 'var(--success)' : 'var(--theme-text-muted)';
                const trendIcon = data.beta_trend === 'increasing' ? 'üìà' :
                                 data.beta_trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';

                // Create canvas for chart
                const canvasId = `betaChart-${ticker}`;
                document.getElementById('betaForecast').innerHTML = `
                    <!-- Beta Rolling Chart -->
                    <div style="margin-bottom: 1.5rem;">
                        <canvas id="${canvasId}" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Beta</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.current_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Forecast (EWMA)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.forecasted_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Trend</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${trendColor};">
                                ${trendIcon} ${data.beta_trend}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">R¬≤ (Fit Quality)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.r_squared * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Annual Alpha</div>
                            <div style="font-size: 1rem; font-weight: 600; color: ${data.alpha >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.alpha >= 0 ? '+' : ''}${data.alpha.toFixed(2)}%
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Volatility Ratio</div>
                            <div style="font-size: 1rem; font-weight: 600;">${data.volatility_ratio.toFixed(2)}x vs SPY</div>
                        </div>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Based on ${data.observation_days} days of returns ‚Ä¢ Forecast method: ${data.forecast_method}
                    </div>
                `;

                // Create Chart.js beta rolling chart
                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = data.rolling_betas.map((_, i) => `-${data.rolling_betas.length - i}d`);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Rolling Beta (60d)',
                                data: data.rolling_betas,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Current Beta',
                                data: new Array(data.rolling_betas.length).fill(data.current_beta),
                                borderColor: 'rgba(255, 99, 132, 0.8)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Forecast (EWMA)',
                                data: new Array(data.rolling_betas.length).fill(data.forecasted_beta),
                                borderColor: 'rgba(75, 192, 192, 0.8)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${ticker} Beta Rolling History vs SPY`,
                                font: { size: 14, weight: '600' }
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: { font: { size: 11 } }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Beta'
                                },
                                grid: {
                                    color: 'rgba(128, 128, 128, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Days Ago'
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

            } catch (error) {
                debugLogger.error('Beta forecast failed', error);
                document.getElementById('betaForecast').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load beta forecast: ${error.message}
                    </div>
                `;
            }
        }

        // Load Earnings Predictor for ticker
        async function loadEarningsPredictor(ticker, activeUser) {
            try {
                document.getElementById('earningsPredictor').innerHTML = '<div class="loading">Loading earnings data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/earnings?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Earnings predictor failed');

                const data = response.data || response;

                const alertColor = data.alert_level === 'high' ? 'var(--danger)' :
                                  data.alert_level === 'medium' ? 'var(--warning)' : 'var(--info)';

                document.getElementById('earningsPredictor').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Alert Level</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${alertColor}; text-transform: uppercase;">
                                ${data.alert_level}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Pre-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.pre_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Post-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${(data.post_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Vol Increase</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">+${data.vol_increase_pct.toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${data.alert_level === 'low' ? 'info' : 'warning'}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${data.alert_level === 'low' ? 'info' : 'warning'}); font-size: 0.875rem;">
                        <strong style="color: var(--${data.alert_level === 'low' ? 'info' : 'warning'});">üí° ${data.recommendation}</strong>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Avg post-earnings move: ${data.avg_post_earnings_move.toFixed(2)}%
                        ${data.next_earnings_date ? ` ‚Ä¢ Next earnings: ${data.next_earnings_date}` : ''}
                    </div>
                `;

            } catch (error) {
                debugLogger.error('Earnings predictor failed', error);
                document.getElementById('earningsPredictor').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load earnings data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Dividend Analysis for ticker
        async function loadDividendAnalysis(ticker, activeUser) {
            try {
                document.getElementById('dividendAnalysis').innerHTML = '<div class="loading">Loading dividend data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/dividends?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));

                const data = response.data || response;

                // Check if data is available or if there was an error
                if (!data.ok || !data.has_dividend_data || data.current_yield === 0) {
                    const errorMsg = data.error ? ` (${data.error})` : '';
                    document.getElementById('dividendAnalysis').innerHTML = `
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚ÑπÔ∏è No dividend data available for ${ticker}${errorMsg}
                        </div>
                    `;
                    return;
                }

                document.getElementById('dividendAnalysis').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Yield</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.current_yield.toFixed(2)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Annual Dividend</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">$${data.annual_dividend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Frequency</div>
                            <div style="font-size: 1rem; font-weight: 600; text-transform: capitalize;">${data.payout_frequency}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Growth Rate (YoY)</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${data.dividend_growth_rate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.dividend_growth_rate >= 0 ? '+' : ''}${data.dividend_growth_rate.toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    ${data.next_ex_dividend_date ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üìÖ Next Ex-Dividend:</strong> ${data.next_ex_dividend_date}
                            ${data.days_until_ex_dividend ? ` (in ${data.days_until_ex_dividend} days)` : ''}
                            <br><small>Expected price drop: ~${data.avg_price_drop_ex_div.toFixed(2)}%</small>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                debugLogger.error('Dividend analysis failed', error);
                document.getElementById('dividendAnalysis').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load dividend data: ${error.message}
                    </div>
                `;
            }
        }

        // Load current Saxo data from active source (via WealthContextBar)
        async function loadCurrentSaxoData() {
            debugLogger.debug('üè¶ Loading Saxo data from active source...');

            try {
                // Show loading state
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('mainContent').innerHTML = '<div class="loading">üìä Chargement des donn√©es Bourse...</div>';
                document.getElementById('dashboardContent').style.display = 'none';

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Build URL with file_key if available
                let portfoliosUrl = '/api/saxo/portfolios';
                if (currentFileKey) {
                    portfoliosUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading portfolio with file_key: ${currentFileKey}`);
                }

                // Step 1: List available portfolios
                const { ok: listOk, data: listData } = await safeFetch(globalConfig.getApiUrl(portfoliosUrl), {
                    headers: { 'X-User': activeUser }
                });

                if (!listOk || !listData?.portfolios || listData.portfolios.length === 0) {
                    debugLogger.warn('Aucun portfolio Saxo disponible.');
                    showNoDataState('üìÇ Aucune donn√©e Saxo disponible');
                    return;
                }

                // Step 2: Load the first portfolio (or find the one matching the source)
                const portfolio = listData.portfolios[0];
                const portfolioId = portfolio.portfolio_id;

                if (!portfolioId) {
                    debugLogger.warn('Portfolio ID manquant.');
                    showNoDataState('‚ùå Erreur: Portfolio ID manquant');
                    return;
                }

                // Step 3: Load full portfolio details
                let detailUrl = `/api/saxo/portfolios/${portfolioId}`;
                if (currentFileKey) {
                    detailUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const { ok: detailOk, data: portfolioData } = await safeFetch(globalConfig.getApiUrl(detailUrl), {
                    headers: { 'X-User': activeUser }
                });

                if (!detailOk || !portfolioData) {
                    debugLogger.warn('Erreur lors du chargement du portfolio.');
                    showNoDataState('‚ùå Erreur lors du chargement du portfolio');
                    return;
                }

                // Store portfolio data
                currentPortfolioData = portfolioData;

                // Hide main content and show dashboard
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Load all sections
                loadOverviewData(currentPortfolioData);

                // Refresh active tab content after data load
                refreshActiveTab();

                debugLogger.debug('‚úÖ Saxo data loaded successfully');

            } catch (error) {
                debugLogger.error('Error loading Saxo data:', error);
                showError('‚ùå Erreur lors du chargement des donn√©es: ' + error.message);
            }
        }

        function loadOverviewData(data) {
            // Safe access to data properties
            const summary = data?.summary || {};
            const totalValue = Number(summary.total_value_usd || 0);
            const totalPositions = summary.total_positions || data?.positions?.length || 0;
            const assetAllocation = summary.asset_allocation || {};
            const currencyExposure = summary.currency_exposure || {};

            // Portfolio Summary
            const summaryHtml = `
                <div class="metric-large">$${totalValue.toLocaleString()}</div>
                <div class="metric-label">Total Portfolio Value</div>
                <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Positions:</span>
                        <span><strong>${totalPositions}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Asset Classes:</span>
                        <span><strong>${Object.keys(assetAllocation).length}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Currencies:</span>
                        <span><strong>${Object.keys(currencyExposure).length}</strong></span>
                    </div>
                </div>
            `;
            document.getElementById('portfolioSummary').innerHTML = summaryHtml;

            // Asset Allocation
            const allocationHtml = Object.keys(assetAllocation).length > 0 ? `
                <div class="allocation-grid">
                    ${Object.entries(assetAllocation)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => `
                            <div class="allocation-item">
                                <div class="allocation-percentage">${Number(percentage).toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                            </div>
                        `).join('')}
                </div>
            ` : '<div class="no-data">Aucune donn√©e d\'allocation disponible</div>';
            document.getElementById('assetAllocation').innerHTML = allocationHtml;

            // Top Holdings
            const topHoldings = summary.top_holdings || data?.positions?.slice(0, 10) || [];
            const holdingsHtml = topHoldings.length > 0 ? `
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Symbol</th>
                            <th>Market Value</th>
                            <th>Asset Class</th>
                            <th>Weight</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topHoldings.map(position => {
                            const name = position.name || position.instrument || position.symbol || 'Unknown';
                            const symbol = position.symbol || 'N/A';
                            const displayName = name !== symbol ? name : (position.isin || name);
                            return `
                            <tr>
                                <td><strong>${displayName}</strong></td>
                                <td><code style="font-size: 0.85rem; color: var(--theme-text-muted);">${symbol}</code></td>
                                <td>$${Number(position.market_value_usd || position.market_value || 0).toLocaleString()}</td>
                                <td>
                                    <span class="asset-class-badge asset-class-${(position.asset_class || 'other').toLowerCase()}">
                                        ${position.asset_class || 'N/A'}
                                    </span>
                                </td>
                                <td>${totalValue > 0 ? (((position.market_value_usd || position.market_value || 0) / totalValue) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            ` : '<div class="no-data">Aucune position trouv√©e</div>';
            document.getElementById('topHoldings').innerHTML = holdingsHtml;
        }

        function loadAllPositions() {
            if (!currentPortfolioData) return;

            const positionsHtml = `
                <div class="table-container">
                    <table class="positions-table">
                        <thead>
                            <tr>
                                <th>Instrument</th>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Market Value</th>
                                <th>Currency</th>
                                <th>Asset Class</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentPortfolioData.positions
                    .sort((a, b) => b.market_value_usd - a.market_value_usd)
                    .map(position => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        return `
                                <tr>
                                    <td>
                                        <strong>${displayName}</strong>
                                        ${position.isin ? `<div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-top: 0.25rem;">ISIN: ${position.isin}</div>` : ''}
                                    </td>
                                    <td><code style="font-size: 0.85rem;">${symbol}</code></td>
                                    <td>${position.quantity.toLocaleString()}</td>
                                    <td><strong>$${position.market_value_usd.toLocaleString()}</strong></td>
                                    <td>${position.currency}</td>
                                    <td>
                                        <span class="asset-class-badge asset-class-${position.asset_class.toLowerCase()}">
                                            ${position.asset_class}
                                        </span>
                                    </td>
                                    <td>${((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100).toFixed(1)}%</td>
                                </tr>
                        `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('allPositions').innerHTML = positionsHtml;
            document.getElementById('positionsCount').textContent = `${currentPortfolioData.positions.length} positions`;
        }

        function loadAllocationDetails() {
            if (!currentPortfolioData) return;

            // Asset class breakdown
            const assetClassHtml = `
                <div class="allocation-grid">
                    ${Object.entries(currentPortfolioData.summary.asset_allocation)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => `
                            <div class="allocation-item">
                                <div class="allocation-percentage">${percentage.toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(currentPortfolioData.summary.total_value_usd * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('assetClassBreakdown').innerHTML = assetClassHtml;

            // Holdings by value
            const holdingsByValueHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${currentPortfolioData.summary.top_holdings.map((position, index) => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--theme-border);">
                            <div>
                                <div style="font-weight: 600;">${index + 1}. ${displayName}</div>
                                <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                    ${symbol} ‚Ä¢ ${position.asset_class}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${position.market_value_usd.toLocaleString()}</div>
                                <div style="font-size: 0.8rem; color: var(--theme-text-muted);">
                                    ${((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            document.getElementById('holdingsByValue').innerHTML = holdingsByValueHtml;
        }

        function loadCurrencyDetails() {
            if (!currentPortfolioData) return;

            const currencyHtml = `
                <div class="currency-grid">
                    ${Object.entries(currentPortfolioData.summary.currency_exposure)
                    .sort(([, a], [, b]) => b - a)
                    .map(([currency, percentage]) => `
                            <div class="currency-item">
                                <div class="currency-percentage">${percentage.toFixed(1)}%</div>
                                <div class="currency-code">${currency}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(currentPortfolioData.summary.total_value_usd * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                </div>
                <div style="margin-top: 2rem; padding: 1rem; background: var(--info-bg); border-radius: var(--radius-md); border: 1px solid var(--info);">
                    <div style="font-size: 0.875rem; color: var(--info);">
                        <strong>Note:</strong> Currency exposure is calculated based on the original currency of each position.
                        USD values are converted using estimated exchange rates.
                    </div>
                </div>
            `;
            document.getElementById('currencyExposure').innerHTML = currencyHtml;
        }

        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">${message}</div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showNoDataState(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="no-data">
                    <h3>üìÇ Aucune donn√©e disponible</h3>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            debugLogger.debug('üè¶ Saxo Dashboard initialized');

            // Initialize wealth context integration
            initWealthContextIntegration();

            // Listen for Bourse source changes from WealthContextBar
            window.addEventListener('bourseSourceChanged', async (event) => {
                debugLogger.debug('üîÑ Bourse source changed:', event.detail);

                // Resolve file_key from source (same logic as wealth-saxo-summary.js)
                const bourseSource = window.wealthContextBar?.getContext()?.bourse;
                currentFileKey = null; // Reset

                if (bourseSource && bourseSource !== 'all' && bourseSource.startsWith('saxo:')) {
                    const key = bourseSource.substring(5); // Remove 'saxo:' prefix
                    const activeUser = localStorage.getItem('activeUser') || 'demo';

                    try {
                        // Load available sources to resolve file_key
                        if (!window.availableSources) {
                            const response = await fetch('/api/users/sources', {
                                headers: { 'X-User': activeUser }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                window.availableSources = data.sources || [];
                            }
                        }

                        // Find matching source and extract filename
                        const source = window.availableSources?.find(s => s.key === key);
                        if (source?.file_path) {
                            currentFileKey = source.file_path.split(/[/\\]/).pop();
                            debugLogger.debug(`üìÑ Resolved file_key: ${currentFileKey}`);
                        }
                    } catch (err) {
                        debugLogger.warn('[Saxo Dashboard] Failed to resolve file_key:', err);
                    }
                }

                // Reload data with new source
                loadCurrentSaxoData();
            });

            // Load current Saxo data from active source
            await loadCurrentSaxoData();
        });

        // ==================== SECTOR TABLE FILTERING & SORTING ====================

        /**
         * Filter sectors by signal type
         */
        function filterSectors(filter) {
            const rows = document.querySelectorAll('#sectorTableBody tr');
            const buttons = document.querySelectorAll('.sector-filter-btn');

            // Update button styles
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'var(--theme-bg)';
                btn.style.color = 'var(--theme-text)';
            });

            const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = 'var(--brand-primary)';
                activeBtn.style.color = 'white';
            }

            // Filter rows
            rows.forEach(row => {
                const signal = row.dataset.signal;
                const searchTerm = document.getElementById('sectorSearch')?.value.toLowerCase() || '';
                const sectorName = row.dataset.sector.toLowerCase();
                const matchesSearch = sectorName.includes(searchTerm);

                let show = matchesSearch;
                if (filter === 'hot') {
                    show = show && signal === 'overweight';
                } else if (filter === 'cold') {
                    show = show && signal === 'underweight';
                }

                row.style.display = show ? '' : 'none';
            });
        }

        /**
         * Sort sector table by column
         */
        let sectorSortState = {
            column: null,
            ascending: true
        };

        function sortSectorTable(column) {
            const tbody = document.getElementById('sectorTableBody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (sectorSortState.column === column) {
                sectorSortState.ascending = !sectorSortState.ascending;
            } else {
                sectorSortState.column = column;
                sectorSortState.ascending = false; // Default to descending for numbers
            }

            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'name':
                        aVal = a.dataset.sector;
                        bVal = b.dataset.sector;
                        return sectorSortState.ascending
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);

                    case 'return':
                        aVal = parseFloat(a.dataset.return);
                        bVal = parseFloat(b.dataset.return);
                        break;

                    case 'momentum':
                        aVal = parseFloat(a.dataset.momentum);
                        bVal = parseFloat(b.dataset.momentum);
                        break;

                    case 'signal':
                        const signalOrder = { 'overweight': 3, 'neutral': 2, 'underweight': 1 };
                        aVal = signalOrder[a.dataset.signal] || 0;
                        bVal = signalOrder[b.dataset.signal] || 0;
                        break;

                    default:
                        return 0;
                }

                return sectorSortState.ascending ? aVal - bVal : bVal - aVal;
            });

            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicators
            ['Name', 'Return', 'Momentum', 'Signal'].forEach(col => {
                const indicator = document.getElementById(`sort${col}`);
                if (indicator) {
                    if (col.toLowerCase() === column) {
                        indicator.textContent = sectorSortState.ascending ? '‚ñ≤' : '‚ñº';
                    } else {
                        indicator.textContent = '‚ÜïÔ∏è';
                    }
                }
            });
        }

        // ==================== PDF EXPORT ====================

        /**
         * Export Risk & Analytics tab to PDF
         */
        async function exportRiskPDF() {
            try {
                const { jsPDF } = window.jspdf;

                // Show loading indicator
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '‚è≥ Generating PDF...';
                exportBtn.disabled = true;

                // Get the Risk tab content
                const riskTab = document.getElementById('risk');

                // Create a temporary container with white background for PDF
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; background: white; padding: 20px; width: 800px;';
                tempContainer.innerHTML = `
                    <div style="font-family: Arial, sans-serif; color: #000;">
                        <h1 style="text-align: center; color: #1e40af; margin-bottom: 10px;">üìà Risk & Analytics Report</h1>
                        <p style="text-align: center; color: #666; margin-bottom: 30px;">
                            Generated on ${new Date().toLocaleDateString('fr-FR')} at ${new Date().toLocaleTimeString('fr-FR')}
                        </p>
                        ${riskTab.innerHTML}
                    </div>
                `;
                document.body.appendChild(tempContainer);

                // Wait for charts to render
                await new Promise(resolve => setTimeout(resolve, 500));

                // Capture the content with html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowWidth: 800
                });

                // Remove temporary container
                document.body.removeChild(tempContainer);

                // Create PDF
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Calculate dimensions to fit A4
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 297; // A4 height in mm

                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add more pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Add footer with timestamp and app name
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(128, 128, 128);
                    pdf.text(
                        `Page ${i} of ${pageCount} | Generated by Crypto Rebalancer - Bourse Risk Analytics`,
                        105,
                        290,
                        { align: 'center' }
                    );
                }

                // Save PDF
                const fileName = `Risk_Analytics_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Reset button
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

                debugLogger.info(`PDF exported successfully: ${fileName}`);

            } catch (error) {
                debugLogger.error('PDF export failed', error);
                alert('Failed to export PDF. Please try again.');

                // Reset button on error
                if (event?.target) {
                    event.target.innerHTML = 'üìÑ Export PDF';
                    event.target.disabled = false;
                }
            }
        }
    </script>
</body>

</html>