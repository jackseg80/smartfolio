<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Dashboard Bourse - Crypto Rebalancer</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module">
        import { initDeepLinks } from './components/deep-links.js';
        import { wealthContextBar } from './components/WealthContextBar.js';
        import { safeFetch } from './modules/http.js';

        // Ancres pour saxo-dashboard.html
        initDeepLinks({
            'overview': 'Vue d\'ensemble',
            'positions': 'Positions',
            'allocation': 'Allocation',
            'performance': 'Performance'
        });

        window.wealthContextBar = wealthContextBar;
        window.safeFetch = safeFetch;
    </script>
    <script src="debug-logger.js"></script>
  <script src="global-config.js"></script>
    <script src="appearance.js"></script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--theme-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--theme-border);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .dashboard-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .card-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            background: var(--theme-bg);
            color: var(--theme-text-muted);
            border: 1px solid var(--theme-border);
        }

        .metric-large {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--theme-text-muted);
            font-size: 0.875rem;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .allocation-item {
            text-align: center;
            padding: 1rem;
            background: var(--theme-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--theme-border);
        }

        .allocation-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--brand-primary);
        }

        .allocation-label {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
            margin-top: 0.25rem;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .positions-table th,
        .positions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--theme-border);
        }

        .positions-table th {
            background: var(--theme-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .positions-table tr:hover {
            background: var(--theme-bg);
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
        }

        .asset-class-badge {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .asset-class-stock {
            background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
            color: var(--brand-primary);
        }

        .asset-class-etf {
            background: color-mix(in oklab, var(--success) 10%, transparent);
            color: var(--success);
        }

        .asset-class-bond {
            background: color-mix(in oklab, var(--warning) 10%, transparent);
            color: var(--warning);
        }

        .asset-class-cfd {
            background: color-mix(in oklab, #FF6B6B 10%, transparent);
            color: #FF6B6B;
        }

        .asset-class-other {
            background: color-mix(in oklab, var(--info) 10%, transparent);
            color: var(--info);
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .currency-item {
            padding: 0.75rem;
            text-align: center;
            background: var(--theme-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--theme-border);
        }

        .currency-percentage {
            font-weight: 700;
            color: var(--brand-primary);
        }

        .currency-code {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--theme-text-muted);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--theme-text-muted);
        }

        .error-message {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .refresh-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all var(--transition-fast);
        }

        .refresh-btn:hover {
            background: color-mix(in oklab, var(--brand-primary) 80%, black);
        }


        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--theme-border);
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--theme-text-muted);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .tab-btn.active {
            color: var(--brand-primary);
            border-bottom-color: var(--brand-primary);
        }

        .tab-btn:hover:not(.active) {
            color: var(--theme-text);
            background: var(--theme-bg);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1>üìà Dashboard Bourse (Saxo Bank)</h1>
                <p style="color: var(--theme-text-muted); margin: 0;">Analyse de votre portefeuille actions</p>
            </div>
        </div>


        <!-- Main Content (initially empty, filled by loadCurrentSaxoData) -->
        <div id="mainContent">
            <div class="loading">üìä Chargement initial...</div>
        </div>

        <!-- Dashboard Content (hidden by default) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview', event)">Vue d'ensemble</button>
                <button class="tab-btn" onclick="switchTab('positions', event)">Positions</button>
                <button class="tab-btn" onclick="switchTab('allocation', event)">Allocation</button>
                <button class="tab-btn" onclick="switchTab('currencies', event)">Devises</button>
                <button class="tab-btn" onclick="switchTab('risk', event)">Risk & Analytics</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Portfolio Summary -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Portfolio Summary</h3>
                            <div class="card-badge" id="portfolioBadge">Read-Only</div>
                        </div>
                        <div id="portfolioSummary">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Asset Allocation -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Asset Allocation</h3>
                        </div>
                        <div id="assetAllocation">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Top Holdings -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Top 10 Holdings</h3>
                    </div>
                    <div id="topHoldings">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div id="positions" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">All Positions</h3>
                        <div class="card-badge" id="positionsCount">0 positions</div>
                    </div>
                    <div id="allPositions">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Allocation Tab -->
            <div id="allocation" class="tab-content">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">By Asset Class</h3>
                        </div>
                        <div id="assetClassBreakdown">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Top Holdings by Value</h3>
                        </div>
                        <div id="holdingsByValue">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currencies Tab -->
            <div id="currencies" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Currency Exposure</h3>
                    </div>
                    <div id="currencyExposure">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <div id="risk" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Risk Score (Bourse)</h3>
                    </div>
                    <div id="riskSummary"><div class="loading">Calcul en cours‚Ä¶</div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">M√©triques principales</h3></div>
                        <div id="riskMetrics" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">Concentration & Diversification</h3></div>
                        <div id="riskStructure" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                </div>

                <!-- ML Insights Section -->
                <div class="dashboard-card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">ü§ñ ML Insights & Predictions</h3>
                        <div class="card-badge" id="mlBadge">Loading...</div>
                    </div>
                    <div id="mlInsights"><div class="loading">Chargement des pr√©dictions ML‚Ä¶</div></div>
                </div>

                <!-- Specialized Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üéØ Specialized Analytics
                    </h2>

                    <!-- Sector Rotation -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üìä Sector Rotation Analysis</h3>
                            <div class="card-badge" id="sectorBadge">Portfolio-wide</div>
                        </div>
                        <div id="sectorRotation"><div class="loading">Loading sector rotation data‚Ä¶</div></div>
                    </div>

                    <!-- Margin Monitoring -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">‚ö†Ô∏è Margin Monitoring</h3>
                            <div class="card-badge" id="marginBadge">Portfolio-wide</div>
                        </div>
                        <div id="marginMonitoring"><div class="loading">Loading margin data‚Ä¶</div></div>
                    </div>

                    <!-- Ticker-Specific Analytics -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">üîç Ticker-Specific Analysis</h3>
                            <select id="tickerSelector" style="padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text); font-size: 0.875rem;">
                                <option value="">Select a ticker...</option>
                            </select>
                        </div>

                        <div id="tickerAnalytics" style="display: none;">
                            <!-- Beta Forecast -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìà Beta Forecast vs SPY</h4>
                                <div id="betaForecast"><div class="loading">Loading beta forecast‚Ä¶</div></div>
                            </div>

                            <!-- Earnings Predictor -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÖ Earnings Impact Prediction</h4>
                                <div id="earningsPredictor"><div class="loading">Loading earnings data‚Ä¶</div></div>
                            </div>

                            <!-- Dividend Analysis -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üí∞ Dividend Analysis</h4>
                                <div id="dividendAnalysis"><div class="loading">Loading dividend data‚Ä¶</div></div>
                            </div>
                        </div>

                        <div id="tickerPlaceholder" style="padding: 2rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            üëÜ Select a ticker above to view Beta Forecast, Earnings Predictor, and Dividend Analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPortfolioData = null;
        let currentWealthContext = {
            module: 'bourse'
        };
        let currentFileKey = null;  // Track selected Saxo file

        // Initialize wealth context integration
        function initWealthContextIntegration() {
            debugLogger.debug('üè¶ Initializing WealthContextBar integration for Saxo dashboard...');

            if (!window.wealthContextBar) {
                debugLogger.warn('WealthContextBar not available');
                return;
            }

            // Set initial context to bourse module only (preserve other context values)
            window.wealthContextBar.setContext(currentWealthContext);

            // Listen for context changes
            window.addEventListener('wealth:change', (event) => {
                debugLogger.debug('Wealth context changed in Saxo dashboard:', event.detail);
                currentWealthContext = { ...event.detail };

                // Update UI based on context changes
                updateContextualDisplay();
            });

            debugLogger.debug('‚úÖ WealthContextBar integrated for Saxo dashboard');
        }

        function updateContextualDisplay() {
            // Update currency display based on context
            if (currentPortfolioData && currentWealthContext.currency !== 'USD') {
                // Could implement currency conversion here
                debugLogger.debug(`Display currency preference: ${currentWealthContext.currency}`);
            }
        }

        // Refresh active tab content (called after data reload)
        function refreshActiveTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            debugLogger.debug(`üîÑ Refreshing active tab: ${tabId}`);

            // Reload data for the active tab
            if (currentPortfolioData) {
                switch (tabId) {
                    case 'overview':
                        loadOverviewData(currentPortfolioData);
                        break;
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'allocation':
                        loadAllocationDetails();
                        break;
                    case 'currencies':
                        loadCurrencyDetails();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                }
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by data attribute or text content
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tab if needed
            if (currentPortfolioData) {
                switch (tabName) {
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'allocation':
                        loadAllocationDetails();
                        break;
                    case 'currencies':
                        loadCurrencyDetails();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                }
            }
        }

        // Load Risk & Analytics (lazy-loaded when tab is clicked)
        async function loadRiskAnalytics() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('riskSummary').innerHTML = '<div class="loading">Calcul des m√©triques de risque‚Ä¶</div>';
                document.getElementById('riskMetrics').innerHTML = '<div class="loading">‚Ä¶</div>';
                document.getElementById('riskStructure').innerHTML = '<div class="loading">‚Ä¶</div>';

                // Build URL with file_key if available
                let riskUrl = `/api/risk/bourse/dashboard?user_id=${activeUser}`;
                if (currentFileKey) {
                    riskUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading risk with file_key: ${currentFileKey}`);
                }

                const response = await safeFetch(globalConfig.getApiUrl(riskUrl));
                if (!response?.ok) throw new Error('risk endpoint failed');

                const { risk, coverage, positions_count, total_value_usd } = response.data || response;
                const score = risk?.score ?? 0;
                const level = risk?.level ?? 'N/A';

                // Get risk level color
                const getRiskColor = (lvl) => {
                    const levelUpper = String(lvl).toUpperCase();
                    if (levelUpper === 'LOW' || levelUpper === 'VERY_LOW') return 'var(--success)';
                    if (levelUpper === 'MEDIUM' || levelUpper === 'MODERATE') return 'var(--warning)';
                    if (levelUpper === 'HIGH' || levelUpper === 'VERY_HIGH') return 'var(--danger)';
                    if (levelUpper === 'CRITICAL') return '#8B0000';
                    return 'var(--theme-text-muted)';
                };

                const riskColor = getRiskColor(level);

                // Risk Summary with enhanced UI
                document.getElementById('riskSummary').innerHTML = `
                  <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;">
                      <div class="metric-large" style="color:${riskColor}">${score.toFixed(0)}<span style="font-size:1rem;color:var(--theme-text-muted);">/100</span></div>
                      <div class="metric-label">Risk Score (higher = safer)</div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                      <div style="font-weight:600;font-size:1.25rem;color:${riskColor};margin-bottom:0.5rem;">${level}</div>
                      <div style="color:var(--theme-text-muted);font-size:0.875rem;">
                        ${positions_count || 0} positions ‚Ä¢ $${(total_value_usd || 0).toLocaleString()}
                      </div>
                      <div style="margin-top:0.5rem;color:var(--theme-text-muted);font-size:0.875rem;">
                        Coverage: ${(coverage*100).toFixed(0)}%
                      </div>
                    </div>
                  </div>`;

                const m = risk?.metrics || {};

                // Format percentage values (convert to %)
                const formatPct = (val) => ((val ?? 0) * 100).toFixed(2);

                // Key Metrics Table
                document.getElementById('riskMetrics').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td><strong>VaR (95%, 1d)</strong></td>
                        <td style="color:var(--danger)">${formatPct(m.var_95_1d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (30d)</strong></td>
                        <td>${formatPct(m.volatility_30d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (252d)</strong></td>
                        <td>${formatPct(m.volatility_252d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Max Drawdown</strong></td>
                        <td style="color:var(--danger)">${formatPct(m.max_drawdown)}%</td>
                      </tr>
                      <tr>
                        <td><strong>Sharpe Ratio</strong></td>
                        <td style="color:${(m.sharpe_ratio??0) > 1 ? 'var(--success)' : 'var(--theme-text)'}">${(m.sharpe_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Sortino Ratio</strong></td>
                        <td>${(m.sortino_ratio??0).toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>`;

                // Additional Metrics
                document.getElementById('riskStructure').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td><strong>Beta (Portfolio)</strong></td>
                        <td>${(m.beta_portfolio??1.0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Calmar Ratio</strong></td>
                        <td>${(m.calmar_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td><strong>Volatility (90d)</strong></td>
                        <td>${formatPct(m.volatility_90d)}%</td>
                      </tr>
                      <tr>
                        <td><strong>VaR Method</strong></td>
                        <td style="text-transform:capitalize;">${m.var_method || 'historical'}</td>
                      </tr>
                      <tr>
                        <td><strong>Drawdown Days</strong></td>
                        <td>${m.drawdown_days ?? 'N/A'}</td>
                      </tr>
                    </tbody>
                  </table>`;

            } catch (e) {
                debugLogger.error('Risk analytics load failed', e);
                document.getElementById('riskSummary').innerHTML = `
                  <div class="error-message">
                    <strong>Erreur de chargement</strong><br>
                    ${e.message}<br>
                    <small style="opacity:0.8;">V√©rifiez que yfinance est install√© et que les donn√©es sont disponibles.</small>
                  </div>`;
                document.getElementById('riskMetrics').innerHTML = '';
                document.getElementById('riskStructure').innerHTML = '';
                document.getElementById('mlInsights').innerHTML = '';
            }

            // Load ML Insights in parallel (don't block risk metrics)
            loadMLInsights().catch(err => {
                debugLogger.warn('ML insights loading failed (non-blocking)', err);
            });

            // Load Specialized Analytics in parallel (don't block risk metrics)
            loadSpecializedAnalytics().catch(err => {
                debugLogger.warn('Specialized analytics loading failed (non-blocking)', err);
            });
        }

        // Load ML Insights & Predictions (async, non-blocking)
        async function loadMLInsights() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                document.getElementById('mlBadge').textContent = 'Analyzing...';

                // Get top 3 stocks from portfolio for predictions
                const topStocks = currentPortfolioData?.summary?.top_holdings?.slice(0, 3) || [];
                if (topStocks.length === 0) {
                    document.getElementById('mlInsights').innerHTML = '<div class="no-data">Aucune position disponible pour ML</div>';
                    document.getElementById('mlBadge').textContent = 'No data';
                    return;
                }

                const benchmark = 'SPY'; // S&P500 as default benchmark
                const firstStock = topStocks[0]?.symbol || 'AAPL';

                // Fetch ML predictions in parallel (direct URLs, no globalConfig params)
                const baseUrl = window.location.origin;
                const [regimeRes, volatilityRes] = await Promise.all([
                    safeFetch(`${baseUrl}/api/ml/bourse/regime?benchmark=${benchmark}&lookback_days=365`),
                    safeFetch(`${baseUrl}/api/ml/bourse/forecast?symbol=${firstStock}&lookback_days=365`)
                ]);

                const regime = regimeRes?.data || regimeRes || {};
                const volatility = volatilityRes?.data || volatilityRes || {};

                // Get regime color
                const getRegimeColor = (reg) => {
                    const r = String(reg).toLowerCase();
                    if (r.includes('bull')) return 'var(--success)';
                    if (r.includes('bear')) return 'var(--danger)';
                    if (r.includes('consolidation')) return 'var(--warning)';
                    return 'var(--info)';
                };

                const regimeColor = getRegimeColor(regime.current_regime);
                const regimeConfidence = ((regime.confidence || 0) * 100).toFixed(0);

                // Extract volatility predictions
                const vol1d = volatility.predictions?.['1d']?.predicted_volatility;
                const vol7d = volatility.predictions?.['7d']?.predicted_volatility;
                const vol30d = volatility.predictions?.['30d']?.predicted_volatility;

                // Build ML Insights HTML
                document.getElementById('mlInsights').innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:1.5rem;">
                        <!-- Market Regime -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Market Regime</div>
                            <div style="font-size:1.25rem;font-weight:700;color:${regimeColor};margin-bottom:0.25rem;">
                                ${regime.current_regime || 'Unknown'}
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);">
                                Confidence: ${regimeConfidence}% ‚Ä¢ ${regime.benchmark || benchmark}
                            </div>
                        </div>

                        <!-- Volatility Forecast -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Volatility Forecast (${firstStock})</div>
                            <div style="display:flex;gap:1rem;align-items:baseline;">
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">1d</div>
                                    <div style="font-weight:600;">${vol1d ? (vol1d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">7d</div>
                                    <div style="font-weight:600;">${vol7d ? (vol7d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">30d</div>
                                    <div style="font-weight:600;">${vol30d ? (vol30d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);margin-top:0.5rem;">
                                Model: ${volatility.model_type || 'Historical'}
                            </div>
                        </div>

                        <!-- Regime Characteristics -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Regime Characteristics</div>
                            ${Object.entries(regime.characteristics || {})
                                .map(([key, value]) => `
                                    <div style="display:flex;justify-content:space-between;margin:0.25rem 0;">
                                        <span style="font-size:0.8rem;text-transform:capitalize;">${key}:</span>
                                        <span style="font-size:0.8rem;font-weight:600;color:var(--theme-text);">${value}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>

                    <!-- Additional Regime Probabilities -->
                    ${Object.keys(regime.regime_probabilities || {}).length > 0 ? `
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.75rem;">Regime Probabilities</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;">
                                ${Object.entries(regime.regime_probabilities || {})
                                    .sort(([,a], [,b]) => b - a)
                                    .map(([regimeName, prob]) => `
                                        <div style="text-align:center;">
                                            <div style="font-weight:700;font-size:1.1rem;color:${getRegimeColor(regimeName)};">
                                                ${(prob * 100).toFixed(0)}%
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--theme-text-muted);margin-top:0.25rem;">
                                                ${regimeName}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top:1rem;padding:0.75rem;background:var(--info-bg);border-radius:var(--radius-sm);border:1px solid var(--info);font-size:0.875rem;color:var(--info);">
                        <strong>Note:</strong> ML predictions are based on ${volatility.lookback_days || 365} days of historical data.
                        ${volatility.note || regime.note ? `<br><em>${volatility.note || regime.note}</em>` : ''}
                    </div>
                `;

                document.getElementById('mlBadge').textContent = `${regime.model_type || 'ML'} Active`;
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--success) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--success)';

            } catch (error) {
                debugLogger.error('ML insights load failed', error);
                document.getElementById('mlInsights').innerHTML = `
                    <div style="padding:1rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius-md);">
                        <div style="color:var(--warning);margin-bottom:0.5rem;"><strong>‚ö†Ô∏è ML Predictions Unavailable</strong></div>
                        <div style="font-size:0.875rem;color:var(--theme-text-muted);">
                            ${error.message || 'Failed to load ML predictions'}
                            <br><small>Models may need training or data may be insufficient.</small>
                        </div>
                    </div>
                `;
                document.getElementById('mlBadge').textContent = 'Fallback';
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--warning) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--warning)';
            }
        }

        // ==================== SPECIALIZED ANALYTICS ====================

        // Load all specialized analytics (called from loadRiskAnalytics)
        async function loadSpecializedAnalytics() {
            // Load portfolio-wide analytics
            await Promise.all([
                loadSectorRotation().catch(err => debugLogger.warn('Sector rotation failed', err)),
                loadMarginMonitoring().catch(err => debugLogger.warn('Margin monitoring failed', err))
            ]);

            // Populate ticker selector
            populateTickerSelector();
        }

        // Load Sector Rotation Analysis
        async function loadSectorRotation() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('sectorRotation').innerHTML = '<div class="loading">Analyzing sectors‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/sector-rotation?user_id=${activeUser}&lookback_days=60`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Sector rotation failed');

                const data = response.data || response;
                const sectors = data.sectors || {};
                const hotSectors = data.hot_sectors || [];
                const coldSectors = data.cold_sectors || [];

                // Sort sectors by momentum
                const sortedSectors = Object.entries(sectors)
                    .sort((a, b) => (b[1].momentum || 0) - (a[1].momentum || 0));

                document.getElementById('sectorRotation').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); background: color-mix(in oklab, var(--${data.rotation_detected ? 'warning' : 'info'}) 10%, transparent); color: var(--${data.rotation_detected ? 'warning' : 'info'}); font-size: 0.75rem; font-weight: 600;">
                            ${data.rotation_detected ? 'üîÑ Rotation Detected' : 'üìä No Rotation'}
                        </div>
                        <span style="margin-left: 1rem; font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_sectors} sectors analyzed over ${data.lookback_days} days
                        </span>
                    </div>

                    <table class="positions-table" style="margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th>Sector</th>
                                <th>Return</th>
                                <th>Momentum</th>
                                <th>Signal</th>
                                <th>Positions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedSectors.map(([name, data]) => {
                                const signalColor = data.signal === 'overweight' ? 'var(--success)' :
                                                   data.signal === 'underweight' ? 'var(--danger)' : 'var(--theme-text-muted)';
                                const signalIcon = data.signal === 'overweight' ? 'üî•' :
                                                  data.signal === 'underweight' ? '‚ùÑÔ∏è' : '‚ûñ';
                                return `
                                    <tr>
                                        <td style="font-weight: 600;">${name}</td>
                                        <td style="color: ${data.return >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                            ${data.return >= 0 ? '+' : ''}${data.return.toFixed(2)}%
                                        </td>
                                        <td>${data.momentum.toFixed(2)}x</td>
                                        <td style="color: ${signalColor}; font-weight: 600;">
                                            ${signalIcon} ${data.signal.toUpperCase()}
                                        </td>
                                        <td>${data.num_positions}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('sectorBadge').textContent = `${hotSectors.length} hot, ${coldSectors.length} cold`;
                document.getElementById('sectorBadge').style.background = data.rotation_detected ?
                    'color-mix(in oklab, var(--warning) 10%, transparent)' : '';
                document.getElementById('sectorBadge').style.color = data.rotation_detected ? 'var(--warning)' : '';

            } catch (error) {
                debugLogger.error('Sector rotation failed', error);
                document.getElementById('sectorRotation').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load sector rotation data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Margin Monitoring
        async function loadMarginMonitoring() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('marginMonitoring').innerHTML = '<div class="loading">Calculating margin metrics‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/margin?user_id=${activeUser}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Margin monitoring failed');

                const data = response.data || response;

                const warningLevel = data.warnings.length > 0 ?
                    (data.warnings.some(w => w.includes('CRITICAL')) ? 'danger' : 'warning') : 'success';

                // Margin call distance color
                const marginColor = data.margin_call_distance < 10 ? 'var(--danger)' :
                                   data.margin_call_distance < 20 ? 'var(--warning)' : 'var(--success)';

                document.getElementById('marginMonitoring').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Utilization</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.margin_utilization.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                $${(data.total_margin_used || 0).toLocaleString()} / $${(data.account_equity || 0).toLocaleString()}
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Leverage</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.current_leverage.toFixed(2)}x</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                Optimal: ${data.optimal_leverage.toFixed(2)}x
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Call Distance</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${marginColor};">${data.margin_call_distance.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                ${data.margin_call_distance >= 50 ? '‚úÖ Very Safe' :
                                  data.margin_call_distance >= 20 ? '‚ö†Ô∏è Monitor' : 'üö® Risk'}
                            </div>
                        </div>
                    </div>

                    ${data.warnings.length > 0 ? `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${warningLevel}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${warningLevel}); font-size: 0.875rem;">
                            <strong style="color: var(--${warningLevel});">‚ö†Ô∏è Warnings (${data.warnings.length}):</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: var(--${warningLevel});">
                                ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--success); font-size: 0.875rem; color: var(--success);">
                            ‚úÖ No margin warnings - Portfolio is healthy
                        </div>
                    `}

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('marginBadge').textContent = data.warnings.length > 0 ?
                    `${data.warnings.length} warnings` : 'Healthy';
                document.getElementById('marginBadge').style.background = `color-mix(in oklab, var(--${warningLevel}) 10%, transparent)`;
                document.getElementById('marginBadge').style.color = `var(--${warningLevel})`;

            } catch (error) {
                debugLogger.error('Margin monitoring failed', error);
                document.getElementById('marginMonitoring').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load margin data: ${error.message}
                    </div>
                `;
            }
        }

        // Populate ticker selector with portfolio tickers
        function populateTickerSelector() {
            const selector = document.getElementById('tickerSelector');
            if (!currentPortfolioData || !currentPortfolioData.positions) {
                return;
            }

            // Get unique tickers from positions
            const tickers = [...new Set(currentPortfolioData.positions.map(p => p.ticker || p.symbol))].filter(Boolean).sort();

            selector.innerHTML = '<option value="">Select a ticker...</option>' +
                tickers.map(ticker => `<option value="${ticker}">${ticker}</option>`).join('');

            // Add change event listener
            selector.onchange = (e) => {
                const ticker = e.target.value;
                if (ticker) {
                    document.getElementById('tickerAnalytics').style.display = 'block';
                    document.getElementById('tickerPlaceholder').style.display = 'none';
                    loadTickerSpecificAnalytics(ticker);
                } else {
                    document.getElementById('tickerAnalytics').style.display = 'none';
                    document.getElementById('tickerPlaceholder').style.display = 'block';
                }
            };
        }

        // Load ticker-specific analytics (Beta, Earnings, Dividends)
        async function loadTickerSpecificAnalytics(ticker) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            // Load all ticker analytics in parallel
            await Promise.all([
                loadBetaForecast(ticker, activeUser),
                loadEarningsPredictor(ticker, activeUser),
                loadDividendAnalysis(ticker, activeUser)
            ]);
        }

        // Load Beta Forecast for ticker
        async function loadBetaForecast(ticker, activeUser) {
            try {
                document.getElementById('betaForecast').innerHTML = '<div class="loading">Loading beta forecast‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/beta-forecast?user_id=${activeUser}&ticker=${ticker}&benchmark=SPY`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Beta forecast failed');

                const data = response.data || response;

                const trendColor = data.beta_trend === 'increasing' ? 'var(--danger)' :
                                  data.beta_trend === 'decreasing' ? 'var(--success)' : 'var(--theme-text-muted)';
                const trendIcon = data.beta_trend === 'increasing' ? 'üìà' :
                                 data.beta_trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';

                document.getElementById('betaForecast').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Beta</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.current_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Forecast (EWMA)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.forecasted_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Trend</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${trendColor};">
                                ${trendIcon} ${data.beta_trend}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">R¬≤ (Fit Quality)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.r_squared * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Annual Alpha</div>
                            <div style="font-size: 1rem; font-weight: 600; color: ${data.alpha >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.alpha >= 0 ? '+' : ''}${data.alpha.toFixed(2)}%
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Volatility Ratio</div>
                            <div style="font-size: 1rem; font-weight: 600;">${data.volatility_ratio.toFixed(2)}x vs SPY</div>
                        </div>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Based on ${data.observation_days} days of returns ‚Ä¢ Forecast method: ${data.forecast_method}
                    </div>
                `;

            } catch (error) {
                debugLogger.error('Beta forecast failed', error);
                document.getElementById('betaForecast').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load beta forecast: ${error.message}
                    </div>
                `;
            }
        }

        // Load Earnings Predictor for ticker
        async function loadEarningsPredictor(ticker, activeUser) {
            try {
                document.getElementById('earningsPredictor').innerHTML = '<div class="loading">Loading earnings data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/earnings?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Earnings predictor failed');

                const data = response.data || response;

                const alertColor = data.alert_level === 'high' ? 'var(--danger)' :
                                  data.alert_level === 'medium' ? 'var(--warning)' : 'var(--info)';

                document.getElementById('earningsPredictor').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Alert Level</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${alertColor}; text-transform: uppercase;">
                                ${data.alert_level}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Pre-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.pre_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Post-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${(data.post_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Vol Increase</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">+${data.vol_increase_pct.toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${data.alert_level === 'low' ? 'info' : 'warning'}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${data.alert_level === 'low' ? 'info' : 'warning'}); font-size: 0.875rem;">
                        <strong style="color: var(--${data.alert_level === 'low' ? 'info' : 'warning'});">üí° ${data.recommendation}</strong>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Avg post-earnings move: ${data.avg_post_earnings_move.toFixed(2)}%
                        ${data.next_earnings_date ? ` ‚Ä¢ Next earnings: ${data.next_earnings_date}` : ''}
                    </div>
                `;

            } catch (error) {
                debugLogger.error('Earnings predictor failed', error);
                document.getElementById('earningsPredictor').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load earnings data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Dividend Analysis for ticker
        async function loadDividendAnalysis(ticker, activeUser) {
            try {
                document.getElementById('dividendAnalysis').innerHTML = '<div class="loading">Loading dividend data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/dividends?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Dividend analysis failed');

                const data = response.data || response;

                if (!data.has_dividend_data || data.current_yield === 0) {
                    document.getElementById('dividendAnalysis').innerHTML = `
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚ÑπÔ∏è No dividend data available for ${ticker}
                        </div>
                    `;
                    return;
                }

                document.getElementById('dividendAnalysis').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Yield</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.current_yield.toFixed(2)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Annual Dividend</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">$${data.annual_dividend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Frequency</div>
                            <div style="font-size: 1rem; font-weight: 600; text-transform: capitalize;">${data.payout_frequency}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Growth Rate (YoY)</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${data.dividend_growth_rate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.dividend_growth_rate >= 0 ? '+' : ''}${data.dividend_growth_rate.toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    ${data.next_ex_dividend_date ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üìÖ Next Ex-Dividend:</strong> ${data.next_ex_dividend_date}
                            ${data.days_until_ex_dividend ? ` (in ${data.days_until_ex_dividend} days)` : ''}
                            <br><small>Expected price drop: ~${data.avg_price_drop_ex_div.toFixed(2)}%</small>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                debugLogger.error('Dividend analysis failed', error);
                document.getElementById('dividendAnalysis').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load dividend data: ${error.message}
                    </div>
                `;
            }
        }

        // Load current Saxo data from active source (via WealthContextBar)
        async function loadCurrentSaxoData() {
            debugLogger.debug('üè¶ Loading Saxo data from active source...');

            try {
                // Show loading state
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('mainContent').innerHTML = '<div class="loading">üìä Chargement des donn√©es Bourse...</div>';
                document.getElementById('dashboardContent').style.display = 'none';

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // Build URL with file_key if available
                let portfoliosUrl = '/api/saxo/portfolios';
                if (currentFileKey) {
                    portfoliosUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading portfolio with file_key: ${currentFileKey}`);
                }

                // Step 1: List available portfolios
                const { ok: listOk, data: listData } = await safeFetch(globalConfig.getApiUrl(portfoliosUrl), {
                    headers: { 'X-User': activeUser }
                });

                if (!listOk || !listData?.portfolios || listData.portfolios.length === 0) {
                    debugLogger.warn('Aucun portfolio Saxo disponible.');
                    showNoDataState('üìÇ Aucune donn√©e Saxo disponible');
                    return;
                }

                // Step 2: Load the first portfolio (or find the one matching the source)
                const portfolio = listData.portfolios[0];
                const portfolioId = portfolio.portfolio_id;

                if (!portfolioId) {
                    debugLogger.warn('Portfolio ID manquant.');
                    showNoDataState('‚ùå Erreur: Portfolio ID manquant');
                    return;
                }

                // Step 3: Load full portfolio details
                let detailUrl = `/api/saxo/portfolios/${portfolioId}`;
                if (currentFileKey) {
                    detailUrl += `?file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const { ok: detailOk, data: portfolioData } = await safeFetch(globalConfig.getApiUrl(detailUrl), {
                    headers: { 'X-User': activeUser }
                });

                if (!detailOk || !portfolioData) {
                    debugLogger.warn('Erreur lors du chargement du portfolio.');
                    showNoDataState('‚ùå Erreur lors du chargement du portfolio');
                    return;
                }

                // Store portfolio data
                currentPortfolioData = portfolioData;

                // Hide main content and show dashboard
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Load all sections
                loadOverviewData(currentPortfolioData);

                // Refresh active tab content after data load
                refreshActiveTab();

                debugLogger.debug('‚úÖ Saxo data loaded successfully');

            } catch (error) {
                debugLogger.error('Error loading Saxo data:', error);
                showError('‚ùå Erreur lors du chargement des donn√©es: ' + error.message);
            }
        }

        function loadOverviewData(data) {
            // Safe access to data properties
            const summary = data?.summary || {};
            const totalValue = Number(summary.total_value_usd || 0);
            const totalPositions = summary.total_positions || data?.positions?.length || 0;
            const assetAllocation = summary.asset_allocation || {};
            const currencyExposure = summary.currency_exposure || {};

            // Portfolio Summary
            const summaryHtml = `
                <div class="metric-large">$${totalValue.toLocaleString()}</div>
                <div class="metric-label">Total Portfolio Value</div>
                <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Positions:</span>
                        <span><strong>${totalPositions}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Asset Classes:</span>
                        <span><strong>${Object.keys(assetAllocation).length}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Currencies:</span>
                        <span><strong>${Object.keys(currencyExposure).length}</strong></span>
                    </div>
                </div>
            `;
            document.getElementById('portfolioSummary').innerHTML = summaryHtml;

            // Asset Allocation
            const allocationHtml = Object.keys(assetAllocation).length > 0 ? `
                <div class="allocation-grid">
                    ${Object.entries(assetAllocation)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => `
                            <div class="allocation-item">
                                <div class="allocation-percentage">${Number(percentage).toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                            </div>
                        `).join('')}
                </div>
            ` : '<div class="no-data">Aucune donn√©e d\'allocation disponible</div>';
            document.getElementById('assetAllocation').innerHTML = allocationHtml;

            // Top Holdings
            const topHoldings = summary.top_holdings || data?.positions?.slice(0, 10) || [];
            const holdingsHtml = topHoldings.length > 0 ? `
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Symbol</th>
                            <th>Market Value</th>
                            <th>Asset Class</th>
                            <th>Weight</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topHoldings.map(position => {
                            const name = position.name || position.instrument || position.symbol || 'Unknown';
                            const symbol = position.symbol || 'N/A';
                            const displayName = name !== symbol ? name : (position.isin || name);
                            return `
                            <tr>
                                <td><strong>${displayName}</strong></td>
                                <td><code style="font-size: 0.85rem; color: var(--theme-text-muted);">${symbol}</code></td>
                                <td>$${Number(position.market_value_usd || position.market_value || 0).toLocaleString()}</td>
                                <td>
                                    <span class="asset-class-badge asset-class-${(position.asset_class || 'other').toLowerCase()}">
                                        ${position.asset_class || 'N/A'}
                                    </span>
                                </td>
                                <td>${totalValue > 0 ? (((position.market_value_usd || position.market_value || 0) / totalValue) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            ` : '<div class="no-data">Aucune position trouv√©e</div>';
            document.getElementById('topHoldings').innerHTML = holdingsHtml;
        }

        function loadAllPositions() {
            if (!currentPortfolioData) return;

            const positionsHtml = `
                <div class="table-container">
                    <table class="positions-table">
                        <thead>
                            <tr>
                                <th>Instrument</th>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Market Value</th>
                                <th>Currency</th>
                                <th>Asset Class</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentPortfolioData.positions
                    .sort((a, b) => b.market_value_usd - a.market_value_usd)
                    .map(position => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        return `
                                <tr>
                                    <td>
                                        <strong>${displayName}</strong>
                                        ${position.isin ? `<div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-top: 0.25rem;">ISIN: ${position.isin}</div>` : ''}
                                    </td>
                                    <td><code style="font-size: 0.85rem;">${symbol}</code></td>
                                    <td>${position.quantity.toLocaleString()}</td>
                                    <td><strong>$${position.market_value_usd.toLocaleString()}</strong></td>
                                    <td>${position.currency}</td>
                                    <td>
                                        <span class="asset-class-badge asset-class-${position.asset_class.toLowerCase()}">
                                            ${position.asset_class}
                                        </span>
                                    </td>
                                    <td>${((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100).toFixed(1)}%</td>
                                </tr>
                        `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('allPositions').innerHTML = positionsHtml;
            document.getElementById('positionsCount').textContent = `${currentPortfolioData.positions.length} positions`;
        }

        function loadAllocationDetails() {
            if (!currentPortfolioData) return;

            // Asset class breakdown
            const assetClassHtml = `
                <div class="allocation-grid">
                    ${Object.entries(currentPortfolioData.summary.asset_allocation)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => `
                            <div class="allocation-item">
                                <div class="allocation-percentage">${percentage.toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(currentPortfolioData.summary.total_value_usd * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('assetClassBreakdown').innerHTML = assetClassHtml;

            // Holdings by value
            const holdingsByValueHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${currentPortfolioData.summary.top_holdings.map((position, index) => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--theme-border);">
                            <div>
                                <div style="font-weight: 600;">${index + 1}. ${displayName}</div>
                                <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                    ${symbol} ‚Ä¢ ${position.asset_class}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${position.market_value_usd.toLocaleString()}</div>
                                <div style="font-size: 0.8rem; color: var(--theme-text-muted);">
                                    ${((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            document.getElementById('holdingsByValue').innerHTML = holdingsByValueHtml;
        }

        function loadCurrencyDetails() {
            if (!currentPortfolioData) return;

            const currencyHtml = `
                <div class="currency-grid">
                    ${Object.entries(currentPortfolioData.summary.currency_exposure)
                    .sort(([, a], [, b]) => b - a)
                    .map(([currency, percentage]) => `
                            <div class="currency-item">
                                <div class="currency-percentage">${percentage.toFixed(1)}%</div>
                                <div class="currency-code">${currency}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(currentPortfolioData.summary.total_value_usd * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                </div>
                <div style="margin-top: 2rem; padding: 1rem; background: var(--info-bg); border-radius: var(--radius-md); border: 1px solid var(--info);">
                    <div style="font-size: 0.875rem; color: var(--info);">
                        <strong>Note:</strong> Currency exposure is calculated based on the original currency of each position.
                        USD values are converted using estimated exchange rates.
                    </div>
                </div>
            `;
            document.getElementById('currencyExposure').innerHTML = currencyHtml;
        }

        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">${message}</div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showNoDataState(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="no-data">
                    <h3>üìÇ Aucune donn√©e disponible</h3>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            debugLogger.debug('üè¶ Saxo Dashboard initialized');

            // Initialize wealth context integration
            initWealthContextIntegration();

            // Listen for Bourse source changes from WealthContextBar
            window.addEventListener('bourseSourceChanged', async (event) => {
                debugLogger.debug('üîÑ Bourse source changed:', event.detail);

                // Resolve file_key from source (same logic as wealth-saxo-summary.js)
                const bourseSource = window.wealthContextBar?.getContext()?.bourse;
                currentFileKey = null; // Reset

                if (bourseSource && bourseSource !== 'all' && bourseSource.startsWith('saxo:')) {
                    const key = bourseSource.substring(5); // Remove 'saxo:' prefix
                    const activeUser = localStorage.getItem('activeUser') || 'demo';

                    try {
                        // Load available sources to resolve file_key
                        if (!window.availableSources) {
                            const response = await fetch('/api/users/sources', {
                                headers: { 'X-User': activeUser }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                window.availableSources = data.sources || [];
                            }
                        }

                        // Find matching source and extract filename
                        const source = window.availableSources?.find(s => s.key === key);
                        if (source?.file_path) {
                            currentFileKey = source.file_path.split(/[/\\]/).pop();
                            debugLogger.debug(`üìÑ Resolved file_key: ${currentFileKey}`);
                        }
                    } catch (err) {
                        debugLogger.warn('[Saxo Dashboard] Failed to resolve file_key:', err);
                    }
                }

                // Reload data with new source
                loadCurrentSaxoData();
            });

            // Load current Saxo data from active source
            await loadCurrentSaxoData();
        });
    </script>
</body>

</html>