<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Stock Market Dashboard - SmartFolio</title>
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <link rel="stylesheet" href="css/saxo-dashboard.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module">
        import { initDeepLinks } from './components/deep-links.js';
        import { wealthContextBar } from './components/WealthContextBar.js';
        import { safeFetch } from './modules/http.js';

        // Anchors for saxo-dashboard.html
        initDeepLinks({
            'overview': 'Overview',
            'positions': 'Positions',
            'allocation': 'Allocation',
            'performance': 'Performance'
        });

        window.wealthContextBar = wealthContextBar;
        window.safeFetch = safeFetch;
    </script>
    <script src="debug-logger.js"></script>
    <script src="components/toast.js" type="module"></script>
  <script src="global-config.js"></script>
    <script src="appearance.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- Plotly.js: Lazy loaded on demand for heatmaps/dendrograms (saves 3 MB on initial load) -->
    <!-- jsPDF and html2canvas: Lazy loaded on demand (saves 1 MB initial load) -->

</head>

<body>
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div>
                    <h1>üìà Dashboard Bourse (Saxo Bank)</h1>
                    <p style="color: var(--theme-text-muted); margin: 0;">Analyse de votre portefeuille actions</p>
                </div>
                <span
                    id="cacheIndicator"
                    style="display: none; padding: 0.25rem 0.75rem; background: var(--success); color: white; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">
                    ‚ö° Cached
                </span>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <button
                    id="btnAskAI"
                    onclick="openAIChatModal()"
                    style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"
                    title="Discuter avec l'IA pour analyser votre portefeuille">
                    ü§ñ Ask AI
                </button>
                <button
                    id="btnForceRefresh"
                    onclick="loadCurrentSaxoData(true)"
                    style="padding: 0.75rem 1.25rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"
                    title="Forcer le rechargement des donn√©es (bypass cache)">
                    üîÑ Actualiser
                </button>
            </div>
        </div>


        <!-- Main Content (initially empty, filled by loadCurrentSaxoData) -->
        <div id="mainContent">
            <div class="loading">üìä Chargement initial...</div>
        </div>

        <!-- Dashboard Content (hidden by default) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview', event)">Vue d'ensemble</button>
                <button class="tab-btn" onclick="switchTab('positions', event)">Positions</button>
                <button class="tab-btn" onclick="switchTab('risk', event)">Risk</button>
                <button class="tab-btn" onclick="switchTab('analytics', event)">Analytics</button>
                <button class="tab-btn" onclick="switchTab('recommendations', event)">Recommendations</button>
                <button class="tab-btn" onclick="switchTab('opportunities', event)">Market Opportunities</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Portfolio Summary -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Portfolio Summary</h3>
                            <div class="card-badge" id="portfolioBadge">Read-Only</div>
                        </div>
                        <div id="portfolioSummary">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Asset Allocation & Currency Exposure -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Asset Allocation & Currency Exposure</h3>
                        </div>
                        <div id="assetAllocationCurrency">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Asset Allocation Chart -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Allocation Breakdown</h3>
                        </div>
                        <div style="padding: 1.5rem; display: flex; justify-content: center; align-items: center;">
                            <canvas id="allocationChart" style="max-width: 350px; max-height: 350px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Holdings -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Top 10 Holdings</h3>
                    </div>
                    <div id="topHoldings">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div id="positions" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">All Positions</h3>
                        <div class="card-badge" id="positionsCount">0 positions</div>
                    </div>
                    <div id="allPositions">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Risk Tab -->
            <!-- Risk Tab (Essential Metrics Only) -->
            <div id="risk" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Risk Score (Bourse)</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="exportRiskPDF()" style="padding: 0.5rem 1rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üìÑ Export PDF
                            </button>
                        </div>
                    </div>
                    <div id="riskSummary"><div class="loading">Calcul en cours‚Ä¶</div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">M√©triques principales</h3></div>
                        <div id="riskMetrics" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header"><h3 class="card-title">Concentration & Diversification</h3></div>
                        <div id="riskStructure" class="table-wrapper"><div class="loading">‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Alerts Section (placeholder for critical warnings) -->
                <div class="dashboard-card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">‚ö†Ô∏è Critical Alerts</h3>
                        <div class="card-badge" id="alertsBadge">0 active</div>
                    </div>
                    <div id="criticalAlerts">
                        <div style="padding: 1.5rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚úÖ No critical alerts. Portfolio within safe thresholds.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab (Advanced Features) -->
            <div id="analytics" class="tab-content">
                <!-- ML Insights Section -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">ü§ñ ML Insights & Predictions</h3>
                        <div class="card-badge" id="mlBadge">Loading...</div>
                    </div>
                    <div id="mlInsights"><div class="loading">Chargement des pr√©dictions ML‚Ä¶</div></div>
                </div>

                <!-- Advanced Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üìä Advanced Analytics
                    </h2>

                    <!-- Correlation Heatmap -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üîó Correlation Matrix & Clustering</h3>
                            <div class="card-badge" id="correlationBadge">Portfolio-wide</div>
                        </div>
                        <div id="correlationAnalysis"><div class="loading">Loading correlation matrix‚Ä¶</div></div>
                    </div>

                    <!-- Stress Testing -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üí• Stress Testing Scenarios</h3>
                            <div class="card-badge" id="stressBadge">Interactive</div>
                        </div>
                        <div id="stressTestingUI"><div class="loading">Loading stress testing‚Ä¶</div></div>
                    </div>

                    <!-- ML Regime History -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">ü§ñ ML Regime History & Forecast</h3>
                            <div class="card-badge" id="regimeBadge">SPY Benchmark</div>
                        </div>
                        <div id="regimeHistory"><div class="loading">Loading ML regime history‚Ä¶</div></div>
                    </div>
                </div>

                <!-- Specialized Analytics Section -->
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--theme-text);">
                        üéØ Specialized Analytics
                    </h2>

                    <!-- Sector Rotation -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üìä Sector Rotation Analysis</h3>
                            <div class="card-badge" id="sectorBadge">Portfolio-wide</div>
                        </div>
                        <div id="sectorRotation"><div class="loading">Loading sector rotation data‚Ä¶</div></div>
                    </div>

                    <!-- Margin Monitoring -->
                    <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">‚ö†Ô∏è Margin Monitoring</h3>
                            <div class="card-badge" id="marginBadge">Portfolio-wide</div>
                        </div>
                        <div id="marginMonitoring"><div class="loading">Loading margin data‚Ä¶</div></div>
                    </div>

                    <!-- Ticker-Specific Analytics -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">üîç Ticker-Specific Analysis</h3>
                            <select id="tickerSelector" style="padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text); font-size: 0.875rem;">
                                <option value="">Select a ticker...</option>
                            </select>
                        </div>

                        <div id="tickerAnalytics" style="display: none;">
                            <!-- Beta Forecast -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìà Beta Forecast vs SPY</h4>
                                <div id="betaForecast"><div class="loading">Loading beta forecast‚Ä¶</div></div>
                            </div>

                            <!-- Earnings Predictor -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÖ Earnings Impact Prediction</h4>
                                <div id="earningsPredictor"><div class="loading">Loading earnings data‚Ä¶</div></div>
                            </div>

                            <!-- Dividend Analysis -->
                            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); margin-top: 1rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üí∞ Dividend Analysis</h4>
                                <div id="dividendAnalysis"><div class="loading">Loading dividend data‚Ä¶</div></div>
                            </div>
                        </div>

                        <div id="tickerPlaceholder" style="padding: 2rem; text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            üëÜ Select a ticker above to view Beta Forecast, Earnings Predictor, and Dividend Analysis
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendations" class="tab-content">
                <!-- Market Context Banner -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, #1e40af) 100%); color: white;">
                    <div style="padding: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: white;">
                            üìä Portfolio Recommendations
                        </h2>
                        <div id="marketContext" style="display: flex; gap: 2rem; margin-top: 1rem; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Market Regime</div>
                                <div id="contextRegime" style="font-size: 1.125rem; font-weight: 600;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Overall Posture</div>
                                <div id="contextPosture" style="font-size: 1.125rem; font-weight: 600;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Last Update</div>
                                <div id="contextUpdate" style="font-size: 1.125rem; font-weight: 600;">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeframe Selector & Summary -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 class="card-title">Investment Horizon</h3>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--theme-text-muted);">Select your timeframe for optimized recommendations</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="timeframe-btn" data-timeframe="short">
                                <div style="font-weight: 600;">1-2 Weeks</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Trading</div>
                            </button>
                            <button class="timeframe-btn active" data-timeframe="medium">
                                <div style="font-weight: 600;">1 Month</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Tactical</div>
                            </button>
                            <button class="timeframe-btn" data-timeframe="long">
                                <div style="font-weight: 600;">3-6 Months</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Strategic</div>
                            </button>

                            <!-- Vertical separator -->
                            <div style="border-left: 1px solid var(--theme-border); height: 2rem; margin: 0 0.5rem;"></div>

                            <!-- Scan button -->
                            <button id="btnScanRecommendations" class="btn primary small" style="padding: 0.5rem 1rem;">
                                üîç Scan
                            </button>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div id="recSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; padding: 1rem; border-top: 1px solid var(--theme-border);">
                        <div style="text-align: center; color: var(--theme-text-muted); padding: 1rem;">
                            üìä Click "Scan" to analyze your portfolio and get recommendations
                        </div>
                    </div>
                </div>

                <!-- Filters & Search -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding: 1rem;">
                        <input
                            type="text"
                            id="recSearch"
                            placeholder="üîç Search by symbol or name..."
                            style="flex: 1; min-width: 200px; padding: 0.5rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);"
                        />
                        <select
                            id="recFilter"
                            style="padding: 0.5rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--theme-border); background: var(--theme-surface); color: var(--theme-text);"
                        >
                            <option value="all">All Actions</option>
                            <option value="STRONG BUY">Strong Buy</option>
                            <option value="BUY">Buy</option>
                            <option value="HOLD">Hold</option>
                            <option value="SELL">Sell</option>
                            <option value="STRONG SELL">Strong Sell</option>
                        </select>
                    </div>
                </div>

                <!-- Recommendations Table -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Position Recommendations</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button id="btnExportTextRecs" class="btn secondary small" style="padding: 0.35rem 0.75rem; font-size: 0.75rem;">
                                üìÑ Export Text (All Timeframes)
                            </button>
                            <div class="card-badge" id="recCount">0 positions</div>
                        </div>
                    </div>
                    <div id="recommendationsTable">
                        <div style="padding: 3rem; text-align: center; color: var(--theme-text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">Ready to Analyze</div>
                            <div style="font-size: 0.875rem;">Click the "Scan" button above to get personalized recommendations for your portfolio</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Opportunities Tab -->
            <div id="opportunities" class="tab-content">
                <!-- Banner -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <div style="padding: 1rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; color: white;">
                            üåç Market Opportunities
                        </h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">
                            Discover underweight sectors and new investment opportunities.
                        </p>
                    </div>
                </div>

                <!-- Horizon Selector & Actions -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="flex-wrap: wrap; gap: 1rem; align-items: center;">
                        <div>
                            <h3 class="card-title">Scan Configuration</h3>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <!-- Horizon buttons -->
                            <button class="timeframe-btn" data-opp-horizon="short">
                                <div style="font-weight: 600;">1-3 Months</div>
                            </button>
                            <button class="timeframe-btn active" data-opp-horizon="medium">
                                <div style="font-weight: 600;">6-12 Months</div>
                            </button>
                            <button class="timeframe-btn" data-opp-horizon="long">
                                <div style="font-weight: 600;">2-3 Years</div>
                            </button>
                            
                            <!-- Vertical separator -->
                            <div style="border-left: 1px solid var(--theme-border); height: 2rem; margin: 0 0.5rem;"></div>

                            <!-- Action buttons -->
                            <button id="btnScanOpportunities" class="btn primary small" style="padding: 0.5rem 1rem;">
                                üîç Scan
                            </button>
                            <button id="btnExportTextOpps" class="btn secondary small" style="padding: 0.5rem 1rem;">
                                üìÑ Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Gaps (Sectors) -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">üìä Portfolio Gaps (Underweight Sectors)</h3>
                        <div class="card-badge" id="gapsCount">0 gaps</div>
                    </div>
                    <div id="portfolioGaps">
                        <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                            Click "Scan for Opportunities" to identify sector gaps
                        </div>
                    </div>
                </div>

                <!-- Top Opportunities -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Top Opportunities</h3>
                        <div class="card-badge" id="opportunitiesCount">0 opportunities</div>
                    </div>
                    <div id="opportunitiesTable">
                        <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                            No opportunities yet. Run scan first.
                        </div>
                    </div>
                </div>

                <!-- Suggested Sales -->
                <div class="dashboard-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">üí∞ Suggested Sales (To Fund Opportunities)</h3>
                        <div class="card-badge" id="salesCount">0 suggestions</div>
                    </div>
                    <div id="suggestedSales">
                        <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                            No sales suggestions yet. Run scan first.
                        </div>
                    </div>
                </div>

                <!-- Impact Simulator -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Reallocation Impact Simulator</h3>
                        <div class="card-badge">Before / After</div>
                    </div>
                    <div id="impactSimulator">
                        <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                            Impact analysis will appear here after scan
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentPortfolioData = null;
        let positionsSortState = {
            column: 'market_value',
            ascending: false
        };
        let currentWealthContext = {
            module: 'bourse'
        };
        let currentFileKey = null;  // Track selected Saxo file

        // Initialize wealth context integration
        function initWealthContextIntegration() {
            debugLogger.debug('üè¶ Initializing WealthContextBar integration for Saxo dashboard...');

            if (!window.wealthContextBar) {
                debugLogger.warn('WealthContextBar not available');
                return;
            }

            // Set initial context to bourse module only (preserve other context values)
            window.wealthContextBar.setContext(currentWealthContext);

            // Listen for context changes
            window.addEventListener('wealth:change', (event) => {
                debugLogger.debug('Wealth context changed in Saxo dashboard:', event.detail);
                currentWealthContext = { ...event.detail };

                // Update UI based on context changes
                updateContextualDisplay();
            });

            debugLogger.debug('‚úÖ WealthContextBar integrated for Saxo dashboard');
        }

        function updateContextualDisplay() {
            // Update currency display based on context
            if (currentPortfolioData && currentWealthContext.currency !== 'USD') {
                // Could implement currency conversion here
                debugLogger.debug(`Display currency preference: ${currentWealthContext.currency}`);
            }

            // Reset analytics tab loaded flag when source changes (force reload)
            analyticsTabLoaded = false;
        }

        // Refresh active tab content (called after data reload)
        function refreshActiveTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            debugLogger.debug(`üîÑ Refreshing active tab: ${tabId}`);

            // Reload data for the active tab
            if (currentPortfolioData) {
                switch (tabId) {
                    case 'overview':
                        loadOverviewData(currentPortfolioData);
                        break;
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                    case 'analytics':
                        loadAnalyticsTab();
                        break;
                }
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by data attribute or text content
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tab if needed
            if (currentPortfolioData) {
                switch (tabName) {
                    case 'overview':
                        loadOverviewData(currentPortfolioData);
                        break;
                    case 'positions':
                        loadAllPositions();
                        break;
                    case 'risk':
                        loadRiskAnalytics();
                        break;
                    case 'analytics':
                        loadAnalyticsTab();
                        break;
                    case 'recommendations':
                        loadRecommendationsTab();
                        break;
                    case 'opportunities':
                        loadOpportunitiesTab();
                        break;
                }
            }
        }

        // Load Risk Tab (essential metrics only)
        async function loadRiskAnalytics() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('riskSummary').innerHTML = '<div class="loading">Calcul des m√©triques de risque‚Ä¶</div>';
                document.getElementById('riskMetrics').innerHTML = '<div class="loading">‚Ä¶</div>';
                document.getElementById('riskStructure').innerHTML = '<div class="loading">‚Ä¶</div>';

                // Build URL with file_key (CSV) or source (API)
                let riskUrl = `/api/risk/bourse/dashboard?user_id=${activeUser}`;
                if (window.saxoSourceType === 'api') {
                    // API mode: use source parameter
                    riskUrl += `&source=saxobank_api`;
                    debugLogger.debug(`üîç Loading risk from API source: saxobank_api`);
                } else if (currentFileKey) {
                    // CSV mode: use file_key
                    riskUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading risk with file_key: ${currentFileKey}`);
                }
                // Include cash amount if available
                if (window.portfolioCash && window.portfolioCash > 0) {
                    riskUrl += `&cash_amount=${window.portfolioCash}`;
                    debugLogger.debug(`üíµ Including cash in risk calculation: $${window.portfolioCash}`);
                }

                const response = await safeFetch(globalConfig.getApiUrl(riskUrl));
                if (!response?.ok) throw new Error('risk endpoint failed');

                const { risk, coverage, positions_count, total_value_usd } = response.data || response;
                const score = risk?.score ?? 0;
                const level = risk?.level ?? 'N/A';

                // Get risk level color
                const getRiskColor = (lvl) => {
                    const levelUpper = String(lvl).toUpperCase();
                    if (levelUpper === 'LOW' || levelUpper === 'VERY_LOW') return 'var(--success)';
                    if (levelUpper === 'MEDIUM' || levelUpper === 'MODERATE') return 'var(--warning)';
                    if (levelUpper === 'HIGH' || levelUpper === 'VERY_HIGH') return 'var(--danger)';
                    if (levelUpper === 'CRITICAL') return '#8B0000';
                    return 'var(--theme-text-muted)';
                };

                const riskColor = getRiskColor(level);

                // Helper to create metric with tooltip (defined before use)
                const metricWithTooltip = (label, tooltip) => `
                    <span class="metric-with-tooltip">
                        <strong>${label}</strong>
                        <span class="tooltip-icon" data-tooltip="${tooltip}">i</span>
                    </span>`;

                // Risk Summary with enhanced UI
                document.getElementById('riskSummary').innerHTML = `
                  <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;">
                      <div class="metric-large" style="color:${riskColor}">${score.toFixed(0)}<span style="font-size:1rem;color:var(--theme-text-muted);">/100</span></div>
                      <div class="metric-label">
                        ${metricWithTooltip('Risk Score (higher = safer)', 'Score de risque global (0-100) : synth√®se de toutes les m√©triques de risque. 80-100 = Tr√®s s√ªr. 60-80 = Mod√©r√©. 40-60 = Risqu√©. <40 = Tr√®s risqu√©. Plus le score est √©lev√©, plus votre portefeuille est stable et diversifi√©.')}
                      </div>
                    </div>
                    <div style="flex:1;min-width:200px;">
                      <div style="font-weight:600;font-size:1.25rem;color:${riskColor};margin-bottom:0.5rem;">${level}</div>
                      <div style="color:var(--theme-text-muted);font-size:0.875rem;">
                        ${positions_count || 0} positions ‚Ä¢ $${(total_value_usd || 0).toLocaleString()}
                      </div>
                      <div style="margin-top:0.5rem;color:var(--theme-text-muted);font-size:0.875rem;">
                        ${metricWithTooltip('Coverage: ' + (coverage*100).toFixed(0) + '%', 'Couverture des donn√©es : pourcentage de positions pour lesquelles l\'historique de prix est disponible. 100% = toutes les positions ont des donn√©es. <80% = certaines positions manquent d\'historique (calculs moins fiables).')}
                      </div>
                    </div>
                  </div>`;

                const m = risk?.metrics || {};

                // Format percentage values (convert to %)
                const formatPct = (val) => ((val ?? 0) * 100).toFixed(2);

                // Key Metrics Table
                document.getElementById('riskMetrics').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td>${metricWithTooltip('VaR (95%, 1d)', 'Value at Risk : perte maximale potentielle sur 1 jour avec 95% de confiance. Exemple : -2% signifie que vous avez 5% de chances de perdre plus de 2% en une journ√©e. Plus la valeur est faible (en %), mieux c\'est.')}</td>
                        <td style="color:var(--danger)">${formatPct(m.var_95_1d)}%</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Volatility (30d)', 'Volatilit√© sur 30 jours : mesure les fluctuations de prix r√©centes (annualis√©es). Une volatilit√© √©lev√©e (>30%) indique un portefeuille tr√®s variable, une faible volatilit√© (<15%) indique un portefeuille stable.')}</td>
                        <td>${formatPct(m.volatility_30d)}%</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Volatility (252d)', 'Volatilit√© sur 1 an (252 jours de trading) : mesure la stabilit√© long terme du portefeuille. Sert de r√©f√©rence pour √©valuer si la volatilit√© r√©cente (30j) est inhabituelle.')}</td>
                        <td>${formatPct(m.volatility_252d)}%</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Max Drawdown', 'Drawdown maximum : plus grosse perte depuis le plus haut historique sur 252 jours (1 an de trading). Exemple : -15% signifie que votre portefeuille a perdu 15% depuis son pic sur l\'ann√©e √©coul√©e. Indique votre capacit√© √† supporter les baisses prolong√©es.')}</td>
                        <td style="color:var(--danger)">${formatPct(m.max_drawdown)}%</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Sharpe Ratio', 'Ratio de Sharpe : rendement ajust√© du risque. >1 = bon, >2 = excellent, <1 = faible. Mesure si les gains compensent la volatilit√©. Un Sharpe de 1.5 signifie 1.5 unit√© de rendement par unit√© de risque pris.')}</td>
                        <td style="color:${(m.sharpe_ratio??0) > 1 ? 'var(--success)' : 'var(--theme-text)'}">${(m.sharpe_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Sortino Ratio', 'Ratio de Sortino : similaire au Sharpe mais ne p√©nalise que la volatilit√© √† la baisse (pertes). >1.5 = bon, >2 = excellent. Plus pertinent que le Sharpe car seules les baisses comptent comme risque.')}</td>
                        <td>${(m.sortino_ratio??0).toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>`;

                // Additional Metrics
                document.getElementById('riskStructure').innerHTML = `
                  <table class="positions-table">
                    <tbody>
                      <tr>
                        <td>${metricWithTooltip('Beta (Portfolio)', 'Beta du portefeuille : mesure la sensibilit√© aux mouvements du march√© (S&P 500). Beta = 1 : suit le march√©. Beta > 1 : plus volatil que le march√©. Beta < 1 : moins volatil. Exemple : Beta 1.2 = si march√© +10%, vous faites +12%.')}</td>
                        <td>${(m.beta_portfolio??1.0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Calmar Ratio', 'Ratio de Calmar : rendement annuel divis√© par le drawdown max. >3 = excellent, 1-3 = bon, <1 = faible. Mesure si les gains justifient les pires baisses subies. Un Calmar de 2 signifie que vous gagnez 2% par an pour chaque 1% de drawdown max.')}</td>
                        <td>${(m.calmar_ratio??0).toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Volatility (90d)', 'Volatilit√© sur 90 jours (3 mois) : compromis entre court terme (30j) et long terme (252j). Utile pour d√©tecter les changements de r√©gime de march√© (passage de calme √† volatil).')}</td>
                        <td>${formatPct(m.volatility_90d)}%</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('VaR Method', 'M√©thode de calcul de la VaR. Historical = bas√© sur l\'historique r√©el des prix (plus fiable). Parametric = suppose distribution normale (moins fiable si march√©s extr√™mes). Monte Carlo = simulations al√©atoires.')}</td>
                        <td style="text-transform:capitalize;">${m.var_method || 'historical'}</td>
                      </tr>
                      <tr>
                        <td>${metricWithTooltip('Drawdown Days', 'Nombre de jours depuis le plus haut historique. 0 jours = nouveau sommet ! >100 jours = p√©riode difficile prolong√©e. Indique si vous √™tes en phase de r√©cup√©ration ou si vous battez des records.')}</td>
                        <td>${m.drawdown_days ?? 'N/A'}</td>
                      </tr>
                    </tbody>
                  </table>`;

            } catch (e) {
                debugLogger.error('Risk analytics load failed', e);
                document.getElementById('riskSummary').innerHTML = `
                  <div class="error-message">
                    <strong>Erreur de chargement</strong><br>
                    ${e.message}<br>
                    <small style="opacity:0.8;">V√©rifiez que yfinance est install√© et que les donn√©es sont disponibles.</small>
                  </div>`;
                document.getElementById('riskMetrics').innerHTML = '';
                document.getElementById('riskStructure').innerHTML = '';
            }

            // Load alerts in parallel (non-blocking)
            loadCriticalAlerts().catch(err => {
                debugLogger.warn('Alerts loading failed (non-blocking)', err);
            });
        }

        // Load Critical Alerts (async, non-blocking)
        async function loadCriticalAlerts() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Build URL with file_key if available
                let alertsUrl = `/api/risk/bourse/alerts?user_id=${activeUser}`;
                if (currentFileKey) {
                    alertsUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(alertsUrl));
                if (!response?.ok) {
                    throw new Error('Alerts endpoint failed');
                }

                const data = response.data || response;
                const { critical, warnings, info, summary } = data;

                // Update badge
                const totalAlerts = summary?.total || 0;
                const badge = document.getElementById('alertsBadge');
                if (totalAlerts === 0) {
                    badge.textContent = '0 active';
                    badge.style.background = 'var(--success)';
                    badge.style.color = 'white';
                } else if (summary?.critical > 0) {
                    badge.textContent = `${summary.critical} critical`;
                    badge.style.background = 'var(--danger)';
                    badge.style.color = 'white';
                } else if (summary?.warning > 0) {
                    badge.textContent = `${summary.warning} warning`;
                    badge.style.background = 'var(--warning)';
                    badge.style.color = 'white';
                } else {
                    badge.textContent = `${summary?.info || 0} info`;
                    badge.style.background = 'var(--info)';
                    badge.style.color = 'white';
                }

                // Build HTML
                let html = '';

                // Critical alerts
                if (critical && critical.length > 0) {
                    critical.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-critical" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    üî¥ ${alert.title}
                                    <span class="alert-badge badge-critical">CRITICAL</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Valeur:</strong> ${alert.value}
                                    <span style="color: var(--theme-text-muted);">(seuil: ${alert.threshold})</span>
                                </div>
                                <div class="alert-impact">
                                    <strong>Impact:</strong> ${alert.impact}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Recommandation:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    ‚è∞ Action requise: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // Warning alerts
                if (warnings && warnings.length > 0) {
                    warnings.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-warning" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    ‚ö†Ô∏è ${alert.title}
                                    <span class="alert-badge badge-warning">WARNING</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Valeur:</strong> ${alert.value}
                                    <span style="color: var(--theme-text-muted);">(seuil: ${alert.threshold})</span>
                                </div>
                                <div class="alert-impact">
                                    <strong>Impact:</strong> ${alert.impact || alert.details || 'Surveillance recommand√©e'}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Recommandation:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    ‚è∞ Action sugg√©r√©e: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // Info alerts
                if (info && info.length > 0) {
                    info.forEach(alert => {
                        const isAcknowledged = alert.acknowledged || false;
                        const acknowledgeBtn = isAcknowledged
                            ? `<button class="acknowledge-btn acknowledged" disabled>‚úì Alerte vue</button>`
                            : `<button class="acknowledge-btn" onclick="acknowledgeAlert('${alert.id}', this)">Marquer comme vu</button>`;

                        html += `
                            <div class="alert alert-info" data-alert-id="${alert.id || ''}">
                                <div class="alert-title">
                                    ‚ÑπÔ∏è ${alert.title}
                                    <span class="alert-badge badge-info">INFO</span>
                                </div>
                                <div class="alert-value">
                                    <strong>Contexte:</strong> ${alert.value || alert.impact}
                                </div>
                                <div class="alert-recommendation">
                                    <strong>‚Üí Opportunit√©:</strong> ${alert.recommendation}
                                </div>
                                <div class="alert-deadline">
                                    üìÖ Horizon: ${alert.action_deadline}
                                </div>
                                ${acknowledgeBtn}
                            </div>
                        `;
                    });
                }

                // If no alerts, show success message
                if (totalAlerts === 0) {
                    html = `
                        <div class="alert-empty">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">
                                Portfolio Sain
                            </div>
                            <div style="font-size: 0.875rem;">
                                Aucune alerte d√©tect√©e. Toutes les m√©triques sont dans les zones s√ªres.
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 1rem; opacity: 0.7;">
                                Calibr√© pour profil mod√©r√© ‚Ä¢ Gestion active hebdomadaire
                            </div>
                        </div>
                    `;
                }

                document.getElementById('criticalAlerts').innerHTML = html;

            } catch (e) {
                debugLogger.error('Critical alerts load failed', e);
                document.getElementById('criticalAlerts').innerHTML = `
                    <div class="alert-empty" style="color: var(--danger);">
                        ‚ö†Ô∏è Erreur de chargement des alertes<br>
                        <small>${e.message}</small>
                    </div>
                `;
                document.getElementById('alertsBadge').textContent = 'Error';
                document.getElementById('alertsBadge').style.background = 'var(--danger)';
            }
        }

        // Acknowledge Alert Function
        async function acknowledgeAlert(alertId, buttonElement) {
            if (!alertId) {
                debugLogger.error('acknowledgeAlert: No alert ID provided');
                return;
            }

            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Update button state immediately (optimistic UI)
                buttonElement.textContent = 'En cours...';
                buttonElement.disabled = true;

                // Call acknowledge endpoint
                const acknowledgeUrl = `/api/risk/bourse/alerts/${alertId}/acknowledge?user_id=${activeUser}`;
                const response = await safeFetch(globalConfig.getApiUrl(acknowledgeUrl), {
                    method: 'POST'
                });

                if (!response?.ok) {
                    throw new Error('Acknowledge failed');
                }

                // Update button to acknowledged state
                buttonElement.classList.add('acknowledged');
                buttonElement.textContent = '‚úì Alerte vue';

                // Remove alert from DOM after short delay
                setTimeout(() => {
                    const alertCard = buttonElement.closest('.alert');
                    if (alertCard) {
                        alertCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        alertCard.style.opacity = '0';
                        alertCard.style.transform = 'scale(0.95)';

                        setTimeout(() => {
                            alertCard.remove();

                            // Update badge count
                            const remainingAlerts = document.querySelectorAll('.alert:not(.alert-empty)').length;
                            const badge = document.getElementById('alertsBadge');
                            if (remainingAlerts === 0) {
                                badge.textContent = '0 active';
                                badge.style.background = 'var(--success)';
                                badge.style.color = 'white';

                                // Show success message
                                document.getElementById('criticalAlerts').innerHTML = `
                                    <div class="alert-empty">
                                        <div style="font-size: 2.5rem;">‚úÖ</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; margin: 1rem 0;">Portfolio Sain</div>
                                        <p style="max-width: 600px; margin: 0 auto; line-height: 1.6;">
                                            Aucune alerte active pour votre profil mod√©r√© (moyen-long terme, gestion active hebdomadaire).
                                        </p>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                }, 500);

                debugLogger.info(`Alert ${alertId} acknowledged successfully`);

            } catch (e) {
                debugLogger.error('Failed to acknowledge alert', e);

                // Restore button state on error
                buttonElement.textContent = 'Erreur - R√©essayer';
                buttonElement.disabled = false;
                buttonElement.style.background = 'var(--danger)';
                buttonElement.style.color = 'white';

                // Reset after 2 seconds
                setTimeout(() => {
                    buttonElement.textContent = 'Marquer comme vu';
                    buttonElement.style.background = '';
                    buttonElement.style.color = '';
                }, 2000);
            }
        }

        // Track if analytics tab has been loaded (for lazy loading)
        let analyticsTabLoaded = false;

        // Load Analytics Tab (ML + Advanced + Specialized)
        async function loadAnalyticsTab() {
            // Lazy loading - only load once
            if (analyticsTabLoaded) {
                debugLogger.debug('Analytics tab already loaded, skipping...');
                return;
            }

            debugLogger.debug('Loading Analytics tab for the first time...');
            analyticsTabLoaded = true;

            // Load all analytics sections in parallel
            Promise.all([
                loadMLInsights().catch(err => {
                    debugLogger.warn('ML insights loading failed (non-blocking)', err);
                }),
                loadAdvancedAnalytics().catch(err => {
                    debugLogger.warn('Advanced analytics loading failed (non-blocking)', err);
                }),
                loadSpecializedAnalytics().catch(err => {
                    debugLogger.warn('Specialized analytics loading failed (non-blocking)', err);
                })
            ]);
        }

        // Load ML Insights & Predictions (async, non-blocking)
        async function loadMLInsights() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                document.getElementById('mlBadge').textContent = 'Analyzing...';

                // Get top 3 stocks from portfolio for predictions
                const topStocks = currentPortfolioData?.summary?.top_holdings?.slice(0, 3) || [];
                if (topStocks.length === 0) {
                    document.getElementById('mlInsights').innerHTML = '<div class="no-data">Aucune position disponible pour ML</div>';
                    document.getElementById('mlBadge').textContent = 'No data';
                    return;
                }

                const benchmark = 'SPY'; // S&P500 as default benchmark
                // Clean symbol: remove exchange suffix (e.g., "IWDA:xams" -> "IWDA")
                const firstStockRaw = topStocks[0]?.symbol || 'AAPL';
                const firstStock = firstStockRaw.split(':')[0];

                // Fetch ML predictions in parallel (direct URLs, no globalConfig params)
                // Use 20 years (7300 days) for regime to capture 4-5 full market cycles (dot-com, 2008, COVID, 2022)
                const baseUrl = window.location.origin;
                const [regimeRes, volatilityRes] = await Promise.all([
                    safeFetch(`${baseUrl}/api/ml/bourse/regime?benchmark=${benchmark}&lookback_days=7300`),
                    safeFetch(`${baseUrl}/api/ml/bourse/forecast?symbol=${firstStock}&lookback_days=365`)
                ]);

                // Check if requests succeeded
                if (!regimeRes?.ok && !volatilityRes?.ok) {
                    throw new Error('ML services unavailable. Please check backend logs or try again later.');
                }

                const regime = regimeRes?.data || regimeRes || {};
                const volatility = volatilityRes?.data || volatilityRes || {};

                // Get regime color
                const getRegimeColor = (reg) => {
                    const r = String(reg).toLowerCase();
                    if (r.includes('bull')) return 'var(--success)';
                    if (r.includes('bear')) return 'var(--danger)';
                    if (r.includes('consolidation')) return 'var(--warning)';
                    return 'var(--info)';
                };

                const regimeColor = getRegimeColor(regime.current_regime);
                const regimeConfidence = ((regime.confidence || 0) * 100).toFixed(0);

                // Extract volatility predictions
                const vol1d = volatility.predictions?.['1d']?.predicted_volatility;
                const vol7d = volatility.predictions?.['7d']?.predicted_volatility;
                const vol30d = volatility.predictions?.['30d']?.predicted_volatility;

                // Build ML Insights HTML
                document.getElementById('mlInsights').innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:1.5rem;">
                        <!-- Market Regime -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Market Regime</div>
                            <div style="font-size:1.25rem;font-weight:700;color:${regimeColor};margin-bottom:0.25rem;">
                                ${regime.current_regime || 'Unknown'}
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);">
                                Confidence: ${regimeConfidence}% ‚Ä¢ ${regime.benchmark || benchmark}
                            </div>
                        </div>

                        <!-- Volatility Forecast -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Volatility Forecast (${firstStock})</div>
                            <div style="display:flex;gap:1rem;align-items:baseline;">
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">1d</div>
                                    <div style="font-weight:600;">${vol1d ? (vol1d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">7d</div>
                                    <div style="font-weight:600;">${vol7d ? (vol7d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem;color:var(--theme-text-muted);">30d</div>
                                    <div style="font-weight:600;">${vol30d ? (vol30d * 100).toFixed(2) : 'N/A'}%</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--theme-text-muted);margin-top:0.5rem;">
                                Model: ${volatility.model_type || 'Historical'}
                            </div>
                        </div>

                        <!-- Regime Characteristics -->
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.5rem;">Regime Characteristics</div>
                            ${Object.entries(regime.characteristics || {})
                                .map(([key, value]) => `
                                    <div style="display:flex;justify-content:space-between;margin:0.25rem 0;">
                                        <span style="font-size:0.8rem;text-transform:capitalize;">${key}:</span>
                                        <span style="font-size:0.8rem;font-weight:600;color:var(--theme-text);">${value}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>

                    <!-- Additional Regime Probabilities -->
                    ${Object.keys(regime.regime_probabilities || {}).length > 0 ? `
                        <div style="padding:1rem;background:var(--theme-bg);border-radius:var(--radius-md);border:1px solid var(--theme-border);">
                            <div style="font-size:0.875rem;color:var(--theme-text-muted);margin-bottom:0.75rem;">Regime Probabilities</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;">
                                ${Object.entries(regime.regime_probabilities || {})
                                    .sort(([,a], [,b]) => b - a)
                                    .map(([regimeName, prob]) => `
                                        <div style="text-align:center;">
                                            <div style="font-weight:700;font-size:1.1rem;color:${getRegimeColor(regimeName)};">
                                                ${(prob * 100).toFixed(0)}%
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--theme-text-muted);margin-top:0.25rem;">
                                                ${regimeName}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- ML Disclaimer: Critical for user understanding -->
                    <div style="margin-top:1rem;padding:0.75rem;background:var(--warning-bg);border-radius:var(--radius-sm);border:1px solid var(--warning);font-size:0.875rem;color:var(--theme-text);">
                        <div style="font-weight:600;color:var(--warning);margin-bottom:0.5rem;">‚ö†Ô∏è Model Limitations</div>
                        <div style="line-height:1.5;">
                            ‚Ä¢ <strong>Historical Pattern Matching:</strong> High confidence indicates strong resemblance to past ${regime.current_regime || 'regime'} periods (20-year dataset: 66% bull, 31% correction, 3% bear)<br>
                            ‚Ä¢ <strong>Not Predictive:</strong> Cannot anticipate unprecedented events, black swans, or rapid regime shifts<br>
                            ‚Ä¢ <strong>Dataset Bias:</strong> Trained on post-2004 data (QE era) - may underestimate crisis risk<br>
                            ‚Ä¢ <strong>Use with Caution:</strong> Combine with fundamental analysis, risk management, and portfolio diversification
                        </div>
                    </div>
                `;

                document.getElementById('mlBadge').textContent = `${regime.model_type || 'ML'} Active`;
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--success) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--success)';

            } catch (error) {
                debugLogger.error('ML insights load failed', error);
                document.getElementById('mlInsights').innerHTML = `
                    <div style="padding:1rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius-md);">
                        <div style="color:var(--warning);margin-bottom:0.5rem;"><strong>‚ö†Ô∏è ML Predictions Unavailable</strong></div>
                        <div style="font-size:0.875rem;color:var(--theme-text-muted);">
                            ${error.message || 'Failed to load ML predictions'}
                            <br><small>Models may need training or data may be insufficient.</small>
                        </div>
                    </div>
                `;
                document.getElementById('mlBadge').textContent = 'Fallback';
                document.getElementById('mlBadge').style.background = 'color-mix(in oklab, var(--warning) 10%, transparent)';
                document.getElementById('mlBadge').style.color = 'var(--warning)';
            }
        }

        // ==================== ADVANCED ANALYTICS ====================

        // Load all advanced analytics (called from loadRiskAnalytics)
        async function loadAdvancedAnalytics() {
            // Load advanced analytics in parallel
            await Promise.all([
                loadCorrelationAnalysis().catch(err => debugLogger.warn('Correlation analysis failed', err)),
                loadStressTestingUI().catch(err => debugLogger.warn('Stress testing failed', err)),
                loadRegimeHistory().catch(err => debugLogger.warn('Regime history failed', err))
            ]);
        }

        // ==================== PLOTLY LAZY LOADER ====================

        /**
         * Lazy load Plotly.js library (3 MB) - only when heatmaps/dendrograms needed
         */
        let plotlyLoaded = false;
        async function loadPlotlyLib() {
            if (plotlyLoaded) return;

            debugLogger.debug('[Plotly] Loading Plotly.js library (3 MB)...');

            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });

            plotlyLoaded = true;
            debugLogger.debug('[Plotly] Library loaded successfully');
        }

        // Load Correlation Matrix & Heatmap
        async function loadCorrelationAnalysis() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('correlationAnalysis').innerHTML = '<div class="loading">Loading visualization library‚Ä¶</div>';

                // Lazy load Plotly
                await loadPlotlyLib();

                document.getElementById('correlationAnalysis').innerHTML = '<div class="loading">Calculating correlations‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/correlation?user_id=${activeUser}&method=pearson&lookback_days=252`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Correlation analysis failed');

                const data = response.data || response;

                // Create Plotly heatmap
                const corrMatrix = data.correlation_matrix || {};
                const labels = data.clustering?.labels || Object.keys(corrMatrix);

                // Convert corrMatrix object to 2D array for Plotly
                const corrArray = labels.map(row =>
                    labels.map(col => corrMatrix[row]?.[col] || 0)
                );

                const heatmapDiv = 'correlationHeatmap';
                const dendrogramDiv = 'correlationDendrogram';
                document.getElementById('correlationAnalysis').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <span style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_positions} positions analyzed ‚Ä¢ Avg correlation: ${(data.avg_correlation || 0).toFixed(3)}
                        </span>
                    </div>

                    <!-- Correlation Heatmap -->
                    <div id="${heatmapDiv}" style="width: 100%; height: 600px;"></div>

                    <!-- Clustering Dendrogram -->
                    <div style="margin-top: 2rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üå≥ Hierarchical Clustering Dendrogram
                        </h4>
                        <div id="${dendrogramDiv}" style="width: 100%; height: 400px;"></div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Dendrogram shows hierarchical grouping of positions based on correlation similarity (Ward linkage)
                        </div>
                    </div>

                    ${data.max_pair ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.875rem;">
                            <strong>Max correlation:</strong> ${data.max_pair.pair.join(' & ')} (${data.max_pair.correlation.toFixed(3)})<br>
                            <strong>Min correlation:</strong> ${data.min_pair.pair.join(' & ')} (${data.min_pair.correlation.toFixed(3)})
                        </div>
                    ` : ''}
                `;

                // Plot heatmap with Plotly
                const heatmapTrace = {
                    z: corrArray,
                    x: labels,
                    y: labels,
                    type: 'heatmap',
                    colorscale: [
                        [0, '#ef4444'],      // Red (negative correlation)
                        [0.5, '#f3f4f6'],    // Gray (no correlation)
                        [1, '#22c55e']       // Green (positive correlation)
                    ],
                    zmid: 0,
                    colorbar: {
                        title: 'Correlation',
                        titleside: 'right'
                    },
                    hovertemplate: '%{y} & %{x}<br>Correlation: %{z:.3f}<extra></extra>'
                };

                const layout = {
                    title: 'üîó Position Correlation Heatmap',
                    xaxis: { title: '', tickangle: -45 },
                    yaxis: { title: '' },
                    width: null,
                    height: 600,
                    margin: { l: 100, r: 50, t: 100, b: 100 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot(heatmapDiv, [heatmapTrace], layout, { responsive: true, displayModeBar: false });

                // Create dendrogram if linkage matrix available
                const linkageMatrix = data.clustering?.linkage_matrix || [];
                if (linkageMatrix && linkageMatrix.length > 0) {
                    createDendrogram(dendrogramDiv, linkageMatrix, labels);
                }

                document.getElementById('correlationBadge').textContent = `${labels.length} positions`;

            } catch (error) {
                debugLogger.error('Correlation analysis failed', error);
                document.getElementById('correlationAnalysis').innerHTML = `
                    <div class="error-message">Failed to load correlation matrix: ${error.message}</div>
                `;
            }
        }

        // Create Dendrogram using Plotly
        function createDendrogram(divId, linkageMatrix, labels) {
            try {
                // Plotly requires dendrogram data in specific format
                // linkageMatrix from scipy: [[idx1, idx2, distance, count], ...]

                // Simple dendrogram visualization using scatter plot
                // (Full dendrogram requires complex transformation, so we use simplified visualization)

                // Create hierarchical tree structure visualization
                const n = labels.length;
                const traces = [];

                // Draw horizontal lines connecting clusters
                linkageMatrix.forEach((link, i) => {
                    const [idx1, idx2, distance, count] = link;
                    const y1 = idx1 < n ? idx1 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx1 - n]));
                    const y2 = idx2 < n ? idx2 : (n + linkageMatrix.findIndex(l => l === linkageMatrix[idx2 - n]));

                    // Horizontal line
                    traces.push({
                        x: [distance, distance],
                        y: [y1, y2],
                        mode: 'lines',
                        line: { color: '#64748b', width: 2 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });

                    // Vertical connectors
                    if (idx1 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y1, y1],
                            mode: 'lines',
                            line: { color: '#64748b', width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                    if (idx2 < n) {
                        traces.push({
                            x: [0, distance],
                            y: [y2, y2],
                            mode: 'lines',
                            line: { color: '#64748b', width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip'
                        });
                    }
                });

                // Add leaf labels
                const leafTrace = {
                    x: Array(n).fill(0),
                    y: Array.from({length: n}, (_, i) => i),
                    mode: 'markers+text',
                    marker: { size: 8, color: '#3b82f6' },
                    text: labels,
                    textposition: 'middle left',
                    textfont: { size: 10 },
                    showlegend: false,
                    hovertemplate: '%{text}<extra></extra>'
                };
                traces.push(leafTrace);

                const layout = {
                    title: '',
                    showlegend: false,
                    xaxis: {
                        title: 'Distance (Correlation Dissimilarity)',
                        zeroline: false,
                        showgrid: true,
                        gridcolor: 'rgba(100, 116, 139, 0.1)'
                    },
                    yaxis: {
                        title: '',
                        showticklabels: false,
                        zeroline: false,
                        showgrid: false
                    },
                    width: null,
                    height: 400,
                    margin: { l: 120, r: 50, t: 50, b: 60 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot(divId, traces, layout, { responsive: true, displayModeBar: false });

            } catch (error) {
                debugLogger.error('Failed to create dendrogram', error);
                document.getElementById(divId).innerHTML = `
                    <div class="error-message" style="padding: 1rem;">Dendrogram visualization unavailable</div>
                `;
            }
        }

        // Load Stress Testing UI with sliders
        async function loadStressTestingUI() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestingUI').innerHTML = `
                    <!-- Predefined Scenarios -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìã Generic Scenarios</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                            <button onclick="runStressTest('market_crash')" style="padding: 0.75rem; border: 1px solid var(--danger); background: color-mix(in oklab, var(--danger) 10%, transparent); color: var(--danger); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìâ Market Crash (-10%)
                            </button>
                            <button onclick="runStressTest('market_rally')" style="padding: 0.75rem; border: 1px solid var(--success); background: color-mix(in oklab, var(--success) 10%, transparent); color: var(--success); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìà Market Rally (+10%)
                            </button>
                            <button onclick="runStressTest('moderate_selloff')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                ‚ö†Ô∏è Moderate Selloff (-5%)
                            </button>
                            <button onclick="runStressTest('rate_hike')" style="padding: 0.75rem; border: 1px solid var(--warning); background: color-mix(in oklab, var(--warning) 10%, transparent); color: var(--warning); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üìä Rate Hike (-3%)
                            </button>
                        </div>
                    </div>

                    <!-- Historical Crisis Scenarios -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìú Historical Crisis Scenarios</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
                            <button onclick="runStressTest('covid_crash')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">ü¶† COVID-19 (2020)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-34% S&P 500</div>
                            </button>
                            <button onclick="runStressTest('financial_crisis_2008')" style="padding: 0.75rem; border: 1px solid #8B0000; background: color-mix(in oklab, #8B0000 10%, transparent); color: #8B0000; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üè¶ Financial Crisis (2008)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-57% peak-to-trough</div>
                            </button>
                            <button onclick="runStressTest('dotcom_bubble')" style="padding: 0.75rem; border: 1px solid #4B0082; background: color-mix(in oklab, #4B0082 10%, transparent); color: #4B0082; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üíª Dot-com Bubble (2000)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-78% NASDAQ</div>
                            </button>
                            <button onclick="runStressTest('black_monday_1987')" style="padding: 0.75rem; border: 1px solid #DC143C; background: color-mix(in oklab, #DC143C 10%, transparent); color: #DC143C; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üìâ Black Monday (1987)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-22% in 1 day</div>
                            </button>
                            <button onclick="runStressTest('flash_crash_2010')" style="padding: 0.75rem; border: 1px solid #FF6347; background: color-mix(in oklab, #FF6347 10%, transparent); color: #FF6347; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">‚ö° Flash Crash (2010)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-9% in minutes</div>
                            </button>
                            <button onclick="runStressTest('brexit_2016')" style="padding: 0.75rem; border: 1px solid #FF8C00; background: color-mix(in oklab, #FF8C00 10%, transparent); color: #FF8C00; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; text-align: left;">
                                <div style="font-size: 0.875rem; font-weight: 700;">üá¨üáß Brexit (2016)</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">-12% FTSE</div>
                            </button>
                        </div>
                    </div>

                    <!-- Custom Scenario -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üéöÔ∏è Custom Scenario</h4>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <label style="flex: 0 0 120px; font-weight: 600;">Market Impact:</label>
                            <input type="range" id="customStressSlider" min="-30" max="30" value="0" step="1" style="flex: 1;">
                            <span id="customStressValue" style="flex: 0 0 80px; font-weight: 700; font-size: 1.25rem;">0%</span>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button onclick="runCustomStressTest()" style="padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">
                                üß™ Run Custom Test
                            </button>
                            <button id="saveScenarioBtn" onclick="saveCurrentScenario()" style="padding: 0.75rem 1.5rem; background: var(--success); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; display: none;">
                                üíæ Save Scenario
                            </button>
                        </div>
                    </div>

                    <!-- Saved Scenarios -->
                    <div id="savedScenariosSection" style="margin-bottom: 1.5rem; display: none;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìÅ Saved Scenarios</h4>
                        <div id="savedScenariosList" style="display: flex; flex-wrap: wrap; gap: 0.75rem;"></div>
                    </div>

                    <!-- Results -->
                    <div id="stressTestResults" style="display: none;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">üìä Stress Test Results</h4>
                        <div id="stressTestChart" style="width: 100%; height: 300px; margin-bottom: 1rem;"></div>
                        <div id="stressTestMetrics"></div>
                    </div>
                `;

                // Update slider value display
                document.getElementById('customStressSlider').addEventListener('input', function(e) {
                    const val = e.target.value;
                    document.getElementById('customStressValue').textContent = (val >= 0 ? '+' : '') + val + '%';
                });

                // Load saved scenarios
                loadSavedScenarios();

            } catch (error) {
                debugLogger.error('Stress testing UI failed', error);
                document.getElementById('stressTestingUI').innerHTML = `
                    <div class="error-message">Failed to load stress testing: ${error.message}</div>
                `;
            }
        }

        // Run stress test with predefined scenario
        async function runStressTest(scenario) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=${scenario}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Stress test failed');

                const data = response.data || response;

                displayStressTestResults(data);

            } catch (error) {
                debugLogger.error('Stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `
                    <div class="error-message">Stress test failed: ${error.message}</div>
                `;
            }
        }

        // Run custom stress test
        async function runCustomStressTest() {
            const impactPct = parseFloat(document.getElementById('customStressSlider').value) / 100;
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                document.getElementById('stressTestResults').style.display = 'block';
                document.getElementById('stressTestMetrics').innerHTML = '<div class="loading">Running custom stress test‚Ä¶</div>';

                let url = `/api/risk/bourse/advanced/stress-test?user_id=${activeUser}&scenario=custom&market_shock=${impactPct}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url), { method: 'POST' });
                if (!response?.ok) throw new Error('Custom stress test failed');

                const data = response.data || response;

                displayStressTestResults(data);

            } catch (error) {
                debugLogger.error('Custom stress test failed', error);
                document.getElementById('stressTestMetrics').innerHTML = `
                    <div class="error-message">Custom stress test failed: ${error.message}</div>
                `;
            }
        }

        // Display stress test results
        function displayStressTestResults(data) {
            // Fix: Use pnl_pct instead of impact_pct
            const pnlPct = data.pnl_pct || 0;
            const totalPnl = data.total_pnl || 0;
            const valueBefore = data.total_value_before || 0;
            const valueAfter = data.total_value_after || 0;

            const pnlColor = pnlPct >= 0 ? 'var(--success)' : 'var(--danger)';

            document.getElementById('stressTestMetrics').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Scenario</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${data.scenario}</div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Total P&L</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: ${pnlColor};">
                            ${pnlPct >= 0 ? '+' : ''}$${totalPnl.toLocaleString('en-US', {maximumFractionDigits: 0})}
                            (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                        </div>
                    </div>
                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Portfolio Value</div>
                        <div style="font-size: 1rem; font-weight: 600;">
                            $${valueBefore.toLocaleString()} ‚Üí $${valueAfter.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            // Create Chart.js impact chart
            const ctx = document.createElement('canvas');
            document.getElementById('stressTestChart').innerHTML = '';
            document.getElementById('stressTestChart').appendChild(ctx);

            // Destroy previous chart to prevent memory leak
            if (stressTestChartInstance) {
                stressTestChartInstance.destroy();
            }

            stressTestChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current', 'Stressed'],
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: [valueBefore, valueAfter],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            pnlPct >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Stress Test Impact: ${data.scenario}`,
                            font: { size: 14, weight: '600' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Portfolio Value ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Show save button only for custom scenarios
            const saveBtn = document.getElementById('saveScenarioBtn');
            if (saveBtn && data.scenario === 'custom') {
                saveBtn.style.display = 'inline-block';
                // Store current scenario data for saving (normalize field names)
                window.currentStressTestData = {
                    ...data,
                    impact_pct: pnlPct  // Add for backwards compatibility with saveCurrentScenario
                };
            } else if (saveBtn) {
                saveBtn.style.display = 'none';
            }
        }

        // ==================== SAVED SCENARIOS MANAGEMENT ====================

        // Load saved scenarios from localStorage
        function loadSavedScenarios() {
            try {
                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                const listDiv = document.getElementById('savedScenariosList');
                const sectionDiv = document.getElementById('savedScenariosSection');

                if (scenarios.length === 0) {
                    sectionDiv.style.display = 'none';
                    return;
                }

                sectionDiv.style.display = 'block';
                listDiv.innerHTML = scenarios.map((scenario, idx) => {
                    const color = scenario.impact >= 0 ? 'var(--success)' : 'var(--danger)';
                    return `
                        <div style="padding: 0.75rem; border: 1px solid ${color}; background: color-mix(in oklab, ${color} 5%, transparent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; min-width: 200px;">
                            <div onclick="loadSavedScenario(${idx})" style="cursor: pointer; flex: 1;">
                                <div style="font-weight: 600; color: ${color};">${scenario.name}</div>
                                <div style="font-size: 0.8rem; color: var(--theme-text-muted);">${scenario.impact >= 0 ? '+' : ''}${scenario.impact}%</div>
                            </div>
                            <button onclick="deleteSavedScenario(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.25rem; padding: 0.25rem;">
                                √ó
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                debugLogger.error('Failed to load saved scenarios', error);
            }
        }

        // Save current scenario
        function saveCurrentScenario() {
            try {
                const data = window.currentStressTestData;
                if (!data) {
                    alert('No stress test results to save');
                    return;
                }

                const name = prompt('Enter a name for this scenario:', `Custom ${data.impact_pct.toFixed(1)}%`);
                if (!name) return;

                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                scenarios.push({
                    name: name,
                    impact: parseFloat(data.impact_pct.toFixed(2)),
                    timestamp: new Date().toISOString()
                });

                localStorage.setItem('savedStressScenarios', JSON.stringify(scenarios));
                loadSavedScenarios();

                // Hide save button after saving
                document.getElementById('saveScenarioBtn').style.display = 'none';

                debugLogger.info('Scenario saved', { name, impact: data.impact_pct });

            } catch (error) {
                debugLogger.error('Failed to save scenario', error);
                alert('Failed to save scenario: ' + error.message);
            }
        }

        // Load a saved scenario
        async function loadSavedScenario(index) {
            try {
                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                const scenario = scenarios[index];
                if (!scenario) return;

                // Set slider to saved value
                const slider = document.getElementById('customStressSlider');
                if (slider) {
                    slider.value = scenario.impact;
                    document.getElementById('customStressValue').textContent =
                        (scenario.impact >= 0 ? '+' : '') + scenario.impact + '%';
                }

                // Run the test
                await runCustomStressTest();

            } catch (error) {
                debugLogger.error('Failed to load saved scenario', error);
                alert('Failed to load scenario: ' + error.message);
            }
        }

        // Delete a saved scenario
        function deleteSavedScenario(index) {
            try {
                if (!confirm('Delete this saved scenario?')) return;

                const scenarios = JSON.parse(localStorage.getItem('savedStressScenarios') || '[]');
                scenarios.splice(index, 1);
                localStorage.setItem('savedStressScenarios', JSON.stringify(scenarios));
                loadSavedScenarios();

                debugLogger.info('Scenario deleted', { index });

            } catch (error) {
                debugLogger.error('Failed to delete scenario', error);
                alert('Failed to delete scenario: ' + error.message);
            }
        }

        // Load ML Regime History Chart
        async function loadRegimeHistory() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Fetch current regime (20 years for 4-5 full market cycles: dot-com, 2008, COVID, 2022)
                const regimeUrl = `/api/ml/bourse/regime?user_id=${activeUser}&benchmark=SPY&lookback_days=7300`;
                const regimeResponse = await safeFetch(globalConfig.getApiUrl(regimeUrl));
                if (!regimeResponse?.ok) throw new Error('Regime detection failed');

                const regimeData = regimeResponse.data || regimeResponse;

                // Detect absurd probabilities (one regime at 100%, others at 0%)
                const probabilities = regimeData.regime_probabilities || {};
                const probValues = Object.values(probabilities);
                const hasAbsurdProbs = probValues.some(p => p === 1.0) && probValues.filter(p => p === 0).length >= 3;

                // Fallback message if model is overconfident
                const fallbackWarning = hasAbsurdProbs ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--warning-bg); border: 1px solid var(--warning); border-radius: var(--radius-md);">
                        <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Model Confidence Issue Detected</div>
                        <div style="font-size: 0.875rem; color: var(--theme-text-muted);">
                            Le mod√®le ML affiche une confiance anormale (100%). Cela indique un probl√®me de calibration.
                            Le mod√®le sera r√©entra√Æn√© automatiquement au prochain appel.<br>
                            <strong>Note:</strong> ${regimeData.note || regimeData.model_type === 'moving_average_fallback' ? 'Utilisation du fallback MA-based pour le moment.' : 'Les probabilit√©s peuvent √™tre peu fiables.'}
                        </div>
                    </div>
                ` : '';

                // Create regime history visualization
                document.getElementById('regimeHistory').innerHTML = `
                    ${fallbackWarning}
                    <!-- Current Regime Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Regime</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${getRegimeColor(regimeData.current_regime)};">
                                ${getRegimeEmoji(regimeData.current_regime)} ${regimeData.current_regime}
                            </div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Confidence</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(regimeData.confidence * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Benchmark</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${regimeData.benchmark}</div>
                        </div>
                    </div>

                    <!-- Regime Probabilities Chart -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--theme-text);">
                            üìä Regime Probabilities
                        </h4>
                        <canvas id="regimeProbabilitiesChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Regime Timeline (Real Historical Data) -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin: 0; color: var(--theme-text);">
                                üìà Market Regime History with SPY Price
                            </h4>
                            <div id="timeframeSelector" style="display: flex; gap: 0.25rem;">
                                <button class="timeframe-btn active" data-days="365">1Y</button>
                                <button class="timeframe-btn" data-days="730">2Y</button>
                                <button class="timeframe-btn" data-days="1825">5Y</button>
                                <button class="timeframe-btn" data-days="3650">10Y</button>
                                <button class="timeframe-btn" data-days="7300">20Y</button>
                                <button class="timeframe-btn" data-days="10950">30Y</button>
                            </div>
                        </div>
                        <canvas id="regimeTimelineChart" style="max-height: 350px;"></canvas>
                        <div id="regimeTimelineInfo" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--theme-text-muted);">
                            ‚ÑπÔ∏è Loading historical regime data...
                        </div>
                    </div>
                `;

                // Create Regime Probabilities Bar Chart
                createRegimeProbabilitiesChart(regimeData.regime_probabilities);

                // Create Regime Timeline with Price Overlay
                await createRegimeTimelineChart(regimeData, 365); // Default: 1 year

                // Setup timeframe selector buttons
                setupTimeframeSelector(regimeData);

                document.getElementById('regimeBadge').textContent = `${regimeData.benchmark} ‚Ä¢ ${regimeData.current_regime}`;

            } catch (error) {
                debugLogger.error('Failed to load regime history', error);
                document.getElementById('regimeHistory').innerHTML = `
                    <div class="error-message">Failed to load ML regime history: ${error.message}</div>
                `;
            }
        }

        // Helper: Get regime color (Option 1: Intensit√© de tendance)
        function getRegimeColor(regime) {
            const colors = {
                'Bear Market': '#dc2626',          // Dark red (violent crashes)
                'Correction': '#f97316',           // Orange (pullbacks, slow bears)
                'Consolidation': '#94a3b8',        // Alias for backward compatibility
                'Bull Market': '#22c55e',          // Green (stable uptrend)
                'Expansion': '#3b82f6',            // Blue (violent rebounds post-crash)
                'Strong Bull Market': '#3b82f6'    // Alias for backward compatibility
            };
            return colors[regime] || '#64748b';
        }

        // Helper: Get regime emoji
        function getRegimeEmoji(regime) {
            const emojis = {
                'Bear Market': 'üî¥',               // Red circle for crashes
                'Correction': 'üü†',                // Orange circle for pullbacks
                'Consolidation': '‚ÜîÔ∏è',             // Alias for backward compatibility
                'Bull Market': 'üü¢',               // Green circle for stable uptrend
                'Expansion': 'üîµ',                 // Blue circle for violent rebounds
                'Strong Bull Market': 'üöÄ'         // Alias for backward compatibility
            };
            return emojis[regime] || '‚ùì';
        }

        // Create Regime Probabilities Bar Chart
        function createRegimeProbabilitiesChart(probabilities) {
            const ctx = document.getElementById('regimeProbabilitiesChart');
            if (!ctx) return;

            const regimes = Object.keys(probabilities);
            const values = Object.values(probabilities);

            // Destroy previous chart to prevent memory leak
            if (regimeProbabilitiesChartInstance) {
                regimeProbabilitiesChartInstance.destroy();
            }

            regimeProbabilitiesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: regimes,
                    datasets: [{
                        label: 'Probability',
                        data: values,
                        backgroundColor: regimes.map(r => getRegimeColor(r) + '80'),
                        borderColor: regimes.map(r => getRegimeColor(r)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Probability: ${(context.parsed.x * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            title: { display: true, text: 'Probability' }
                        },
                        y: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // Global variables to store chart instances (prevent memory leaks)
        let regimeTimelineChartInstance = null;
        let stressTestChartInstance = null;
        let regimeProbabilitiesChartInstance = null;
        let betaForecastChartInstance = null;

        // Create Regime Timeline with Real Historical Data
        async function createRegimeTimelineChart(regimeData, lookback_days = 365) {
            const ctx = document.getElementById('regimeTimelineChart');
            if (!ctx) return;

            try {
                // Fetch real historical regime data from API
                const baseUrl = window.location.origin;
                const historyUrl = `${baseUrl}/api/ml/bourse/regime-history?benchmark=${regimeData.benchmark || 'SPY'}&lookback_days=${lookback_days}`;

                document.getElementById('regimeTimelineInfo').innerHTML = '‚è≥ Loading historical data...';

                const response = await safeFetch(historyUrl);
                if (!response?.ok) {
                    const errorMsg = response?.status === 503
                        ? 'ML service temporarily unavailable. Model may need initialization or yfinance data download.'
                        : `Failed to fetch regime history (status: ${response?.status || 'unknown'})`;
                    throw new Error(errorMsg);
                }

                const historyData = response.data || response;

                // Prepare data for chart
                const labels = historyData.dates;
                const prices = historyData.prices;
                const regimes = historyData.regimes;

                // Map regimes to colors
                const regimeColors = regimes.map(regime => getRegimeColor(regime));

                // Debug: Log regime distribution and mapping
                const regimeCount = {};
                regimes.forEach(r => {
                    regimeCount[r] = (regimeCount[r] || 0) + 1;
                });
                debugLogger.debug('=== REGIME TIMELINE DEBUG ===');
                debugLogger.debug(`Timeframe: ${lookback_days} days (${lookback_days/365} years)`);
                debugLogger.debug('Regime distribution in data:', regimeCount);
                if (historyData.regime_id_mapping) {
                    debugLogger.debug('Regime ID ‚Üí Name mapping:', historyData.regime_id_mapping);
                }
                debugLogger.debug('Sample regimes (first 10):', regimes.slice(0, 10));
                debugLogger.debug('Sample regime IDs (first 10):', historyData.regime_ids?.slice(0, 10));
                debugLogger.debug('Sample colors (first 10):', regimeColors.slice(0, 10));

                // Prepare annotations for key events
                const annotations = [];
                if (historyData.events && historyData.events.length > 0) {
                    historyData.events.forEach((event, idx) => {
                        // Find index of event date in labels
                        const eventIndex = labels.findIndex(date => date === event.date);
                        if (eventIndex >= 0) {
                            const colors = {
                                'crisis': '#ef4444',
                                'policy': '#3b82f6',
                                'volatility': '#f59e0b',
                                'bottom': '#22c55e'
                            };
                            const eventColor = colors[event.type] || '#64748b';

                            annotations.push({
                                type: 'line',
                                xMin: eventIndex,
                                xMax: eventIndex,
                                borderColor: eventColor,
                                borderWidth: 3,
                                borderDash: [6, 4],
                                label: {
                                    display: true,
                                    content: event.label,
                                    position: 'start',
                                    backgroundColor: eventColor,
                                    color: '#ffffff',
                                    font: {
                                        size: 11,
                                        weight: 'bold'
                                    },
                                    padding: 6,
                                    borderRadius: 4,
                                    rotation: 0
                                }
                            });
                        }
                    });
                }

                // Debug: Log events for troubleshooting
                debugLogger.debug(`Found ${historyData.events?.length || 0} events, created ${annotations.length} annotations`);

                // Destroy previous chart if exists
                if (regimeTimelineChartInstance) {
                    regimeTimelineChartInstance.destroy();
                }

                // Subsample data for better performance if > 250 points
                let displayLabels = labels;
                let displayPrices = prices;
                let displayColors = regimeColors;
                let sampleRate = 1;

                if (labels.length > 250) {
                    sampleRate = Math.ceil(labels.length / 250);
                    displayLabels = labels.filter((_, i) => i % sampleRate === 0);
                    displayPrices = prices.filter((_, i) => i % sampleRate === 0);
                    displayColors = regimeColors.filter((_, i) => i % sampleRate === 0);
                }

                // Create new chart
                regimeTimelineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: `${historyData.benchmark} Price`,
                            data: displayPrices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.05)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointBackgroundColor: displayColors,
                            pointBorderColor: displayColors,
                            pointRadius: lookback_days > 1825 ? 3 : 5, // Smaller points for long periods
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'var(--theme-text)',
                                    font: {
                                        size: 12
                                    },
                                    generateLabels: function(chart) {
                                        // Add custom legend for regimes (Phase 2.7 + Option 1 colors)
                                        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-text').trim() || '#e2e8f0';
                                        return [
                                            { text: `${historyData.benchmark} Price`, fillStyle: '#8b5cf6', strokeStyle: '#8b5cf6', fontColor: textColor },
                                            { text: 'Bear Market', fillStyle: '#dc2626', fontColor: textColor },
                                            { text: 'Correction', fillStyle: '#f97316', fontColor: textColor },
                                            { text: 'Bull Market', fillStyle: '#22c55e', fontColor: textColor },
                                            { text: 'Expansion', fillStyle: '#3b82f6', fontColor: textColor }
                                        ];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        const idx = context.dataIndex * sampleRate;
                                        const regime = regimes[idx] || 'Unknown';

                                        // Add historical examples for each regime (Phase 2.7)
                                        const regimeExamples = {
                                            'Bear Market': '(e.g., 2008 Lehman crisis, COVID crash Mar 2020)',
                                            'Correction': '(e.g., 2022 Fed hikes bear, pullbacks, sideways periods)',
                                            'Bull Market': '(e.g., QE era 2009-2020 stable uptrend, 2023-2024 AI rally)',
                                            'Expansion': '(e.g., Mar-Jun 2009 recovery, Apr-Jun 2020 post-COVID rebound)',
                                            // Backward compatibility aliases
                                            'Consolidation': '(e.g., 2015-2016 range, 2018 volatility)',
                                            'Strong Bull Market': '(e.g., 2009-2010 recovery, 2020 post-COVID rally)'
                                        };

                                        return [
                                            `Price: $${context.parsed.y.toFixed(2)}`,
                                            `Regime: ${regime}`,
                                            regimeExamples[regime] || ''
                                        ];
                                    }
                                }
                            },
                            annotation: {
                                annotations: annotations
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Price ($)',
                                    color: 'var(--theme-text)',
                                    font: { size: 12 }
                                },
                                ticks: {
                                    color: 'var(--theme-text-muted)',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: {
                                    color: 'var(--theme-border)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: 'var(--theme-text)',
                                    font: { size: 12 }
                                },
                                ticks: {
                                    color: 'var(--theme-text-muted)',
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: 20
                                },
                                grid: {
                                    color: 'var(--theme-border)'
                                }
                            }
                        }
                    }
                });

                // Update info panel
                const dist = historyData.regime_distribution;
                let distText = '<strong>Regime Distribution:</strong><br>';
                for (const [regime, stats] of Object.entries(dist)) {
                    distText += `${getRegimeEmoji(regime)} ${regime}: ${stats.percentage}% (${stats.count} days)<br>`;
                }

                document.getElementById('regimeTimelineInfo').innerHTML = `
                    ‚ÑπÔ∏è <strong>${lookback_days} days</strong> of real historical data with ${historyData.total_samples} regime predictions<br>
                    ${distText}
                    <em>Colored points show detected market regime. Click timeframe buttons to change period.</em>
                `;

            } catch (error) {
                debugLogger.error('Failed to load regime timeline', error);
                document.getElementById('regimeTimelineInfo').innerHTML = `
                    ‚ùå Failed to load historical data: ${error.message}
                `;
            }
        }

        // Setup timeframe selector buttons
        function setupTimeframeSelector(regimeData) {
            // Only select buttons within the timeframeSelector container (Regime History)
            const buttons = document.querySelectorAll('#timeframeSelector .timeframe-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    // Remove active class from all buttons in this group
                    buttons.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');

                    // Get lookback days from button
                    const lookback = parseInt(this.dataset.days);

                    // Reload chart with new timeframe
                    await createRegimeTimelineChart(regimeData, lookback);
                });
            });
        }

        // ==================== SPECIALIZED ANALYTICS ====================

        // Load all specialized analytics (called from loadRiskAnalytics)
        async function loadSpecializedAnalytics() {
            // Load portfolio-wide analytics
            await Promise.all([
                loadSectorRotation().catch(err => debugLogger.warn('Sector rotation failed', err)),
                loadMarginMonitoring().catch(err => debugLogger.warn('Margin monitoring failed', err))
            ]);

            // Populate ticker selector
            populateTickerSelector();
        }

        // Load Sector Rotation Analysis
        async function loadSectorRotation() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('sectorRotation').innerHTML = '<div class="loading">Loading visualization library‚Ä¶</div>';

                // Lazy load Plotly
                await loadPlotlyLib();

                document.getElementById('sectorRotation').innerHTML = '<div class="loading">Analyzing sectors‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/sector-rotation?user_id=${activeUser}&lookback_days=60`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Sector rotation failed');

                const data = response.data || response;
                const sectors = data.sectors || {};
                const hotSectors = data.hot_sectors || [];
                const coldSectors = data.cold_sectors || [];

                // Sort sectors by momentum
                const sortedSectors = Object.entries(sectors)
                    .sort((a, b) => (b[1].momentum || 0) - (a[1].momentum || 0));

                document.getElementById('sectorRotation').innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); background: color-mix(in oklab, var(--${data.rotation_detected ? 'warning' : 'info'}) 10%, transparent); color: var(--${data.rotation_detected ? 'warning' : 'info'}); font-size: 0.75rem; font-weight: 600;">
                            ${data.rotation_detected ? 'üîÑ Rotation Detected' : 'üìä No Rotation'}
                        </div>
                        <span style="margin-left: 1rem; font-size: 0.875rem; color: var(--theme-text-muted);">
                            ${data.num_sectors} sectors analyzed over ${data.lookback_days} days
                        </span>
                    </div>

                    <!-- Portfolio Analysis - Automatic Insights -->
                    ${data.portfolio_analysis ? `
                        ${data.portfolio_analysis.alerts && data.portfolio_analysis.alerts.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--danger) 10%, transparent); border-left: 3px solid var(--danger); border-radius: var(--radius-sm);">
                                <strong style="color: var(--danger); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">‚ö†Ô∏è ALERTS</strong>
                                ${data.portfolio_analysis.alerts.map(alert => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${alert.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${alert.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.portfolio_analysis.warnings && data.portfolio_analysis.warnings.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--warning) 10%, transparent); border-left: 3px solid var(--warning); border-radius: var(--radius-sm);">
                                <strong style="color: var(--warning); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">‚ö° WARNINGS</strong>
                                ${data.portfolio_analysis.warnings.map(warning => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${warning.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${warning.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.portfolio_analysis.opportunities && data.portfolio_analysis.opportunities.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-left: 3px solid var(--success); border-radius: var(--radius-sm);">
                                <strong style="color: var(--success); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">üí° OPPORTUNITIES</strong>
                                ${data.portfolio_analysis.opportunities.map(opp => `
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                                        <div style="font-weight: 600; color: var(--theme-text);">${opp.message}</div>
                                        <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">‚Üí ${opp.suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    ` : ''}

                    <!-- Hierarchical Clustering Dendrogram -->
                    ${data.clustering ? `
                        <div id="dendrogramPlot" style="margin-bottom: 1.5rem; background: var(--theme-bg); border-radius: var(--radius-sm); padding: 1rem;"></div>
                    ` : ''}

                    <!-- Filters & Search -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="sectorSearch" placeholder="üîç Search sectors..."
                            style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text);">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="filterSectors('all')" id="filterAll" class="sector-filter-btn active" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--brand-primary); color: white; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                All
                            </button>
                            <button onclick="filterSectors('hot')" id="filterHot" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üî• Hot
                            </button>
                            <button onclick="filterSectors('cold')" id="filterCold" class="sector-filter-btn" style="padding: 0.5rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-sm); background: var(--theme-bg); color: var(--theme-text); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                ‚ùÑÔ∏è Cold
                            </button>
                        </div>
                    </div>

                    <table class="positions-table" id="sectorTable" style="margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th onclick="sortSectorTable('name')" style="cursor: pointer; user-select: none;">
                                    Sector <span id="sortName">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('return')" style="cursor: pointer; user-select: none;">
                                    Return <span id="sortReturn">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('weight')" style="cursor: pointer; user-select: none;">
                                    Weight <span id="sortWeight">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('momentum')" style="cursor: pointer; user-select: none;">
                                    Momentum <span id="sortMomentum">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortSectorTable('signal')" style="cursor: pointer; user-select: none;">
                                    Signal <span id="sortSignal">‚ÜïÔ∏è</span>
                                </th>
                                <th>Positions</th>
                            </tr>
                        </thead>
                        <tbody id="sectorTableBody">
                            ${sortedSectors.map(([name, data]) => {
                                const signalColor = data.signal === 'overweight' ? 'var(--success)' :
                                                   data.signal === 'underweight' ? 'var(--danger)' : 'var(--theme-text-muted)';
                                const signalIcon = data.signal === 'overweight' ? 'üî•' :
                                                  data.signal === 'underweight' ? '‚ùÑÔ∏è' : '‚ûñ';
                                const weight = data.weight !== undefined ? data.weight.toFixed(1) : '‚Äî';
                                return `
                                    <tr data-sector="${name}" data-signal="${data.signal}" data-momentum="${data.momentum}" data-return="${data.return}" data-weight="${data.weight || 0}">
                                        <td style="font-weight: 600;">${name}</td>
                                        <td style="color: ${data.return >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                            ${data.return >= 0 ? '+' : ''}${data.return.toFixed(2)}%
                                        </td>
                                        <td style="font-weight: 600; color: var(--theme-text-muted);">${weight}%</td>
                                        <td>${data.momentum.toFixed(2)}x</td>
                                        <td style="color: ${signalColor}; font-weight: 600;">
                                            ${signalIcon} ${data.signal.toUpperCase()}
                                        </td>
                                        <td>${data.num_positions}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                // Add event listener for search
                document.getElementById('sectorSearch').addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#sectorTableBody tr');
                    rows.forEach(row => {
                        const sectorName = row.dataset.sector.toLowerCase();
                        row.style.display = sectorName.includes(searchTerm) ? '' : 'none';
                    });
                });

                // Create dendrogram if clustering data available
                if (data.clustering && data.clustering.linkage_matrix) {
                    // Convert linkage matrix to Plotly format
                    const linkageMatrix = data.clustering.linkage_matrix;
                    const labels = data.clustering.labels;

                    // Color sectors by momentum
                    const sectorColors = labels.map(label => {
                        const sectorData = sectors[label];
                        if (!sectorData) return '#888888';

                        const momentum = sectorData.momentum || 0;
                        if (momentum > 1) return '#22c55e'; // Green for hot
                        if (momentum < -1) return '#ef4444'; // Red for cold
                        return '#6b7280'; // Gray for neutral
                    });

                    // Create dendrogram trace
                    const trace = {
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#888888', width: 2 },
                        marker: { size: 8, color: sectorColors },
                        hovertemplate: '<b>%{text}</b><extra></extra>',
                        text: labels
                    };

                    // Build dendrogram manually from scipy linkage matrix
                    // Format: [i, j, distance, num_leaves]
                    const n = labels.length;
                    const icoord = [];
                    const dcoord = [];

                    // Simple dendrogram rendering (horizontal layout)
                    for (let i = 0; i < linkageMatrix.length; i++) {
                        const [idx1, idx2, dist, count] = linkageMatrix[i];
                        const x1 = idx1 < n ? idx1 : ((idx1 - n) * 2);
                        const x2 = idx2 < n ? idx2 : ((idx2 - n) * 2);
                        const y = dist;

                        icoord.push([x1, x1, x2, x2]);
                        dcoord.push([0, y, y, 0]);
                    }

                    const layout = {
                        title: {
                            text: 'üìä Sector Clustering (Ward Linkage)',
                            font: { size: 14, weight: 600 }
                        },
                        xaxis: {
                            title: 'Sectors',
                            ticktext: labels,
                            tickvals: labels.map((_, i) => i),
                            tickangle: -45
                        },
                        yaxis: {
                            title: 'Distance (1 - |Correlation|)',
                            zeroline: false
                        },
                        height: 300,
                        margin: { l: 60, r: 20, t: 50, b: 100 },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        hovermode: 'closest'
                    };

                    // Use Plotly's built-in dendrogram support
                    const plotData = [{
                        type: 'scatter',
                        x: labels.map((_, i) => i),
                        y: labels.map(label => sectors[label]?.momentum || 0),
                        mode: 'markers+text',
                        marker: {
                            size: 15,
                            color: sectorColors,
                            line: { width: 2, color: '#ffffff' }
                        },
                        text: labels,
                        textposition: 'top center',
                        textfont: { size: 10 },
                        hovertemplate: '<b>%{text}</b><br>Momentum: %{y:.2f}x<extra></extra>'
                    }];

                    Plotly.newPlot('dendrogramPlot', plotData, layout, { responsive: true, displayModeBar: false });
                }

                document.getElementById('sectorBadge').textContent = `${hotSectors.length} hot, ${coldSectors.length} cold`;
                document.getElementById('sectorBadge').style.background = data.rotation_detected ?
                    'color-mix(in oklab, var(--warning) 10%, transparent)' : '';
                document.getElementById('sectorBadge').style.color = data.rotation_detected ? 'var(--warning)' : '';

            } catch (error) {
                debugLogger.error('Sector rotation failed', error);
                document.getElementById('sectorRotation').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load sector rotation data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Margin Monitoring
        async function loadMarginMonitoring() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                document.getElementById('marginMonitoring').innerHTML = '<div class="loading">Calculating margin metrics‚Ä¶</div>';

                let url = `/api/risk/bourse/specialized/margin?user_id=${activeUser}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Margin monitoring failed');

                const data = response.data || response;

                const warningLevel = data.warnings.length > 0 ?
                    (data.warnings.some(w => w.includes('CRITICAL')) ? 'danger' : 'warning') : 'success';

                // Margin call distance color
                const marginColor = data.margin_call_distance < 10 ? 'var(--danger)' :
                                   data.margin_call_distance < 20 ? 'var(--warning)' : 'var(--success)';

                document.getElementById('marginMonitoring').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Utilization</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.margin_utilization.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                $${(data.total_margin_used || 0).toLocaleString()} / $${(data.account_equity || 0).toLocaleString()}
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Leverage</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${data.current_leverage.toFixed(2)}x</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                Optimal: ${data.optimal_leverage.toFixed(2)}x
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Margin Call Distance</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${marginColor};">${data.margin_call_distance.toFixed(1)}%</div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                ${data.margin_call_distance >= 50 ? '‚úÖ Very Safe' :
                                  data.margin_call_distance >= 20 ? '‚ö†Ô∏è Monitor' : 'üö® Risk'}
                            </div>
                        </div>
                    </div>

                    ${data.warnings.length > 0 ? `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${warningLevel}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${warningLevel}); font-size: 0.875rem;">
                            <strong style="color: var(--${warningLevel});">‚ö†Ô∏è Warnings (${data.warnings.length}):</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: var(--${warningLevel});">
                                ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    ` : `
                        <div style="padding: 0.75rem; background: color-mix(in oklab, var(--success) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--success); font-size: 0.875rem; color: var(--success);">
                            ‚úÖ No margin warnings - Portfolio is healthy
                        </div>
                    `}

                    ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üí° Recommendations:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('marginBadge').textContent = data.warnings.length > 0 ?
                    `${data.warnings.length} warnings` : 'Healthy';
                document.getElementById('marginBadge').style.background = `color-mix(in oklab, var(--${warningLevel}) 10%, transparent)`;
                document.getElementById('marginBadge').style.color = `var(--${warningLevel})`;

            } catch (error) {
                debugLogger.error('Margin monitoring failed', error);
                document.getElementById('marginMonitoring').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load margin data: ${error.message}
                    </div>
                `;
            }
        }

        // Populate ticker selector with portfolio tickers
        function populateTickerSelector() {
            const selector = document.getElementById('tickerSelector');
            if (!currentPortfolioData || !currentPortfolioData.positions) {
                return;
            }

            // Get unique tickers from positions
            const tickers = [...new Set(currentPortfolioData.positions.map(p => p.ticker || p.symbol))].filter(Boolean).sort();

            selector.innerHTML = '<option value="">Select a ticker...</option>' +
                tickers.map(ticker => `<option value="${ticker}">${ticker}</option>`).join('');

            // Add change event listener
            selector.onchange = (e) => {
                const ticker = e.target.value;
                if (ticker) {
                    document.getElementById('tickerAnalytics').style.display = 'block';
                    document.getElementById('tickerPlaceholder').style.display = 'none';
                    loadTickerSpecificAnalytics(ticker);
                } else {
                    document.getElementById('tickerAnalytics').style.display = 'none';
                    document.getElementById('tickerPlaceholder').style.display = 'block';
                }
            };
        }

        // Load ticker-specific analytics (Beta, Earnings, Dividends)
        async function loadTickerSpecificAnalytics(ticker) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            // Load all ticker analytics in parallel
            await Promise.all([
                loadBetaForecast(ticker, activeUser),
                loadEarningsPredictor(ticker, activeUser),
                loadDividendAnalysis(ticker, activeUser)
            ]);
        }

        // Load Beta Forecast for ticker
        async function loadBetaForecast(ticker, activeUser) {
            try {
                document.getElementById('betaForecast').innerHTML = '<div class="loading">Loading beta forecast‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/beta-forecast?user_id=${activeUser}&ticker=${ticker}&benchmark=SPY`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Beta forecast failed');

                const data = response.data || response;

                const trendColor = data.beta_trend === 'increasing' ? 'var(--danger)' :
                                  data.beta_trend === 'decreasing' ? 'var(--success)' : 'var(--theme-text-muted)';
                const trendIcon = data.beta_trend === 'increasing' ? 'üìà' :
                                 data.beta_trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';

                // Create canvas for chart
                const canvasId = `betaChart-${ticker}`;
                document.getElementById('betaForecast').innerHTML = `
                    <!-- Beta Rolling Chart -->
                    <div style="margin-bottom: 1.5rem;">
                        <canvas id="${canvasId}" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Beta</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.current_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Forecast (EWMA)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${data.forecasted_beta.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Trend</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${trendColor};">
                                ${trendIcon} ${data.beta_trend}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">R¬≤ (Fit Quality)</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.r_squared * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm);">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Annual Alpha</div>
                            <div style="font-size: 1rem; font-weight: 600; color: ${data.alpha >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.alpha >= 0 ? '+' : ''}${data.alpha.toFixed(2)}%
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Volatility Ratio</div>
                            <div style="font-size: 1rem; font-weight: 600;">${data.volatility_ratio.toFixed(2)}x vs SPY</div>
                        </div>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Based on ${data.observation_days} days of returns ‚Ä¢ Forecast method: ${data.forecast_method}
                    </div>
                `;

                // Create Chart.js beta rolling chart
                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = data.rolling_betas.map((_, i) => `-${data.rolling_betas.length - i}d`);

                // Destroy previous chart to prevent memory leak
                if (betaForecastChartInstance) {
                    betaForecastChartInstance.destroy();
                }

                betaForecastChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Rolling Beta (60d)',
                                data: data.rolling_betas,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Current Beta',
                                data: new Array(data.rolling_betas.length).fill(data.current_beta),
                                borderColor: 'rgba(255, 99, 132, 0.8)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Forecast (EWMA)',
                                data: new Array(data.rolling_betas.length).fill(data.forecasted_beta),
                                borderColor: 'rgba(75, 192, 192, 0.8)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${ticker} Beta Rolling History vs SPY`,
                                font: { size: 14, weight: '600' }
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: { font: { size: 11 } }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Beta'
                                },
                                grid: {
                                    color: 'rgba(128, 128, 128, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Days Ago'
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

            } catch (error) {
                debugLogger.error('Beta forecast failed', error);
                document.getElementById('betaForecast').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load beta forecast: ${error.message}
                    </div>
                `;
            }
        }

        // Load Earnings Predictor for ticker
        async function loadEarningsPredictor(ticker, activeUser) {
            try {
                document.getElementById('earningsPredictor').innerHTML = '<div class="loading">Loading earnings data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/earnings?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) throw new Error('Earnings predictor failed');

                const data = response.data || response;

                const alertColor = data.alert_level === 'high' ? 'var(--danger)' :
                                  data.alert_level === 'medium' ? 'var(--warning)' : 'var(--info)';

                document.getElementById('earningsPredictor').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Alert Level</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${alertColor}; text-transform: uppercase;">
                                ${data.alert_level}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Pre-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${(data.pre_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Post-Earnings Vol</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${(data.post_earnings_vol * 100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Vol Increase</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">+${data.vol_increase_pct.toFixed(1)}%</div>
                        </div>
                    </div>

                    <div style="padding: 0.75rem; background: color-mix(in oklab, var(--${data.alert_level === 'low' ? 'info' : 'warning'}) 10%, transparent); border-radius: var(--radius-sm); border: 1px solid var(--${data.alert_level === 'low' ? 'info' : 'warning'}); font-size: 0.875rem;">
                        <strong style="color: var(--${data.alert_level === 'low' ? 'info' : 'warning'});">üí° ${data.recommendation}</strong>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--theme-text-muted);">
                        Avg post-earnings move: ${data.avg_post_earnings_move.toFixed(2)}%
                        ${data.next_earnings_date ? ` ‚Ä¢ Next earnings: ${data.next_earnings_date}` : ''}
                    </div>
                `;

            } catch (error) {
                debugLogger.error('Earnings predictor failed', error);
                document.getElementById('earningsPredictor').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load earnings data: ${error.message}
                    </div>
                `;
            }
        }

        // Load Dividend Analysis for ticker
        async function loadDividendAnalysis(ticker, activeUser) {
            try {
                document.getElementById('dividendAnalysis').innerHTML = '<div class="loading">Loading dividend data‚Ä¶</div>';

                const url = `/api/risk/bourse/specialized/dividends?user_id=${activeUser}&ticker=${ticker}`;
                const response = await safeFetch(globalConfig.getApiUrl(url));

                const data = response.data || response;

                // Check if data is available or if there was an error
                if (!data.ok || !data.has_dividend_data || data.current_yield === 0) {
                    const errorMsg = data.error ? ` (${data.error})` : '';
                    document.getElementById('dividendAnalysis').innerHTML = `
                        <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); text-align: center; color: var(--theme-text-muted); font-size: 0.875rem;">
                            ‚ÑπÔ∏è No dividend data available for ${ticker}${errorMsg}
                        </div>
                    `;
                    return;
                }

                document.getElementById('dividendAnalysis').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current Yield</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.current_yield.toFixed(2)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Annual Dividend</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">$${data.annual_dividend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Frequency</div>
                            <div style="font-size: 1rem; font-weight: 600; text-transform: capitalize;">${data.payout_frequency}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Growth Rate (YoY)</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${data.dividend_growth_rate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${data.dividend_growth_rate >= 0 ? '+' : ''}${data.dividend_growth_rate.toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    ${data.next_ex_dividend_date ? `
                        <div style="padding: 0.75rem; background: var(--info-bg); border-radius: var(--radius-sm); border: 1px solid var(--info); font-size: 0.875rem;">
                            <strong style="color: var(--info);">üìÖ Next Ex-Dividend:</strong> ${data.next_ex_dividend_date}
                            ${data.days_until_ex_dividend ? ` (in ${data.days_until_ex_dividend} days)` : ''}
                            <br><small>Expected price drop: ~${data.avg_price_drop_ex_div.toFixed(2)}%</small>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                debugLogger.error('Dividend analysis failed', error);
                document.getElementById('dividendAnalysis').innerHTML = `
                    <div class="error-message" style="font-size: 0.875rem;">
                        Failed to load dividend data: ${error.message}
                    </div>
                `;
            }
        }

        // Calculate summary metrics from normalized positions
        function calculateSummaryMetrics(positions, totalValue) {
            // Group positions by symbol to aggregate lots
            const symbolGroups = {};
            positions.forEach(pos => {
                const symbol = pos.symbol;
                if (!symbolGroups[symbol]) {
                    symbolGroups[symbol] = {
                        symbol: symbol,
                        name: pos.name || symbol,
                        asset_class: pos.asset_class || pos.asset_type || 'Unknown',
                        currency: pos.currency || 'USD',
                        isin: pos.isin || '',
                        total_quantity: 0,
                        total_value: 0
                    };
                }
                const value = pos.market_value_usd || pos.market_value || 0;
                symbolGroups[symbol].total_quantity += pos.quantity || 0;
                symbolGroups[symbol].total_value += value;
            });

            // Convert to array and calculate weights
            const aggregatedPositions = Object.values(symbolGroups).map(group => ({
                symbol: group.symbol,
                name: group.name,
                instrument: group.name,
                asset_class: group.asset_class,
                currency: group.currency,
                isin: group.isin,
                quantity: group.total_quantity,
                market_value: group.total_value,
                weight: totalValue > 0 ? (group.total_value / totalValue) * 100 : 0
            }));

            // Sort by value descending
            aggregatedPositions.sort((a, b) => b.market_value - a.market_value);

            const totalPositions = aggregatedPositions.length;

            // Calculate asset allocation (by asset_class)
            const assetTotals = {};
            aggregatedPositions.forEach(pos => {
                const assetClass = pos.asset_class;
                assetTotals[assetClass] = (assetTotals[assetClass] || 0) + pos.market_value;
            });

            const assetAllocation = {};
            Object.entries(assetTotals).forEach(([assetClass, value]) => {
                assetAllocation[assetClass] = totalValue > 0 ? (value / totalValue) * 100 : 0;
            });

            // Calculate currency exposure
            const currencyTotals = {};
            aggregatedPositions.forEach(pos => {
                const currency = pos.currency;
                currencyTotals[currency] = (currencyTotals[currency] || 0) + pos.market_value;
            });

            const currencyExposure = {};
            Object.entries(currencyTotals).forEach(([currency, value]) => {
                currencyExposure[currency] = totalValue > 0 ? (value / totalValue) * 100 : 0;
            });

            // Top 10 holdings (aggregated by symbol)
            const topHoldings = aggregatedPositions.slice(0, 10);

            return {
                total_value_usd: totalValue,
                total_positions: totalPositions,     // Unique symbols
                positions_count: positions.length,    // Total lots
                asset_allocation: assetAllocation,
                currency_exposure: currencyExposure,
                top_holdings: topHoldings
            };
        }

        // Load current Saxo data from active source (via WealthContextBar)
        // OPTIMIZATIONS:
        // 1. localStorage cache (5 min TTL) ‚Üí instant reload (~500ms gain)
        // 2. Parallel API calls (list + cash) ‚Üí ~200ms gain
        // 3. Force refresh option to bypass cache
        async function loadCurrentSaxoData(forceRefresh = false) {
            debugLogger.debug('üè¶ Loading Saxo data from active source...');

            try {
                // Hide cache indicator on fresh load
                const cacheIndicator = document.getElementById('cacheIndicator');
                if (cacheIndicator && forceRefresh) {
                    cacheIndicator.style.display = 'none';
                }

                // Show loading state
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('mainContent').innerHTML = '<div class="loading">üìä Chargement des donn√©es Bourse...</div>';
                document.getElementById('dashboardContent').style.display = 'none';

                const activeUser = localStorage.getItem('activeUser') || 'demo';

                // ‚úÖ FIX: Read bourseSource dynamically (don't trust window.saxoSourceType which may be stale)
                let bourseSource = window.wealthContextBar?.getContext()?.bourse;
                if (!bourseSource) {
                    bourseSource = localStorage.getItem('bourseSource') || 'api:saxobank_api';
                    debugLogger.debug(`‚ö†Ô∏è wealthContextBar not ready, using localStorage fallback: ${bourseSource}`);
                }

                // Determine source type from bourseSource
                const isApiSource = bourseSource && bourseSource.startsWith('api:');
                const isCsvSource = bourseSource && bourseSource.startsWith('saxo:');

                debugLogger.debug(`üîç Source detection: ${bourseSource} ‚Üí ${isApiSource ? 'API' : isCsvSource ? 'CSV' : 'UNKNOWN'}`);

                // Include source type in cache key to avoid mixing API and CSV data
                const sourcePrefix = isApiSource ? 'api' : (currentFileKey || 'default');
                const cacheKey = `saxo_portfolio_${activeUser}_${sourcePrefix}`;
                const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

                // Check cache first (skip if force refresh)
                if (!forceRefresh) {
                    try {
                        const cached = localStorage.getItem(cacheKey);
                        if (cached) {
                            const { data, timestamp, cashAmount } = JSON.parse(cached);
                            if (Date.now() - timestamp < CACHE_TTL) {
                                debugLogger.debug('‚ö° Using cached portfolio data');
                                currentPortfolioData = data;
                                window.portfolioCash = cashAmount || 0;

                                // Show cache indicator
                                const cacheIndicator = document.getElementById('cacheIndicator');
                                if (cacheIndicator) {
                                    cacheIndicator.style.display = 'inline-block';
                                    // Auto-hide after 3 seconds
                                    setTimeout(() => {
                                        cacheIndicator.style.display = 'none';
                                    }, 3000);
                                }

                                // Instant display from cache
                                document.getElementById('mainContent').style.display = 'none';
                                document.getElementById('dashboardContent').style.display = 'block';
                                loadOverviewData(currentPortfolioData);
                                refreshActiveTab();

                                // Add export button
                                const overviewSection = document.getElementById('overview');
                                if (overviewSection && !overviewSection.querySelector('.export-btn')) {
                                    import('./modules/export-button.js').then(({ renderExportButton }) => {
                                        renderExportButton(overviewSection, 'saxo', {
                                            endpoint: '/api/saxo/export-lists',
                                            filename: 'saxo-portfolio'
                                        });
                                    }).catch(err => debugLogger.warn('Failed to load export button:', err));
                                }

                                debugLogger.debug('‚úÖ Portfolio loaded from cache');
                                return;
                            }
                        }
                    } catch (cacheError) {
                        debugLogger.warn('Cache read failed, fetching fresh data:', cacheError);
                    }
                }

                let portfolioData;

                // Load from API or CSV based on source type
                if (isApiSource) {
                    debugLogger.debug('üåê Loading Saxo data from API...');

                    // OPTIMIZATION: Parallel fetch of API positions + cash (independent calls)
                    const [apiResult, cashResult] = await Promise.all([
                        safeFetch(`${window.getApiBase()}/api/saxo/api-positions`, {
                            headers: { 'X-User': activeUser }
                        }),
                        loadPortfolioCash() // Run in parallel
                    ]);

                    const { ok: apiOk, data: apiData } = apiResult;

                    if (!apiOk || !apiData) {
                        debugLogger.warn('Erreur lors du chargement depuis l\'API Saxo.');
                        showNoDataState('‚ùå Erreur lors du chargement depuis l\'API Saxo');
                        return;
                    }

                    // Extract nested data from API response (safeFetch wraps success_response twice)
                    const innerData = apiData.data || apiData;

                    // üîç DEBUG: Log API response structure
                    console.log('üîç DEBUG API Response:', {
                        total_value: innerData.total_value,
                        cash_balance: innerData.cash_balance,
                        positions_count: innerData.positions?.length
                    });

                    // Transform API response to match CSV structure
                    const positions = innerData.positions || [];

                    // Normalize positions to add USD fields
                    const normalizedPositions = positions.map(pos => ({
                        ...pos,
                        market_value_usd: pos.market_value || 0,  // API uses market_value, frontend expects market_value_usd
                        total_value_usd: pos.market_value || 0    // Add total_value_usd for compatibility
                    }));

                    // Calculate total portfolio value
                    // ‚ö†Ô∏è CRITICAL: innerData.total_value from API already includes cash!
                    const totalValue = innerData.total_value || normalizedPositions.reduce((sum, p) => sum + (p.market_value_usd || 0), 0);
                    const totalValueIncludesCash = !!innerData.total_value; // Flag: true if from API (includes cash)

                    // Calculate summary metrics from positions
                    const summary = calculateSummaryMetrics(normalizedPositions, totalValue);

                    portfolioData = {
                        portfolio_id: 'saxo_api',
                        name: `Saxo Bank API (${innerData.source})`,
                        positions: normalizedPositions,
                        source: innerData.source || 'api',
                        timestamp: innerData.timestamp || new Date().toISOString(),
                        summary: summary,
                        totalValueIncludesCash: totalValueIncludesCash  // Flag for correct cash handling
                    };

                    // Extract cash balance from API
                    if (innerData.cash_balance !== undefined) {
                        window.portfolioCash = innerData.cash_balance;
                        debugLogger.debug(`üí∞ Cash balance from API: ${innerData.cash_balance} ${innerData.currency || 'EUR'}`);
                    } else {
                        // Fallback: calculate from total_value - positions
                        window.portfolioCash = Math.max(0, totalValue - normalizedPositions.reduce((sum, p) => sum + (p.market_value_usd || 0), 0));
                    }

                    // Show warning if using cached API data
                    if (innerData.warning) {
                        debugLogger.warn(`‚ö†Ô∏è API Cache Fallback: ${innerData.warning}`);
                    }

                    debugLogger.debug(`‚úÖ Loaded ${portfolioData.positions.length} positions from API (Total: ${totalValue.toLocaleString()} ${innerData.currency || 'EUR'})`);

                    // Show info message for empty Sim accounts
                    if (normalizedPositions.length === 0 && innerData.source === 'api') {
                        const envLabel = window.availableSources?.find(s => s.key === 'saxobank_api')?.environment || 'sim';
                        if (envLabel === 'sim') {
                            debugLogger.info('‚ÑπÔ∏è Compte Saxo Simulation vide - Utilisez le portail Saxo pour ajouter des positions de test');
                        }
                    }

                } else {
                    // Load from CSV (existing logic)
                    debugLogger.debug('üìÑ Loading Saxo data from CSV...');

                    // Extract file_key from bourseSource if available
                    let fileKey = currentFileKey; // Use global currentFileKey as fallback
                    if (isCsvSource) {
                        const key = bourseSource.substring(5); // Remove 'saxo:' prefix

                        // Try to resolve file_key from availableSources
                        if (!window.availableSources) {
                            try {
                                const response = await safeFetch(`${window.getApiBase()}/api/users/sources`, {
                                    headers: { 'X-User': activeUser }
                                });
                                if (response?.ok) {
                                    window.availableSources = response.data?.sources || [];
                                }
                            } catch (err) {
                                debugLogger.warn('Failed to load availableSources:', err);
                            }
                        }

                        // Find matching source and extract filename
                        const source = window.availableSources?.find(s => s.key === key);
                        if (source?.file_path) {
                            fileKey = source.file_path.split(/[/\\]/).pop();
                            debugLogger.debug(`üìÑ Resolved file_key from bourseSource: ${fileKey}`);
                        } else {
                            debugLogger.warn(`‚ö†Ô∏è Could not resolve file_key for source: ${key}`);
                        }
                    }

                    // Build URLs
                    let portfoliosUrl = '/api/saxo/portfolios';
                    if (fileKey) {
                        portfoliosUrl += `?file_key=${encodeURIComponent(fileKey)}`;
                        debugLogger.debug(`üîç Loading portfolio with file_key: ${fileKey}`);
                    }

                    // OPTIMIZATION: Parallel fetch of list + cash (independent calls)
                    const [listResult, cashResult] = await Promise.all([
                        safeFetch(`${window.getApiBase()}${portfoliosUrl}`, {
                            headers: { 'X-User': activeUser }
                        }),
                        loadPortfolioCash(fileKey) // Run in parallel (pass fileKey)
                    ]);

                    const { ok: listOk, data: listData } = listResult;

                    if (!listOk || !listData?.portfolios || listData.portfolios.length === 0) {
                        debugLogger.warn('Aucun portfolio Saxo disponible.');
                        showNoDataState('üìÇ Aucune donn√©e Saxo disponible');
                        return;
                    }

                    // Get first portfolio
                    const portfolio = listData.portfolios[0];
                    const portfolioId = portfolio.portfolio_id;

                    if (!portfolioId) {
                        debugLogger.warn('Portfolio ID manquant.');
                        showNoDataState('‚ùå Erreur: Portfolio ID manquant');
                        return;
                    }

                    // Load full portfolio details
                    let detailUrl = `/api/saxo/portfolios/${portfolioId}`;
                    if (fileKey) {
                        detailUrl += `?file_key=${encodeURIComponent(fileKey)}`;
                    }

                    const { ok: detailOk, data: csvData } = await safeFetch(`${window.getApiBase()}${detailUrl}`, {
                        headers: { 'X-User': activeUser }
                    });

                    if (!detailOk || !csvData) {
                        debugLogger.warn('Erreur lors du chargement du portfolio.');
                        showNoDataState('‚ùå Erreur lors du chargement du portfolio');
                        return;
                    }

                    portfolioData = csvData;
                }

                // Store portfolio data
                currentPortfolioData = portfolioData;

                // Save to cache
                try {
                    localStorage.setItem(cacheKey, JSON.stringify({
                        data: portfolioData,
                        cashAmount: window.portfolioCash || 0,
                        timestamp: Date.now()
                    }));
                    debugLogger.debug('üíæ Portfolio cached for 5 minutes');
                } catch (cacheError) {
                    debugLogger.warn('Failed to cache portfolio:', cacheError);
                }

                // Hide main content and show dashboard
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Load all sections
                loadOverviewData(currentPortfolioData);

                // Refresh active tab content after data load
                refreshActiveTab();

                debugLogger.debug('‚úÖ Saxo data loaded successfully');

                // Add export button once (check if already exists to avoid duplicates)
                const overviewSection = document.getElementById('overview');
                if (overviewSection && !overviewSection.querySelector('.export-btn')) {
                    // Dynamic import for ES module
                    import('./modules/export-button.js').then(({ renderExportButton }) => {
                        renderExportButton(overviewSection, 'saxo', {
                            endpoint: '/api/saxo/export-lists',
                            filename: 'saxo-portfolio'
                        });
                    }).catch(err => {
                        debugLogger.warn('Failed to load export button:', err);
                    });
                }

            } catch (error) {
                debugLogger.error('Error loading Saxo data:', error);
                showError('‚ùå Erreur lors du chargement des donn√©es: ' + error.message);
            }
        }

        function loadOverviewData(data) {
            // Safe access to data properties
            const summary = data?.summary || {};
            const totalValue = Number(summary.total_value_usd || 0);
            const totalPositions = summary.total_positions || data?.positions?.length || 0;
            const assetAllocation = summary.asset_allocation || {};
            const currencyExposure = summary.currency_exposure || {};

            // Get saved cash value for this portfolio
            const savedCash = window.portfolioCash || 0;

            // ‚ö†Ô∏è CRITICAL: If total_value comes from API, it already includes cash!
            // Only add cash if totalValue was calculated from positions (CSV mode)
            const totalValueIncludesCash = data?.totalValueIncludesCash || false;
            const totalWithCash = totalValueIncludesCash ? totalValue : (totalValue + savedCash);

            // Portfolio Summary
            const summaryHtml = `
                <div class="metric-large">$${totalWithCash.toLocaleString()}</div>
                <div class="metric-label">Total Portfolio Value</div>
                <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Positions:</span>
                        <span><strong>${totalPositions}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Asset Classes:</span>
                        <span><strong>${Object.keys(assetAllocation).length + (savedCash > 0 ? 1 : 0)}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                        <span>Currencies:</span>
                        <span><strong>${Object.keys(currencyExposure).length}</strong></span>
                    </div>
                </div>
            `;
            document.getElementById('portfolioSummary').innerHTML = summaryHtml;

            // Asset Allocation (include cash as an asset class)
            const allocationWithCash = {};

            // Handle cash allocation based on source
            if (totalValueIncludesCash) {
                // API mode: totalValue already includes cash, percentages are already correct
                // Just copy existing allocations and add cash as separate class
                Object.assign(allocationWithCash, assetAllocation);
                if (savedCash > 0 && totalWithCash > 0) {
                    const cashPercentage = (savedCash / totalWithCash) * 100;
                    allocationWithCash['Cash'] = cashPercentage;
                }
            } else {
                // CSV mode: totalValue is positions only, need to recalculate with cash
                if (totalWithCash > 0) {
                    // Add existing asset classes with recalculated percentages
                    Object.entries(assetAllocation).forEach(([assetClass, percentage]) => {
                        const originalValue = (percentage / 100) * totalValue;
                        const newPercentage = (originalValue / totalWithCash) * 100;
                        allocationWithCash[assetClass] = newPercentage;
                    });

                    // Add cash as an asset class
                    if (savedCash > 0) {
                        const cashPercentage = (savedCash / totalWithCash) * 100;
                        allocationWithCash['Cash'] = cashPercentage;
                    }
                } else {
                    // No cash, use original allocation
                    Object.assign(allocationWithCash, assetAllocation);
                }
            }

            // Combined Asset Allocation & Currency Exposure
            const allocationHtml = Object.keys(allocationWithCash).length > 0 ? `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Asset Classes</h3>
                    <button onclick="editCashAmount()" style="padding: 0.4rem 0.75rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.35rem;">
                        Edit Cash
                    </button>
                </div>
                <div class="allocation-grid">
                    ${Object.entries(allocationWithCash)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => {
                        const isCash = assetClass === 'Cash';
                        const style = isCash ? 'border: 2px solid #10b981;' : '';
                        return `
                            <div class="allocation-item" style="${style}">
                                <div class="allocation-percentage">${Number(percentage).toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                                ${isCash ? `<div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">$${savedCash.toLocaleString()}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="border-top: 1px solid var(--theme-border); margin: 1.5rem 0 1rem 0; padding-top: 1rem;">
                    <h3 style="margin: 0 0 1rem 0;">Currencies</h3>
                    <div class="currency-grid">
                        ${Object.entries(currencyExposure)
                        .sort(([, a], [, b]) => b - a)
                        .map(([currency, percentage]) => `
                            <div class="currency-item">
                                <div class="currency-percentage">${percentage.toFixed(1)}%</div>
                                <div class="currency-code">${currency}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(totalValue * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<div class="no-data">Aucune donn√©e d\'allocation disponible</div>';
            document.getElementById('assetAllocationCurrency').innerHTML = allocationHtml;

            // Create allocation chart
            renderAllocationChart(allocationWithCash);

            // Top Holdings
            const topHoldings = summary.top_holdings || data?.positions?.slice(0, 10) || [];
            const holdingsHtml = topHoldings.length > 0 ? `
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Symbol</th>
                            <th>Market Value</th>
                            <th>Asset Class</th>
                            <th>Weight</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topHoldings.map(position => {
                            const name = position.name || position.instrument || position.symbol || 'Unknown';
                            const symbol = position.symbol || 'N/A';
                            const displayName = name !== symbol ? name : (position.isin || name);
                            return `
                            <tr>
                                <td><strong>${displayName}</strong></td>
                                <td><code style="font-size: 0.85rem; color: var(--theme-text-muted);">${symbol}</code></td>
                                <td>$${Number(position.market_value_usd || position.market_value || 0).toLocaleString()}</td>
                                <td>
                                    <span class="asset-class-badge asset-class-${(position.asset_class || 'other').toLowerCase()}">
                                        ${position.asset_class || 'N/A'}
                                    </span>
                                </td>
                                <td>${totalValue > 0 ? (((position.market_value_usd || position.market_value || 0) / totalValue) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            ` : '<div class="no-data">Aucune position trouv√©e</div>';
            document.getElementById('topHoldings').innerHTML = holdingsHtml;
        }

        // ==================== CASH / LIQUIDITIES MANAGEMENT ====================

        // Load saved cash amount for current portfolio
        async function loadPortfolioCash(fileKey = null) {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Build URL with file_key (use parameter if provided, fallback to global)
                const key = fileKey || currentFileKey;
                let url = `/api/saxo/cash?user_id=${activeUser}`;
                if (key) {
                    url += `&file_key=${encodeURIComponent(key)}`;
                }

                const response = await safeFetch(`${window.getApiBase()}${url}`);
                if (response?.ok && response?.data) {
                    window.portfolioCash = Number(response.data.cash_amount || 0);
                    debugLogger.debug(`üíµ Loaded cash amount: $${window.portfolioCash}`);
                } else {
                    window.portfolioCash = 0;
                }
            } catch (error) {
                debugLogger.warn('Failed to load cash amount, defaulting to 0', error);
                window.portfolioCash = 0;
            }
        }

        // Edit cash amount (show modal)
        async function editCashAmount() {
            const currentCash = window.portfolioCash || 0;

            // Saved currency preference (default USD since portfolioCash is always in USD from API)
            const savedCurrency = localStorage.getItem('saxoCashCurrency') || 'USD';

            // Pre-load exchange rates (non-blocking)
            const ratesPromise = Promise.all([
                window.currencyManager.ensureRate('EUR'),
                window.currencyManager.ensureRate('CHF')
            ]);

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'cashModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: var(--theme-surface); border-radius: var(--radius-lg); padding: 2rem; max-width: 500px; width: 90%; box-shadow: var(--shadow-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">üíµ √âditer Liquidit√©s</h3>
                        <button onclick="closeCashModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--theme-text-muted);">√ó</button>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Devise:</label>
                        <select id="currencySelect"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--theme-border); border-radius: var(--radius-md); background: var(--theme-bg); color: var(--theme-text); font-size: 1rem; cursor: pointer;">
                            <option value="EUR" ${savedCurrency === 'EUR' ? 'selected' : ''}>EUR (Euro)</option>
                            <option value="USD" ${savedCurrency === 'USD' ? 'selected' : ''}>USD (Dollar)</option>
                            <option value="CHF" ${savedCurrency === 'CHF' ? 'selected' : ''}>CHF (Franc Suisse)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Montant:</label>
                        <input type="number" id="cashInput" value="${currentCash}" step="100" min="0"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--theme-border); border-radius: var(--radius-md); background: var(--theme-bg); color: var(--theme-text); font-size: 1rem;"
                        />
                    </div>

                    <div id="conversionDisplay" style="padding: 1rem; background: var(--brand-primary-alpha); border-left: 3px solid var(--brand-primary); border-radius: var(--radius-sm); margin-bottom: 1rem; font-size: 0.875rem;">
                        <strong>üí± √âquivalent USD:</strong> <span id="usdEquivalent">Chargement des taux de change...</span>
                    </div>

                    <div style="padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-sm); margin-bottom: 1.5rem; font-size: 0.875rem; color: var(--theme-text-muted);">
                        ‚ÑπÔ∏è <strong>Info:</strong> Cette valeur repr√©sente les liquidit√©s disponibles sur votre compte Saxo. Elle sera prise en compte dans les analyses de risque et les recommandations (converties en USD).
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeCashModal()" style="padding: 0.75rem 1.5rem; background: var(--theme-bg); border: 1px solid var(--theme-border); border-radius: var(--radius-md); cursor: pointer; font-weight: 600;">
                            Annuler
                        </button>
                        <button id="saveCashBtn" onclick="saveCashAmount()" disabled style="padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--radius-md); cursor: not-allowed; font-weight: 600; opacity: 0.5;">
                            ‚è≥ Chargement...
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Real-time conversion update
            function updateConversion() {
                const amount = parseFloat(document.getElementById('cashInput')?.value || 0);
                const currency = document.getElementById('currencySelect')?.value || 'EUR';
                const usdSpan = document.getElementById('usdEquivalent');

                if (currency === 'USD') {
                    usdSpan.textContent = `$${amount.toFixed(2)} USD`;
                } else {
                    const rate = window.currencyManager.getRateSync(currency);
                    if (rate > 0) {
                        const usdAmount = amount / rate;
                        usdSpan.textContent = `$${usdAmount.toFixed(2)} USD (taux: ${rate.toFixed(4)})`;
                    } else {
                        usdSpan.textContent = 'Chargement du taux...';
                    }
                }
            }

            // Add event listeners
            document.getElementById('cashInput')?.addEventListener('input', updateConversion);
            document.getElementById('currencySelect')?.addEventListener('change', updateConversion);

            // Wait for rates to be loaded, then enable save button
            ratesPromise.then(() => {
                const saveBtn = document.getElementById('saveCashBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.cursor = 'pointer';
                    saveBtn.style.opacity = '1';
                    saveBtn.textContent = 'üíæ Enregistrer';
                }
                updateConversion();
                document.getElementById('cashInput')?.focus();
            }).catch((error) => {
                debugLogger.warn('Failed to load exchange rates, using fallbacks', error);
                // Still enable button (we have fallback rates)
                const saveBtn = document.getElementById('saveCashBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.cursor = 'pointer';
                    saveBtn.style.opacity = '1';
                    saveBtn.textContent = 'üíæ Enregistrer';
                }
                updateConversion();
                document.getElementById('cashInput')?.focus();
            });

            // Close on Escape key
            window.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeCashModal();
                    window.removeEventListener('keydown', escHandler);
                }
            });
        }

        // Close cash modal
        function closeCashModal() {
            const modal = document.getElementById('cashModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save cash amount
        async function saveCashAmount() {
            const cashInput = document.getElementById('cashInput');
            const currencySelect = document.getElementById('currencySelect');
            const cashAmount = Number(cashInput?.value || 0);
            const currency = currencySelect?.value || 'EUR';

            if (cashAmount < 0) {
                alert('Le montant ne peut pas √™tre n√©gatif');
                return;
            }

            const activeUser = localStorage.getItem('activeUser') || 'demo';

            try {
                // Show saving indicator
                cashInput.disabled = true;
                currencySelect.disabled = true;

                // Convert to USD
                let cashAmountUSD = cashAmount;
                if (currency !== 'USD') {
                    // Ensure rate is loaded
                    await window.currencyManager.ensureRate(currency);
                    const rate = window.currencyManager.getRateSync(currency);
                    if (rate > 0) {
                        cashAmountUSD = cashAmount / rate;
                        debugLogger.info(`üí± Converting ${cashAmount} ${currency} to USD using rate ${rate.toFixed(4)}`);
                    } else {
                        throw new Error(`Taux de change ${currency}/USD non disponible. Veuillez v√©rifier votre connexion internet.`);
                    }
                }

                // Save currency preference
                localStorage.setItem('saxoCashCurrency', currency);

                // Build URL with file_key
                let url = `/api/saxo/cash?user_id=${activeUser}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                const response = await safeFetch(globalConfig.getApiUrl(url), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': activeUser
                    },
                    body: JSON.stringify({
                        cash_amount: cashAmountUSD
                    })
                });

                if (!response?.ok) {
                    throw new Error('Failed to save cash amount');
                }

                // Update local value (in USD)
                window.portfolioCash = cashAmountUSD;

                // Close modal
                closeCashModal();

                // Reload overview to show updated value
                if (currentPortfolioData) {
                    loadOverviewData(currentPortfolioData);
                }

                debugLogger.info(`üíæ Cash amount saved: ${cashAmount} ${currency} ‚Üí $${cashAmountUSD.toFixed(2)} USD`);

            } catch (error) {
                debugLogger.error('Failed to save cash amount', error);
                alert('Erreur lors de la sauvegarde: ' + error.message);
                cashInput.disabled = false;
                currencySelect.disabled = false;
            }
        }

        function loadAllPositions() {
            if (!currentPortfolioData) return;

            // Consolidate positions by (symbol + asset_class)
            const byKey = {};
            currentPortfolioData.positions.forEach(pos => {
                const symbol = pos.symbol || 'UNKNOWN';
                const assetClass = pos.asset_class || 'Unknown';
                const key = `${symbol}|${assetClass}`;
                if (!byKey[key]) byKey[key] = [];
                byKey[key].push(pos);
            });

            const consolidated = [];
            for (const [key, positions] of Object.entries(byKey)) {
                if (positions.length === 1) {
                    consolidated.push(positions[0]);
                } else {
                    let filteredPositions = positions;
                    const values = positions.map(p => p.market_value_usd || 0).sort((a, b) => b - a);
                    const largest = values[0];
                    const sumOthers = values.slice(1).reduce((sum, v) => sum + v, 0);

                    if (values.length > 1 && Math.abs(largest - sumOthers) / Math.max(largest, 1) < 0.05) {
                        const sortedPositions = positions.slice().sort((a, b) =>
                            (b.market_value_usd || 0) - (a.market_value_usd || 0)
                        );
                        filteredPositions = sortedPositions.slice(1);
                        debugLogger.info(`Saxo summary detected for ${key}: removed summary line, keeping ${filteredPositions.length} detail lots`);
                    }

                    const total = {
                        ...filteredPositions[0],
                        quantity: filteredPositions.reduce((sum, p) => sum + (p.quantity || 0), 0),
                        market_value_usd: filteredPositions.reduce((sum, p) => sum + (p.market_value_usd || 0), 0),
                        lots_count: filteredPositions.length
                    };
                    consolidated.push(total);
                }
            }

            const positionsHtml = `
                <div class="table-container">
                    <table class="positions-table" id="positionsTable">
                        <thead>
                            <tr>
                                <th onclick="sortPositionsTable('instrument')" style="cursor: pointer; user-select: none;">Instrument <span id="sortIcon-instrument">‚ÜïÔ∏è</span></th>
                                <th onclick="sortPositionsTable('symbol')" style="cursor: pointer; user-select: none;">Symbol <span id="sortIcon-symbol">‚ÜïÔ∏è</span></th>
                                <th onclick="sortPositionsTable('quantity')" style="cursor: pointer; user-select: none;">Quantity <span id="sortIcon-quantity">‚ÜïÔ∏è</span></th>
                                <th onclick="sortPositionsTable('market_value')" style="cursor: pointer; user-select: none;">Market Value <span id="sortIcon-market_value">‚ñº</span></th>
                                <th onclick="sortPositionsTable('currency')" style="cursor: pointer; user-select: none;">Currency <span id="sortIcon-currency">‚ÜïÔ∏è</span></th>
                                <th onclick="sortPositionsTable('asset_class')" style="cursor: pointer; user-select: none;">Asset Class <span id="sortIcon-asset_class">‚ÜïÔ∏è</span></th>
                                <th onclick="sortPositionsTable('weight')" style="cursor: pointer; user-select: none;">Weight <span id="sortIcon-weight">‚ÜïÔ∏è</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${consolidated
                    .sort((a, b) => (b.market_value_usd || 0) - (a.market_value_usd || 0))
                    .map(position => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        const weight = ((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100);

                        const lotsCount = position.lots_count || 0;
                        const fragmentationBadge = lotsCount > 1 ?
                            `<span style="display: inline-block; margin-left: 0.5rem; font-size: 0.65rem; padding: 0.15rem 0.4rem; background: #ef4444; color: white; border-radius: 3px; font-weight: 600;" title="${lotsCount} lots d√©tect√©s - Consid√©rer consolidation pour r√©duire frais">‚ö†Ô∏è ${lotsCount} lots</span>` : '';

                        return `
                                <tr 
                                    data-instrument="${displayName.replace(/"/g, '&quot;')}"
                                    data-symbol="${symbol}"
                                    data-quantity="${position.quantity}"
                                    data-market_value="${position.market_value_usd}"
                                    data-currency="${position.currency}"
                                    data-asset_class="${position.asset_class}"
                                    data-weight="${weight}"
                                >
                                    <td>
                                        <strong>${displayName}</strong>${fragmentationBadge}
                                        ${position.isin ? `<div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-top: 0.25rem;">ISIN: ${position.isin}</div>` : ''}
                                    </td>
                                    <td><code style="font-size: 0.85rem;">${symbol}</code></td>
                                    <td>${position.quantity.toLocaleString()}</td>
                                    <td><strong>$${position.market_value_usd.toLocaleString()}</strong></td>
                                    <td>${position.currency}</td>
                                    <td>
                                        <span class="asset-class-badge asset-class-${(position.asset_class || position.asset_type || 'unknown').toLowerCase()}">
                                            ${position.asset_class || position.asset_type || 'Unknown'}
                                        </span>
                                    </td>
                                    <td>${weight.toFixed(1)}%</td>
                                </tr>
                        `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('allPositions').innerHTML = positionsHtml;
            document.getElementById('positionsCount').textContent = `${consolidated.length} positions`;
        }

        function sortPositionsTable(column) {
            const table = document.getElementById('positionsTable');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (positionsSortState.column === column) {
                positionsSortState.ascending = !positionsSortState.ascending;
            } else {
                positionsSortState.column = column;
                positionsSortState.ascending = ['instrument', 'symbol', 'currency', 'asset_class'].includes(column); // Default to ascending for text
            }

            const isNumeric = ['quantity', 'market_value', 'weight'].includes(column);

            rows.sort((a, b) => {
                const aValText = a.dataset[column] || '';
                const bValText = b.dataset[column] || '';

                if (isNumeric) {
                    const aVal = parseFloat(aValText);
                    const bVal = parseFloat(bValText);
                    if (!isNaN(aVal) && !isNaN(bVal)) {
                        return positionsSortState.ascending ? aVal - bVal : bVal - aVal;
                    }
                }
                
                // Fallback to string comparison
                const comparison = aValText.localeCompare(bValText);
                return positionsSortState.ascending ? comparison : -comparison;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));

            // Update icons
            const headers = ['instrument', 'symbol', 'quantity', 'market_value', 'currency', 'asset_class', 'weight'];
            headers.forEach(header => {
                const icon = document.getElementById(`sortIcon-${header}`);
                if (icon) {
                    if (header === column) {
                        icon.textContent = positionsSortState.ascending ? '‚ñ≤' : '‚ñº';
                    } else {
                        icon.textContent = '‚ÜïÔ∏è';
                    }
                }
            });
        }

        function loadAllocationDetails() {
            if (!currentPortfolioData) return;

            // Asset class breakdown
            const assetClassHtml = `
                <div class="allocation-grid">
                    ${Object.entries(currentPortfolioData.summary.asset_allocation)
                    .sort(([, a], [, b]) => b - a)
                    .map(([assetClass, percentage]) => `
                            <div class="allocation-item">
                                <div class="allocation-percentage">${percentage.toFixed(1)}%</div>
                                <div class="allocation-label">${assetClass}</div>
                                <div style="font-size: 0.7rem; color: var(--theme-text-muted); margin-top: 0.25rem;">
                                    $${(currentPortfolioData.summary.total_value_usd * percentage / 100).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('assetClassBreakdown').innerHTML = assetClassHtml;

            // Holdings by value
            const holdingsByValueHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${currentPortfolioData.summary.top_holdings.map((position, index) => {
                        const name = position.name || position.instrument || position.symbol || 'Unknown';
                        const symbol = position.symbol || 'N/A';
                        const displayName = name !== symbol ? name : (position.isin || name);
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--theme-border);">
                            <div>
                                <div style="font-weight: 600;">${index + 1}. ${displayName}</div>
                                <div style="font-size: 0.75rem; color: var(--theme-text-muted);">
                                    ${symbol} ‚Ä¢ ${position.asset_class}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${position.market_value_usd.toLocaleString()}</div>
                                <div style="font-size: 0.8rem; color: var(--theme-text-muted);">
                                    ${((position.market_value_usd / currentPortfolioData.summary.total_value_usd) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            document.getElementById('holdingsByValue').innerHTML = holdingsByValueHtml;
        }
        // Allocation Chart
        let allocationChartInstance = null;

        function renderAllocationChart(allocationData) {
            const canvas = document.getElementById('allocationChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy previous chart instance if exists
            if (allocationChartInstance) {
                allocationChartInstance.destroy();
            }

            // Prepare data
            const labels = Object.keys(allocationData);
            const data = Object.values(allocationData);

            // Color palette
            const colors = {
                'ETF': '#3b82f6',      // Blue
                'Stock': '#8b5cf6',    // Purple
                'Cash': '#10b981',     // Green
                'Bond': '#f59e0b',     // Orange
                'Other': '#6b7280'     // Gray
            };

            const backgroundColors = labels.map(label => colors[label] || '#94a3b8');

            // Create chart
            allocationChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${value.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">${message}</div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showNoDataState(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="no-data">
                    <h3>üìÇ Aucune donn√©e disponible</h3>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            debugLogger.debug('üè¶ Saxo Dashboard initialized');

            // Initialize wealth context integration
            initWealthContextIntegration();

            // Initialize saxoSourceType from localStorage
            const bourseSource = localStorage.getItem('bourseSource') || 'api:saxobank_api';
            if (bourseSource && bourseSource.startsWith('api:')) {
                window.saxoSourceType = 'api';
                debugLogger.debug(`üåê Initial source type: API (${bourseSource})`);
            } else if (bourseSource && bourseSource.startsWith('saxo:')) {
                window.saxoSourceType = 'csv';
                debugLogger.debug(`üìÑ Initial source type: CSV (${bourseSource})`);
            } else {
                window.saxoSourceType = 'api'; // Default to API
                debugLogger.debug('üåê Initial source type: API (default)');
            }

            // Debounce timer for source changes
            let sourceChangeTimeout = null;

            // Listen for Bourse source changes from WealthContextBar (with debounce)
            window.addEventListener('bourseSourceChanged', async (event) => {
                debugLogger.debug('üîÑ Bourse source changed:', event.detail);

                // Clear previous timeout to debounce rapid changes
                if (sourceChangeTimeout) {
                    clearTimeout(sourceChangeTimeout);
                    debugLogger.debug('‚è±Ô∏è Debouncing source change...');
                }

                // Debounce: wait 300ms before loading
                sourceChangeTimeout = setTimeout(async () => {
                    // Resolve file_key from source (same logic as wealth-saxo-summary.js)
                    const bourseSource = window.wealthContextBar?.getContext()?.bourse;
                    currentFileKey = null; // Reset
                    window.saxoSourceType = null; // Reset source type

                    // Detect API source (starts with 'api:')
                    if (bourseSource && bourseSource.startsWith('api:')) {
                        window.saxoSourceType = 'api';
                        debugLogger.debug(`üåê API source detected: ${bourseSource}`);
                    }
                    // Detect CSV source (starts with 'saxo:')
                    else if (bourseSource && bourseSource !== 'all' && bourseSource.startsWith('saxo:')) {
                        window.saxoSourceType = 'csv';
                        const key = bourseSource.substring(5); // Remove 'saxo:' prefix
                        const activeUser = localStorage.getItem('activeUser') || 'demo';

                        try {
                            // Load available sources to resolve file_key
                            if (!window.availableSources) {
                                const response = await safeFetch(globalConfig.getApiUrl('/api/users/sources'));
                                if (response?.ok) {
                                    window.availableSources = response.data?.sources || [];
                                }
                            }

                            // Find matching source and extract filename
                            const source = window.availableSources?.find(s => s.key === key);
                            if (source?.file_path) {
                                currentFileKey = source.file_path.split(/[/\\]/).pop();
                                debugLogger.debug(`üìÑ Resolved file_key: ${currentFileKey}`);
                            }
                        } catch (err) {
                            debugLogger.warn('[Saxo Dashboard] Failed to resolve file_key:', err);
                        }
                    }

                    // Reload data with new source (force refresh to bypass cache on source change)
                    loadCurrentSaxoData(true);
                }, 300);
            });

            // Load current Saxo data from active source
            await loadCurrentSaxoData();
        });

        // ==================== SECTOR TABLE FILTERING & SORTING ====================

        /**
         * Filter sectors by signal type
         */
        function filterSectors(filter) {
            const rows = document.querySelectorAll('#sectorTableBody tr');
            const buttons = document.querySelectorAll('.sector-filter-btn');

            // Update button styles
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'var(--theme-bg)';
                btn.style.color = 'var(--theme-text)';
            });

            const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = 'var(--brand-primary)';
                activeBtn.style.color = 'white';
            }

            // Filter rows
            rows.forEach(row => {
                const signal = row.dataset.signal;
                const searchTerm = document.getElementById('sectorSearch')?.value.toLowerCase() || '';
                const sectorName = row.dataset.sector.toLowerCase();
                const matchesSearch = sectorName.includes(searchTerm);

                let show = matchesSearch;
                if (filter === 'hot') {
                    show = show && signal === 'overweight';
                } else if (filter === 'cold') {
                    show = show && signal === 'underweight';
                }

                row.style.display = show ? '' : 'none';
            });
        }

        /**
         * Sort sector table by column
         */
        let sectorSortState = {
            column: null,
            ascending: true
        };

        function sortSectorTable(column) {
            const tbody = document.getElementById('sectorTableBody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (sectorSortState.column === column) {
                sectorSortState.ascending = !sectorSortState.ascending;
            } else {
                sectorSortState.column = column;
                sectorSortState.ascending = false; // Default to descending for numbers
            }

            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'name':
                        aVal = a.dataset.sector;
                        bVal = b.dataset.sector;
                        return sectorSortState.ascending
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);

                    case 'return':
                        aVal = parseFloat(a.dataset.return);
                        bVal = parseFloat(b.dataset.return);
                        break;

                    case 'weight':
                        aVal = parseFloat(a.dataset.weight) || 0;
                        bVal = parseFloat(b.dataset.weight) || 0;
                        break;

                    case 'momentum':
                        aVal = parseFloat(a.dataset.momentum);
                        bVal = parseFloat(b.dataset.momentum);
                        break;

                    case 'signal':
                        const signalOrder = { 'overweight': 3, 'neutral': 2, 'underweight': 1 };
                        aVal = signalOrder[a.dataset.signal] || 0;
                        bVal = signalOrder[b.dataset.signal] || 0;
                        break;

                    default:
                        return 0;
                }

                return sectorSortState.ascending ? aVal - bVal : bVal - aVal;
            });

            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicators
            ['Name', 'Return', 'Weight', 'Momentum', 'Signal'].forEach(col => {
                const indicator = document.getElementById(`sort${col}`);
                if (indicator) {
                    if (col.toLowerCase() === column) {
                        indicator.textContent = sectorSortState.ascending ? '‚ñ≤' : '‚ñº';
                    } else {
                        indicator.textContent = '‚ÜïÔ∏è';
                    }
                }
            });
        }

        // ==================== PDF EXPORT ====================

        /**
         * Lazy load PDF libraries (jsPDF + html2canvas) - saves 1 MB on initial load
         */
        let pdfLibsLoaded = false;
        async function loadPDFLibraries() {
            if (pdfLibsLoaded) return;

            debugLogger.debug('[PDF Export] Loading jsPDF and html2canvas...');

            // Load jsPDF
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });

            // Load html2canvas
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });

            pdfLibsLoaded = true;
            debugLogger.debug('[PDF Export] Libraries loaded successfully');
        }

        /**
         * Export Risk & Analytics tab to PDF
         */
        async function exportRiskPDF() {
            try {
                // Show loading indicator first
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '‚è≥ Loading libraries...';
                exportBtn.disabled = true;

                // Lazy load PDF libraries
                await loadPDFLibraries();

                exportBtn.innerHTML = '‚è≥ Generating PDF...';

                const { jsPDF } = window.jspdf;

                // Get the Risk tab content
                const riskTab = document.getElementById('risk');

                // Create a temporary container with white background for PDF
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; background: white; padding: 20px; width: 800px;';
                tempContainer.innerHTML = `
                    <div style="font-family: Arial, sans-serif; color: #000;">
                        <h1 style="text-align: center; color: #1e40af; margin-bottom: 10px;">üìà Risk & Analytics Report</h1>
                        <p style="text-align: center; color: #666; margin-bottom: 30px;">
                            Generated on ${new Date().toLocaleDateString('fr-FR')} at ${new Date().toLocaleTimeString('fr-FR')}
                        </p>
                        ${riskTab.innerHTML}
                    </div>
                `;
                document.body.appendChild(tempContainer);

                // Wait for charts to render
                await new Promise(resolve => setTimeout(resolve, 500));

                // Capture the content with html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowWidth: 800
                });

                // Remove temporary container
                document.body.removeChild(tempContainer);

                // Create PDF
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Calculate dimensions to fit A4
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 297; // A4 height in mm

                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add more pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Add footer with timestamp and app name
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(128, 128, 128);
                    pdf.text(
                        `Page ${i} of ${pageCount} | Generated by SmartFolio - Bourse Risk Analytics`,
                        105,
                        290,
                        { align: 'center' }
                    );
                }

                // Save PDF
                const fileName = `Risk_Analytics_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Reset button
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

                debugLogger.info(`PDF exported successfully: ${fileName}`);

            } catch (error) {
                debugLogger.error('PDF export failed', error);
                alert('Failed to export PDF. Please try again.');

                // Reset button on error
                if (event?.target) {
                    event.target.innerHTML = 'üìÑ Export PDF';
                    event.target.disabled = false;
                }
            }
        }

        // ================================================================================
        // RECOMMENDATIONS TAB - Portfolio BUY/HOLD/SELL Recommendations
        // ================================================================================

        let currentRecommendations = [];
        let currentTimeframe = 'medium';
        let recommendationsLoaded = false;

        /**
         * Load recommendations tab (setup only, no auto-scan)
         */
        async function loadRecommendationsTab() {
            if (recommendationsLoaded) {
                debugLogger.debug('Recommendations tab already loaded, skipping...');
                return;
            }

            debugLogger.info('Setting up Recommendations tab...');

            // Setup event listeners only (no auto-load)
            setupRecommendationsListeners();

            recommendationsLoaded = true;
        }

        /**
         * Setup event listeners for recommendations tab
         */
        function setupRecommendationsListeners() {
            // Scan button
            const scanBtn = document.getElementById('btnScanRecommendations');
            if (scanBtn) {
                scanBtn.addEventListener('click', async () => {
                    await loadRecommendations(currentTimeframe);
                });
            }

            // Timeframe buttons - only select buttons within recommendations tab
            const recButtons = document.querySelectorAll('#recommendations .timeframe-btn');
            recButtons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const timeframe = e.currentTarget.dataset.timeframe;

                    // Update active button (only within recommendations tab)
                    recButtons.forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Update current timeframe (but don't reload automatically)
                    currentTimeframe = timeframe;
                });
            });

            // Search filter
            const searchInput = document.getElementById('recSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterRecommendations(e.target.value, document.getElementById('recFilter').value);
                });
            }

            // Action filter
            const filterSelect = document.getElementById('recFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', (e) => {
                    filterRecommendations(document.getElementById('recSearch').value, e.target.value);
                });
            }

            // Export text button
            const exportBtn = document.getElementById('btnExportTextRecs');
            if (exportBtn) {
                exportBtn.addEventListener('click', async () => {
                    await exportRecommendationsToText();
                });
            }
        }

        /**
         * Load recommendations from API
         */
        async function loadRecommendations(timeframe = 'medium') {
            const tableContainer = document.getElementById('recommendationsTable');
            const scanBtn = document.getElementById('btnScanRecommendations');
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            const originalText = scanBtn ? scanBtn.textContent : '';

            try {
                debugLogger.info(`Fetching ${timeframe} recommendations for user ${activeUser}...`);

                // Update button state
                if (scanBtn) {
                    scanBtn.disabled = true;
                    scanBtn.textContent = 'üîç Scanning...';
                }

                tableContainer.innerHTML = '<div class="loading">Analyzing portfolio...</div>';

                // Build URL with parameters (file_key for CSV, source for API)
                let recsUrl = `/api/ml/bourse/portfolio-recommendations?timeframe=${timeframe}&lookback_days=90`;
                if (window.saxoSourceType === 'api') {
                    // API mode: use source parameter
                    recsUrl += `&source=saxobank_api`;
                    debugLogger.debug(`üîç Loading recommendations from API source: saxobank_api`);
                } else if (currentFileKey) {
                    // CSV mode: use file_key
                    recsUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    debugLogger.debug(`üîç Loading recommendations with file_key: ${currentFileKey}`);
                }
                // Include cash amount if available
                if (window.portfolioCash && window.portfolioCash > 0) {
                    recsUrl += `&cash_amount=${window.portfolioCash}`;
                    debugLogger.debug(`üíµ Including cash in recommendations: $${window.portfolioCash}`);
                }

                const response = await safeFetch(globalConfig.getApiUrl(recsUrl));

                if (!response?.ok) {
                    throw new Error(`HTTP ${response.status || 'unknown'}: ${response.error || 'unknown error'}`);
                }

                const data = response.data || response;

                debugLogger.info('Recommendations loaded:', data);

                currentRecommendations = data.recommendations || [];

                // Update market context
                updateMarketContext(data);

                // Update summary
                updateRecommendationsSummary(data.summary || {});

                // Render table
                renderRecommendationsTable(currentRecommendations);

            } catch (error) {
                debugLogger.error('Failed to load recommendations:', error);
                tableContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Error loading recommendations</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                // Restore button state
                if (scanBtn) {
                    scanBtn.disabled = false;
                    scanBtn.textContent = originalText || 'üîç Scan';
                }
            }
        }

        /**
         * Update market context banner
         */
        function updateMarketContext(data) {
            const regimeEl = document.getElementById('contextRegime');
            const postureEl = document.getElementById('contextPosture');
            const updateEl = document.getElementById('contextUpdate');

            if (regimeEl) regimeEl.textContent = data.market_regime || '--';
            if (postureEl) postureEl.textContent = data.summary?.overall_posture || '--';
            if (updateEl) {
                const date = data.generated_at ? new Date(data.generated_at) : new Date();
                updateEl.textContent = date.toLocaleTimeString();
            }
        }

        /**
         * Update recommendations summary stats
         */
        function updateRecommendationsSummary(summary) {
            const summaryEl = document.getElementById('recSummary');
            const counts = summary.action_counts || {};

            summaryEl.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${counts['STRONG BUY'] || 0}</div>
                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); text-transform: uppercase;">Strong Buy</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${counts['BUY'] || 0}</div>
                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); text-transform: uppercase;">Buy</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--theme-text-muted);">${counts['HOLD'] || 0}</div>
                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); text-transform: uppercase;">Hold</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--warning);">${counts['SELL'] || 0}</div>
                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); text-transform: uppercase;">Sell</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--danger);">${counts['STRONG SELL'] || 0}</div>
                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); text-transform: uppercase;">Strong Sell</div>
                </div>
            `;
        }

        /**
         * Render recommendations table
         */
        function renderRecommendationsTable(recommendations) {
            const tableContainer = document.getElementById('recommendationsTable');
            const countBadge = document.getElementById('recCount');

            if (countBadge) {
                countBadge.textContent = `${recommendations.length} position${recommendations.length !== 1 ? 's' : ''}`;
            }

            if (recommendations.length === 0) {
                tableContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                        No recommendations available
                    </div>
                `;
                return;
            }

            // Build table HTML
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table id="recommendationsTableElement" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--theme-border); background: var(--theme-bg-subtle);">
                                <th onclick="sortRecommendationsTable('symbol')" style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Symbol <span id="sortRecSymbol">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('name')" style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Name <span id="sortRecName">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('action')" style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Action <span id="sortRecAction">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('rr')" style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    R/R <span id="sortRecRr">‚ñº</span>
                                </th>
                                <th onclick="sortRecommendationsTable('score')" style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Score <span id="sortRecScore">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('confidence')" style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Confidence <span id="sortRecConfidence">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('sector')" style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Sector <span id="sortRecSector">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('weight')" style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Weight <span id="sortRecWeight">‚ÜïÔ∏è</span>
                                </th>
                                <th onclick="sortRecommendationsTable('value')" style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted); cursor: pointer; user-select: none;">
                                    Value <span id="sortRecValue">‚ÜïÔ∏è</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="recommendationsTableBody">
            `;

            recommendations.forEach(rec => {
                const actionBadge = getActionBadge(rec.action, rec.adjusted, rec.original_action);
                const confidenceBar = getConfidenceBar(rec.confidence);

                // Get full name from mapping
                const fullName = getDisplayName(rec.symbol, rec.name);
                // Shorten name if too long
                const displayName = fullName.length > 25 ? fullName.substring(0, 22) + '...' : fullName;

                // Risk/Reward ratio
                const rr = rec.price_targets?.risk_reward_tp1 || 0;
                const rrDisplay = rr > 0 ? `1:${rr.toFixed(2)}` : 'N/A';
                const rrColor = rr >= 2 ? 'var(--success)' : rr >= 1.5 ? 'var(--warning)' : 'var(--danger)';
                const rrIcon = rr >= 2 ? '‚úÖ' : rr >= 1.5 ? '‚ö†Ô∏è' : '‚ùå';

                // Score
                const score = rec.score || 0;
                const scoreDisplay = (score * 100).toFixed(0);
                const scoreColor = score >= 0.7 ? 'var(--success)' : score >= 0.5 ? 'var(--warning)' : 'var(--danger)';

                // Legacy badge (trailing stop active)
                const isTrailingStop = rec.price_targets?.stop_loss_analysis?.recommended_method === 'trailing_stop';
                const trailingInfo = rec.price_targets?.stop_loss_analysis?.stop_loss_levels?.trailing_stop;
                const gainPct = trailingInfo?.gain_pct || 0;
                const legacyBadge = isTrailingStop ?
                    `<span style="display: inline-block; margin-left: 0.25rem; font-size: 0.65rem; padding: 0.15rem 0.4rem; background: #10b981; color: white; border-radius: 3px;" title="Legacy position +${gainPct.toFixed(0)}% (trailing stop active)">üèÜ</span>` : '';

                // CFD/Leverage badge (P0 Enhancement - Oct 2025)
                const isCFD = rec.is_cfd || false;
                const leverage = rec.leverage || 1;
                const cfdBadge = isCFD ?
                    `<span style="display: inline-block; margin-left: 0.25rem; font-size: 0.65rem; padding: 0.15rem 0.4rem; background: #f59e0b; color: white; border-radius: 3px; font-weight: 600;" title="CFD/Leveraged ${leverage.toFixed(0)}x - Tight stops required">‚ö†Ô∏è ${leverage.toFixed(0)}x</span>` : '';

                // Fragmentation badge (P0 Enhancement - Oct 2025)
                const positionsCount = rec.positions_count || 0;
                const fragmentationBadge = positionsCount > 1 ?
                    `<span style="display: inline-block; margin-left: 0.25rem; font-size: 0.65rem; padding: 0.15rem 0.4rem; background: #ef4444; color: white; border-radius: 3px; font-weight: 600;" title="${positionsCount} lots d'achat s√©par√©s dans le CSV - Consid√©rer consolidation en une seule position">‚ö†Ô∏è ${positionsCount} lots</span>` : '';

                tableHTML += `
                    <tr class="rec-row"
                        data-symbol="${rec.symbol}"
                        data-name="${fullName}"
                        data-action="${rec.action}"
                        data-rr="${rr}"
                        data-score="${score}"
                        data-confidence="${rec.confidence}"
                        data-sector="${rec.sector}"
                        data-weight="${rec.weight_pct}"
                        data-value="${rec.current_value}"
                        style="border-bottom: 1px solid var(--theme-border); cursor: pointer;"
                        onclick="showRecommendationModal('${rec.symbol}')">
                        <td style="padding: 0.75rem;">
                            <div style="font-weight: 600; color: var(--theme-text);">${rec.symbol}${legacyBadge}${cfdBadge}${fragmentationBadge}</div>
                        </td>
                        <td style="padding: 0.75rem;">
                            <div style="font-size: 0.875rem; color: var(--theme-text-muted);" title="${fullName}">${displayName}</div>
                        </td>
                        <td style="padding: 0.75rem;">${actionBadge}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="color: ${rrColor}; font-weight: 600;">${rrIcon} ${rrDisplay}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="color: ${scoreColor}; font-weight: 600;">${scoreDisplay}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">${confidenceBar}</td>
                        <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--theme-text-muted);">${rec.sector}</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${rec.weight_pct}%</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${formatCurrency(rec.current_value)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            tableContainer.innerHTML = tableHTML;

            // Apply default sort by R/R (descending) after rendering
            sortRecommendationsTable('rr');
        }

        /**
         * Get action badge HTML
         */
        function getActionBadge(action, adjusted = false, originalAction = null) {
            const badges = {
                'STRONG BUY': '<span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); background: #22c55e; color: white; font-size: 0.75rem; font-weight: 600;">üü¢ STRONG BUY</span>',
                'BUY': '<span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); background: #86efac; color: #166534; font-size: 0.75rem; font-weight: 600;">üü¢ BUY</span>',
                'HOLD': '<span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); background: var(--theme-bg-subtle); color: var(--theme-text-muted); font-size: 0.75rem; font-weight: 600;">üîµ HOLD</span>',
                'SELL': '<span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); background: #fbbf24; color: #78350f; font-size: 0.75rem; font-weight: 600;">üü† SELL</span>',
                'STRONG SELL': '<span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); background: #ef4444; color: white; font-size: 0.75rem; font-weight: 600;">üî¥ STRONG SELL</span>'
            };

            let badge = badges[action] || action;

            // Add adjustment indicator if action was downgraded
            if (adjusted && originalAction) {
                badge += ` <span style="display: inline-block; margin-left: 0.25rem; cursor: help; font-size: 0.875rem;" title="Originally ${originalAction}, adjusted for portfolio constraints">‚ö†Ô∏è</span>`;
            }

            return badge;
        }

        /**
         * Get confidence bar HTML
         */
        function getConfidenceBar(confidence) {
            const percentage = Math.round(confidence * 100);
            const color = percentage > 70 ? '#22c55e' : percentage > 50 ? '#fbbf24' : '#ef4444';

            return `
                <div style="display: flex; align-items: center; gap: 0.5rem; min-width: 120px;">
                    <div style="flex: 1; height: 8px; background: var(--theme-bg-subtle); border-radius: var(--radius-full); overflow: hidden; min-width: 80px;">
                        <div style="height: 100%; width: ${percentage}%; background: ${color};"></div>
                    </div>
                    <span style="font-size: 0.75rem; font-weight: 600; min-width: 2.5rem;">${percentage}%</span>
                </div>
            `;
        }

        /**
         * Filter recommendations
         */
        function filterRecommendations(searchTerm, actionFilter) {
            const filtered = currentRecommendations.filter(rec => {
                const matchesSearch = !searchTerm ||
                    rec.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    rec.name.toLowerCase().includes(searchTerm.toLowerCase());

                const matchesAction = actionFilter === 'all' || rec.action === actionFilter;

                return matchesSearch && matchesAction;
            });

            renderRecommendationsTable(filtered);
        }

        /**
         * Export recommendations to text (Markdown format for AI analysis)
         * Fetches all 3 timeframes and generates structured text
         */
        async function exportRecommendationsToText() {
            const btn = document.getElementById('btnExportTextRecs');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating...';

                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const timeframes = [
                    { id: 'short', name: 'SHORT TERM (1-2 Weeks)', description: 'Trading Horizon' },
                    { id: 'medium', name: 'MEDIUM TERM (1 Month)', description: 'Tactical Horizon' },
                    { id: 'long', name: 'LONG TERM (3-6 Months)', description: 'Strategic Horizon' }
                ];

                let markdownText = `# Portfolio Recommendations Export\n\n`;
                markdownText += `**Generated:** ${new Date().toLocaleString()}\n`;
                markdownText += `**User:** ${activeUser}\n`;
                markdownText += `**Portfolio:** ${currentFileKey || 'Latest'}\n\n`;
                markdownText += `---\n\n`;

                // Fetch all timeframes
                for (const tf of timeframes) {
                    debugLogger.info(`Fetching ${tf.id} timeframe recommendations...`);

                    let recsUrl = `/api/ml/bourse/portfolio-recommendations?user_id=${activeUser}&timeframe=${tf.id}&lookback_days=90`;
                    if (currentFileKey) {
                        recsUrl += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    }
                    if (window.portfolioCash && window.portfolioCash > 0) {
                        recsUrl += `&cash_amount=${window.portfolioCash}`;
                    }

                    const response = await safeFetch(globalConfig.getApiUrl(recsUrl));
                    if (!response?.ok) throw new Error(`Failed to fetch ${tf.id} recommendations`);

                    const data = response.data || response;
                    const recs = data.recommendations || [];
                    const summary = data.summary || {};
                    const marketContext = data.market_context || {};

                    // Add timeframe section
                    markdownText += `## ${tf.name} - ${tf.description}\n\n`;

                    // Market context (only for first timeframe to avoid repetition)
                    if (tf.id === 'short') {
                        markdownText += `### Market Context\n`;
                        markdownText += `- **Cycle Score:** ${marketContext.cycle_score || 'N/A'}/100\n`;
                        markdownText += `- **Market Regime:** ${marketContext.market_regime || 'N/A'}\n`;
                        markdownText += `- **Risk Level:** ${marketContext.risk_level || 'N/A'}\n`;
                        markdownText += `- **ML Sentiment:** ${marketContext.ml_sentiment || 'N/A'}\n\n`;
                    }

                    // Summary stats
                    markdownText += `### Summary Statistics\n`;
                    const counts = summary.action_counts || {};
                    markdownText += `- **Total Positions:** ${recs.length}\n`;
                    markdownText += `- **Strong Buy:** ${counts['STRONG BUY'] || 0}\n`;
                    markdownText += `- **Buy:** ${counts['BUY'] || 0}\n`;
                    markdownText += `- **Hold:** ${counts['HOLD'] || 0}\n`;
                    markdownText += `- **Sell:** ${counts['SELL'] || 0}\n`;
                    markdownText += `- **Strong Sell:** ${counts['STRONG SELL'] || 0}\n\n`;

                    // Detailed recommendations (enriched format with all View modal data)
                    if (recs.length > 0) {
                        markdownText += `### Detailed Recommendations\n\n`;

                        recs.forEach((rec, idx) => {
                            const symbol = rec.symbol || 'N/A';
                            const name = rec.name || 'N/A';
                            const action = rec.action || 'N/A';
                            const conf = rec.confidence ? Math.round(rec.confidence * 100) : 0;
                            const score = rec.score ? rec.score.toFixed(2) : 'N/A';

                            // Position header
                            markdownText += `#### ${idx + 1}. ${symbol} - ${name}\n\n`;
                            markdownText += `**Action:** ${action} | **Confidence:** ${conf}% | **Score:** ${score}\n\n`;

                            // Adjustment warning if applicable
                            if (rec.adjusted && rec.original_action) {
                                markdownText += `‚ö†Ô∏è **ADJUSTED:** Originally ${rec.original_action}, adjusted to ${action}\n`;
                                markdownText += `**Reason:** ${rec.adjustment_note || 'Portfolio constraints'}\n\n`;
                            }

                            // Price targets section
                            if (rec.price_targets) {
                                const pt = rec.price_targets;
                                markdownText += `**Price Targets:**\n`;
                                markdownText += `- Current Price: $${pt.current_price || 'N/A'}\n`;

                                if (pt.action && pt.action.includes('HOLD')) {
                                    // HOLD positions show watch levels
                                    markdownText += `- Upper Watch: $${pt.upper_watch || 'N/A'} (+${pt.upper_watch_pct || 0}%)\n`;
                                    markdownText += `- Lower Watch: $${pt.lower_watch || 'N/A'} (${pt.lower_watch_pct || 0}%)\n`;
                                } else if (pt.entry_zone) {
                                    // BUY/SELL positions show entry/exit zones
                                    markdownText += `- Entry Zone: $${pt.entry_zone.low || 'N/A'} - $${pt.entry_zone.high || 'N/A'}\n`;
                                    markdownText += `- Stop Loss: $${pt.stop_loss || 'N/A'} (${pt.stop_loss_pct || 'N/A'}%)\n`;
                                    markdownText += `- Take Profit 1: $${pt.take_profit_1 || 'N/A'} (+${pt.take_profit_1_pct || 'N/A'}%)\n`;
                                    markdownText += `- Take Profit 2: $${pt.take_profit_2 || 'N/A'} (+${pt.take_profit_2_pct || 'N/A'}%)\n`;

                                    // R/R Ratio with warning
                                    const rr = pt.risk_reward_tp1 || 0;
                                    const rrIcon = rr >= 2.0 ? '‚úÖ' : rr >= 1.5 ? '‚ö†Ô∏è' : '‚ùå';
                                    markdownText += `- Risk/Reward Ratio: ${rrIcon} 1:${rr.toFixed(2)}`;
                                    if (rr < 1.5) {
                                        markdownText += ` (‚ö†Ô∏è Below recommended 1:1.5 minimum)`;
                                    }
                                    markdownText += `\n`;
                                }

                                if (pt.guidance) {
                                    markdownText += `- Guidance: ${pt.guidance}\n`;
                                }

                                markdownText += `\n`;
                            }

                            // Stop Loss Analysis (if available)
                            if (rec.price_targets?.stop_loss_analysis) {
                                const sla = rec.price_targets.stop_loss_analysis;
                                markdownText += `**Stop Loss Methods Comparison:**\n`;

                                if (sla.trailing_stop) {
                                    markdownText += `- Trailing Stop: $${sla.trailing_stop.price?.toFixed(2) || 'N/A'} (${sla.trailing_stop.percent?.toFixed(1) || 'N/A'}%)\n`;
                                }
                                if (sla.fixed_variable) {
                                    markdownText += `- Fixed Variable: $${sla.fixed_variable.price?.toFixed(2) || 'N/A'} (${sla.fixed_variable.percent?.toFixed(1) || 'N/A'}%)\n`;
                                }
                                if (sla.atr_2x) {
                                    markdownText += `- ATR 2x: $${sla.atr_2x.price?.toFixed(2) || 'N/A'} (${sla.atr_2x.percent?.toFixed(1) || 'N/A'}%)\n`;
                                }
                                if (sla.technical_support) {
                                    markdownText += `- Technical Support: $${sla.technical_support.price?.toFixed(2) || 'N/A'} (${sla.technical_support.percent?.toFixed(1) || 'N/A'}%)\n`;
                                }
                                if (sla.volatility_2sigma) {
                                    markdownText += `- Volatility 2œÉ: $${sla.volatility_2sigma.price?.toFixed(2) || 'N/A'} (${sla.volatility_2sigma.percent?.toFixed(1) || 'N/A'}%)\n`;
                                }

                                markdownText += `\n`;
                            }

                            // Technical indicators
                            if (rec.technical) {
                                const tech = rec.technical;
                                markdownText += `**Technical Indicators:**\n`;
                                markdownText += `- RSI (14d): ${tech.rsi_14d ? tech.rsi_14d.toFixed(1) : 'N/A'}`;
                                if (tech.rsi_14d) {
                                    if (tech.rsi_14d > 70) markdownText += ` (Overbought ‚ö†Ô∏è)`;
                                    else if (tech.rsi_14d < 30) markdownText += ` (Oversold ‚úÖ)`;
                                }
                                markdownText += `\n`;
                                markdownText += `- MACD Signal: ${tech.macd_signal || 'N/A'}\n`;
                                markdownText += `- vs MA50: ${tech.vs_ma50_pct ? tech.vs_ma50_pct.toFixed(1) + '%' : 'N/A'}\n`;
                                markdownText += `- vs SPY (30d): ${tech.vs_spy_30d ? tech.vs_spy_30d.toFixed(1) + '%' : 'N/A'}\n`;
                                markdownText += `\n`;
                            }

                            // Rationale (full, not truncated)
                            if (rec.rationale) {
                                markdownText += `**Rationale:**\n`;
                                if (Array.isArray(rec.rationale)) {
                                    rec.rationale.forEach(r => {
                                        markdownText += `- ${r}\n`;
                                    });
                                } else if (typeof rec.rationale === 'string') {
                                    markdownText += `${rec.rationale}\n`;
                                } else {
                                    markdownText += `${String(rec.rationale)}\n`;
                                }
                                markdownText += `\n`;
                            }

                            // Tactical advice
                            if (rec.tactical_advice) {
                                markdownText += `**üéØ Tactical Advice:** ${rec.tactical_advice}\n\n`;
                            }

                            // Position sizing
                            if (rec.position_sizing?.guidance) {
                                markdownText += `**‚öñÔ∏è Position Sizing:** ${rec.position_sizing.guidance}\n\n`;
                            }

                            // Portfolio context (if available)
                            if (rec.current_value || rec.weight_pct) {
                                markdownText += `**Current Position:**\n`;
                                if (rec.current_value) markdownText += `- Value: $${rec.current_value.toFixed(2)}\n`;
                                if (rec.weight_pct) markdownText += `- Weight: ${rec.weight_pct}% of portfolio\n`;
                                markdownText += `\n`;
                            }

                            markdownText += `---\n\n`;
                        });

                    } else {
                        markdownText += `*No recommendations for this timeframe*\n\n`;
                    }

                    markdownText += `---\n\n`;
                }

                // Add footer
                markdownText += `## Notes & Glossary\n\n`;
                markdownText += `### Key Metrics\n`;
                markdownText += `- **Action:** STRONG BUY/BUY/HOLD/SELL/STRONG SELL recommendation\n`;
                markdownText += `- **Confidence:** ML model confidence score (70%+ recommended for action)\n`;
                markdownText += `- **Score:** Composite score combining technical and fundamental factors\n`;
                markdownText += `- **R/R Ratio:** Risk/Reward Ratio (minimum 1.5 recommended, 2.0+ excellent)\n`;
                markdownText += `  - ‚úÖ ‚â•2.0: Excellent risk/reward\n`;
                markdownText += `  - ‚ö†Ô∏è 1.5-2.0: Acceptable\n`;
                markdownText += `  - ‚ùå <1.5: Not recommended (too much risk)\n\n`;

                markdownText += `### Price Targets\n`;
                markdownText += `- **Entry Zone:** Recommended price range to open position\n`;
                markdownText += `- **Stop Loss:** Exit price if trade goes against you (risk management)\n`;
                markdownText += `- **Take Profit 1/2:** Target prices to take partial or full profits\n`;
                markdownText += `- **Upper/Lower Watch:** Monitoring levels for HOLD positions\n\n`;

                markdownText += `### Technical Indicators\n`;
                markdownText += `- **RSI (14d):** Relative Strength Index (>70=overbought, <30=oversold)\n`;
                markdownText += `- **MACD:** Moving Average Convergence Divergence (bullish/bearish signal)\n`;
                markdownText += `- **vs MA50:** Distance from 50-day moving average (%)\n`;
                markdownText += `- **vs SPY:** Relative performance vs S&P 500 over 30 days\n\n`;

                markdownText += `### Stop Loss Methods\n`;
                markdownText += `Multiple stop loss calculation methods for comparison:\n`;
                markdownText += `- **Trailing Stop:** Adaptive stop based on position gains (protects profits)\n`;
                markdownText += `- **Fixed Variable:** Volatility-adjusted fixed % (4-8%)\n`;
                markdownText += `- **ATR 2x:** Based on Average True Range (volatility-based)\n`;
                markdownText += `- **Technical Support:** Based on key support levels (MA20/MA50)\n`;
                markdownText += `- **Volatility 2œÉ:** Statistical 2 standard deviations\n\n`;

                markdownText += `*Generated by SmartFolio - Saxo Dashboard*\n`;
                markdownText += `*Export includes all View modal details: Price targets, Stop loss analysis, Technical indicators, Full rationale, Tactical advice, Position sizing*\n`;

                // Download as .txt file
                const blob = new Blob([markdownText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-recommendations-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                debugLogger.info('‚úÖ Recommendations exported successfully');
                btn.textContent = '‚úÖ Downloaded!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                debugLogger.error('Failed to export recommendations:', error);
                alert(`Error exporting recommendations: ${error.message}`);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        /**
         * Sort recommendations table by column
         */
        let recommendationsSortState = {
            column: 'rr',  // Default sort by R/R
            ascending: false  // Descending (best R/R first)
        };

        function sortRecommendationsTable(column) {
            const tbody = document.getElementById('recommendationsTableBody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (recommendationsSortState.column === column) {
                recommendationsSortState.ascending = !recommendationsSortState.ascending;
            } else {
                recommendationsSortState.column = column;
                // Default to descending for numeric columns, ascending for text
                recommendationsSortState.ascending = ['symbol', 'name', 'sector'].includes(column);
            }

            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'symbol':
                        aVal = a.dataset.symbol;
                        bVal = b.dataset.symbol;
                        return recommendationsSortState.ascending
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);

                    case 'name':
                        aVal = a.dataset.name;
                        bVal = b.dataset.name;
                        return recommendationsSortState.ascending
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);

                    case 'action':
                        // Sort by action priority: STRONG BUY > BUY > HOLD > SELL > STRONG SELL
                        const actionOrder = {
                            'STRONG BUY': 5,
                            'BUY': 4,
                            'HOLD': 3,
                            'SELL': 2,
                            'STRONG SELL': 1
                        };
                        aVal = actionOrder[a.dataset.action] || 0;
                        bVal = actionOrder[b.dataset.action] || 0;
                        break;

                    case 'rr':
                        aVal = parseFloat(a.dataset.rr) || 0;
                        bVal = parseFloat(b.dataset.rr) || 0;
                        break;

                    case 'score':
                        aVal = parseFloat(a.dataset.score) || 0;
                        bVal = parseFloat(b.dataset.score) || 0;
                        break;

                    case 'confidence':
                        aVal = parseFloat(a.dataset.confidence);
                        bVal = parseFloat(b.dataset.confidence);
                        break;

                    case 'sector':
                        aVal = a.dataset.sector;
                        bVal = b.dataset.sector;
                        return recommendationsSortState.ascending
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);

                    case 'weight':
                        aVal = parseFloat(a.dataset.weight) || 0;
                        bVal = parseFloat(b.dataset.weight) || 0;
                        break;

                    case 'value':
                        aVal = parseFloat(a.dataset.value) || 0;
                        bVal = parseFloat(b.dataset.value) || 0;
                        break;

                    default:
                        return 0;
                }

                return recommendationsSortState.ascending ? aVal - bVal : bVal - aVal;
            });

            // Reorder rows in DOM
            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicators
            ['Symbol', 'Name', 'Action', 'Rr', 'Score', 'Confidence', 'Sector', 'Weight', 'Value'].forEach(col => {
                const indicator = document.getElementById(`sortRec${col}`);
                if (indicator) {
                    if (col.toLowerCase() === column) {
                        indicator.textContent = recommendationsSortState.ascending ? '‚ñ≤' : '‚ñº';
                    } else {
                        indicator.textContent = '‚ÜïÔ∏è';
                    }
                }
            });
        }

        /**
         * Show recommendation modal (drill-down)
         */
        /**
         * Symbol to name mapping
         */
        const SYMBOL_NAMES = {
            // Tech
            'AAPL': 'Apple',
            'MSFT': 'Microsoft',
            'GOOGL': 'Alphabet (Google)',
            'AMZN': 'Amazon',
            'META': 'Meta (Facebook)',
            'NVDA': 'NVIDIA',
            'TSLA': 'Tesla',
            'AMD': 'AMD',
            'INTC': 'Intel',
            'PLTR': 'Palantir',
            'COIN': 'Coinbase',
            'IFX': 'Infineon Technologies',
            'CDR': 'Cedar Realty Trust',

            // Finance
            'BRKb': 'Berkshire Hathaway',
            'UBSG': 'UBS Group',
            'SLHn': 'Sandvik AB',

            // Consumer
            'KO': 'Coca-Cola',
            'UHRN': 'Richemont',

            // Healthcare
            'PFE': 'Pfizer',
            'BAX': 'Baxter',
            'ROG': 'Roche',

            // ETFs
            'IWDA': 'iShares MSCI World',
            'WORLD': 'UBS MSCI World',
            'ACWI': 'iShares MSCI ACWI',
            'ITEK': 'iShares S&P Tech',
            'AGGS': 'iShares Aggregate Bond',
            'BTEC': 'iShares Biotech',
            'XGDU': 'Xtrackers Gold ETC'
        };

        /**
         * Get display name for symbol
         * Priority: 1) Real portfolio data, 2) Static mapping, 3) API fallback name, 4) Symbol
         */
        function getDisplayName(symbol, fallbackName) {
            // First, try to get name from current portfolio data (most accurate)
            if (currentPortfolioData && currentPortfolioData.positions) {
                const position = currentPortfolioData.positions.find(p => p.symbol === symbol);
                if (position && position.name) {
                    return position.name;
                }
            }

            // Fallback to static mapping or API name
            return SYMBOL_NAMES[symbol] || fallbackName || symbol;
        }

        /**
         * Get adjusted tactical advice for positions that were downgraded
         */
        function getAdjustedTacticalAdvice(rec) {
            // If position was adjusted, provide specific advice for the adjusted action
            if (rec.adjusted) {
                const reason = rec.adjustment_reason;
                const action = rec.action;
                const sector = rec.sector || 'Unknown';
                const sectorWeight = rec.sector_weight ? (rec.sector_weight * 100).toFixed(0) : 'N/A';

                if (action === 'SELL') {
                    if (reason === 'sector_concentration_high') {
                        return `Reduce position by 30-50% to rebalance ${sector} sector (currently ${sectorWeight}% of portfolio, target 40%). ` +
                               `Rotate capital to underweight sectors (Finance, Healthcare) or diversified ETFs. ` +
                               `This is a weaker performer in an overweight sector.`;
                    } else if (reason === 'insufficient_risk_reward') {
                        return `Risk/Reward ratio unfavorable (${rec.risk_reward_tp1?.toFixed(2) || 'N/A'}:1 < 1.5). ` +
                               `Consider reducing position by 30-50%. Wait for better entry if you want to rebuy later.`;
                    }
                } else if (action === 'HOLD') {
                    if (reason === 'sector_concentration') {
                        return `Hold current position. Sector concentration prevents adding (${sector} at ${sectorWeight}%). ` +
                               `Monitor for rebalancing opportunities. Consider trimming if sector weight increases further.`;
                    } else if (reason === 'insufficient_risk_reward') {
                        return `Hold current position. Risk/Reward ratio improved but still below threshold for new entries. ` +
                               `Monitor for better setup. Don't add to position until R/R > 1.5.`;
                    }
                }
            }

            // If concentration warning (not adjusted but flagged)
            if (rec.concentration_warning) {
                const sector = rec.sector || 'Unknown';
                const sectorWeight = rec.sector_weight ? (rec.sector_weight * 100).toFixed(0) : 'N/A';
                return `‚ö†Ô∏è Sector concentration warning: ${sector} at ${sectorWeight}% (target 40%). ` +
                       `${rec.tactical_advice} Do not add to this position.`;
            }

            // Default: use original tactical advice
            return rec.tactical_advice;
        }

        function showRecommendationModal(symbol) {
            const rec = currentRecommendations.find(r => r.symbol === symbol);
            if (!rec) return;

            // Build modal HTML
            const modalHTML = `
                <div id="recModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;" onclick="closeRecommendationModal(event)">
                    <div style="background: var(--theme-surface); border-radius: var(--radius-lg); max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--theme-border); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--theme-text);">${rec.symbol}</h2>
                                <p style="margin: 0; color: var(--theme-text-muted); font-size: 0.875rem;">${rec.name}</p>
                            </div>
                            <button onclick="closeRecommendationModal()" style="padding: 0.5rem; border: none; background: transparent; cursor: pointer; font-size: 1.5rem; color: var(--theme-text-muted);">√ó</button>
                        </div>

                        <!-- Content -->
                        <div style="padding: 1.5rem;">
                            <!-- Action Summary -->
                            <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Action</div>
                                    <div style="font-size: 1.25rem; font-weight: 700;">${getActionBadge(rec.action)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Confidence</div>
                                    <div style="font-size: 1.25rem; font-weight: 700;">${Math.round(rec.confidence * 100)}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Score</div>
                                    <div style="font-size: 1.25rem; font-weight: 700;">${rec.score.toFixed(2)}</div>
                                </div>
                            </div>

                            <!-- CFD/Leverage Warning (P0 Enhancement - Oct 2025) -->
                            ${rec.is_cfd ? `
                            <div style="background: #fee2e2; border: 2px solid #ef4444; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #7f1d1d;">CFD/Leveraged Position</h3>
                                        <p style="margin: 0; font-size: 0.875rem; color: #991b1b;">
                                            <strong>Leverage:</strong> ${rec.leverage?.toFixed(1)}x<br>
                                            <strong>‚ö†Ô∏è Risk:</strong> Losses amplified by ${rec.leverage?.toFixed(1)}x<br>
                                            <strong>üõ°Ô∏è Stop Loss:</strong> Tighter stop applied (divided by leverage)<br>
                                            <strong>üí° Position Sizing:</strong> Reduce position size by 50% vs normal stocks
                                        </p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            ${rec.adjusted ? `
                            <!-- Adjustment Note -->
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #92400e;">Action Adjusted</h3>
                                        <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
                                            <strong>Original:</strong> ${rec.original_action || 'N/A'}<br>
                                            <strong>Adjusted to:</strong> ${rec.action}<br>
                                            <strong>Reason:</strong> ${rec.adjustment_note || 'Portfolio constraints applied'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Risk/Reward Warning -->
                            ${rec.price_targets?.risk_reward_tp1 && rec.price_targets.risk_reward_tp1 < 1.5 ? `
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #92400e;">Poor Risk/Reward Ratio</h3>
                                        <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
                                            <strong>Current R/R:</strong> 1:${rec.price_targets.risk_reward_tp1.toFixed(2)} (minimum recommended: 1:1.5)<br>
                                            <strong>‚ö†Ô∏è Risk:</strong> ${Math.abs(rec.price_targets.stop_loss_pct || 0).toFixed(1)}% downside for only ${rec.price_targets.take_profit_1_pct || 0}% upside<br>
                                            <strong>üí° Suggestion:</strong> Wait for better entry point (pullback) or consider tighter stop loss
                                        </p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Price Targets -->
                            <div style="background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem;">üìä Price Information</h3>
                                ${renderPriceTargets(rec.price_targets)}
                            </div>

                            <!-- Stop Loss Analysis (Multi-Method) -->
                            ${rec.price_targets?.stop_loss_analysis ? renderStopLossAnalysis(rec.price_targets.stop_loss_analysis, rec.current_value) : ''}

                            <!-- Rationale -->
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem;">üí° Rationale</h3>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${rec.rationale.map(r => `<li style="padding: 0.5rem 0; border-bottom: 1px solid var(--theme-border); font-size: 0.875rem;">${r}</li>`).join('')}
                                </ul>
                            </div>

                            <!-- Tactical Advice -->
                            <div style="background: var(--theme-bg-subtle); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üéØ Tactical Advice</h3>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--theme-text);">${getAdjustedTacticalAdvice(rec)}</p>
                            </div>

                            <!-- Technical Details (Collapsible) -->
                            <details style="margin-bottom: 1.5rem;">
                                <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; background: var(--theme-bg); border-radius: var(--radius-sm);">üìà Technical Indicators</summary>
                                <div style="padding: 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-md); margin-top: 0.5rem;">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">RSI (14d)</div>
                                            <div style="font-weight: 600;">${rec.technical.rsi_14d?.toFixed(1) || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">MACD Signal</div>
                                            <div style="font-weight: 600;">${rec.technical.macd_signal || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">vs MA50</div>
                                            <div style="font-weight: 600;">${rec.technical.vs_ma50_pct ? rec.technical.vs_ma50_pct.toFixed(1) + '%' : 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">vs SPY (30d)</div>
                                            <div style="font-weight: 600;">${rec.technical.vs_spy_30d ? rec.technical.vs_spy_30d.toFixed(1) + '%' : 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- Position Sizing -->
                            <div style="background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-md);">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">‚öñÔ∏è Position Sizing</h3>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--theme-text-muted);">${rec.position_sizing.guidance || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        /**
         * Render price targets section
         */
        function renderPriceTargets(targets) {
            if (!targets) return '<p style="color: var(--theme-text-muted);">No price targets available</p>';

            if (targets.action === 'HOLD - Monitor position') {
                return `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Current Price</div>
                            <div style="font-weight: 600;">$${targets.current_price}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Upper Watch</div>
                            <div style="font-weight: 600; color: var(--success);">$${targets.upper_watch} <span style="font-size: 0.75rem;">(+${targets.upper_watch_pct}%)</span></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Lower Watch</div>
                            <div style="font-weight: 600; color: var(--danger);">$${targets.lower_watch} <span style="font-size: 0.75rem;">(${targets.lower_watch_pct}%)</span></div>
                        </div>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--theme-text-muted);">${targets.guidance}</p>
                `;
            } else if (targets.entry_zone) {
                return `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Current Price</div>
                            <div style="font-weight: 600;">$${targets.current_price}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Entry Zone</div>
                            <div style="font-weight: 600;">$${targets.entry_zone.low} - $${targets.entry_zone.high}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Stop Loss</div>
                            <div style="font-weight: 600; color: var(--danger);">$${targets.stop_loss} <span style="font-size: 0.75rem;">(${targets.stop_loss_pct}%)</span></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Take Profit 1</div>
                            <div style="font-weight: 600; color: var(--success);">$${targets.take_profit_1} <span style="font-size: 0.75rem;">(+${targets.take_profit_1_pct}%)</span></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Take Profit 2</div>
                            <div style="font-weight: 600; color: var(--success);">$${targets.take_profit_2} <span style="font-size: 0.75rem;">(+${targets.take_profit_2_pct}%)</span></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted);">Risk/Reward</div>
                            <div style="font-weight: 600;">1:${targets.risk_reward_tp1?.toFixed(2) || 'N/A'}</div>
                        </div>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-muted);">${targets.position_sizing || ''}</p>
                `;
            } else {
                return '<p style="color: var(--theme-text-muted);">Price targets not available</p>';
            }
        }

        /**
         * Render Stop Loss Analysis (Multi-Method Comparison)
         */
        function renderStopLossAnalysis(analysis, positionValue) {
            if (!analysis || !analysis.stop_loss_levels) return '';

            const levels = analysis.stop_loss_levels;
            const recommended = analysis.recommended_method;
            const currentPrice = analysis.current_price;

            // Calculate risk in dollars for each method if position exists
            const calculateRiskDollars = (stopPrice) => {
                if (!positionValue || positionValue === 0) return null;
                const shares = positionValue / currentPrice;
                return (currentPrice - stopPrice) * shares;
            };

            // Quality badge color
            const getQualityColor = (quality) => {
                if (quality === 'high') return 'var(--success)';
                if (quality === 'medium') return 'var(--warning)';
                return 'var(--theme-text-muted)';
            };

            // Render each method row
            const renderMethod = (methodKey, methodData) => {
                const isRecommended = methodKey === recommended;
                const riskDollars = calculateRiskDollars(methodData.price);
                const qualityColor = getQualityColor(methodData.quality);
                const isTrailingStop = methodKey === 'trailing_stop';

                // Special note for trailing stop with tier details (P0 Enhancement - Oct 2025)
                let trailingNote = '';
                if (isTrailingStop && methodData.gain_pct) {
                    const gainPct = methodData.gain_pct;
                    let tier = '';
                    let trailingPct = 0;
                    let protectedGainPct = 0;

                    // Determine tier and protected gain
                    if (gainPct >= 500) {
                        tier = '>500% (Legendary)';
                        trailingPct = 30;
                        protectedGainPct = gainPct - 30;
                    } else if (gainPct >= 100) {
                        tier = '100-500% (Legacy)';
                        trailingPct = 25;
                        protectedGainPct = gainPct - 25;
                    } else if (gainPct >= 50) {
                        tier = '50-100% (Strong)';
                        trailingPct = 20;
                        protectedGainPct = gainPct - 20;
                    } else {
                        tier = '20-50% (Good)';
                        trailingPct = 15;
                        protectedGainPct = gainPct - 15;
                    }

                    trailingNote = `<div style="font-size: 0.65rem; color: var(--success); margin-top: 0.25rem;">
                        üèÜ Legacy position: +${gainPct.toFixed(0)}%<br>
                        üìä Tier: ${tier} ‚Üí Trailing -${trailingPct}%<br>
                        üõ°Ô∏è Protected minimum gain: +${protectedGainPct.toFixed(0)}%
                    </div>`;
                }

                return `
                    <tr style="background: ${isRecommended ? 'color-mix(in oklab, var(--success) 10%, transparent)' : 'transparent'}; border-bottom: 1px solid var(--theme-border);">
                        <td style="padding: 0.75rem;">
                            ${isRecommended ? '‚úÖ ' : ''}
                            <strong>${getMethodLabel(methodKey)}</strong>
                            ${isRecommended ? '<br><span style="font-size: 0.7rem; color: var(--success);">Recommended</span>' : ''}
                            ${trailingNote}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                            $${methodData.price}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; color: ${methodData.distance_pct < 0 ? 'var(--danger)' : 'var(--success)'};">
                            ${methodData.distance_pct}%
                        </td>
                        <td style="padding: 0.75rem; text-align: right; ${riskDollars ? '' : 'color: var(--theme-text-muted);'}">
                            ${riskDollars ? `-‚Ç¨${Math.abs(riskDollars).toFixed(0)}` : 'N/A'}
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="display: inline-block; padding: 0.125rem 0.5rem; border-radius: var(--radius-full); background: ${qualityColor}20; color: ${qualityColor}; font-size: 0.7rem; font-weight: 600;">
                                ${methodData.quality?.toUpperCase() || 'N/A'}
                            </span>
                        </td>
                    </tr>
                `;
            };

            return `
                <details open style="margin-bottom: 1.5rem; border: 2px solid var(--info); border-radius: var(--radius-md); padding: 0.75rem; background: color-mix(in oklab, var(--info) 5%, transparent);">
                    <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; color: var(--info); user-select: none;">
                        üõ°Ô∏è Stop Loss Analysis (5 Methods Compared)
                    </summary>
                    <div style="padding: 1rem 0.5rem 0.5rem 0.5rem;">
                        <p style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: 1rem;">
                            Comparing multiple stop loss calculation methods. <strong style="color: var(--success);">Fixed Variable</strong> is recommended (backtested +8% vs Fixed 5%, +156% vs ATR). Simple rules: 4% (low vol), 6% (moderate vol), 8% (high vol).
                        </p>

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--theme-border); background: var(--theme-bg-subtle);">
                                        <th style="padding: 0.5rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Method</th>
                                        <th style="padding: 0.5rem; text-align: right; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Price</th>
                                        <th style="padding: 0.5rem; text-align: right; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Distance</th>
                                        <th style="padding: 0.5rem; text-align: right; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Max Loss</th>
                                        <th style="padding: 0.5rem; text-align: center; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Quality</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(levels).map(([key, data]) => renderMethod(key, data)).join('')}
                                </tbody>
                            </table>
                        </div>

                        ${levels[recommended] && levels[recommended].reasoning ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--theme-bg); border-radius: var(--radius-sm); border-left: 3px solid var(--success);">
                                <strong style="font-size: 0.875rem; color: var(--success);">üí° Why ${getMethodLabel(recommended)}?</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--theme-text);">
                                    ${levels[recommended].reasoning}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </details>
            `;
        }

        /**
         * Get human-readable label for stop loss method
         */
        function getMethodLabel(methodKey) {
            const labels = {
                'trailing_stop': 'üèÜ Trailing Stop (Legacy)',
                'fixed_variable': 'Fixed Variable (Adaptive)',
                'atr_2x': 'ATR 2x',
                'technical_support': 'Technical Support',
                'volatility_2std': 'Volatility 2œÉ',
                'fixed_pct': 'Fixed %'
            };
            return labels[methodKey] || methodKey;
        }

        /**
         * Close recommendation modal
         */
        function closeRecommendationModal(event) {
            if (event && event.target.id !== 'recModal') return;

            const modal = document.getElementById('recModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Format currency
         */
        function formatCurrency(value) {
            if (value === undefined || value === null) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // ================================================================================
        // END RECOMMENDATIONS TAB
        // ================================================================================


        // ================================================================================
        // MARKET OPPORTUNITIES TAB
        // ================================================================================

        let opportunitiesLoaded = false;
        let currentHorizon = 'medium';
        let lastOpportunitiesData = null;

        /**
         * Setup event listeners for opportunities tab
         */
        function setupOpportunitiesListeners() {
            // Horizon buttons
            const horizonButtons = document.querySelectorAll('[data-opp-horizon]');
            horizonButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    // Update active state
                    horizonButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Update current horizon
                    currentHorizon = btn.getAttribute('data-opp-horizon');

                    // If data already loaded, reload with new horizon
                    if (lastOpportunitiesData) {
                        await loadMarketOpportunities();
                    }
                });
            });

            // Scan button
            const scanBtn = document.getElementById('btnScanOpportunities');
            if (scanBtn) {
                scanBtn.addEventListener('click', async () => {
                    await loadMarketOpportunities();
                });
            }

            // Export text button
            const exportBtn = document.getElementById('btnExportTextOpps');
            if (exportBtn) {
                exportBtn.addEventListener('click', async () => {
                    await exportOpportunitiesToText();
                });
            }
        }

        /**
         * Load opportunities tab (lazy)
         */
        async function loadOpportunitiesTab() {
            if (!opportunitiesLoaded) {
                setupOpportunitiesListeners();
                opportunitiesLoaded = true;
            }
        }

        /**
         * Load market opportunities data from API
         */
        async function loadMarketOpportunities() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            const scanBtn = document.getElementById('btnScanOpportunities');
            const originalText = scanBtn.textContent;

            try {
                scanBtn.disabled = true;
                scanBtn.textContent = 'üîç Scanning...';

                // Show loading states
                document.getElementById('portfolioGaps').innerHTML = '<div class="loading">Analyzing sector gaps...</div>';
                document.getElementById('opportunitiesTable').innerHTML = '<div class="loading">Identifying opportunities...</div>';
                document.getElementById('suggestedSales').innerHTML = '<div class="loading">Calculating suggested sales...</div>';
                document.getElementById('impactSimulator').innerHTML = '<div class="loading">Computing impact...</div>';

                // Build API URL
                let url = `/api/bourse/opportunities?user_id=${activeUser}&horizon=${currentHorizon}`;
                if (currentFileKey) {
                    url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                }

                debugLogger.info(`Loading market opportunities (horizon: ${currentHorizon})`);

                const response = await safeFetch(globalConfig.getApiUrl(url));
                if (!response?.ok) {
                    throw new Error('Opportunities endpoint failed');
                }

                const data = response.data || response;
                lastOpportunitiesData = data;

                debugLogger.info('Market opportunities loaded:', data);

                // Render sections
                renderGapsCards(data.gaps || []);
                renderOpportunitiesTable(data.opportunities || []);
                renderSuggestedSales(data.suggested_sales || []);
                renderImpactSimulator(data.impact || {});

                // Update counts
                document.getElementById('gapsCount').textContent = `${data.gaps?.length || 0} gaps`;
                document.getElementById('opportunitiesCount').textContent = `${data.opportunities?.length || 0} opportunities`;
                document.getElementById('salesCount').textContent = `${data.suggested_sales?.length || 0} suggestions`;

                scanBtn.textContent = '‚úÖ Scan Complete';
                setTimeout(() => {
                    scanBtn.textContent = originalText;
                    scanBtn.disabled = false;
                }, 2000);

            } catch (error) {
                debugLogger.error('Failed to load market opportunities:', error);

                document.getElementById('portfolioGaps').innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--danger);">
                        Error loading opportunities: ${error.message}
                    </div>
                `;

                scanBtn.textContent = '‚ùå Error';
                setTimeout(() => {
                    scanBtn.textContent = originalText;
                    scanBtn.disabled = false;
                }, 2000);
            }
        }

        /**
         * Export market opportunities to text (Markdown format for AI analysis)
         * Fetches all 3 horizons and generates structured text
         */
        async function exportOpportunitiesToText() {
            const btn = document.getElementById('btnExportTextOpps');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating...';

                const activeUser = localStorage.getItem('activeUser') || 'demo';
                const horizons = [
                    { id: 'short', name: 'SHORT TERM (1-3 Months)', description: 'Short-term opportunities' },
                    { id: 'medium', name: 'MEDIUM TERM (6-12 Months)', description: 'Mid-term opportunities' },
                    { id: 'long', name: 'LONG TERM (2-3 Years)', description: 'Long-term opportunities' }
                ];

                let markdownText = `# Market Opportunities Export\n\n`;
                markdownText += `**Generated:** ${new Date().toLocaleString()}\n`;
                markdownText += `**User:** ${activeUser}\n`;
                markdownText += `**Portfolio:** ${currentFileKey || 'Latest'}\n\n`;
                markdownText += `---\n\n`;

                // Fetch all horizons
                for (const horizon of horizons) {
                    debugLogger.info(`Fetching ${horizon.id} horizon opportunities...`);

                    let url = `/api/bourse/opportunities?user_id=${activeUser}&horizon=${horizon.id}`;
                    if (currentFileKey) {
                        url += `&file_key=${encodeURIComponent(currentFileKey)}`;
                    }

                    const response = await safeFetch(globalConfig.getApiUrl(url));
                    if (!response?.ok) throw new Error(`Failed to fetch ${horizon.id} opportunities`);

                    const data = response.data || response;
                    const gaps = data.gaps || [];
                    const opportunities = data.opportunities || [];
                    const suggestedSales = data.suggested_sales || [];
                    const impact = data.impact || {};

                    // Add horizon section
                    markdownText += `## ${horizon.name} - ${horizon.description}\n\n`;

                    // Portfolio Gaps section
                    markdownText += `### üìä Portfolio Gaps (Underweight Sectors)\n\n`;
                    if (gaps.length > 0) {
                        markdownText += `**Total Gaps:** ${gaps.length}\n\n`;
                        gaps.forEach((gap, idx) => {
                            const sector = gap.sector || 'N/A';
                            const current = gap.current_pct ? gap.current_pct.toFixed(1) : '0.0';
                            const target = gap.target_pct ? gap.target_pct.toFixed(1) : 'N/A';
                            const gapPct = gap.gap_pct ? gap.gap_pct.toFixed(1) : '0.0';
                            const score = gap.score ? gap.score.toFixed(0) : 'N/A';
                            const etf = gap.etf || 'N/A';
                            const rationale = gap.rationale || 'Sector underweight relative to target allocation';

                            markdownText += `#### ${idx + 1}. ${sector} (Score: ${score})\n`;
                            markdownText += `- **Current Allocation:** ${current}%\n`;
                            markdownText += `- **Target Allocation:** ${target}%\n`;
                            markdownText += `- **Gap:** ${gapPct}%\n`;
                            markdownText += `- **Suggested ETF:** ${etf}\n`;
                            markdownText += `- **Rationale:** ${rationale}\n\n`;
                        });
                    } else {
                        markdownText += `No significant portfolio gaps identified.\n\n`;
                    }

                    // Top Opportunities section
                    markdownText += `### üéØ Top Opportunities\n\n`;
                    if (opportunities.length > 0) {
                        markdownText += `**Total Opportunities:** ${opportunities.length}\n\n`;
                        opportunities.forEach((opp, idx) => {
                            const symbol = opp.symbol || 'N/A';
                            const name = opp.name || 'N/A';
                            const sector = opp.sector || 'N/A';
                            const score = opp.score ? opp.score.toFixed(0) : 'N/A';
                            const type = opp.type || 'N/A';
                            const capitalNeeded = opp.capital_needed ? `‚Ç¨${opp.capital_needed.toLocaleString()}` : 'N/A';
                            const rationale = opp.rationale || 'No rationale provided';

                            markdownText += `#### ${idx + 1}. ${symbol} - ${name}\n`;
                            markdownText += `- **Sector:** ${sector}\n`;
                            markdownText += `- **Opportunity Score:** ${score}\n`;
                            markdownText += `- **Type:** ${type}\n`;
                            markdownText += `- **Capital Needed:** ${capitalNeeded}\n`;
                            markdownText += `- **Rationale:** ${rationale}\n\n`;
                        });
                    } else {
                        markdownText += `No opportunities identified for this horizon.\n\n`;
                    }

                    // Suggested Sales section
                    markdownText += `### üí∞ Suggested Sales\n\n`;
                    if (suggestedSales.length > 0) {
                        markdownText += `**Total Suggestions:** ${suggestedSales.length}\n\n`;
                        suggestedSales.forEach((sale, idx) => {
                            const symbol = sale.symbol || 'N/A';
                            const currentVal = sale.current_value ? `‚Ç¨${sale.current_value.toLocaleString()}` : 'N/A';
                            const saleVal = sale.sale_value ? `‚Ç¨${sale.sale_value.toLocaleString()}` : 'N/A';
                            const pct = sale.sale_pct ? sale.sale_pct.toFixed(0) : '0';
                            const rationale = sale.rationale || 'No rationale provided';

                            markdownText += `#### ${idx + 1}. ${symbol}\n`;
                            markdownText += `- **Current Value:** ${currentVal}\n`;
                            markdownText += `- **Sell Amount:** ${saleVal} (${pct}%)\n`;
                            markdownText += `- **Rationale:** ${rationale}\n\n`;
                        });
                    } else {
                        markdownText += `No suggested sales for this horizon.\n\n`;
                    }

                    // Impact Simulation section
                    markdownText += `### üìà Impact Simulation\n\n`;
                    if (impact && Object.keys(impact).length > 0) {
                        // Risk metrics
                        if (impact.risk_before !== undefined && impact.risk_after !== undefined) {
                            const riskBefore = impact.risk_before.toFixed(1);
                            const riskAfter = impact.risk_after.toFixed(1);
                            markdownText += `**Risk Score:** ${riskBefore} ‚Üí ${riskAfter}\n`;
                        }

                        // Capital freed
                        if (impact.total_freed !== undefined) {
                            const capitalFreed = `‚Ç¨${Math.round(impact.total_freed).toLocaleString()}`;
                            markdownText += `**Capital Freed:** ${capitalFreed}\n`;
                        }

                        // Capital invested
                        if (impact.total_invested !== undefined) {
                            const capitalInvested = `‚Ç¨${Math.round(impact.total_invested).toLocaleString()}`;
                            markdownText += `**Capital Invested:** ${capitalInvested}\n`;
                        }

                        // Before vs After allocations
                        if (impact.before && impact.after) {
                            markdownText += `\n**Sector Allocation Changes:**\n`;
                            const allSectors = new Set([...Object.keys(impact.before), ...Object.keys(impact.after)]);
                            allSectors.forEach(sector => {
                                const beforeVal = impact.before[sector] ? impact.before[sector].toFixed(1) : '0.0';
                                const afterVal = impact.after[sector] ? impact.after[sector].toFixed(1) : '0.0';
                                const change = (impact.after[sector] || 0) - (impact.before[sector] || 0);
                                const changeStr = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                                markdownText += `  - ${sector}: ${beforeVal}% ‚Üí ${afterVal}% (${changeStr}%)\n`;
                            });
                        }

                        markdownText += `\n`;
                    } else {
                        markdownText += `No impact simulation data available.\n\n`;
                    }

                    markdownText += `---\n\n`;
                }

                // Footer
                markdownText += `*Generated by SmartFolio - Saxo Dashboard*\n`;
                markdownText += `*Export includes all 3 investment horizons with gaps, opportunities, suggested sales, and impact analysis*\n`;

                // Download as .txt file
                const blob = new Blob([markdownText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `market-opportunities-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                debugLogger.info('‚úÖ Market opportunities exported successfully');
                btn.textContent = '‚úÖ Downloaded!';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                debugLogger.error('Failed to export market opportunities:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        /**
         * Render portfolio gaps as cards
         */
        function renderGapsCards(gaps) {
            const container = document.getElementById('portfolioGaps');

            if (!gaps || gaps.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                        No significant sector gaps detected. Portfolio is well-diversified!
                    </div>
                `;
                return;
            }

            const cardsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 1rem;">
                    ${gaps.map(gap => {
                        const scoreColor = gap.score >= 70 ? 'var(--success)' : gap.score >= 50 ? 'var(--warning)' : 'var(--theme-text-muted)';
                        return `
                            <div style="padding: 1.5rem; background: var(--theme-bg); border-radius: var(--radius-md); border: 1px solid var(--theme-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">${gap.sector}</h4>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${scoreColor};">${gap.score.toFixed(0)}</div>
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.25rem;">Current / Target</div>
                                    <div style="font-size: 1.125rem; font-weight: 600;">
                                        ${gap.current_pct.toFixed(1)}% ‚Üí ${gap.target_pct.toFixed(1)}%
                                    </div>
                                </div>
                                <div style="padding: 0.5rem; background: var(--theme-surface); border-radius: var(--radius-sm); font-size: 0.75rem;">
                                    <div style="color: var(--theme-text-muted);">Gap: <strong style="color: var(--warning);">${gap.gap_pct.toFixed(1)}%</strong></div>
                                    <div style="color: var(--theme-text-muted); margin-top: 0.25rem;">ETF: <strong>${gap.etf}</strong></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = cardsHtml;
        }

        /**
         * Render opportunities table
         */
        function renderOpportunitiesTable(opportunities) {
            const container = document.getElementById('opportunitiesTable');

            if (!opportunities || opportunities.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                        No significant opportunities identified. Current portfolio is well-positioned.
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--theme-border); background: var(--theme-bg-subtle);">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Symbol</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Name</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Sector</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Score</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Type</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Capital Needed</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Rationale</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${opportunities.map(opp => {
                                const scoreColor = opp.score >= 70 ? 'var(--success)' : opp.score >= 50 ? 'var(--warning)' : 'var(--theme-text-muted)';
                                return `
                                    <tr style="border-bottom: 1px solid var(--theme-border);">
                                        <td style="padding: 0.75rem; font-weight: 600;">${opp.symbol}</td>
                                        <td style="padding: 0.75rem; color: var(--theme-text);">${opp.name || opp.symbol}</td>
                                        <td style="padding: 0.75rem;">${opp.sector}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="color: ${scoreColor}; font-weight: 600;">${opp.score.toFixed(0)}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="padding: 0.25rem 0.5rem; background: var(--info-bg); color: var(--info); border-radius: var(--radius-sm); font-size: 0.75rem;">${opp.type}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${formatCurrency(opp.capital_needed)}</td>
                                        <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--theme-text-muted);">${opp.rationale}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        /**
         * Render suggested sales table
         */
        function renderSuggestedSales(sales) {
            const container = document.getElementById('suggestedSales');

            if (!sales || sales.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                        No sales needed. Portfolio has sufficient liquidity or no opportunities identified.
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--theme-border); background: var(--theme-bg-subtle);">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Symbol</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Current Value</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Sell %</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Frees</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Rationale</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sales.map(sale => `
                                <tr style="border-bottom: 1px solid var(--theme-border);">
                                    <td style="padding: 0.75rem; font-weight: 600;">${sale.symbol}</td>
                                    <td style="padding: 0.75rem; text-align: right;">${formatCurrency(sale.current_value)}</td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        <span style="padding: 0.25rem 0.5rem; background: var(--warning-bg); color: var(--warning); border-radius: var(--radius-sm); font-weight: 600;">${sale.sale_pct.toFixed(0)}%</span>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--success);">+${formatCurrency(sale.sale_value)}</td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--theme-text-muted);">${sale.rationale}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        /**
         * Render impact simulator (before/after allocation)
         */
        function renderImpactSimulator(impact) {
            const container = document.getElementById('impactSimulator');

            if (!impact || !impact.before || !impact.after) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--theme-text-muted);">
                        No impact data available. Run scan first.
                    </div>
                `;
                return;
            }

            const before = impact.before;
            const after = impact.after;

            // Get all sectors (union of before and after)
            const allSectors = new Set([...Object.keys(before), ...Object.keys(after)]);

            const simulatorHtml = `
                <div style="padding: 1.5rem;">
                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.5rem;">Risk Score</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">
                                <span style="color: var(--warning);">${impact.risk_before?.toFixed(1) || 'N/A'}</span>
                                <span style="margin: 0 0.5rem;">‚Üí</span>
                                <span style="color: var(--success);">${impact.risk_after?.toFixed(1) || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.5rem;">Capital Freed</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${formatCurrency(impact.total_freed || 0)}</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
                            <div style="font-size: 0.75rem; color: var(--theme-text-muted); margin-bottom: 0.5rem;">Capital Invested</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${formatCurrency(impact.total_invested || 0)}</div>
                        </div>
                    </div>

                    <!-- Sector Comparison -->
                    <h4 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">Sector Allocation Changes</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--theme-border); background: var(--theme-bg-subtle);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Sector</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Before</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">After</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--theme-text-muted);">Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.from(allSectors).map(sector => {
                                    const beforePct = before[sector] || 0;
                                    const afterPct = after[sector] || 0;
                                    const change = afterPct - beforePct;
                                    const changeColor = change > 0 ? 'var(--success)' : change < 0 ? 'var(--danger)' : 'var(--theme-text-muted)';
                                    const changePrefix = change > 0 ? '+' : '';

                                    return `
                                        <tr style="border-bottom: 1px solid var(--theme-border);">
                                            <td style="padding: 0.75rem; font-weight: 600;">${sector}</td>
                                            <td style="padding: 0.75rem; text-align: right;">${beforePct.toFixed(1)}%</td>
                                            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${afterPct.toFixed(1)}%</td>
                                            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${changeColor};">
                                                ${changePrefix}${change.toFixed(1)}%
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = simulatorHtml;
        }

        // ================================================================================
        // END MARKET OPPORTUNITIES TAB
        // ================================================================================


        // ================================================================================
        // END RECOMMENDATIONS TAB
        // ================================================================================

    </script>

    <!-- AI Chat Modal -->
    <div id="aiChatModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div id="aiChatModalContent" class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column; background: var(--theme-surface); border-radius: var(--radius-lg); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; transform: scale(0.95); transition: transform 0.2s ease-out;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--theme-border); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.5rem;">
                    ü§ñ Assistant IA - Analyse Portfolio
                </h3>
                <button onclick="closeAIChatModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); line-height: 1;">&times;</button>
            </div>

            <!-- Quick Questions -->
            <div id="aiQuickQuestions" style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--theme-border); display: flex; flex-wrap: wrap; gap: 0.5rem; background: var(--theme-surface);">
                <span style="font-size: 0.75rem; color: var(--theme-text-muted); width: 100%; margin-bottom: 0.25rem;">Questions rapides:</span>
            </div>

            <!-- Chat Messages -->
            <div id="aiChatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; background: var(--theme-bg);">
                <div class="ai-welcome" style="text-align: center; padding: 2rem; color: var(--theme-text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
                    <p style="margin: 0;">Posez-moi des questions sur votre portefeuille!</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">J'utilise vos donnees en temps reel pour une analyse personnalisee.</p>
                </div>
            </div>

            <!-- Chat Input -->
            <div style="padding: 1rem; border-top: 1px solid var(--theme-border); background: var(--theme-surface);">
                <div style="display: flex; gap: 0.5rem;">
                    <input
                        type="text"
                        id="aiChatInput"
                        placeholder="Posez votre question..."
                        style="flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--theme-border); border-radius: var(--radius-md); font-size: 0.9rem; background: var(--theme-bg); color: var(--theme-text);"
                        onkeypress="if(event.key === 'Enter') sendAIChatMessage()"
                    >
                    <button
                        id="aiSendBtn"
                        onclick="sendAIChatMessage()"
                        style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        Envoyer
                    </button>
                </div>
                <div id="aiChatStatus" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--theme-text-muted); display: none;"></div>
            </div>
        </div>
    </div>

    <script>
    // ================================================================================
    // AI CHAT FUNCTIONALITY
    // ================================================================================

    const aiChatState = {
        messages: [],
        isLoading: false,
        configured: false
    };

    // Open the AI Chat modal
    async function openAIChatModal() {
        const modal = document.getElementById('aiChatModal');
        const modalContent = document.getElementById('aiChatModalContent');
        modal.style.display = 'flex';

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Animate in
        requestAnimationFrame(() => {
            modal.style.opacity = '0';
            modalContent.style.transform = 'scale(0.9)';
            requestAnimationFrame(() => {
                modal.style.transition = 'opacity 0.2s ease-out';
                modal.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
            });
        });

        // Check AI status
        await checkAIStatus();

        // Load quick questions
        await loadQuickQuestions();

        // Focus input
        document.getElementById('aiChatInput').focus();
    }

    // Close the AI Chat modal
    function closeAIChatModal() {
        const modal = document.getElementById('aiChatModal');
        const modalContent = document.getElementById('aiChatModalContent');

        // Animate out
        modal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
            modal.style.display = 'none';
            modalContent.style.transform = 'scale(0.95)'; // Reset for next open
            // Restore body scroll
            document.body.style.overflow = '';
        }, 200);
    }

    // Close modal on overlay click
    document.getElementById('aiChatModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeAIChatModal();
    });

    // Check if AI is configured
    async function checkAIStatus() {
        try {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            const response = await fetch('/api/ai/status', {
                headers: { 'X-User': activeUser }
            });
            const data = await response.json();

            aiChatState.configured = data.configured;

            if (!data.configured) {
                showAIChatStatus('‚ö†Ô∏è API Groq non configuree. Ajoutez votre cle dans Settings > API Keys.', 'warning');
            }
        } catch (error) {
            console.error('Error checking AI status:', error);
        }
    }

    // Load quick questions
    async function loadQuickQuestions() {
        try {
            const response = await fetch('/api/ai/quick-questions');
            const data = await response.json();

            if (data.ok && data.questions) {
                const container = document.getElementById('aiQuickQuestions');
                const label = container.querySelector('span');
                container.innerHTML = '';
                container.appendChild(label);

                data.questions.forEach(q => {
                    const btn = document.createElement('button');
                    btn.textContent = q.label;
                    btn.style.cssText = 'padding: 0.35rem 0.75rem; font-size: 0.75rem; background: var(--theme-bg); border: 1px solid var(--theme-border); border-radius: var(--radius-sm); cursor: pointer; color: var(--theme-text); transition: all 0.2s;';
                    btn.onmouseover = () => btn.style.background = 'var(--brand-primary-light)';
                    btn.onmouseout = () => btn.style.background = 'var(--theme-bg)';
                    btn.onclick = () => {
                        document.getElementById('aiChatInput').value = q.prompt;
                        sendAIChatMessage();
                    };
                    container.appendChild(btn);
                });
            }
        } catch (error) {
            console.error('Error loading quick questions:', error);
        }
    }

    // Send message to AI
    async function sendAIChatMessage() {
        const input = document.getElementById('aiChatInput');
        const message = input.value.trim();

        if (!message || aiChatState.isLoading) return;

        // Add user message to UI
        addChatMessage('user', message);
        input.value = '';

        // Add to state
        aiChatState.messages.push({ role: 'user', content: message });

        // Show loading
        aiChatState.isLoading = true;
        showAIChatStatus('ü§î Reflexion en cours...', 'info');
        const sendBtn = document.getElementById('aiSendBtn');
        sendBtn.disabled = true;
        sendBtn.textContent = '...';

        try {
            const activeUser = localStorage.getItem('activeUser') || 'demo';

            // Build portfolio context
            const context = buildPortfolioContext();
            console.log('üì§ AI Chat context:', context);

            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User': activeUser
                },
                body: JSON.stringify({
                    messages: aiChatState.messages,
                    context: context,
                    max_tokens: 1024,
                    temperature: 0.7
                })
            });

            const data = await response.json();

            if (data.ok) {
                addChatMessage('assistant', data.message);
                aiChatState.messages.push({ role: 'assistant', content: data.message });

                if (data.usage) {
                    showAIChatStatus(`‚úì ${data.usage.total_tokens} tokens utilises`, 'success');
                } else {
                    hideAIChatStatus();
                }
            } else {
                addChatMessage('error', data.error || 'Erreur inconnue');
                showAIChatStatus('‚ùå ' + (data.error || 'Erreur'), 'error');
            }
        } catch (error) {
            console.error('AI Chat error:', error);
            addChatMessage('error', 'Erreur de connexion. Verifiez votre connexion internet.');
            showAIChatStatus('‚ùå Erreur de connexion', 'error');
        } finally {
            aiChatState.isLoading = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'Envoyer';
        }
    }

    // Build portfolio context from current data
    function buildPortfolioContext() {
        const context = {
            page: 'Saxo Dashboard - Portfolio Bourse',
            timestamp: new Date().toISOString()
        };

        // Get data from global state (currentPortfolioData is set by loadCurrentSaxoData)
        if (!currentPortfolioData) {
            context.error = 'Aucune donn√©e de portefeuille charg√©e';
            return context;
        }

        const data = currentPortfolioData;
        const summary = data.summary || {};
        const savedCash = window.portfolioCash || 0;

        // Portfolio summary
        const totalValue = Number(summary.total_value_usd || 0);
        const totalValueIncludesCash = data.totalValueIncludesCash || false;
        const totalWithCash = totalValueIncludesCash ? totalValue : (totalValue + savedCash);

        context.total_value = totalWithCash;
        context.total_positions = summary.total_positions || data.positions?.length || 0;
        context.cash = savedCash;

        // P&L information
        if (summary.total_pnl_usd !== undefined) {
            context.total_pnl = summary.total_pnl_usd;
            context.total_pnl_pct = summary.total_pnl_pct || 0;
        }

        // Positions (top 15 with details)
        if (data.positions && Array.isArray(data.positions)) {
            context.positions = data.positions.slice(0, 15).map(p => ({
                symbol: p.Symbol || p.symbol || '?',
                name: p.Name || p.name || '',
                value: p.MarketValue || p.value || 0,
                weight: p.Weight || p.weight || 0,
                pnl: p.PnL || p.pnl || 0,
                pnl_pct: p.PnLPercent || p.pnl_pct || 0,
                sector: p.Sector || p.sector || 'Unknown'
            }));
        }

        // Sector allocation
        if (summary.sector_allocation) {
            context.sectors = summary.sector_allocation;
        }

        // Asset allocation
        if (summary.asset_allocation) {
            context.asset_allocation = summary.asset_allocation;
        }

        // Currency exposure
        if (summary.currency_exposure) {
            context.currencies = summary.currency_exposure;
        }

        // Risk metrics if available
        if (data.risk_metrics) {
            context.risk_score = data.risk_metrics.score || 0;
            context.volatility = data.risk_metrics.volatility || 0;
        }

        return context;
    }

    // Add a message to the chat UI
    function addChatMessage(role, content) {
        const container = document.getElementById('aiChatMessages');

        // Remove welcome message if present
        const welcome = container.querySelector('.ai-welcome');
        if (welcome) welcome.remove();

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message chat-${role}`;

        const isUser = role === 'user';
        const isError = role === 'error';

        msgDiv.style.cssText = `
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            ${isUser ? 'align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' : ''}
            ${!isUser && !isError ? 'align-self: flex-start; background: var(--theme-surface); border: 1px solid var(--theme-border);' : ''}
            ${isError ? 'align-self: center; background: var(--danger-light); color: var(--danger); border: 1px solid var(--danger);' : ''}
            line-height: 1.5;
            font-size: 0.9rem;
        `;

        // Format content (basic markdown)
        const formattedContent = formatMarkdown(content);
        msgDiv.innerHTML = formattedContent;

        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

    // Basic markdown formatting
    function formatMarkdown(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code style="background: var(--theme-bg); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.85em;">$1</code>')
            .replace(/\n/g, '<br>');
    }

    // Show status message
    function showAIChatStatus(message, type) {
        const status = document.getElementById('aiChatStatus');
        status.textContent = message;
        status.style.display = 'block';
        status.style.color = type === 'error' ? 'var(--danger)' :
                             type === 'warning' ? 'var(--warning)' :
                             type === 'success' ? 'var(--success)' :
                             'var(--theme-text-muted)';
    }

    function hideAIChatStatus() {
        document.getElementById('aiChatStatus').style.display = 'none';
    }

    // ================================================================================
    // END AI CHAT
    // ================================================================================
    </script>
</body>

</html>